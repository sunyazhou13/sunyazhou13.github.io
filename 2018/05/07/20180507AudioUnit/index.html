<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>AudioUnit | 東引甌越</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="嗨，我是孙亚洲, 一个来自北国冰城的iOS&amp;macOS开发者,就职于百度,爱好书法。开发5年有余,没有为往圣续绝学深感惭愧，今2017年开始写博客, 望诸位同仁多多指教.">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="AudioUnit | 東引甌越">
    <meta name="twitter:description" content="嗨，我是孙亚洲, 一个来自北国冰城的iOS&amp;macOS开发者,就职于百度,爱好书法。开发5年有余,没有为往圣续绝学深感惭愧，今2017年开始写博客, 望诸位同仁多多指教.">

    <meta property="og:type" content="article">
    <meta property="og:title" content="AudioUnit | 東引甌越">
    <meta property="og:description" content="嗨，我是孙亚洲, 一个来自北国冰城的iOS&amp;macOS开发者,就职于百度,爱好书法。开发5年有余,没有为往圣续绝学深感惭愧，今2017年开始写博客, 望诸位同仁多多指教.">

    
    <meta name="author" content="sunyazhou">
    
    <link rel="stylesheet" href="/css/vno.css">
    <link rel="stylesheet" href="//apps.bdimg.com/libs/fontawesome/4.1.0/css/font-awesome.min.css">

    
    <link rel="icon" href="/images/favicon.ico">
    

    <meta name="generator" content="hexo"/>
    
    <link rel="alternate" type="application/rss+xml" title="東引甌越" href="/atom.xml">
    

    <link rel="canonical" href="https://www.sunyazhou.com/2018/05/07/20180507AudioUnit/"/>

    
    <link rel="author" href="https://plus.google.com/107423989995616646161"/>
    

    
<script type="text/javascript">
	var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?36adfbed8b30cd669f1457e388071878";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();

</script>

</head>

<body class="home-template no-js">

    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>

    
<header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/" title="前往 東引甌越 的主页"><img src="/images/logo2.jpg" width="80" alt="東引甌越 logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage for 東引甌越">東引甌越</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">不断学习, 与时俱进.</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">嗨,我是孙亚洲(@sunyazhou13),一名来自北国冰城的iOS开发者,也搞过一些mac.现居帝都北京.开发数年有余,没有为往圣续绝学深感惭愧,今2017年开始写博客.望诸位同仁多多指教.</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="访问博客" class="blog-button">文章</a></li>
            
              <li class="navigation__item"><a href="/archives">归档</a></li>
            
              <li class="navigation__item"><a href="/projects">作品</a></li>
            
              <li class="navigation__item"><a href="/aboutme">关于</a></li>
            
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  
  <li class="navigation__item">
    <a href="https://weibo.com/sunyazhou13" title="我的微博" target="_blank">
      <i class='social fa fa-weibo'></i>
      <span class="label">Weibo</span>
    </a>
  </li>


  <!-- Github -->
  
  <li class="navigation__item">
    <a href="https://github.com/sunyazhou13" title="查看我的GitHub主页" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>


<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  
  <li class="navigation__item">
    <a href="https://plus.google.com/107423989995616646161" title="Google+" target="_blank">
      <i class='social fa fa-google-plus-square'></i>
      <span class="label">Google+</span>
    </a>
  </li>


<!-- Facebook -->


<!-- Twitter -->

  <li class="navigation__item">
    <a href="https://twitter.com/sunyazhou" title="上Twitter找我" target="_blank">
      <i class='social fa fa-twitter'></i>
      <span class="label">Twitter</span>
    </a>
  </li>

<!-- instagram -->


  <li class="navigation__item">
    <a href="/atom.xml" title="RSS" target="_blank">
      <i class='social fa fa-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>


  <li class="navigation__item">
    <a href="mailto:sunyazhou13@163.com" title="邮件联系我" target="_blank">
      <i class='social fa fa-envelope'></i>
      <span class="label">Email</span>
    </a>
  </li>


  </ul>
</nav>

          </div>
        </div>

      </div>

    </div>

    <div class="panel-cover--overlay cover-disabled"></div>
  </div>
</header>


    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2018-05-07T06:59:41.000Z" class="post-list__meta--date date">2018-05-07</time>
 &#8226; <span class="post-meta__tags tags">分类&nbsp;
  <a class="tag-link" href="/tags/iOS开发/">iOS开发</a>, <a class="tag-link" href="/tags/macOS开发/">macOS开发</a>

</span>
    </div>
    <h1 class="post-title">AudioUnit</h1>
  </header>

  <section class="post">
    <p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/20180430AudioEffectImplement/au_host_app1.jpg" alt=""></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>声音的渲染在iOS平台上回直接使用<code>AudioUnit</code>的API来完成.用来实现一些类似<code>大叔</code>,<code>KTV</code>,<code>耳返等效果</code>….</p>
<p>今天带领大家深入了解和学习一下这些音效.</p>
<h2 id="实现iOS变声的背景"><a href="#实现iOS变声的背景" class="headerlink" title="实现iOS变声的背景"></a>实现iOS变声的背景</h2><p>声音变声一般都是发生在 一端采集录制另一端播放音频, 忽略中间的转码过程,在输入输出的中间过程中进行相应的音频参数就实现了变声. </p>
<p>下图是AVAudioSession的工作流<br><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/9818fa6853c32f92936661cfc06f25c87f07f64f/20180430AudioEffectImplement/ASPG_intro_2x.png" alt=""></p>
<p>大家常用的变声方案有很多:</p>
<ol>
<li>FFMpeg提供内部效果器 eg:EQ均衡器  </li>
<li>AVFoundation底层的<code>Audio Unit</code> eg: 混响reverb</li>
<li>SoundTouch</li>
<li>其它方案…</li>
</ol>
<p>这里我们选用iOS AVFoundation本身提供的音频处理单元<code>Audio Unit</code>. </p>
<p><code>Audio Unit</code>提供如下功能:</p>
<ul>
<li>低延迟的音频I/O eg:voip</li>
<li>多路声音的合成并回放 eg:游戏中的音乐合成器</li>
<li>Audio Unit 自身提供 eg：回声消除、Mix两轨音频、均衡器、压缩器、混响效果器等.</li>
<li>需要图状的结构来处理音频. eg: 有点类似PC时代的主播经常用的一种叫KX 驱动. </li>
</ul>
<p>下图是KX 驱动连线图 windows平台 </p>
<p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/ce762c6a5f6eb1d09da7bde9c7ec773c42f2d663/20180430AudioEffectImplement/kx.jpeg" alt=""></p>
<h2 id="AudioUnit介绍"><a href="#AudioUnit介绍" class="headerlink" title="AudioUnit介绍"></a>AudioUnit介绍</h2><h4 id="iOS层级架构图"><a href="#iOS层级架构图" class="headerlink" title="iOS层级架构图"></a>iOS层级架构图</h4><p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/20180430AudioEffectImplement/iphone_os_audio_architecture_2x.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/20180430AudioEffectImplement/AboutAudioUnitHosting_2x.png" alt=""></p>
<blockquote>
<p>声音的处理过程, 首先需要认识一下<code>AUGraph</code></p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/360b2677618e504462966e58d406d0a47a6e993d/20180430AudioEffectImplement/simple_au_chain_2x.png" alt=""></p>
<blockquote>
<p><strong>audio processing graph</strong>:  A representation of a signal chain comprising an interconnection of audio units. Also called an AUGraph or graph. Core Audio represents such an interconnected network as a software object of typeAUGraph. Audio processing graphs must end in an output unit. See also audio unit.<br>一种信号链的表示，包括音频单元的互连。也称为AUGraph或graph。Core Audio代表着这样一个相互连接的网络，它是一个<code>AUGraph</code>类型的对象。</p>
</blockquote>
<h4 id="audio-unit-结构图-工作流"><a href="#audio-unit-结构图-工作流" class="headerlink" title="audio unit 结构图(工作流)"></a>audio unit 结构图(工作流)</h4><p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/7e99645383e5db4837567bd9ec35fe78588439f6/20180430AudioEffectImplement/au_architecture.jpg" alt=""></p>
<h4 id="Audio-Unit-构成图"><a href="#Audio-Unit-构成图" class="headerlink" title="Audio Unit 构成图"></a>Audio Unit 构成图</h4><p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/0b99a7e821ed34b72dd684552394dda26c16cf2d/20180430AudioEffectImplement/audioUnitScopes_2x.png" alt=""></p>
<p>Unit 一般 分为 Element0 和  Element1</p>
<p>下面我们举Remote I/O Unit为例:  </p>
<p>RemoteIO 这个Unit是和硬件IO相关的Unit，它分为输入端和输出端, 输入端一般指麦克风,输出端一般指扬声器.</p>
<blockquote>
<p><code>Element0</code> 控制输出<br><code>Element1</code> 控制输入<br>图中Element 也叫 bus；<br>音频流从输入域（input scope）输入， 从输出域（output scope）输出<br>整个Render过程就是一次RenderCycle</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/20180430AudioEffectImplement/IO_unit_2x.png" alt=""></p>
<p><strong>同时每个Element分为Input Scope 和 Output Scope.如果我们想使用扬声器的声音播放功能,必须需将这个Unit的<code>Element0</code>的<code>OutputScope</code>和Speak进行连接. 如果想使用麦克风录音功能,那么必须将这个Unit的<code>Element1</code>的<code>InputScope</code>和麦克风进行连接.</strong></p>
<h3 id="构建Audio-Unit"><a href="#构建Audio-Unit" class="headerlink" title="构建Audio Unit"></a>构建Audio Unit</h3><p>首先需要启用音频会话 这些大家自己配置就好 了 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">//配置会话相关伪代码</div><div class="line">[[AVAudioSession sharedInstance].xxxxx xxxxx];</div></pre></td></tr></table></figure>
<p>如何用代码构建一个Audio Unit？ 这里我们以Remote I/O Unit 为例:</p>
<p>创建AudioUnit有两种方式</p>
<ol>
<li>直接使用AudioUnit裸创建 </li>
<li>使用AUGraph和AUNode来构建</li>
</ol>
<ul>
<li>第一种 裸创建</li>
</ul>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;AudioUnit/AudioUnit.h&gt;</span></span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line">&#123;</div><div class="line">    AudioUnit ioUnitInstance; <span class="comment">//声明一变量</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="comment">//首先构造出要用到创建Unit的结构体</span></div><div class="line">    AudioComponentDescription ioUnitDescription;</div><div class="line">    ioUnitDescription.componentType = kAudioUnitType_Output;</div><div class="line">    ioUnitDescription.componentSubType = kAudioUnitSubType_RemoteIO;</div><div class="line">    ioUnitDescription.componentManufacturer = kAudioUnitManufacturer_Apple;</div><div class="line">    ioUnitDescription.componentFlags = <span class="number">0</span>;</div><div class="line">    ioUnitDescription.componentFlagsMask = <span class="number">0</span>;</div><div class="line">    </div><div class="line">    AudioComponent ioUnitRef = AudioComponentFindNext(<span class="literal">NULL</span>, &amp;ioUnitDescription);</div><div class="line">    <span class="comment">//创建AudioUnit实例</span></div><div class="line">    AudioComponentInstanceNew(ioUnitRef, &amp;ioUnitInstance);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>第二种使用AUGraph和AUNode</li>
</ul>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;AudioUnit/AudioUnit.h&gt;</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;AudioToolbox/AudioToolbox.h&gt;</span></span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line">&#123;</div><div class="line">    AUGraph     processingGraph;</div><div class="line">    AUNode      ioNode;</div><div class="line">    AudioUnit   ioUnit;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="comment">//首先构造出要用到创建Unit的结构体</span></div><div class="line">    AudioComponentDescription ioUnitDescription;</div><div class="line">    ioUnitDescription.componentType = kAudioUnitType_Output;</div><div class="line">    ioUnitDescription.componentSubType = kAudioUnitSubType_RemoteIO;</div><div class="line">    ioUnitDescription.componentManufacturer = kAudioUnitManufacturer_Apple;</div><div class="line">    ioUnitDescription.componentFlags = <span class="number">0</span>;</div><div class="line">    ioUnitDescription.componentFlagsMask = <span class="number">0</span>;</div><div class="line">    </div><div class="line">    <span class="comment">//1 new</span></div><div class="line">    NewAUGraph(&amp;processingGraph);</div><div class="line">    AUGraphAddNode(processingGraph, &amp;ioUnitDescription, &amp;ioNode);</div><div class="line">    </div><div class="line">    <span class="comment">//2 open</span></div><div class="line">    AUGraphOpen(processingGraph);</div><div class="line">    </div><div class="line">    <span class="comment">//3 从相应的Node中获得AudioUnit</span></div><div class="line">    AUGraphNodeInfo(processingGraph, ioNode, <span class="literal">NULL</span>, &amp;ioUnit);</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>推荐使用第二种因为这种创建扩展性更高一些<br>注意:<strong><em>AUNode必须和AudioUnit成对出现</em></strong></p>
</blockquote>
<p>如下图 ：Remote I/O Unit </p>
<p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/0b99a7e821ed34b72dd684552394dda26c16cf2d/20180430AudioEffectImplement/IO_unit_2x.png" alt=""></p>
<blockquote>
<p>麦克风或者扬声器在Audio Unit中有相应的枚举.<br>直播中的<code>耳返</code>就是用的这个把麦克风采集的数据直接扔给扬声器 这样就能做到 低延迟的实时听到麦克风的声音.<br>直播中一般使用<code>Remote I/O</code> unit来进行采集工作</p>
</blockquote>
<p>使用AudioUnit连接扬声器</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">OSStatus status = noErr;</div><div class="line"><span class="built_in">UInt32</span> onFlag = <span class="number">1</span>;</div><div class="line"><span class="built_in">UInt32</span> busZero = <span class="number">0</span>; <span class="comment">//Element0  就是bus0</span></div><div class="line">status = AudioUnitSetProperty(remoteIOUnit, kAudioOutputUnitProperty_EnableIO, kAudioUnitScope_Output, busZero, &amp;onFlag, <span class="keyword">sizeof</span>(onFlag));</div><div class="line">CheckStatus(status, <span class="string">@"不能连接扬声器"</span>, <span class="literal">YES</span>);</div></pre></td></tr></table></figure>
<blockquote>
<p>注意: kAudioUnitScope_Output 就是连接扬声器的key</p>
</blockquote>
<p>连接麦克风</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">OSStatus status = noErr;</div><div class="line"><span class="built_in">UInt32</span> busOne = <span class="number">1</span>; <span class="comment">//Element1 就是bus1 接麦克风输入</span></div><div class="line"><span class="built_in">UInt32</span> oneFlag = <span class="number">1</span>;</div><div class="line">status =  AudioUnitSetProperty(remoteIOUnit, kAudioOutputUnitProperty_EnableIO, kAudioUnitScope_Input, busOne, &amp;oneFlag, <span class="keyword">sizeof</span>(oneFlag));</div><div class="line">CheckStatus(status, <span class="string">@"不能连接麦克风"</span>, <span class="literal">YES</span>);</div></pre></td></tr></table></figure>
<p>可以使用如下代码检查每一步执行出错debug  </p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> CheckStatus(OSStatus status, <span class="built_in">NSString</span> *message, <span class="built_in">BOOL</span> fatal) &#123;</div><div class="line">    <span class="keyword">if</span> (status != noErr) &#123;</div><div class="line">        <span class="keyword">char</span> fourCC[<span class="number">16</span>];</div><div class="line">        *(<span class="built_in">UInt32</span> *)fourCC = <span class="built_in">CFSwapInt32HostToBig</span>(status);</div><div class="line">        fourCC[<span class="number">4</span>] = <span class="string">'\0'</span>;</div><div class="line">        <span class="keyword">if</span> (isprint(fourCC[<span class="number">0</span>]) &amp;&amp; isprint(fourCC[<span class="number">1</span>]) &amp;&amp;</div><div class="line">            isprint(fourCC[<span class="number">2</span>]) &amp;&amp; isprint(fourCC[<span class="number">4</span>])) &#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@:%s"</span>,message, fourCC);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@:%d"</span>,message, (<span class="keyword">int</span>)status);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (fatal) &#123;</div><div class="line">            exit(<span class="number">-1</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>由于status每次报错都打印 相关数字大家可能不理解可以点击<a href="https://www.osstatus.com/" target="_blank" rel="external">OSStatus</a> 查询相关错误码</p>
</blockquote>
<h4 id="AVAudioMix"><a href="#AVAudioMix" class="headerlink" title="AVAudioMix"></a>AVAudioMix</h4><p>我们一般都在采集、录制或编辑音视频相应的类中使用AVAudioMixer.</p>
<p>举个例子:我们变声实现的流程大概是这个样子 <strong>AVAudioPlayer -&gt; AVPlayerItem -&gt; AVAudioMixer-&gt; AUGraph -&gt; AUNode + AudioUnit</strong></p>
<p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/903e2fa4eb2daafcc3b187854edc69d1bad8b382/20180430AudioEffectImplement/AVAudioMix-class.001.png" alt=""></p>
<h4 id="AudioStreamBasicDescription-配置麦克风输入的参数"><a href="#AudioStreamBasicDescription-配置麦克风输入的参数" class="headerlink" title="AudioStreamBasicDescription 配置麦克风输入的参数"></a>AudioStreamBasicDescription 配置麦克风输入的参数</h4><p>当我们控制Remote IO Unit的时候想告诉麦克风 各种input的参数 可以通过 一个叫ASBD 格式的结构体数据描述来设置给相应的Unit</p>
<h5 id="Audio-Stream-Format-描述ASBD"><a href="#Audio-Stream-Format-描述ASBD" class="headerlink" title="Audio Stream Format 描述ASBD"></a>Audio Stream Format 描述ASBD</h5><figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="built_in">UInt32</span> bytePerSample = <span class="keyword">sizeof</span>(Float32);</div><div class="line">AudioStreamBasicDescription asbd;</div><div class="line">bzero(&amp;asbd, <span class="keyword">sizeof</span>(asbd));</div><div class="line">asbd.mFormatID = kAudioFormatLinearPCM;</div><div class="line">asbd.mSampleRate = <span class="number">44100</span>;</div><div class="line">asbd.mChannelsPerFrame = channels;</div><div class="line">asbd.mFramesPerPacket = <span class="number">1</span>;</div><div class="line">asbd.mFormatFlags = kAudioFormatFlagsNativeFloatPacked | kAudioFormatFlagIsNonInterleaved;</div><div class="line">asbd.mBitsPerChannel = <span class="number">8</span> * bytePerSample;</div><div class="line">asbd.mBytesPerFrame = bytePerSample;</div><div class="line">asbd.mBytesPerPacket = bytePerSample;</div></pre></td></tr></table></figure>
<blockquote>
<p>上边代码展示了如何填充ASBD结构体,这个描述音视频的具体格式.</p>
</blockquote>
<p>下面具体介绍一下各个参数的意思</p>
<ul>
<li>mFormatID 可用来指定编码格式 eg:PCM</li>
<li>mSampleRate 采样率</li>
<li>mChannelsPerFrame 每个Frame有几个channel</li>
<li>mFramesPerPacket 每个Packet有几Frame</li>
<li>mFormatFlags 这个是用来描述声音格式表示格式的参数,上面代码我们指定的是每个sample的表示格式为Float格式,有点类似SInt16,如果后边是NonInterleaved代表非交错的,对于这个音频来讲就是左右声道的是非交错存放的,实际的音频数据会存储在一个AudioBufferList结构中的变量mBuffers中,如果mFormatFlags指定的是NonInterleaved,那么左声道就在会在mBuffers[0]里面,右声道就在mBuffers[1]里面.</li>
<li>mBitsPerChannel 表示一个声道的音频数据用多少位来表示,上面我们用的是Float来表示, 所以这里使用的是 8 乘以 每个采样的字节数来赋值.</li>
<li>mBytesPerFrame 和 mBytesPerPacket 这两个的赋值需要根据mFormatFlags 的值来进行分配,如果是NonInterleaved非交错的情况下, 就赋值bytePerSample(因为左右声道是分开的).但如果是Interleaved的话,那就应该是 bytePerSample * channels (因为左右声道是交错存放),这样才能表示一个Frame里面到底有多少byte.</li>
</ul>
<p>讲了这么多 那我们怎么把这个ASDB给 Unit?</p>
<p>如下代码 设置ASBD给相应的Audio Unit</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">AudioUnitSetProperty(remoteIOUnit, kAudioUnitProperty_StreamFormat, kAudioUnitScope_Output, <span class="number">1</span>, &amp;asbd, <span class="keyword">sizeof</span>(asbd));</div></pre></td></tr></table></figure>
<p>完整的代码如下</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="comment">//设置ASBD</span></div><div class="line">AudioStreamBasicDescription inputFormat;</div><div class="line">inputFormat.mSampleRate = <span class="number">44100</span>;</div><div class="line">inputFormat.mFormatID = kAudioFormatLinearPCM;</div><div class="line">inputFormat.mFormatFlags = kAudioFormatFlagIsSignedInteger | kAudioFormatFlagIsNonInterleaved;</div><div class="line">inputFormat.mFramesPerPacket = <span class="number">1</span>;</div><div class="line">inputFormat.mChannelsPerFrame = <span class="number">1</span>;</div><div class="line">inputFormat.mBytesPerPacket = <span class="number">2</span>;</div><div class="line">inputFormat.mBytesPerFrame = <span class="number">2</span>;</div><div class="line">inputFormat.mBitsPerChannel = <span class="number">16</span>;</div><div class="line"><span class="comment">//设置给输入端 配置麦克风输出的数据是什么格式</span></div><div class="line">OSStatus status = noErr;</div><div class="line">status = AudioUnitSetProperty(audioUnit,</div><div class="line">                              kAudioUnitProperty_StreamFormat,</div><div class="line">                              kAudioUnitScope_Output,</div><div class="line">                              InputBus,</div><div class="line">                              &amp;inputFormat,</div><div class="line">                              <span class="keyword">sizeof</span>(inputFormat));</div><div class="line">CheckStatus(status, <span class="string">@"AudioUnitGetProperty bus1 output ASBD error"</span>, <span class="literal">YES</span>);</div></pre></td></tr></table></figure>
<h3 id="Audio-Unit-分类"><a href="#Audio-Unit-分类" class="headerlink" title="Audio Unit 分类"></a>Audio Unit 分类</h3><figure class="highlight"><table><tr><td class="code"><pre><div class="line">CF_ENUM(UInt32) &#123;</div><div class="line">	kAudioUnitType_Output					= 'auou',</div><div class="line">	kAudioUnitType_MusicDevice				= 'aumu',</div><div class="line">	kAudioUnitType_MusicEffect				= 'aumf',</div><div class="line">	kAudioUnitType_FormatConverter			= 'aufc',</div><div class="line">	kAudioUnitType_Effect					= 'aufx',</div><div class="line">	kAudioUnitType_Mixer					= 'aumx',</div><div class="line">	kAudioUnitType_Panner					= 'aupn',</div><div class="line">	kAudioUnitType_Generator				= 'augn',</div><div class="line">	kAudioUnitType_OfflineEffect			= 'auol',</div><div class="line">	kAudioUnitType_MIDIProcessor			= 'aumi'</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left">分类</th>
<th style="text-align:left">功能/作用</th>
<th style="text-align:left">类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Effect Unit</td>
<td style="text-align:left">提供声音特效处理</td>
<td style="text-align:left">kAudioUnitType_Effect</td>
</tr>
<tr>
<td style="text-align:left">Mixer Units</td>
<td style="text-align:left">提供Mix多路声音的功能</td>
<td style="text-align:left">kAudioUnitType_Mixer</td>
</tr>
<tr>
<td style="text-align:left">I/O Units</td>
<td style="text-align:left">I/O 采集音频与播放音频功能</td>
<td style="text-align:left">kAudioUnitType_Output</td>
</tr>
<tr>
<td style="text-align:left">AUConverter Units</td>
<td style="text-align:left">格式转换 eg:采样格式Float转SInt16、交错或平铺、单双声道的转换</td>
<td style="text-align:left">kAudioUnitType_FormatConverter</td>
</tr>
<tr>
<td style="text-align:left">Generator Units</td>
<td style="text-align:left">提供播放器功能</td>
<td style="text-align:left">kAudioUnitType_Generator</td>
</tr>
</tbody>
</table>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">CF_ENUM(UInt32) &#123;</div><div class="line">	kAudioUnitSubType_PeakLimiter			= 'lmtr',</div><div class="line">	kAudioUnitSubType_DynamicsProcessor		= 'dcmp',</div><div class="line">	kAudioUnitSubType_LowPassFilter			= 'lpas',</div><div class="line">	kAudioUnitSubType_HighPassFilter		= 'hpas',</div><div class="line">	kAudioUnitSubType_BandPassFilter		= 'bpas',</div><div class="line">	kAudioUnitSubType_HighShelfFilter		= 'hshf',</div><div class="line">	kAudioUnitSubType_LowShelfFilter		= 'lshf',</div><div class="line">	kAudioUnitSubType_ParametricEQ			= 'pmeq',</div><div class="line">	kAudioUnitSubType_Distortion			= 'dist',</div><div class="line">	kAudioUnitSubType_Delay					= 'dely',</div><div class="line">	kAudioUnitSubType_SampleDelay			= 'sdly',</div><div class="line">	kAudioUnitSubType_NBandEQ				= 'nbeq'</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line">CF_ENUM(UInt32) &#123;</div><div class="line">	kAudioUnitSubType_Reverb2				= 'rvb2',</div><div class="line">	kAudioUnitSubType_AUiPodEQ				= 'ipeq'</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="Effect-Unit-子类型及用途说明"><a href="#Effect-Unit-子类型及用途说明" class="headerlink" title="Effect Unit 子类型及用途说明"></a>Effect Unit 子类型及用途说明</h4><table>
<thead>
<tr>
<th style="text-align:left">子类型</th>
<th style="text-align:left">用途说明</th>
<th style="text-align:left">子枚举类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">均衡效果器</td>
<td style="text-align:left">为声音的某些<a href="https://baike.baidu.com/item/%E9%A2%91%E5%B8%A6" target="_blank" rel="external">频带</a>增强或衰减能量，效果器需要指定多个频带,然后为各频带设置增益最终改变声音在音域上的能量分布</td>
<td style="text-align:left">kAudioUnitSubType_NBandEQ</td>
</tr>
<tr>
<td style="text-align:left">压缩效果器</td>
<td style="text-align:left">当声音较小或较大通过设置阀值来提高或降低声音能量 eg:作用时间、释放时间、以及触发值从而最终控制声音在时域上的能量范围</td>
<td style="text-align:left">kAudioUnitSubType_DynamicsProcessor</td>
</tr>
<tr>
<td style="text-align:left">混响效果器</td>
<td style="text-align:left">通过声音反射的延迟控制声音效果</td>
<td style="text-align:left">kAudioUnitSubType_Reverb2</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Effect Unit 下最常用的效果器就上边这三种, 像高通(High Pass)、低通(Low Pass)、带通(Band Pass)、延迟(Delay)、压限(Limiter) 等这些不是很常用,如果大家对这个很熟悉可以试试使用一下.</p>
</blockquote>
<h4 id="Mixer-Units-子类型及用途说明"><a href="#Mixer-Units-子类型及用途说明" class="headerlink" title="Mixer Units 子类型及用途说明"></a>Mixer Units 子类型及用途说明</h4><table>
<thead>
<tr>
<th style="text-align:left">子类型</th>
<th style="text-align:left">用途说明</th>
<th style="text-align:left">子枚举类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">3D Mixer</td>
<td style="text-align:left">仅支持 macOS</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">MultiChannelMixer</td>
<td style="text-align:left">多路声音混音效果器,可以接受多路音频输入,还可以分别调整每一路的音频增益和开关,并将多路音频合成一路</td>
<td style="text-align:left">kAudioUnitSubType_MultiChannelMixer</td>
</tr>
</tbody>
</table>
<h4 id="I-O-Units-子类型及用途说明"><a href="#I-O-Units-子类型及用途说明" class="headerlink" title="I/O Units 子类型及用途说明"></a>I/O Units 子类型及用途说明</h4><table>
<thead>
<tr>
<th style="text-align:left">子类型</th>
<th style="text-align:left">用途说明</th>
<th style="text-align:left">子枚举类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Remote I/O</td>
<td style="text-align:left">采集音频与播放音频,在Audio Unit中使用麦克风和扬声器的时候会用到这个Unit</td>
<td style="text-align:left">kAudioUnitType_Output</td>
</tr>
<tr>
<td style="text-align:left">Generic Output</td>
<td style="text-align:left">进行离线处理,或者说AUGraph中不使用扬声器来驱动整个数据流,而希望使用一个输出(可以放入内存队列或者磁盘I/O操作)来驱动数据流时</td>
<td style="text-align:left">kAudioUnitSubType_GenericOutput</td>
</tr>
</tbody>
</table>
<h4 id="AUConverter-Units-子类型及用途说明"><a href="#AUConverter-Units-子类型及用途说明" class="headerlink" title="AUConverter Units 子类型及用途说明"></a>AUConverter Units 子类型及用途说明</h4><table>
<thead>
<tr>
<th style="text-align:left">子类型</th>
<th style="text-align:left">用途说明</th>
<th style="text-align:left">子枚举类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">AUConverter</td>
<td style="text-align:left">格式转换,当某些效果器对输入的音频格式有明确要求时,或者我们将音频数据输入给一些其它的编码器进行编码。。。</td>
<td style="text-align:left">kAudioUnitSubType_AUConverter</td>
</tr>
<tr>
<td style="text-align:left">Time Pitch</td>
<td style="text-align:left">变速变调效果器,调整声音音高. eg:会说话的Tom猫</td>
<td style="text-align:left">kAudioUnitSubType_NewTimePitch</td>
</tr>
</tbody>
</table>
<blockquote>
<p>注意: AUConverter  如果由FFMpeg解码出来的PCM 是SInt16格式 如果要用格式转换效果器unit必须转成Float32格式表示的数据.</p>
</blockquote>
<h4 id="Generator-Units-子类型及用途说明"><a href="#Generator-Units-子类型及用途说明" class="headerlink" title="Generator Units 子类型及用途说明"></a>Generator Units 子类型及用途说明</h4><table>
<thead>
<tr>
<th style="text-align:left">子类型</th>
<th style="text-align:left">用途说明</th>
<th style="text-align:left">子枚举类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">AudioFilePlayer</td>
<td style="text-align:left">接收裸PCM 播放 一般大家可以用这个配合Remote I/O 做播放器</td>
<td style="text-align:left">kAudioUnitSubType_AudioFilePlayer</td>
</tr>
</tbody>
</table>
<p>相关shell命令 <strong>将音频文件转成pcm</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">ffmpeg -i test.mp3 -acodec pcm_s16le -f s16le output.pcm</div></pre></td></tr></table></figure>
<blockquote>
<p>brew install ffmpeg</p>
</blockquote>
<p><a href="https://github.com/sunyazhou13/AduioUnitDemo" target="_blank" rel="external">Demo实现耳返功能</a><br><a href="https://github.com/sunyazhou13/AudioUnitDemo2" target="_blank" rel="external">Demo2实现耳返+伴奏播放</a></p>
<h4 id="下面我分享一个变声中混响效果代码"><a href="#下面我分享一个变声中混响效果代码" class="headerlink" title="下面我分享一个变声中混响效果代码"></a>下面我分享一个变声中混响效果代码</h4><figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//声明部分  .h</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">KSYAudioReverbFilter</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"></div><div class="line">-(<span class="keyword">instancetype</span>)init;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setupWithAUGraph:(AUGraph)auGraph asbd:(<span class="keyword">const</span> AudioStreamBasicDescription *)asbd maxFrame:(<span class="built_in">CMItemCount</span>)max;</div><div class="line"></div><div class="line"><span class="comment">// Global, CrossFade, 0-&gt;100, 100</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="keyword">double</span> dryWetMix;</div><div class="line"><span class="comment">// Global, Decibels, -20-&gt;20, 0dB.</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="keyword">double</span> gain;</div><div class="line"><span class="comment">// Global, Secs, 0.0001-&gt;1.0, 0.008</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="keyword">double</span> minDelayTime;</div><div class="line"><span class="comment">// Global, Secs, 0.0001-&gt;1.0, 0.050</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="keyword">double</span> maxDelayTime;</div><div class="line"><span class="comment">// Global, Secs, 0.001-&gt;20.0, 1.0</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="keyword">double</span> decayTimeAt0Hz;</div><div class="line"><span class="comment">// Global, Secs, 0.001-&gt;20.0, 0.5</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="keyword">double</span> decayTimeAtNyquist;</div><div class="line"><span class="comment">// Global, Integer, 1-&gt;1000, 1</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="keyword">double</span> randomizeReflections;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//实现部分</span></div><div class="line"></div><div class="line"><span class="comment">//通用的宏</span></div><div class="line"><span class="meta">#define RC_CHECK(rc, str) if (rc != noErr) \</span></div><div class="line">&#123; \</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"Err :%@ %@ %@"</span>, @(rc), str, @(__func__)); \</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">KSYAudioReverbFilter</span></span></div><div class="line"></div><div class="line">-(<span class="keyword">instancetype</span>)init&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>)&#123;</div><div class="line">        <span class="keyword">self</span>.acDes = (AudioComponentDescription)&#123;kAudioUnitType_Effect, kAudioUnitSubType_Reverb2, kAudioUnitManufacturer_Apple, <span class="number">0</span>, <span class="number">0</span>&#125;;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setupWithAUGraph:(AUGraph)auGraph asbd:(<span class="keyword">const</span> AudioStreamBasicDescription *)asbd maxFrame:(<span class="built_in">CMItemCount</span>)maxFrame</div><div class="line">&#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">    OSStatus status = noErr;</div><div class="line">    <span class="built_in">NSAssert</span>(auGraph != <span class="literal">nil</span>, <span class="string">@"auGraph is null"</span>);</div><div class="line">    audioGraph = auGraph;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"setup :%@"</span>, <span class="built_in">NSStringFromCode</span>(_acDes.componentSubType));</div><div class="line">    status = AUGraphAddNode(auGraph, &amp;_acDes, &amp;_node);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (noErr != status)&#123;</div><div class="line">        </div><div class="line">        <span class="built_in">NSString</span> *error = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"add node with type %u failed"</span>, _acDes.componentType];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, error);</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    status = AUGraphNodeInfo(auGraph, _node, <span class="literal">NULL</span>, &amp;_audioUnit);</div><div class="line">    <span class="keyword">if</span> (noErr != status)&#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"create audiouinit failed err:%@"</span>, @(status));</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    RC_CHECK(AudioUnitSetProperty(_audioUnit,</div><div class="line">                                  kAudioUnitProperty_StreamFormat,</div><div class="line">                                  kAudioUnitScope_Input, <span class="number">0</span>, asbd, <span class="keyword">sizeof</span>(AudioStreamBasicDescription)),</div><div class="line">             <span class="string">@"kAudioUnitProperty_StreamFormat kAudioUnitScope_Input err"</span>);</div><div class="line">    </div><div class="line">    RC_CHECK(AudioUnitSetProperty(_audioUnit,</div><div class="line">                                  kAudioUnitProperty_StreamFormat,</div><div class="line">                                  kAudioUnitScope_Output, <span class="number">0</span>, asbd, <span class="keyword">sizeof</span>(AudioStreamBasicDescription)),</div><div class="line">             <span class="string">@"kAudioUnitProperty_StreamFormat kAudioUnitScope_Output err"</span>);</div><div class="line">    </div><div class="line">    <span class="comment">// Set audio unit maximum frames per slice to max frames.</span></div><div class="line">    RC_CHECK(AudioUnitSetProperty(_audioUnit,</div><div class="line">                                  kAudioUnitProperty_MaximumFramesPerSlice,</div><div class="line">                                  kAudioUnitScope_Global, <span class="number">0</span>, &amp;maxFrame, (<span class="built_in">UInt32</span>)<span class="keyword">sizeof</span>(<span class="built_in">UInt32</span>)),</div><div class="line">             <span class="string">@"set kAudioUnitProperty_MaximumFramesPerSlice err"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#pragma mark - Setters</span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setDryWetMix:(<span class="keyword">double</span>)dryWetMix</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">self</span> setGlobalParam:kReverb2Param_DryWetMix value:dryWetMix];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setGain:(<span class="keyword">double</span>)gain</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">self</span> setGlobalParam:kReverb2Param_Gain value:gain];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setMinDelayTime:(<span class="keyword">double</span>)minDelayTime</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">self</span> setGlobalParam:kReverb2Param_MinDelayTime value:minDelayTime];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setMaxDelayTime:(<span class="keyword">double</span>)maxDelayTime</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">self</span> setGlobalParam:kReverb2Param_MaxDelayTime value:maxDelayTime];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setDecayTimeAt0Hz:(<span class="keyword">double</span>)decayTimeAt0Hz</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">self</span> setGlobalParam:kReverb2Param_DecayTimeAt0Hz value:decayTimeAt0Hz];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setDecayTimeAtNyquist:(<span class="keyword">double</span>)decayTimeAtNyquist</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">self</span> setGlobalParam:kReverb2Param_DecayTimeAtNyquist value:decayTimeAtNyquist];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setRandomizeReflections:(<span class="keyword">double</span>)randomizeReflections</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">self</span> setGlobalParam:kReverb2Param_RandomizeReflections value:randomizeReflections];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//通用方法</span></div><div class="line">- (<span class="keyword">void</span>)setGlobalParam:(AudioUnitParameterID)paramId value:(AudioUnitParameterValue)value</div><div class="line">&#123;</div><div class="line"></div><div class="line">    RC_CHECK(AudioUnitSetParameter(_audioUnit,</div><div class="line">                                   paramId,</div><div class="line">                                   kAudioUnitScope_Global, <span class="number">0</span>, value, <span class="number">0</span>),</div><div class="line">             ([<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"set %u value %f err"</span>, paramId, value]));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>外部调用的话就是这样的</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">AURenderCallbackStruct renderCallbackStruct;</div><div class="line">renderCallbackStruct.inputProc = ksyme_RenderCallback;</div><div class="line">renderCallbackStruct.inputProcRefCon = (<span class="keyword">void</span> *)<span class="keyword">self</span>.apt;</div><div class="line">    </div><div class="line"><span class="keyword">if</span> (!_reverbFilter)&#123;</div><div class="line">    _reverbFilter = [[KSYAudioReverbFilter alloc] init];</div><div class="line">    [_reverbFilter setupWithAUGraph:auGraph asbd:format maxFrame:max];</div><div class="line">    _reverbFilter.renderCallBack = renderCallbackStruct;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="连接node"><a href="#连接node" class="headerlink" title="连接node"></a>连接node</h3><figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">AUGraphClearConnections(auGraph);</div><div class="line"><span class="built_in">NSMutableArray</span> *array = [[<span class="built_in">NSMutableArray</span> alloc] init];</div><div class="line">[array addObject:@(_mixFilter.node)];</div><div class="line"></div><div class="line">[array addObjectsFromArray:@[@(_reverbFilter.node),@(_delayFilter.node),@(_pitchFilter.node)]];</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; array.count <span class="number">-1</span>; i++) &#123;</div><div class="line">    AUGraphConnectNodeInput(auGraph,[array[i] intValue], <span class="number">0</span>,[array[i+<span class="number">1</span>] intValue], <span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>核心代码就是如何连接Node</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">AUGraphConnectNodeInput(auGraph,reverbNode, <span class="number">0</span>, remoteIONode, <span class="number">0</span>)</div></pre></td></tr></table></figure>
<blockquote>
<p>0代表 bus0</p>
</blockquote>
<p>系统定义的API是这样的</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="keyword">extern</span> OSStatus</div><div class="line">AUGraphConnectNodeInput(	AUGraph			inGraph,</div><div class="line">						AUNode			inSourceNode,</div><div class="line">						<span class="built_in">UInt32</span>			inSourceOutputNumber,</div><div class="line">						AUNode			inDestNode,</div><div class="line">						<span class="built_in">UInt32</span>			inDestInputNumber)		__OSX_AVAILABLE_STARTING(__MAC_10_0,__IPHONE_2_0);</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Audio Unit的相关技术学习点比较多大家灵活掌握运用,不懂没关系从简单的Unit开始学起.</p>
<p>全文完</p>
<p>参考列表:<br><a href="https://developer.apple.com/library/content/documentation/MusicAudio/Reference/CoreAudioGlossary/Glossary/core_audio_glossary.html#//apple_ref/doc/uid/TP40004453-CH210-SW1" target="_blank" rel="external">iOS Audio相关术语(Glossary)</a><br><a href="https://developer.apple.com/library/content/documentation/MusicAudio/Conceptual/AudioUnitHostingGuide_iOS/Introduction/Introduction.html" target="_blank" rel="external">参考</a><br><a href="https://developer.apple.com/library/content/documentation/MusicAudio/Conceptual/AudioUnitProgrammingGuide/Tutorial-BuildingASimpleEffectUnitWithAGenericView/Tutorial-BuildingASimpleEffectUnitWithAGenericView.html#//apple_ref/doc/uid/TP40003278-CH5-SW4" target="_blank" rel="external">如何自己制作一个Audio Unit</a><br><a href="https://www.jianshu.com/p/05cae433faea" target="_blank" rel="external">金山云直播音效实现</a><br><a href="https://developer.apple.com/library/content/documentation/MusicAudio/Conceptual/AudioUnitHostingGuide_iOS/AudioUnitHostingFundamentals/AudioUnitHostingFundamentals.html#//apple_ref/doc/uid/TP40009492-CH3-SW12" target="_blank" rel="external">Audio Unit官方文档</a></p>

  </section>

</article>


    <! -- 添加捐赠图标 -->
<div class ="post-donate">
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           ↑<br>
           欣赏此文？求鼓励，求支持！
        </span>
        <br>
    </div>  
    <div id="donate_guide" class="donate_bar center hidden" >
        <!-- 方式一： 
            ![](/img/Alipay.jpg)
            ![](/img/WeChatpay.jpg)
        -->
        <!-- 方式二；
            step1：在_config.yml中添加配置
                Alipay: /img/Alipay.jpg
                WeChatpay: /img/WeChatpay.jpg
            step2：此处两张图片的路径分别设置为如下
                <img src="undefined"
                <img src="undefined"
        -->
        <!-- 支付宝打赏图案 -->
        <img src="/images/Alipay.jpg" alt="支付宝打赏">
        <!-- 微信打赏图案 -->
        <img src="/images/WeChatpay.jpg" alt="微信打赏">
    </div>
    <script type="text/javascript">
        document.getElementById('btn_donate').onclick = function(){
            $('#donate_board').addClass('hidden');
            $('#donate_guide').removeClass('hidden');
        }
    </script>
</div>

<! -- 添加捐赠图标 -->



<section class="read-more">
     
        
            <div class="read-more-item">
                <span class="read-more-item-dim">最近的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2018/05/08/20180508ManualControlUIViewControllerLifeCycle/" title="手动管理UIViewController的生命周期">手动管理UIViewController的生命周期</a></h2>
                <p class="excerpt">
                
                前言话说很久不用UIViewController的不常用 的API渐渐的都没有了印象,在 iOS 客户端中，多个 childViewController 的页面是个很常见的交互设计,最早的网易新闻,今日头条等.这篇文章回味一下古老的手动控制视图控制器的生命周期的API.
UIViewControll
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2018-05-08T04:01:27.000Z" class="post-list__meta--date date">2018-05-08</time>
 &#8226; <span class="post-list__meta--tags tags">于&nbsp;
  <a class="tag-link" href="/tags/iOS开发/">iOS开发</a>, <a class="tag-link" href="/tags/macOS开发/">macOS开发</a>

</span><a class="btn-border-small" href="/2018/05/08/20180508ManualControlUIViewControllerLifeCycle/">继续阅读</a></div>

            </div>
        

        
            <div class="read-more-item">
                <span class="read-more-item-dim">更早的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2018/04/02/20180402RunLoop/" title="深入理解RunLoop">深入理解RunLoop</a></h2>
                <p class="excerpt">
                
                
前言RunLoop 是 iOS 和 OSX 开发中非常基础的一个概念，这篇文章将从CFRunLoop的源码入手，介绍 RunLoop 的概念以及底层实现原理。之后会介绍一下在 iOS 中，苹果是如何利用RunLoop实现自动释放池、延迟回调、触摸事件、屏幕刷新等功能的。
本文内容
RunLoop 
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2018-04-02T06:16:34.000Z" class="post-list__meta--date date">2018-04-02</time>
 &#8226; <span class="post-list__meta--tags tags">于&nbsp;
  <a class="tag-link" href="/tags/iOS开发/">iOS开发</a>, <a class="tag-link" href="/tags/macOS开发/">macOS开发</a>

</span><a class="btn-border-small" href="/2018/04/02/20180402RunLoop/">继续阅读</a></div>

            </div>
        
   
</section>



<section class="post-comments">
       <!-- 来必力City版安装代码 -->
    <div id="lv-container" data-id="city" data-uid="MTAyMC8yOTU0NS82MTEz">
      <script type="text/javascript">
       (function(d, s) {
           var j, e = d.getElementsByTagName(s)[0];

           if (typeof LivereTower === 'function') { return; }

           j = d.createElement(s);
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;

           e.parentNode.insertBefore(j, e);
       })(document, 'script');
      </script>
    <noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
    </div>
    <!-- City版安装代码已完成 -->
</section>




            <footer class="footer">
    <span class="footer__copyright">
        本站点采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>
    </span>
    <span class="footer__copyright">
        基于 <a href="http://hexo.io">Hexo</a> 搭建，感谢 <a href="https://pages.github.com/">GitHub Pages</a> 和 Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a> 提供免费的托管服务
    </span>
    <span class="footer__copyright">
        &copy; 2018 - 本站由 <a href="/">@sunyazhou13</a> 创建,
        使用<a href="https://github.com/lenbo-ma/hexo-theme-vno">hexo-theme-vno</a>主题,
        修改自<a href="https://github.com/onevcat/vno" target="_blank">喵神的vno</a>
    </span>
</footer>

        </div>
    </div>

    <script src="https://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="/js/main.js"></script>

     


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4f7dcd94f5b16e7d7771d638fad2b14e";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




    
</body>
</html>
