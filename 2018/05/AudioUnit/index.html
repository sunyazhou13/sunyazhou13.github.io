<!DOCTYPE html><html lang="zh-Hans" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.5.1"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="AudioUnit" /><meta name="author" content="孙亚洲" /><meta property="og:locale" content="zh_Hans" /><meta name="description" content="嗨,我是孙亚洲(@sunyazhou13),一名来自祖国北国冰城的iOS开发者." /><meta property="og:description" content="嗨,我是孙亚洲(@sunyazhou13),一名来自祖国北国冰城的iOS开发者." /><link rel="canonical" href="https://www.sunyazhou.com/2018/05/AudioUnit/" /><meta property="og:url" content="https://www.sunyazhou.com/2018/05/AudioUnit/" /><meta property="og:site_name" content="迈腾大队长" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-05-07T22:59:41+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="AudioUnit" /><meta name="twitter:site" content="@sunyazhou" /><meta name="twitter:creator" content="@孙亚洲" /><meta name="google-site-verification" content="Xo29j227HYVdC-vDA_-qJwvDP3PIo-lC78CFeBvhrDA" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"https://www.sunyazhou.com/2018/05/AudioUnit/","headline":"AudioUnit","dateModified":"2018-05-07T22:59:41+08:00","datePublished":"2018-05-07T22:59:41+08:00","author":{"@type":"Person","name":"孙亚洲"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.sunyazhou.com/2018/05/AudioUnit/"},"description":"嗨,我是孙亚洲(@sunyazhou13),一名来自祖国北国冰城的iOS开发者.","@context":"https://schema.org"}</script><title>AudioUnit | 迈腾大队长</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/images/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">迈腾大队长</a></div><div class="site-subtitle font-italic">不斷學習,與時俱進.求真務實,實事求是.</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>主页</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/projects/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-paint-brush ml-xl-3 mr-xl-3 unloaded"></i> <span>作品</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } get isResolvedDarkMode() { if (this.isLightMode) { return false; } return this.isSysDarkPrefer; } updateCommentStyle() { var theme = "github-light"; if (this.isResolvedDarkMode) { theme = "photon-dark"; } let comment = document.querySelector("iframe.utterances-frame"); if (comment == null) { return; } comment.contentWindow.postMessage( { type: "set-theme", theme: theme }, "https://utteranc.es/" ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateCommentStyle(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/sunyazhou13" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/sunyazhou" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.weibo.com/sunyazhou13" aria-label="" target="_blank" rel="noopener"> <i class="fab fa-weibo"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sunyazhou','111.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 主页 </a> </span> <span>AudioUnit</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>AudioUnit</h1><div class="post-meta text-muted d-flex flex-column"><div> 　由 <span class="author"> 孙亚洲 </span> 发布于 <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, May 7, 2018, 10:59 PM +0800" > 2018-05-07 <i class="unloaded">2018-05-07T22:59:41+08:00</i> </span></div><div> 最后更新: <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Apr 2, 2023, 4:42 PM +0800" > 04-02 <i class="unloaded">2023-04-02T16:42:51+08:00</i> </span></div></div><div class="post-content"><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20180507AudioUnit/auHostApp.webp" alt="" /></p><h1 id="前言">前言</h1><p>声音的渲染在iOS平台上回直接使用<code class="language-plaintext highlighter-rouge">AudioUnit</code>的API来完成.用来实现一些类似<code class="language-plaintext highlighter-rouge">大叔</code>,<code class="language-plaintext highlighter-rouge">KTV</code>,<code class="language-plaintext highlighter-rouge">耳返等效果</code>….</p><p>今天带领大家深入了解和学习一下这些音效.</p><h2 id="实现ios变声的背景">实现iOS变声的背景</h2><p>声音变声一般都是发生在 一端采集录制另一端播放音频, 忽略中间的转码过程,在输入输出的中间过程中进行相应的音频参数就实现了变声.</p><p>下图是AVAudioSession的工作流 <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20180507AudioUnit/ASPGIntro.webp" alt="" /></p><p>大家常用的变声方案有很多:</p><ol><li>FFMpeg提供内部效果器 eg:EQ均衡器<li>AVFoundation底层的<code class="language-plaintext highlighter-rouge">Audio Unit</code> eg: 混响reverb<li>SoundTouch<li>其它方案…</ol><p>这里我们选用iOS AVFoundation本身提供的音频处理单元<code class="language-plaintext highlighter-rouge">Audio Unit</code>.</p><p><code class="language-plaintext highlighter-rouge">Audio Unit</code>提供如下功能:</p><ul><li>低延迟的音频I/O eg:voip<li>多路声音的合成并回放 eg:游戏中的音乐合成器<li>Audio Unit 自身提供 eg：回声消除、Mix两轨音频、均衡器、压缩器、混响效果器等.<li>需要图状的结构来处理音频. eg: 有点类似PC时代的主播经常用的一种叫KX 驱动.</ul><p>下图是KX 驱动连线图 windows平台</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20180507AudioUnit/kx.webp" alt="" /></p><h2 id="audiounit介绍">AudioUnit介绍</h2><h4 id="ios层级架构图">iOS层级架构图</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20180507AudioUnit/iPhone0sAudioArchitecture.webp" alt="" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20180507AudioUnit/AboutAudioUnitHosting.webp" alt="" /></p><blockquote><p>声音的处理过程, 首先需要认识一下<code class="language-plaintext highlighter-rouge">AUGraph</code></p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20180507AudioUnit/simpleAuChain.webp" alt="" /></p><blockquote><p><strong>audio processing graph</strong>: A representation of a signal chain comprising an interconnection of audio units. Also called an AUGraph or graph. Core Audio represents such an interconnected network as a software object of typeAUGraph. Audio processing graphs must end in an output unit. See also audio unit.<br /> 一种信号链的表示，包括音频单元的互连。也称为AUGraph或graph。Core Audio代表着这样一个相互连接的网络，它是一个<code class="language-plaintext highlighter-rouge">AUGraph</code>类型的对象。</p></blockquote><h4 id="audio-unit-结构图工作流">audio unit 结构图(工作流)</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20180507AudioUnit/auArchitecture.webp" alt="" /></p><h4 id="audio-unit-构成图">Audio Unit 构成图</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20180507AudioUnit/AudioUnitScopes.webp" alt="" /></p><p>Unit 一般 分为 Element0 和 Element1</p><p>下面我们举Remote I/O Unit为例:</p><p>RemoteIO 这个Unit是和硬件IO相关的Unit，它分为输入端和输出端, 输入端一般指麦克风,输出端一般指扬声器.</p><blockquote><p><code class="language-plaintext highlighter-rouge">Element0</code> 控制输出<br /> <code class="language-plaintext highlighter-rouge">Element1</code> 控制输入 <br /> 图中Element 也叫 bus；<br /> 音频流从输入域（input scope）输入， 从输出域（output scope）输出 整个Render过程就是一次RenderCycle</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20180507AudioUnit/IOUnit.webp" alt="" /></p><p><strong>同时每个Element分为Input Scope 和 Output Scope.如果我们想使用扬声器的声音播放功能,必须需将这个Unit的<code class="language-plaintext highlighter-rouge">Element0</code>的<code class="language-plaintext highlighter-rouge">OutputScope</code>和Speak进行连接. 如果想使用麦克风录音功能,那么必须将这个Unit的<code class="language-plaintext highlighter-rouge">Element1</code>的<code class="language-plaintext highlighter-rouge">InputScope</code>和麦克风进行连接.</strong></p><h3 id="构建audio-unit">构建Audio Unit</h3><p>首先需要启用音频会话 这些大家自己配置就好 了</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>	//配置会话相关伪代码
	[[AVAudioSession sharedInstance].xxxxx xxxxx];
</pre></table></code></div></div><p>如何用代码构建一个Audio Unit？ 这里我们以Remote I/O Unit 为例:</p><p>创建AudioUnit有两种方式</p><ol><li>直接使用AudioUnit裸创建<li>使用AUGraph和AUNode来构建</ol><ul><li>第一种 裸创建</ul><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="cp">#import "ViewController.h"
#import &lt;AudioUnit/AudioUnit.h&gt;
</span><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span>
<span class="p">{</span>
    <span class="n">AudioUnit</span> <span class="n">ioUnitInstance</span><span class="p">;</span> <span class="c1">//声明一变量</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">ViewController</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">viewDidLoad</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">viewDidLoad</span><span class="p">];</span>
    <span class="c1">//首先构造出要用到创建Unit的结构体</span>
    <span class="n">AudioComponentDescription</span> <span class="n">ioUnitDescription</span><span class="p">;</span>
    <span class="n">ioUnitDescription</span><span class="p">.</span><span class="n">componentType</span> <span class="o">=</span> <span class="n">kAudioUnitType_Output</span><span class="p">;</span>
    <span class="n">ioUnitDescription</span><span class="p">.</span><span class="n">componentSubType</span> <span class="o">=</span> <span class="n">kAudioUnitSubType_RemoteIO</span><span class="p">;</span>
    <span class="n">ioUnitDescription</span><span class="p">.</span><span class="n">componentManufacturer</span> <span class="o">=</span> <span class="n">kAudioUnitManufacturer_Apple</span><span class="p">;</span>
    <span class="n">ioUnitDescription</span><span class="p">.</span><span class="n">componentFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ioUnitDescription</span><span class="p">.</span><span class="n">componentFlagsMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="n">AudioComponent</span> <span class="n">ioUnitRef</span> <span class="o">=</span> <span class="n">AudioComponentFindNext</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioUnitDescription</span><span class="p">);</span>
    <span class="c1">//创建AudioUnit实例</span>
    <span class="n">AudioComponentInstanceNew</span><span class="p">(</span><span class="n">ioUnitRef</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioUnitInstance</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li>第二种使用AUGraph和AUNode</ul><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="cp">#import "ViewController.h"
#import &lt;AudioUnit/AudioUnit.h&gt;
#import &lt;AudioToolbox/AudioToolbox.h&gt;
</span><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span>
<span class="p">{</span>
    <span class="n">AUGraph</span>     <span class="n">processingGraph</span><span class="p">;</span>
    <span class="n">AUNode</span>      <span class="n">ioNode</span><span class="p">;</span>
    <span class="n">AudioUnit</span>   <span class="n">ioUnit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">ViewController</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">viewDidLoad</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">viewDidLoad</span><span class="p">];</span>
    <span class="c1">//首先构造出要用到创建Unit的结构体</span>
    <span class="n">AudioComponentDescription</span> <span class="n">ioUnitDescription</span><span class="p">;</span>
    <span class="n">ioUnitDescription</span><span class="p">.</span><span class="n">componentType</span> <span class="o">=</span> <span class="n">kAudioUnitType_Output</span><span class="p">;</span>
    <span class="n">ioUnitDescription</span><span class="p">.</span><span class="n">componentSubType</span> <span class="o">=</span> <span class="n">kAudioUnitSubType_RemoteIO</span><span class="p">;</span>
    <span class="n">ioUnitDescription</span><span class="p">.</span><span class="n">componentManufacturer</span> <span class="o">=</span> <span class="n">kAudioUnitManufacturer_Apple</span><span class="p">;</span>
    <span class="n">ioUnitDescription</span><span class="p">.</span><span class="n">componentFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ioUnitDescription</span><span class="p">.</span><span class="n">componentFlagsMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="c1">//1 new</span>
    <span class="n">NewAUGraph</span><span class="p">(</span><span class="o">&amp;</span><span class="n">processingGraph</span><span class="p">);</span>
    <span class="n">AUGraphAddNode</span><span class="p">(</span><span class="n">processingGraph</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioUnitDescription</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioNode</span><span class="p">);</span>
    
    <span class="c1">//2 open</span>
    <span class="n">AUGraphOpen</span><span class="p">(</span><span class="n">processingGraph</span><span class="p">);</span>
    
    <span class="c1">//3 从相应的Node中获得AudioUnit</span>
    <span class="n">AUGraphNodeInfo</span><span class="p">(</span><span class="n">processingGraph</span><span class="p">,</span> <span class="n">ioNode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioUnit</span><span class="p">);</span>
    
<span class="p">}</span>

</pre></table></code></div></div><blockquote><p>推荐使用第二种因为这种创建扩展性更高一些<br /> 注意:<strong><em>AUNode必须和AudioUnit成对出现</em></strong></p></blockquote><p>如下图 ：Remote I/O Unit</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20180507AudioUnit/IOUnit.webp" alt="" /></p><blockquote><p>麦克风或者扬声器在Audio Unit中有相应的枚举.<br /> 直播中的<code class="language-plaintext highlighter-rouge">耳返</code>就是用的这个把麦克风采集的数据直接扔给扬声器 这样就能做到 低延迟的实时听到麦克风的声音.<br /> 直播中一般使用<code class="language-plaintext highlighter-rouge">Remote I/O</code> unit来进行采集工作</p></blockquote><p>使用AudioUnit连接扬声器</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">OSStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">noErr</span><span class="p">;</span>
<span class="n">UInt32</span> <span class="n">onFlag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">UInt32</span> <span class="n">busZero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//Element0  就是bus0</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">AudioUnitSetProperty</span><span class="p">(</span><span class="n">remoteIOUnit</span><span class="p">,</span> <span class="n">kAudioOutputUnitProperty_EnableIO</span><span class="p">,</span> <span class="n">kAudioUnitScope_Output</span><span class="p">,</span> <span class="n">busZero</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">onFlag</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">onFlag</span><span class="p">));</span>
<span class="n">CheckStatus</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="s">@"不能连接扬声器"</span><span class="p">,</span> <span class="nb">YES</span><span class="p">);</span>
    
</pre></table></code></div></div><blockquote><p>注意: kAudioUnitScope_Output 就是连接扬声器的key</p></blockquote><p>连接麦克风</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">OSStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">noErr</span><span class="p">;</span>
<span class="n">UInt32</span> <span class="n">busOne</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//Element1 就是bus1 接麦克风输入</span>
<span class="n">UInt32</span> <span class="n">oneFlag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">status</span> <span class="o">=</span>  <span class="n">AudioUnitSetProperty</span><span class="p">(</span><span class="n">remoteIOUnit</span><span class="p">,</span> <span class="n">kAudioOutputUnitProperty_EnableIO</span><span class="p">,</span> <span class="n">kAudioUnitScope_Input</span><span class="p">,</span> <span class="n">busOne</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oneFlag</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">oneFlag</span><span class="p">));</span>
<span class="n">CheckStatus</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="s">@"不能连接麦克风"</span><span class="p">,</span> <span class="nb">YES</span><span class="p">);</span>
</pre></table></code></div></div><p>可以使用如下代码检查每一步执行出错debug</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">CheckStatus</span><span class="p">(</span><span class="n">OSStatus</span> <span class="n">status</span><span class="p">,</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">message</span><span class="p">,</span> <span class="n">BOOL</span> <span class="n">fatal</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">noErr</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">fourCC</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
        <span class="o">*</span><span class="p">(</span><span class="n">UInt32</span> <span class="o">*</span><span class="p">)</span><span class="n">fourCC</span> <span class="o">=</span> <span class="n">CFSwapInt32HostToBig</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
        <span class="n">fourCC</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isprint</span><span class="p">(</span><span class="n">fourCC</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="n">isprint</span><span class="p">(</span><span class="n">fourCC</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
            <span class="n">isprint</span><span class="p">(</span><span class="n">fourCC</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="n">isprint</span><span class="p">(</span><span class="n">fourCC</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> <span class="p">{</span>
            <span class="n">NSLog</span><span class="p">(</span><span class="s">@"%@:%s"</span><span class="p">,</span><span class="n">message</span><span class="p">,</span> <span class="n">fourCC</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">NSLog</span><span class="p">(</span><span class="s">@"%@:%d"</span><span class="p">,</span><span class="n">message</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">status</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">fatal</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>由于status每次报错都打印 相关数字大家可能不理解可以点击<a href="https://www.osstatus.com/">OSStatus</a> 查询相关错误码</p></blockquote><h4 id="avaudiomix">AVAudioMix</h4><p>我们一般都在采集、录制或编辑音视频相应的类中使用AVAudioMixer.</p><p>举个例子:我们变声实现的流程大概是这个样子 <strong>AVAudioPlayer -&gt; AVPlayerItem -&gt; AVAudioMixer-&gt; AUGraph -&gt; AUNode + AudioUnit</strong></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20180507AudioUnit/AVAudioMixClass.webp" alt="" /></p><h4 id="audiostreambasicdescription-配置麦克风输入的参数">AudioStreamBasicDescription 配置麦克风输入的参数</h4><p>当我们控制Remote IO Unit的时候想告诉麦克风 各种input的参数 可以通过 一个叫ASBD 格式的结构体数据描述来设置给相应的Unit</p><h5 id="audio-stream-format-描述asbd">Audio Stream Format 描述ASBD</h5><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">UInt32</span> <span class="n">bytePerSample</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Float32</span><span class="p">);</span>
<span class="n">AudioStreamBasicDescription</span> <span class="n">asbd</span><span class="p">;</span>
<span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asbd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">asbd</span><span class="p">));</span>
<span class="n">asbd</span><span class="p">.</span><span class="n">mFormatID</span> <span class="o">=</span> <span class="n">kAudioFormatLinearPCM</span><span class="p">;</span>
<span class="n">asbd</span><span class="p">.</span><span class="n">mSampleRate</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>
<span class="n">asbd</span><span class="p">.</span><span class="n">mChannelsPerFrame</span> <span class="o">=</span> <span class="n">channels</span><span class="p">;</span>
<span class="n">asbd</span><span class="p">.</span><span class="n">mFramesPerPacket</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">asbd</span><span class="p">.</span><span class="n">mFormatFlags</span> <span class="o">=</span> <span class="n">kAudioFormatFlagsNativeFloatPacked</span> <span class="o">|</span> <span class="n">kAudioFormatFlagIsNonInterleaved</span><span class="p">;</span>
<span class="n">asbd</span><span class="p">.</span><span class="n">mBitsPerChannel</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">bytePerSample</span><span class="p">;</span>
<span class="n">asbd</span><span class="p">.</span><span class="n">mBytesPerFrame</span> <span class="o">=</span> <span class="n">bytePerSample</span><span class="p">;</span>
<span class="n">asbd</span><span class="p">.</span><span class="n">mBytesPerPacket</span> <span class="o">=</span> <span class="n">bytePerSample</span><span class="p">;</span>
    
</pre></table></code></div></div><blockquote><p>上边代码展示了如何填充ASBD结构体,这个描述音视频的具体格式.</p></blockquote><p>下面具体介绍一下各个参数的意思</p><ul><li>mFormatID 可用来指定编码格式 eg:PCM<li>mSampleRate 采样率<li>mChannelsPerFrame 每个Frame有几个channel<li>mFramesPerPacket 每个Packet有几Frame<li>mFormatFlags 这个是用来描述声音格式表示格式的参数,上面代码我们指定的是每个sample的表示格式为Float格式,有点类似SInt16,如果后边是NonInterleaved代表非交错的,对于这个音频来讲就是左右声道的是非交错存放的,实际的音频数据会存储在一个AudioBufferList结构中的变量mBuffers中,如果mFormatFlags指定的是NonInterleaved,那么左声道就在会在mBuffers[0]里面,右声道就在mBuffers[1]里面.<li>mBitsPerChannel 表示一个声道的音频数据用多少位来表示,上面我们用的是Float来表示, 所以这里使用的是 8 乘以 每个采样的字节数来赋值.<li>mBytesPerFrame 和 mBytesPerPacket 这两个的赋值需要根据mFormatFlags 的值来进行分配,如果是NonInterleaved非交错的情况下, 就赋值bytePerSample(因为左右声道是分开的).但如果是Interleaved的话,那就应该是 bytePerSample * channels (因为左右声道是交错存放),这样才能表示一个Frame里面到底有多少byte.</ul><p>讲了这么多 那我们怎么把这个ASDB给 Unit?</p><p>如下代码 设置ASBD给相应的Audio Unit</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">AudioUnitSetProperty</span><span class="p">(</span><span class="n">remoteIOUnit</span><span class="p">,</span> <span class="n">kAudioUnitProperty_StreamFormat</span><span class="p">,</span> <span class="n">kAudioUnitScope_Output</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asbd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">asbd</span><span class="p">));</span>
</pre></table></code></div></div><p>完整的代码如下</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="c1">//设置ASBD</span>
<span class="n">AudioStreamBasicDescription</span> <span class="n">inputFormat</span><span class="p">;</span>
<span class="n">inputFormat</span><span class="p">.</span><span class="n">mSampleRate</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>
<span class="n">inputFormat</span><span class="p">.</span><span class="n">mFormatID</span> <span class="o">=</span> <span class="n">kAudioFormatLinearPCM</span><span class="p">;</span>
<span class="n">inputFormat</span><span class="p">.</span><span class="n">mFormatFlags</span> <span class="o">=</span> <span class="n">kAudioFormatFlagIsSignedInteger</span> <span class="o">|</span> <span class="n">kAudioFormatFlagIsNonInterleaved</span><span class="p">;</span>
<span class="n">inputFormat</span><span class="p">.</span><span class="n">mFramesPerPacket</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">inputFormat</span><span class="p">.</span><span class="n">mChannelsPerFrame</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">inputFormat</span><span class="p">.</span><span class="n">mBytesPerPacket</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">inputFormat</span><span class="p">.</span><span class="n">mBytesPerFrame</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">inputFormat</span><span class="p">.</span><span class="n">mBitsPerChannel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
<span class="c1">//设置给输入端 配置麦克风输出的数据是什么格式</span>
<span class="n">OSStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">noErr</span><span class="p">;</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">AudioUnitSetProperty</span><span class="p">(</span><span class="n">audioUnit</span><span class="p">,</span>
                              <span class="n">kAudioUnitProperty_StreamFormat</span><span class="p">,</span>
                              <span class="n">kAudioUnitScope_Output</span><span class="p">,</span>
                              <span class="n">InputBus</span><span class="p">,</span>
                              <span class="o">&amp;</span><span class="n">inputFormat</span><span class="p">,</span>
                              <span class="k">sizeof</span><span class="p">(</span><span class="n">inputFormat</span><span class="p">));</span>
<span class="n">CheckStatus</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="s">@"AudioUnitGetProperty bus1 output ASBD error"</span><span class="p">,</span> <span class="nb">YES</span><span class="p">);</span>
</pre></table></code></div></div><h3 id="audio-unit-分类">Audio Unit 分类</h3><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">CF_ENUM</span><span class="p">(</span><span class="n">UInt32</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">kAudioUnitType_Output</span>					<span class="o">=</span> <span class="err">'</span><span class="n">auou</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitType_MusicDevice</span>				<span class="o">=</span> <span class="err">'</span><span class="n">aumu</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitType_MusicEffect</span>				<span class="o">=</span> <span class="err">'</span><span class="n">aumf</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitType_FormatConverter</span>			<span class="o">=</span> <span class="err">'</span><span class="n">aufc</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitType_Effect</span>					<span class="o">=</span> <span class="err">'</span><span class="n">aufx</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitType_Mixer</span>					<span class="o">=</span> <span class="err">'</span><span class="n">aumx</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitType_Panner</span>					<span class="o">=</span> <span class="err">'</span><span class="n">aupn</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitType_Generator</span>				<span class="o">=</span> <span class="err">'</span><span class="n">augn</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitType_OfflineEffect</span>			<span class="o">=</span> <span class="err">'</span><span class="n">auol</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitType_MIDIProcessor</span>			<span class="o">=</span> <span class="err">'</span><span class="n">aumi</span><span class="err">'</span>
<span class="p">};</span>
</pre></table></code></div></div><div class="table-wrapper"><table><thead><tr><th style="text-align: left">分类<th style="text-align: left">功能/作用<th style="text-align: left">类型<tbody><tr><td style="text-align: left">Effect Unit<td style="text-align: left">提供声音特效处理<td style="text-align: left">kAudioUnitType_Effect<tr><td style="text-align: left">Mixer Units<td style="text-align: left">提供Mix多路声音的功能<td style="text-align: left">kAudioUnitType_Mixer<tr><td style="text-align: left">I/O Units<td style="text-align: left">I/O 采集音频与播放音频功能<td style="text-align: left">kAudioUnitType_Output<tr><td style="text-align: left">AUConverter Units<td style="text-align: left">格式转换 eg:采样格式Float转SInt16、交错或平铺、单双声道的转换<td style="text-align: left">kAudioUnitType_FormatConverter<tr><td style="text-align: left">Generator Units<td style="text-align: left">提供播放器功能<td style="text-align: left">kAudioUnitType_Generator</table></div><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="n">CF_ENUM</span><span class="p">(</span><span class="n">UInt32</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">kAudioUnitSubType_PeakLimiter</span>			<span class="o">=</span> <span class="err">'</span><span class="n">lmtr</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitSubType_DynamicsProcessor</span>		<span class="o">=</span> <span class="err">'</span><span class="n">dcmp</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitSubType_LowPassFilter</span>			<span class="o">=</span> <span class="err">'</span><span class="n">lpas</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitSubType_HighPassFilter</span>		<span class="o">=</span> <span class="err">'</span><span class="n">hpas</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitSubType_BandPassFilter</span>		<span class="o">=</span> <span class="err">'</span><span class="n">bpas</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitSubType_HighShelfFilter</span>		<span class="o">=</span> <span class="err">'</span><span class="n">hshf</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitSubType_LowShelfFilter</span>		<span class="o">=</span> <span class="err">'</span><span class="n">lshf</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitSubType_ParametricEQ</span>			<span class="o">=</span> <span class="err">'</span><span class="n">pmeq</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitSubType_Distortion</span>			<span class="o">=</span> <span class="err">'</span><span class="n">dist</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitSubType_Delay</span>					<span class="o">=</span> <span class="err">'</span><span class="n">dely</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitSubType_SampleDelay</span>			<span class="o">=</span> <span class="err">'</span><span class="n">sdly</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitSubType_NBandEQ</span>				<span class="o">=</span> <span class="err">'</span><span class="n">nbeq</span><span class="err">'</span>
<span class="p">};</span>


<span class="n">CF_ENUM</span><span class="p">(</span><span class="n">UInt32</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">kAudioUnitSubType_Reverb2</span>				<span class="o">=</span> <span class="err">'</span><span class="n">rvb2</span><span class="err">'</span><span class="p">,</span>
	<span class="n">kAudioUnitSubType_AUiPodEQ</span>				<span class="o">=</span> <span class="err">'</span><span class="n">ipeq</span><span class="err">'</span>
<span class="p">};</span>

</pre></table></code></div></div><h4 id="effect-unit-子类型及用途说明">Effect Unit 子类型及用途说明</h4><div class="table-wrapper"><table><thead><tr><th style="text-align: left">子类型<th style="text-align: left">用途说明<th style="text-align: left">子枚举类型<tbody><tr><td style="text-align: left">均衡效果器<td style="text-align: left">为声音的某些<a href="https://baike.baidu.com/item/%E9%A2%91%E5%B8%A6">频带</a>增强或衰减能量，效果器需要指定多个频带,然后为各频带设置增益最终改变声音在音域上的能量分布<td style="text-align: left">kAudioUnitSubType_NBandEQ<tr><td style="text-align: left">压缩效果器<td style="text-align: left">当声音较小或较大通过设置阀值来提高或降低声音能量 eg:作用时间、释放时间、以及触发值从而最终控制声音在时域上的能量范围<td style="text-align: left">kAudioUnitSubType_DynamicsProcessor<tr><td style="text-align: left">混响效果器<td style="text-align: left">通过声音反射的延迟控制声音效果<td style="text-align: left">kAudioUnitSubType_Reverb2</table></div><blockquote><p>Effect Unit 下最常用的效果器就上边这三种, 像高通(High Pass)、低通(Low Pass)、带通(Band Pass)、延迟(Delay)、压限(Limiter) 等这些不是很常用,如果大家对这个很熟悉可以试试使用一下.</p></blockquote><h4 id="mixer-units-子类型及用途说明">Mixer Units 子类型及用途说明</h4><div class="table-wrapper"><table><thead><tr><th style="text-align: left">子类型<th style="text-align: left">用途说明<th style="text-align: left">子枚举类型<tbody><tr><td style="text-align: left">3D Mixer<td style="text-align: left">仅支持 macOS<td style="text-align: left"> <tr><td style="text-align: left">MultiChannelMixer<td style="text-align: left">多路声音混音效果器,可以接受多路音频输入,还可以分别调整每一路的音频增益和开关,并将多路音频合成一路<td style="text-align: left">kAudioUnitSubType_MultiChannelMixer</table></div><h4 id="io-units-子类型及用途说明">I/O Units 子类型及用途说明</h4><div class="table-wrapper"><table><thead><tr><th style="text-align: left">子类型<th style="text-align: left">用途说明<th style="text-align: left">子枚举类型<tbody><tr><td style="text-align: left">Remote I/O<td style="text-align: left">采集音频与播放音频,在Audio Unit中使用麦克风和扬声器的时候会用到这个Unit<td style="text-align: left">kAudioUnitType_Output<tr><td style="text-align: left">Generic Output<td style="text-align: left">进行离线处理,或者说AUGraph中不使用扬声器来驱动整个数据流,而希望使用一个输出(可以放入内存队列或者磁盘I/O操作)来驱动数据流时<td style="text-align: left">kAudioUnitSubType_GenericOutput</table></div><h4 id="auconverter-units-子类型及用途说明">AUConverter Units 子类型及用途说明</h4><div class="table-wrapper"><table><thead><tr><th style="text-align: left">子类型<th style="text-align: left">用途说明<th style="text-align: left">子枚举类型<tbody><tr><td style="text-align: left">AUConverter<td style="text-align: left">格式转换,当某些效果器对输入的音频格式有明确要求时,或者我们将音频数据输入给一些其它的编码器进行编码。。。<td style="text-align: left">kAudioUnitSubType_AUConverter<tr><td style="text-align: left">Time Pitch<td style="text-align: left">变速变调效果器,调整声音音高. eg:会说话的Tom猫<td style="text-align: left">kAudioUnitSubType_NewTimePitch</table></div><blockquote><p>注意: AUConverter 如果由FFMpeg解码出来的PCM 是SInt16格式 如果要用格式转换效果器unit必须转成Float32格式表示的数据.</p></blockquote><h4 id="generator-units-子类型及用途说明">Generator Units 子类型及用途说明</h4><div class="table-wrapper"><table><thead><tr><th style="text-align: left">子类型<th style="text-align: left">用途说明<th style="text-align: left">子枚举类型<tbody><tr><td style="text-align: left">AudioFilePlayer<td style="text-align: left">接收裸PCM 播放 一般大家可以用这个配合Remote I/O 做播放器<td style="text-align: left">kAudioUnitSubType_AudioFilePlayer</table></div><p>相关shell命令 <strong>将音频文件转成pcm</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ffmpeg <span class="nt">-i</span> test.mp3 <span class="nt">-acodec</span> pcm_s16le <span class="nt">-f</span> s16le output.pcm
</pre></table></code></div></div><blockquote><p>brew install ffmpeg</p></blockquote><p><a href="https://github.com/sunyazhou13/AduioUnitDemo">Demo实现耳返功能</a><br /> <a href="https://github.com/sunyazhou13/AudioUnitDemo2">Demo2实现耳返+伴奏播放</a></p><h4 id="下面我分享一个变声中混响效果代码">下面我分享一个变声中混响效果代码</h4><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
</pre><td class="rouge-code"><pre>
<span class="c1">//声明部分  .h</span>
<span class="k">@interface</span> <span class="nc">KSYAudioReverbFilter</span> <span class="p">:</span> <span class="nc">NSObject</span>


<span class="k">-</span><span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="n">init</span><span class="p">;</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setupWithAUGraph</span><span class="p">:(</span><span class="n">AUGraph</span><span class="p">)</span><span class="nv">auGraph</span> <span class="nf">asbd</span><span class="p">:(</span><span class="k">const</span> <span class="n">AudioStreamBasicDescription</span> <span class="o">*</span><span class="p">)</span><span class="nv">asbd</span> <span class="nf">maxFrame</span><span class="p">:(</span><span class="n">CMItemCount</span><span class="p">)</span><span class="nv">max</span><span class="p">;</span>

<span class="c1">// Global, CrossFade, 0-&gt;100, 100</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">)</span> <span class="kt">double</span> <span class="n">dryWetMix</span><span class="p">;</span>
<span class="c1">// Global, Decibels, -20-&gt;20, 0dB.</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">)</span> <span class="kt">double</span> <span class="n">gain</span><span class="p">;</span>
<span class="c1">// Global, Secs, 0.0001-&gt;1.0, 0.008</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">)</span> <span class="kt">double</span> <span class="n">minDelayTime</span><span class="p">;</span>
<span class="c1">// Global, Secs, 0.0001-&gt;1.0, 0.050</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">)</span> <span class="kt">double</span> <span class="n">maxDelayTime</span><span class="p">;</span>
<span class="c1">// Global, Secs, 0.001-&gt;20.0, 1.0</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">)</span> <span class="kt">double</span> <span class="n">decayTimeAt0Hz</span><span class="p">;</span>
<span class="c1">// Global, Secs, 0.001-&gt;20.0, 0.5</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">)</span> <span class="kt">double</span> <span class="n">decayTimeAtNyquist</span><span class="p">;</span>
<span class="c1">// Global, Integer, 1-&gt;1000, 1</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">)</span> <span class="kt">double</span> <span class="n">randomizeReflections</span><span class="p">;</span>

<span class="k">@end</span>


<span class="c1">//实现部分</span>

<span class="c1">//通用的宏</span>
<span class="cp">#define RC_CHECK(rc, str) if (rc != noErr) \
{ \
NSLog(@"Err :%@ %@ %@", @(rc), str, @(__func__)); \
}
</span>
<span class="k">@implementation</span> <span class="nc">KSYAudioReverbFilter</span>

<span class="k">-</span><span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="n">init</span><span class="p">{</span>
    <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nf">init</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">){</span>
        <span class="n">self</span><span class="p">.</span><span class="n">acDes</span> <span class="o">=</span> <span class="p">(</span><span class="n">AudioComponentDescription</span><span class="p">){</span><span class="n">kAudioUnitType_Effect</span><span class="p">,</span> <span class="n">kAudioUnitSubType_Reverb2</span><span class="p">,</span> <span class="n">kAudioUnitManufacturer_Apple</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setupWithAUGraph</span><span class="p">:(</span><span class="n">AUGraph</span><span class="p">)</span><span class="nv">auGraph</span> <span class="nf">asbd</span><span class="p">:(</span><span class="k">const</span> <span class="n">AudioStreamBasicDescription</span> <span class="o">*</span><span class="p">)</span><span class="nv">asbd</span> <span class="nf">maxFrame</span><span class="p">:(</span><span class="n">CMItemCount</span><span class="p">)</span><span class="nv">maxFrame</span>
<span class="p">{</span>
    <span class="c1">//</span>
    <span class="n">OSStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">noErr</span><span class="p">;</span>
    <span class="n">NSAssert</span><span class="p">(</span><span class="n">auGraph</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@"auGraph is null"</span><span class="p">);</span>
    <span class="n">audioGraph</span> <span class="o">=</span> <span class="n">auGraph</span><span class="p">;</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"setup :%@"</span><span class="p">,</span> <span class="n">NSStringFromCode</span><span class="p">(</span><span class="n">_acDes</span><span class="p">.</span><span class="n">componentSubType</span><span class="p">));</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">AUGraphAddNode</span><span class="p">(</span><span class="n">auGraph</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_acDes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_node</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">noErr</span> <span class="o">!=</span> <span class="n">status</span><span class="p">){</span>
        
        <span class="n">NSString</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"add node with type %u failed"</span><span class="p">,</span> <span class="n">_acDes</span><span class="p">.</span><span class="n">componentType</span><span class="p">];</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"%@"</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">;</span>
    <span class="p">}</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">AUGraphNodeInfo</span><span class="p">(</span><span class="n">auGraph</span><span class="p">,</span> <span class="n">_node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_audioUnit</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">noErr</span> <span class="o">!=</span> <span class="n">status</span><span class="p">){</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"create audiouinit failed err:%@"</span><span class="p">,</span> <span class="err">@</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
        <span class="k">return</span> <span class="p">;</span>
    <span class="p">}</span>
    
    <span class="n">RC_CHECK</span><span class="p">(</span><span class="n">AudioUnitSetProperty</span><span class="p">(</span><span class="n">_audioUnit</span><span class="p">,</span>
                                  <span class="n">kAudioUnitProperty_StreamFormat</span><span class="p">,</span>
                                  <span class="n">kAudioUnitScope_Input</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">asbd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">AudioStreamBasicDescription</span><span class="p">)),</span>
             <span class="s">@"kAudioUnitProperty_StreamFormat kAudioUnitScope_Input err"</span><span class="p">);</span>
    
    <span class="n">RC_CHECK</span><span class="p">(</span><span class="n">AudioUnitSetProperty</span><span class="p">(</span><span class="n">_audioUnit</span><span class="p">,</span>
                                  <span class="n">kAudioUnitProperty_StreamFormat</span><span class="p">,</span>
                                  <span class="n">kAudioUnitScope_Output</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">asbd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">AudioStreamBasicDescription</span><span class="p">)),</span>
             <span class="s">@"kAudioUnitProperty_StreamFormat kAudioUnitScope_Output err"</span><span class="p">);</span>
    
    <span class="c1">// Set audio unit maximum frames per slice to max frames.</span>
    <span class="n">RC_CHECK</span><span class="p">(</span><span class="n">AudioUnitSetProperty</span><span class="p">(</span><span class="n">_audioUnit</span><span class="p">,</span>
                                  <span class="n">kAudioUnitProperty_MaximumFramesPerSlice</span><span class="p">,</span>
                                  <span class="n">kAudioUnitScope_Global</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">maxFrame</span><span class="p">,</span> <span class="p">(</span><span class="n">UInt32</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">UInt32</span><span class="p">)),</span>
             <span class="s">@"set kAudioUnitProperty_MaximumFramesPerSlice err"</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#pragma mark - Setters
</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setDryWetMix</span><span class="p">:(</span><span class="kt">double</span><span class="p">)</span><span class="nv">dryWetMix</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">setGlobalParam</span><span class="p">:</span><span class="n">kReverb2Param_DryWetMix</span> <span class="nf">value</span><span class="p">:</span><span class="n">dryWetMix</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setGain</span><span class="p">:(</span><span class="kt">double</span><span class="p">)</span><span class="nv">gain</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">setGlobalParam</span><span class="p">:</span><span class="n">kReverb2Param_Gain</span> <span class="nf">value</span><span class="p">:</span><span class="n">gain</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setMinDelayTime</span><span class="p">:(</span><span class="kt">double</span><span class="p">)</span><span class="nv">minDelayTime</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">setGlobalParam</span><span class="p">:</span><span class="n">kReverb2Param_MinDelayTime</span> <span class="nf">value</span><span class="p">:</span><span class="n">minDelayTime</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setMaxDelayTime</span><span class="p">:(</span><span class="kt">double</span><span class="p">)</span><span class="nv">maxDelayTime</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">setGlobalParam</span><span class="p">:</span><span class="n">kReverb2Param_MaxDelayTime</span> <span class="nf">value</span><span class="p">:</span><span class="n">maxDelayTime</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setDecayTimeAt0Hz</span><span class="p">:(</span><span class="kt">double</span><span class="p">)</span><span class="nv">decayTimeAt0Hz</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">setGlobalParam</span><span class="p">:</span><span class="n">kReverb2Param_DecayTimeAt0Hz</span> <span class="nf">value</span><span class="p">:</span><span class="n">decayTimeAt0Hz</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setDecayTimeAtNyquist</span><span class="p">:(</span><span class="kt">double</span><span class="p">)</span><span class="nv">decayTimeAtNyquist</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">setGlobalParam</span><span class="p">:</span><span class="n">kReverb2Param_DecayTimeAtNyquist</span> <span class="nf">value</span><span class="p">:</span><span class="n">decayTimeAtNyquist</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setRandomizeReflections</span><span class="p">:(</span><span class="kt">double</span><span class="p">)</span><span class="nv">randomizeReflections</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">setGlobalParam</span><span class="p">:</span><span class="n">kReverb2Param_RandomizeReflections</span> <span class="nf">value</span><span class="p">:</span><span class="n">randomizeReflections</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">//通用方法</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setGlobalParam</span><span class="p">:(</span><span class="n">AudioUnitParameterID</span><span class="p">)</span><span class="nv">paramId</span> <span class="nf">value</span><span class="p">:(</span><span class="n">AudioUnitParameterValue</span><span class="p">)</span><span class="nv">value</span>
<span class="p">{</span>

    <span class="n">RC_CHECK</span><span class="p">(</span><span class="n">AudioUnitSetParameter</span><span class="p">(</span><span class="n">_audioUnit</span><span class="p">,</span>
                                   <span class="n">paramId</span><span class="p">,</span>
                                   <span class="n">kAudioUnitScope_Global</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
             <span class="p">([</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"set %u value %f err"</span><span class="p">,</span> <span class="n">paramId</span><span class="p">,</span> <span class="n">value</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">@end</span>



</pre></table></code></div></div><p>外部调用的话就是这样的</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">AURenderCallbackStruct</span> <span class="n">renderCallbackStruct</span><span class="p">;</span>
<span class="n">renderCallbackStruct</span><span class="p">.</span><span class="n">inputProc</span> <span class="o">=</span> <span class="n">ksyme_RenderCallback</span><span class="p">;</span>
<span class="n">renderCallbackStruct</span><span class="p">.</span><span class="n">inputProcRefCon</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">self</span><span class="p">.</span><span class="n">apt</span><span class="p">;</span>
    
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_reverbFilter</span><span class="p">){</span>
    <span class="n">_reverbFilter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">KSYAudioReverbFilter</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
    <span class="p">[</span><span class="n">_reverbFilter</span> <span class="nf">setupWithAUGraph</span><span class="p">:</span><span class="n">auGraph</span> <span class="nf">asbd</span><span class="p">:</span><span class="n">format</span> <span class="n">maxFrame</span><span class="o">:</span><span class="n">max</span><span class="p">];</span>
    <span class="n">_reverbFilter</span><span class="p">.</span><span class="n">renderCallBack</span> <span class="o">=</span> <span class="n">renderCallbackStruct</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="连接node">连接node</h3><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">AUGraphClearConnections</span><span class="p">(</span><span class="n">auGraph</span><span class="p">);</span>
<span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">array</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSMutableArray</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
<span class="p">[</span><span class="n">array</span> <span class="nf">addObject</span><span class="p">:</span><span class="err">@</span><span class="p">(</span><span class="n">_mixFilter</span><span class="p">.</span><span class="n">node</span><span class="p">)];</span>

<span class="p">[</span><span class="n">array</span> <span class="nf">addObjectsFromArray</span><span class="p">:@[</span><span class="err">@</span><span class="p">(</span><span class="n">_reverbFilter</span><span class="p">.</span><span class="n">node</span><span class="p">),</span><span class="err">@</span><span class="p">(</span><span class="n">_delayFilter</span><span class="p">.</span><span class="n">node</span><span class="p">),</span><span class="err">@</span><span class="p">(</span><span class="n">_pitchFilter</span><span class="p">.</span><span class="n">node</span><span class="p">)]];</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">array</span><span class="p">.</span><span class="n">count</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">AUGraphConnectNodeInput</span><span class="p">(</span><span class="n">auGraph</span><span class="p">,[</span><span class="n">array</span><span class="p">[</span><span class="nf">i</span><span class="p">]</span> <span class="nf">intValue</span><span class="p">],</span> <span class="mi">0</span><span class="p">,[</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="nf">intValue</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
    
</pre></table></code></div></div><p>核心代码就是如何连接Node</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">AUGraphConnectNodeInput</span><span class="p">(</span><span class="n">auGraph</span><span class="p">,</span><span class="n">reverbNode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">remoteIONode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></table></code></div></div><blockquote><p>0代表 bus0</p></blockquote><p>系统定义的API是这样的</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">extern</span> <span class="n">OSStatus</span>
<span class="nf">AUGraphConnectNodeInput</span><span class="p">(</span>	<span class="n">AUGraph</span>			<span class="n">inGraph</span><span class="p">,</span>
						<span class="n">AUNode</span>			<span class="n">inSourceNode</span><span class="p">,</span>
						<span class="n">UInt32</span>			<span class="n">inSourceOutputNumber</span><span class="p">,</span>
						<span class="n">AUNode</span>			<span class="n">inDestNode</span><span class="p">,</span>
						<span class="n">UInt32</span>			<span class="n">inDestInputNumber</span><span class="p">)</span>		<span class="n">__OSX_AVAILABLE_STARTING</span><span class="p">(</span><span class="n">__MAC_10_0</span><span class="p">,</span><span class="n">__IPHONE_2_0</span><span class="p">);</span>
</pre></table></code></div></div><h2 id="总结">总结</h2><p>Audio Unit的相关技术学习点比较多大家灵活掌握运用,不懂没关系从简单的Unit开始学起.</p><p>全文完</p><p>参考列表:<br /> <a href="https://developer.apple.com/library/content/documentation/MusicAudio/Reference/CoreAudioGlossary/Glossary/core_audio_glossary.html#//apple_ref/doc/uid/TP40004453-CH210-SW1">iOS Audio相关术语(Glossary)</a><br /> <a href="https://developer.apple.com/library/content/documentation/MusicAudio/Conceptual/AudioUnitHostingGuide_iOS/Introduction/Introduction.html">参考</a><br /> <a href="https://developer.apple.com/library/content/documentation/MusicAudio/Conceptual/AudioUnitProgrammingGuide/Tutorial-BuildingASimpleEffectUnitWithAGenericView/Tutorial-BuildingASimpleEffectUnitWithAGenericView.html#//apple_ref/doc/uid/TP40003278-CH5-SW4">如何自己制作一个Audio Unit</a><br /> <a href="https://www.jianshu.com/p/05cae433faea">金山云直播音效实现</a><br /> <a href="https://developer.apple.com/library/content/documentation/MusicAudio/Conceptual/AudioUnitHostingGuide_iOS/AudioUnitHostingFundamentals/AudioUnitHostingFundamentals.html#//apple_ref/doc/uid/TP40009492-CH3-SW12">Audio Unit官方文档</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ios/'>iOS</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ios/" class="post-tag no-text-decoration" >iOS</a> <a href="/tags/macos/" class="post-tag no-text-decoration" >macOS</a> <a href="/tags/objective-c/" class="post-tag no-text-decoration" >Objective-C</a> <a href="/tags/avfoundation/" class="post-tag no-text-decoration" >AVFoundation</a> <a href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/" class="post-tag no-text-decoration" >音视频</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 该博客文章由作者通过 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC BY 4.0</a> 进行授权。</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=AudioUnit - 迈腾大队长&url=https://www.sunyazhou.com/2018/05/AudioUnit/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=AudioUnit - 迈腾大队长&u=https://www.sunyazhou.com/2018/05/AudioUnit/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=AudioUnit - 迈腾大队长&url=https://www.sunyazhou.com/2018/05/AudioUnit/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="http://service.weibo.com/share/share.php?title=AudioUnit - 迈腾大队长&url=https://www.sunyazhou.com/2018/05/AudioUnit/" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>最近更新</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/2022/11/swiftuipropertywrapper/">SwiftUI属性包装器:State、Binding、ObservableObject、EnvironmentObject</a><li><a href="/2023/06/learnswiftuichapter1/">SwiftUI第一章学习总结</a><li><a href="/2023/09/learnswiftuichapter5/">SwiftUI第五章学习总结</a><li><a href="/2023/06/learnswiftuichapter2/">SwiftUI第二章学习总结</a><li><a href="/2023/08/swiftuiextention1/">SwiftUI可用性检测,解决小组件iOS17 available问题</a></ul></div><div id="access-tags"> <span>热门标签</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/objective-c/">Objective C</a> <a class="post-tag" href="/tags/ios/">iOS</a> <a class="post-tag" href="/tags/macos/">macOS</a> <a class="post-tag" href="/tags/skills/">skills</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/swift/">Swift</a> <a class="post-tag" href="/tags/c++/">C++</a> <a class="post-tag" href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/">音视频</a> <a class="post-tag" href="/tags/avfoundation/">AVFoundation</a> <a class="post-tag" href="/tags/swiftui/">SwiftUI</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">文章目录</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>接下来阅读</h3><div class="card-deck mb-4"><div class="card"> <a href="/2019/04/AVRoutePickerView/"><div class="card-body"> <span class="timeago small" > 2019-04-17 <i class="unloaded">2019-04-17T23:19:52+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AVRoutePickerView</h3><div class="text-muted small"><p> 前言 最近无意中看了一下AVKit发现内部增加了很多新的内容.其中有个AVRoutePickerView的UI控件,打算研究一下. 其实这个很常见就在系统的控制中心 下拉屏幕就能看见 当你连接耳机或者无线蓝牙设备的时候. 这里网易云音乐中有实践的例子 这个控件主要用于AirPlay投屏 和音频的线路切换 那么我今天就跟大家一起学习一下这个新的控件 代码实现 导入#im...</p></div></div></a></div><div class="card"> <a href="/2022/04/CVPixelBufferRef/"><div class="card-body"> <span class="timeago small" > 2022-04-06 <i class="unloaded">2022-04-06T09:50:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>深入理解CVPixelBufferRef</h3><div class="text-muted small"><p> 在iOS里，我们经常能看到CVPixelBufferRef这个类型，在Camera采集返回的数据里得到一个CMSampleBufferRef,而每个CMSampleBufferRef里则包含一个CVPixelBufferRef,在视频硬解码的返回数据里也是一个CVPixelBufferRef。 顾名思义,CVPixelBufferRef是一种像素图片类型，由于CV开头，所以它是属于Co...</p></div></div></a></div><div class="card"> <a href="/2017/03/LearningAVFoundationAVSpeechSynthesizer/"><div class="card-body"> <span class="timeago small" > 2017-03-11 <i class="unloaded">2017-03-11T20:38:53+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Learning AV Foundation(一)汉字语音朗读</h3><div class="text-muted small"><p> 前言 最近在研究AV Foundation 框架 发现有一本书叫做 AV Foundation开发秘籍：实践掌握iOS &amp; OS X 应用的视听处理技术 然后google查了一下英文版叫 Learning AV Foundation: A Hands-on Guide to Mastering the AV Foundation Framework 看着国人的翻译不仅慨叹...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/2018/04/RunLoop/" class="btn btn-outline-primary"><p>深入理解RunLoop</p></a> <a href="/2018/05/ManualControlUIViewControllerLifeCycle/" class="btn btn-outline-primary"><p>手动管理UIViewController的生命周期</p></a></div><div class="utterances-container"> <script src="https://utteranc.es/client.js" repo="sunyazhou13/gitment-comments" issue-term="pathname" theme="photon-dark" crossorigin="anonymous" async> </script></div><script type="text/javascript"> $(function() { window.onmessage = evt => { if (evt.origin === 'https://utteranc.es') { toggle.updateCommentStyle(); window.onmessage = null; } } }); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/sunyazhou13">sunyazhou13</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，否则本网站上的博客文章均由作者根据知识共享许可协议 - 署名标示 4.0（CC BY 4.0）进行授权许可。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本博客由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，使用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> 作为主题</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">热门标签</h4><a class="post-tag" href="/tags/objective-c/">Objective C</a> <a class="post-tag" href="/tags/ios/">iOS</a> <a class="post-tag" href="/tags/macos/">macOS</a> <a class="post-tag" href="/tags/skills/">skills</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/swift/">Swift</a> <a class="post-tag" href="/tags/c++/">C++</a> <a class="post-tag" href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/">音视频</a> <a class="post-tag" href="/tags/avfoundation/">AVFoundation</a> <a class="post-tag" href="/tags/swiftui/">SwiftUI</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.sunyazhou.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
