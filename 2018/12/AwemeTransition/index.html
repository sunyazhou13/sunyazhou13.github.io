<!DOCTYPE html><html lang="zh-Hans" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.5.1"><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="iOS抖音的转场动画" /><meta name="author" content="孙亚洲" /><meta property="og:locale" content="zh_Hans" /><meta name="description" content="前言" /><meta property="og:description" content="前言" /><link rel="canonical" href="https://www.sunyazhou.com/2018/12/AwemeTransition/" /><meta property="og:url" content="https://www.sunyazhou.com/2018/12/AwemeTransition/" /><meta property="og:site_name" content="迈腾大队长" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-12-21T10:12:07+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="iOS抖音的转场动画" /><meta name="twitter:site" content="@sunyazhou" /><meta name="twitter:creator" content="@孙亚洲" /><meta name="google-site-verification" content="Xo29j227HYVdC-vDA_-qJwvDP3PIo-lC78CFeBvhrDA" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"https://www.sunyazhou.com/2018/12/AwemeTransition/","headline":"iOS抖音的转场动画","dateModified":"2018-12-21T10:12:07+00:00","datePublished":"2018-12-21T10:12:07+00:00","author":{"@type":"Person","name":"孙亚洲"},"description":"前言","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.sunyazhou.com/2018/12/AwemeTransition/"},"@context":"https://schema.org"}</script><title>iOS抖音的转场动画 | 迈腾大队长</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/images/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">迈腾大队长</a></div><div class="site-subtitle font-italic">不斷學習,與時俱進.求真務實,實事求是.</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3"></i> <span>主页</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3"></i> <span>归档</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3"></i> <span>分类</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3"></i> <span>标签</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/projects/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-paint-brush ml-xl-3 mr-xl-3"></i> <span>作品</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3"></i> <span>关于</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } get isResolvedDarkMode() { if (this.isLightMode) { return false; } return this.isSysDarkPrefer; } updateCommentStyle() { var theme = "github-light"; if (this.isResolvedDarkMode) { theme = "photon-dark"; } let comment = document.querySelector("iframe.utterances-frame"); if (comment == null) { return; } comment.contentWindow.postMessage( { type: "set-theme", theme: theme }, "https://utteranc.es/" ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateCommentStyle(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/sunyazhou13" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/sunyazhou" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.weibo.com/sunyazhou13" aria-label="" target="_blank" rel="noopener"> <i class="fab fa-weibo"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sunyazhou','111.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 主页 </a> </span> <span>iOS抖音的转场动画</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>iOS抖音的转场动画</h1><div class="post-meta text-muted d-flex flex-column"><div> 　由 <span class="author"> 孙亚洲 </span> 发布于 <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Dec 21, 2018, 10:12 AM +0000" > 2018-12-21 <i class="unloaded">2018-12-21T10:12:07+00:00</i> </span></div><div> 最后更新: <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Apr 2, 2023, 4:42 PM +0800" > 2023-04-02 <i class="unloaded">2023-04-02T08:42:51+00:00</i> </span></div></div><div class="post-content"><h1 id="前言">前言</h1><p>这几天比较忙,今天给大家带来的是抖音的转场动画实现 废话不多说上图</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20181221AwemeTransition/transition.gif" alt="" /></p><p>这里需要用到前一篇文章的上下滑<a href="https://github.com/sunyazhou13/AwemeDemo">demo</a></p><p>学习这篇文章之前推荐看下喵神的<a href="https://onevcat.com/2013/10/vc-transition-in-ios7/">iOS7中的ViewController转场切换</a></p><p>如果对转场不是很了解的话可能学习会有一些难度和疑问.</p><h2 id="转场调用代码">转场调用代码</h2><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">collectionView</span><span class="p">:(</span><span class="n">UICollectionView</span> <span class="o">*</span><span class="p">)</span><span class="nv">collectionView</span> <span class="nf">didSelectItemAtIndexPath</span><span class="p">:(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span> <span class="p">{</span>
    <span class="n">AwemeListViewController</span> <span class="o">*</span><span class="n">awemeVC</span> <span class="o">=</span> <span class="p">[[</span><span class="n">AwemeListViewController</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
    <span class="n">awemeVC</span><span class="p">.</span><span class="n">transitioningDelegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span> <span class="c1">//0</span>
    
    <span class="c1">// 1</span>
    <span class="n">UICollectionViewCell</span> <span class="o">*</span><span class="n">cell</span> <span class="o">=</span> <span class="p">[</span><span class="n">collectionView</span> <span class="nf">cellForItemAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">];</span>
    <span class="c1">// 2</span>
    <span class="n">CGRect</span> <span class="n">cellFrame</span> <span class="o">=</span> <span class="n">cell</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>
    <span class="c1">// 3</span>
    <span class="n">CGRect</span> <span class="n">cellConvertedFrame</span> <span class="o">=</span> <span class="p">[</span><span class="n">collectionView</span> <span class="nf">convertRect</span><span class="p">:</span><span class="n">cellFrame</span> <span class="nf">toView</span><span class="p">:</span><span class="n">collectionView</span><span class="p">.</span><span class="n">superview</span><span class="p">];</span>
    
    <span class="c1">//弹窗转场</span>
    <span class="n">self</span><span class="p">.</span><span class="n">presentScaleAnimation</span><span class="p">.</span><span class="n">cellConvertFrame</span> <span class="o">=</span> <span class="n">cellConvertedFrame</span><span class="p">;</span> <span class="c1">//4</span>
    
    <span class="c1">//消失转场</span>
    <span class="n">self</span><span class="p">.</span><span class="n">dismissScaleAnimation</span><span class="p">.</span><span class="n">selectCell</span> <span class="o">=</span> <span class="n">cell</span><span class="p">;</span> <span class="c1">// 5</span>
    <span class="n">self</span><span class="p">.</span><span class="n">dismissScaleAnimation</span><span class="p">.</span><span class="n">originCellFrame</span>  <span class="o">=</span> <span class="n">cellFrame</span><span class="p">;</span> <span class="c1">//6</span>
    <span class="n">self</span><span class="p">.</span><span class="n">dismissScaleAnimation</span><span class="p">.</span><span class="n">finalCellFrame</span> <span class="o">=</span> <span class="n">cellConvertedFrame</span><span class="p">;</span> <span class="c1">//7</span>
    
    <span class="n">awemeVC</span><span class="p">.</span><span class="n">modalPresentationStyle</span> <span class="o">=</span> <span class="n">UIModalPresentationOverCurrentContext</span><span class="p">;</span> <span class="c1">//8</span>
    <span class="n">self</span><span class="p">.</span><span class="n">modalPresentationStyle</span> <span class="o">=</span> <span class="n">UIModalPresentationCurrentContext</span><span class="p">;</span> <span class="c1">//9</span>
    
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">leftDragInteractiveTransition</span> <span class="nf">wireToViewController</span><span class="p">:</span><span class="n">awemeVC</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">presentViewController</span><span class="p">:</span><span class="n">awemeVC</span> <span class="nf">animated</span><span class="p">:</span><span class="nb">YES</span> <span class="n">completion</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span>

</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">0</code> 处代码使我们需要把当前的类做为转场的代理<br /> <code class="language-plaintext highlighter-rouge">1</code> 这里我们要拿出cell这个view<br /> <code class="language-plaintext highlighter-rouge">2</code> 拿出当前Cell的frame坐标<br /> <code class="language-plaintext highlighter-rouge">3</code> cell的坐标转成屏幕坐标<br /> <code class="language-plaintext highlighter-rouge">4</code> 设置弹出时候需要cell在屏幕的位置坐标<br /> <code class="language-plaintext highlighter-rouge">5</code> 设置消失转场需要的选中cell视图<br /> <code class="language-plaintext highlighter-rouge">6</code> 设置消失转场原始cell坐标位置<br /> <code class="language-plaintext highlighter-rouge">7</code> 设置消失转场最终得cell屏幕坐标位置 用于消失完成回到原来位置的动画<br /> <code class="language-plaintext highlighter-rouge">8</code> 设置弹出得vc弹出样式 这个用于显示弹出VC得时候 默认底部使blua的高斯模糊<br /> <code class="language-plaintext highlighter-rouge">9</code> 设置当前VC的模态弹出样式为当前的弹出上下文</p><blockquote><p>5~7 步设置的消失转场动画 下面会讲解</p></blockquote><p>这里我们用的是前面讲上下滑的VC对象 大家不必担心 当它是一个普通的UIViewController即可</p><p>## 实现转场所需要的代理</p><p>首先在需要实现<code class="language-plaintext highlighter-rouge">UIViewControllerTransitioningDelegate</code>这个代理</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre> <span class="cp">#pragma mark -
#pragma mark - UIViewControllerAnimatedTransitioning Delegate
</span><span class="k">-</span> <span class="p">(</span><span class="n">nullable</span> <span class="n">id</span> <span class="o">&lt;</span><span class="n">UIViewControllerAnimatedTransitioning</span><span class="o">&gt;</span><span class="p">)</span><span class="nf">animationControllerForPresentedController</span><span class="p">:(</span><span class="n">UIViewController</span> <span class="o">*</span><span class="p">)</span><span class="nv">presented</span> <span class="nf">presentingController</span><span class="p">:(</span><span class="n">UIViewController</span> <span class="o">*</span><span class="p">)</span><span class="nv">presenting</span> <span class="nf">sourceController</span><span class="p">:(</span><span class="n">UIViewController</span> <span class="o">*</span><span class="p">)</span><span class="nv">source</span> <span class="p">{</span>
    
    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">presentScaleAnimation</span><span class="p">;</span> <span class="c1">//present VC</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">nullable</span> <span class="n">id</span> <span class="o">&lt;</span><span class="n">UIViewControllerAnimatedTransitioning</span><span class="o">&gt;</span><span class="p">)</span><span class="nf">animationControllerForDismissedController</span><span class="p">:(</span><span class="n">UIViewController</span> <span class="o">*</span><span class="p">)</span><span class="nv">dismissed</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">dismissScaleAnimation</span><span class="p">;</span> <span class="c1">//dismiss VC</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">nullable</span> <span class="n">id</span> <span class="o">&lt;</span><span class="n">UIViewControllerInteractiveTransitioning</span><span class="o">&gt;</span><span class="p">)</span><span class="nf">interactionControllerForDismissal</span><span class="p">:(</span><span class="n">id</span> <span class="o">&lt;</span><span class="n">UIViewControllerAnimatedTransitioning</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">animator</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">leftDragInteractiveTransition</span><span class="p">.</span><span class="n">isInteracting</span><span class="p">?</span> <span class="n">self</span><span class="p">.</span><span class="n">leftDragInteractiveTransition</span><span class="p">:</span> <span class="nb">nil</span><span class="p">;</span>
<span class="p">}</span>

</pre></table></code></div></div><p>这里面我们看到我们分别返回了</p><ul><li>弹出动画实例<code class="language-plaintext highlighter-rouge">self.presentScaleAnimation</code><li>dismiss动画实例<code class="language-plaintext highlighter-rouge">self.dismissScaleAnimation</code><li>以及<code class="language-plaintext highlighter-rouge">self.leftDragInteractiveTransition</code>实例用于负责转场切换的具体实现</ul><p>所以我们需要在 当前的VC中声明3个成员变量 并初始化</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">PresentScaleAnimation</span> <span class="o">*</span><span class="n">presentScaleAnimation</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">DismissScaleAnimation</span> <span class="o">*</span><span class="n">dismissScaleAnimation</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">DragLeftInteractiveTransition</span> <span class="o">*</span><span class="n">leftDragInteractiveTransition</span><span class="p">;</span>
</pre></table></code></div></div><p>并在<code class="language-plaintext highlighter-rouge">viewDidLoad:</code>方法中初始化一下</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre> <span class="c1">//转场的两个动画</span>
<span class="n">self</span><span class="p">.</span><span class="n">presentScaleAnimation</span> <span class="o">=</span> <span class="p">[[</span><span class="n">PresentScaleAnimation</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
<span class="n">self</span><span class="p">.</span><span class="n">dismissScaleAnimation</span> <span class="o">=</span> <span class="p">[[</span><span class="n">DismissScaleAnimation</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
<span class="n">self</span><span class="p">.</span><span class="n">leftDragInteractiveTransition</span> <span class="o">=</span> <span class="p">[</span><span class="n">DragLeftInteractiveTransition</span> <span class="nf">new</span><span class="p">];</span>
</pre></table></code></div></div><p>这里我说一下这三个成员都负责啥事</p><p>首先<code class="language-plaintext highlighter-rouge">DragLeftInteractiveTransition</code>类负责转场的 手势 过程,就是pan手势在这个类里面实现,并继承自<code class="language-plaintext highlighter-rouge">UIPercentDrivenInteractiveTransition</code>类,这是iOS7以后系统提供的转场基类必须在<code class="language-plaintext highlighter-rouge">interactionControllerForDismissal:</code>代理协议中返回这个类或者子类的实例对象,所以我们生成一个成员变量<code class="language-plaintext highlighter-rouge">self.leftDragInteractiveTransition</code></p><p>其次是弹出present和消失dismiss的动画类,这俩类其实是负责简单的手势完成之后的动画.</p><p>这两个类都是继承自NSObject并实现<code class="language-plaintext highlighter-rouge">UIViewControllerAnimatedTransitioning</code>协议的类,这个协议里面有 需要你复写某些方法返回具体的动画执行时间,和中间过程中我们需要的相关的容器视图以及控制器的视图实例,当我们自己执行完成之后调用相关的block回答告知转场是否完成就行了.</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre> <span class="k">@implementation</span> <span class="nc">PresentScaleAnimation</span>

<span class="k">-</span> <span class="p">(</span><span class="n">NSTimeInterval</span><span class="p">)</span><span class="nf">transitionDuration</span><span class="p">:(</span><span class="n">id</span> <span class="o">&lt;</span><span class="n">UIViewControllerContextTransitioning</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">transitionContext</span><span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">animateTransition</span><span class="p">:(</span><span class="n">id</span> <span class="o">&lt;</span><span class="n">UIViewControllerContextTransitioning</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">transitionContext</span><span class="p">{</span>
    <span class="n">UIViewController</span> <span class="o">*</span><span class="n">toVC</span> <span class="o">=</span> <span class="p">[</span><span class="n">transitionContext</span> <span class="nf">viewControllerForKey</span><span class="p">:</span><span class="n">UITransitionContextToViewControllerKey</span><span class="p">];</span>    
    <span class="k">if</span> <span class="p">(</span><span class="n">CGRectEqualToRect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cellConvertFrame</span><span class="p">,</span> <span class="n">CGRectZero</span><span class="p">))</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">transitionContext</span> <span class="nf">completeTransition</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">CGRect</span> <span class="n">initialFrame</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cellConvertFrame</span><span class="p">;</span>

    <span class="n">UIView</span> <span class="o">*</span><span class="n">containerView</span> <span class="o">=</span> <span class="p">[</span><span class="n">transitionContext</span> <span class="nf">containerView</span><span class="p">];</span>
    <span class="p">[</span><span class="n">containerView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">toVC</span><span class="p">.</span><span class="n">view</span><span class="p">];</span>

    <span class="n">CGRect</span> <span class="n">finalFrame</span> <span class="o">=</span> <span class="p">[</span><span class="n">transitionContext</span> <span class="nf">finalFrameForViewController</span><span class="p">:</span><span class="n">toVC</span><span class="p">];</span>
    <span class="n">NSTimeInterval</span> <span class="n">duration</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">transitionDuration</span><span class="p">:</span><span class="n">transitionContext</span><span class="p">];</span>

    <span class="n">toVC</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">CGPointMake</span><span class="p">(</span><span class="n">initialFrame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">initialFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">initialFrame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">initialFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">toVC</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">CGAffineTransformMakeScale</span><span class="p">(</span><span class="n">initialFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="o">/</span><span class="n">finalFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">initialFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="o">/</span><span class="n">finalFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

    <span class="p">[</span><span class="n">UIView</span> <span class="nf">animateWithDuration</span><span class="p">:</span><span class="n">duration</span>
                          <span class="nl">delay:</span><span class="mi">0</span>
         <span class="nl">usingSpringWithDamping:</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span>
          <span class="nl">initialSpringVelocity:</span><span class="mi">1</span>
                        <span class="nl">options:</span><span class="n">UIViewAnimationOptionLayoutSubviews</span>
                     <span class="nl">animations:</span><span class="o">^</span><span class="p">{</span>
                         <span class="n">toVC</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">CGPointMake</span><span class="p">(</span><span class="n">finalFrame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">finalFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">finalFrame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">finalFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
                         <span class="n">toVC</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">CGAffineTransformMakeScale</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                     <span class="p">}</span> <span class="nf">completion</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">BOOL</span> <span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
                         <span class="p">[</span><span class="n">transitionContext</span> <span class="nf">completeTransition</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
                     <span class="p">}];</span>
<span class="p">}</span>
<span class="k">@end</span>
</pre></table></code></div></div><p>很简单.</p><p>消失的动画 同上边差不多</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre><span class="k">@interface</span> <span class="nc">DismissScaleAnimation</span> <span class="p">()</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">DismissScaleAnimation</span>

<span class="k">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="n">init</span> <span class="p">{</span>
    <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nf">init</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_centerFrame</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">((</span><span class="n">ScreenWidth</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">ScreenHeight</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">NSTimeInterval</span><span class="p">)</span><span class="nf">transitionDuration</span><span class="p">:(</span><span class="n">id</span> <span class="o">&lt;</span><span class="n">UIViewControllerContextTransitioning</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">transitionContext</span><span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">.</span><span class="mi">25</span><span class="n">f</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">animateTransition</span><span class="p">:(</span><span class="n">id</span> <span class="o">&lt;</span><span class="n">UIViewControllerContextTransitioning</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">transitionContext</span><span class="p">{</span>
    <span class="n">UIViewController</span> <span class="o">*</span><span class="n">fromVC</span> <span class="o">=</span> <span class="p">[</span><span class="n">transitionContext</span> <span class="nf">viewControllerForKey</span><span class="p">:</span><span class="n">UITransitionContextFromViewControllerKey</span><span class="p">];</span>
<span class="c1">//    UINavigationController *toNavigation = (UINavigationController *)[transitionContext viewControllerForKey:UITransitionContextToViewControllerKey];</span>
<span class="c1">//    UIViewController *toVC = [toNavigation viewControllers].firstObject;</span>
    
    
    <span class="n">UIView</span> <span class="o">*</span><span class="n">snapshotView</span><span class="p">;</span>
    <span class="n">CGFloat</span> <span class="n">scaleRatio</span><span class="p">;</span>
    <span class="n">CGRect</span> <span class="n">finalFrame</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">finalCellFrame</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">selectCell</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CGRectEqualToRect</span><span class="p">(</span><span class="n">finalFrame</span><span class="p">,</span> <span class="n">CGRectZero</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">snapshotView</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">selectCell</span> <span class="nf">snapshotViewAfterScreenUpdates</span><span class="p">:</span><span class="nb">NO</span><span class="p">];</span>
        <span class="n">scaleRatio</span> <span class="o">=</span> <span class="n">fromVC</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="o">/</span><span class="n">self</span><span class="p">.</span><span class="n">selectCell</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
        <span class="n">snapshotView</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">zPosition</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
        <span class="n">snapshotView</span> <span class="o">=</span> <span class="p">[</span><span class="n">fromVC</span><span class="p">.</span><span class="n">view</span> <span class="nf">snapshotViewAfterScreenUpdates</span><span class="p">:</span><span class="nb">NO</span><span class="p">];</span>
        <span class="n">scaleRatio</span> <span class="o">=</span> <span class="n">fromVC</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="o">/</span><span class="n">ScreenWidth</span><span class="p">;</span>
        <span class="n">finalFrame</span> <span class="o">=</span> <span class="n">_centerFrame</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="n">UIView</span> <span class="o">*</span><span class="n">containerView</span> <span class="o">=</span> <span class="p">[</span><span class="n">transitionContext</span> <span class="nf">containerView</span><span class="p">];</span>
    <span class="p">[</span><span class="n">containerView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">snapshotView</span><span class="p">];</span>
    
    <span class="n">NSTimeInterval</span> <span class="n">duration</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">transitionDuration</span><span class="p">:</span><span class="n">transitionContext</span><span class="p">];</span>
    
    <span class="n">fromVC</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">;</span>
    <span class="n">snapshotView</span><span class="p">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">fromVC</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">center</span><span class="p">;</span>
    <span class="n">snapshotView</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">CGAffineTransformMakeScale</span><span class="p">(</span><span class="n">scaleRatio</span><span class="p">,</span> <span class="n">scaleRatio</span><span class="p">);</span>
    <span class="p">[</span><span class="n">UIView</span> <span class="nf">animateWithDuration</span><span class="p">:</span><span class="n">duration</span>
                          <span class="nl">delay:</span><span class="mi">0</span>
         <span class="nl">usingSpringWithDamping:</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span>
          <span class="nl">initialSpringVelocity:</span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span>
                        <span class="nl">options:</span><span class="n">UIViewAnimationOptionCurveEaseInOut</span>
                     <span class="nl">animations:</span><span class="o">^</span><span class="p">{</span>
                         <span class="n">snapshotView</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">CGAffineTransformMakeScale</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">);</span>
                         <span class="n">snapshotView</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">finalFrame</span><span class="p">;</span>
                     <span class="p">}</span> <span class="nf">completion</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">BOOL</span> <span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
                         <span class="p">[</span><span class="n">transitionContext</span> <span class="nf">finishInteractiveTransition</span><span class="p">];</span>
                         <span class="p">[</span><span class="n">transitionContext</span> <span class="nf">completeTransition</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
                         <span class="p">[</span><span class="n">snapshotView</span> <span class="nf">removeFromSuperview</span><span class="p">];</span>
                     <span class="p">}];</span>
<span class="p">}</span>



<span class="k">@end</span>
</pre></table></code></div></div><p>我们重点需要说一下 转场过渡的类<code class="language-plaintext highlighter-rouge">DragLeftInteractiveTransition</code>继承自<code class="language-plaintext highlighter-rouge">UIPercentDrivenInteractiveTransition</code>负责转场过程,</p><p>头文件的声明</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="k">@interface</span> <span class="nc">DragLeftInteractiveTransition</span> <span class="p">:</span> <span class="nc">UIPercentDrivenInteractiveTransition</span>

<span class="cm">/** 是否正在拖动返回 标识是否正在使用转场的交互中 */</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">assign</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">isInteracting</span><span class="p">;</span>


<span class="cm">/**
 设置需要返回的VC
 
 @param viewController 控制器实例
 */</span>
<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">wireToViewController</span><span class="p">:(</span><span class="n">UIViewController</span> <span class="o">*</span><span class="p">)</span><span class="nv">viewController</span><span class="p">;</span>


<span class="k">@end</span>

</pre></table></code></div></div><p>实现</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
</pre><td class="rouge-code"><pre>
<span class="k">@interface</span> <span class="nc">DragLeftInteractiveTransition</span> <span class="p">()</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UIViewController</span> <span class="o">*</span><span class="n">presentingVC</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">assign</span><span class="p">)</span> <span class="n">CGPoint</span> <span class="n">viewControllerCenter</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">CALayer</span> <span class="o">*</span><span class="n">transitionMaskLayer</span><span class="p">;</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">DragLeftInteractiveTransition</span>

<span class="cp">#pragma mark -
#pragma mark - override methods 复写方法
</span><span class="k">-</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">completionSpeed</span><span class="p">{</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">percentComplete</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">updateInteractiveTransition</span><span class="p">:(</span><span class="n">CGFloat</span><span class="p">)</span><span class="nv">percentComplete</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"%.2f"</span><span class="p">,</span><span class="n">percentComplete</span><span class="p">);</span>
    
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">cancelInteractiveTransition</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"转场取消"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">finishInteractiveTransition</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"转场完成"</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">-</span> <span class="p">(</span><span class="n">CALayer</span> <span class="o">*</span><span class="p">)</span><span class="n">transitionMaskLayer</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_transitionMaskLayer</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_transitionMaskLayer</span> <span class="o">=</span> <span class="p">[</span><span class="n">CALayer</span> <span class="nf">layer</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_transitionMaskLayer</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#pragma mark -
#pragma mark - private methods 私有方法
</span><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">prepareGestureRecognizerInView</span><span class="p">:(</span><span class="n">UIView</span><span class="o">*</span><span class="p">)</span><span class="nv">view</span> <span class="p">{</span>
    <span class="n">UIPanGestureRecognizer</span> <span class="o">*</span><span class="n">gesture</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIPanGestureRecognizer</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithTarget</span><span class="p">:</span><span class="n">self</span> <span class="nf">action</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">handleGesture</span><span class="o">:</span><span class="p">)];</span>
    <span class="p">[</span><span class="n">view</span> <span class="nf">addGestureRecognizer</span><span class="p">:</span><span class="n">gesture</span><span class="p">];</span>
<span class="p">}</span>

<span class="cp">#pragma mark -
#pragma mark - event response 所有触发的事件响应 按钮、通知、分段控件等
</span><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">handleGesture</span><span class="p">:(</span><span class="n">UIPanGestureRecognizer</span> <span class="o">*</span><span class="p">)</span><span class="nv">gestureRecognizer</span> <span class="p">{</span>
    <span class="n">UIView</span> <span class="o">*</span><span class="n">vcView</span> <span class="o">=</span> <span class="n">gestureRecognizer</span><span class="p">.</span><span class="n">view</span><span class="p">;</span>
    <span class="n">CGPoint</span> <span class="n">translation</span> <span class="o">=</span> <span class="p">[</span><span class="n">gestureRecognizer</span> <span class="nf">translationInView</span><span class="p">:</span><span class="n">vcView</span><span class="p">.</span><span class="n">superview</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="p">.</span><span class="n">isInteracting</span> <span class="o">&amp;&amp;</span>
       <span class="p">(</span><span class="n">translation</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
        <span class="n">translation</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
        <span class="n">translation</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">translation</span><span class="p">.</span><span class="n">y</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">gestureRecognizer</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">UIGestureRecognizerStateBegan</span><span class="p">:{</span>
            <span class="c1">//修复当从右侧向左滑动的时候的bug 避免开始的时候从又向左滑动 当未开始的时候</span>
            <span class="n">CGPoint</span> <span class="n">vel</span> <span class="o">=</span> <span class="p">[</span><span class="n">gestureRecognizer</span> <span class="nf">velocityInView</span><span class="p">:</span><span class="n">gestureRecognizer</span><span class="p">.</span><span class="n">view</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="p">.</span><span class="n">isInteracting</span> <span class="o">&amp;&amp;</span> <span class="n">vel</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">self</span><span class="p">.</span><span class="n">isInteracting</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">self</span><span class="p">.</span><span class="n">transitionMaskLayer</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">vcView</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>
            <span class="n">self</span><span class="p">.</span><span class="n">transitionMaskLayer</span><span class="p">.</span><span class="n">opaque</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
            <span class="n">self</span><span class="p">.</span><span class="n">transitionMaskLayer</span><span class="p">.</span><span class="n">opacity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">self</span><span class="p">.</span><span class="n">transitionMaskLayer</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">whiteColor</span><span class="p">].</span><span class="n">CGColor</span><span class="p">;</span> <span class="c1">//必须有颜色不能透明</span>
            <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">transitionMaskLayer</span> <span class="nf">setNeedsDisplay</span><span class="p">];</span>
            <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">transitionMaskLayer</span> <span class="nf">displayIfNeeded</span><span class="p">];</span>
            <span class="n">self</span><span class="p">.</span><span class="n">transitionMaskLayer</span><span class="p">.</span><span class="n">anchorPoint</span> <span class="o">=</span> <span class="n">CGPointMake</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
            <span class="n">self</span><span class="p">.</span><span class="n">transitionMaskLayer</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">CGPointMake</span><span class="p">(</span><span class="n">vcView</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="n">vcView</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">);</span>
            <span class="n">vcView</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">transitionMaskLayer</span><span class="p">;</span>
            <span class="n">vcView</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">masksToBounds</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
            
            <span class="n">self</span><span class="p">.</span><span class="n">isInteracting</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
        <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">UIGestureRecognizerStateChanged</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">CGFloat</span> <span class="n">progress</span> <span class="o">=</span> <span class="n">translation</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="p">[</span><span class="n">UIScreen</span> <span class="nf">mainScreen</span><span class="p">].</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">fminf</span><span class="p">(</span><span class="n">fmaxf</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
            
            <span class="n">CGFloat</span> <span class="n">ratio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">-</span> <span class="n">progress</span><span class="o">*</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="n">f</span><span class="p">;</span>
            <span class="p">[</span><span class="n">_presentingVC</span><span class="p">.</span><span class="n">view</span> <span class="nf">setCenter</span><span class="p">:</span><span class="n">CGPointMake</span><span class="p">(</span><span class="n">_viewControllerCenter</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">translation</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">_viewControllerCenter</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">translation</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)];</span>
            <span class="n">_presentingVC</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">CGAffineTransformMakeScale</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">ratio</span><span class="p">);</span>
            <span class="p">[</span><span class="n">self</span> <span class="nf">updateInteractiveTransition</span><span class="p">:</span><span class="n">progress</span><span class="p">];</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">UIGestureRecognizerStateCancelled</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">UIGestureRecognizerStateEnded</span><span class="p">:{</span>
            <span class="n">CGFloat</span> <span class="n">progress</span> <span class="o">=</span> <span class="n">translation</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="p">[</span><span class="n">UIScreen</span> <span class="nf">mainScreen</span><span class="p">].</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">fminf</span><span class="p">(</span><span class="n">fmaxf</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">progress</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">){</span>
                <span class="p">[</span><span class="n">UIView</span> <span class="nf">animateWithDuration</span><span class="p">:</span><span class="n">progress</span>
                                      <span class="nl">delay:</span><span class="mi">0</span>
                                    <span class="nl">options:</span><span class="n">UIViewAnimationOptionCurveEaseOut</span>
                                 <span class="nl">animations:</span><span class="o">^</span><span class="p">{</span>
                                     <span class="n">CGFloat</span> <span class="n">w</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIScreen</span> <span class="nf">mainScreen</span><span class="p">].</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
                                     <span class="n">CGFloat</span> <span class="n">h</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIScreen</span> <span class="nf">mainScreen</span><span class="p">].</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
                                     <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">presentingVC</span><span class="p">.</span><span class="n">view</span> <span class="nf">setCenter</span><span class="p">:</span><span class="n">CGPointMake</span><span class="p">(</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)];</span>
                                     <span class="n">self</span><span class="p">.</span><span class="n">presentingVC</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">CGAffineTransformMakeScale</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">);</span>
                                 <span class="p">}</span> <span class="nf">completion</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">BOOL</span> <span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
                                     <span class="n">self</span><span class="p">.</span><span class="n">isInteracting</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
                                     <span class="p">[</span><span class="n">self</span> <span class="nf">cancelInteractiveTransition</span><span class="p">];</span>
                                 <span class="p">}];</span>
            <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
                <span class="n">_isInteracting</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
                <span class="p">[</span><span class="n">self</span> <span class="nf">finishInteractiveTransition</span><span class="p">];</span>
                <span class="p">[</span><span class="n">_presentingVC</span> <span class="nf">dismissViewControllerAnimated</span><span class="p">:</span><span class="nb">YES</span> <span class="nf">completion</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="c1">//移除 遮罩</span>
            <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">transitionMaskLayer</span> <span class="nf">removeFromSuperlayer</span><span class="p">];</span>
            <span class="n">self</span><span class="p">.</span><span class="n">transitionMaskLayer</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
        <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#pragma mark -
#pragma mark - public methods 公有方法
</span><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">wireToViewController</span><span class="p">:(</span><span class="n">UIViewController</span> <span class="o">*</span><span class="p">)</span><span class="nv">viewController</span> <span class="p">{</span>
    <span class="n">self</span><span class="p">.</span><span class="n">presentingVC</span> <span class="o">=</span> <span class="n">viewController</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">viewControllerCenter</span> <span class="o">=</span> <span class="n">viewController</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">center</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">prepareGestureRecognizerInView</span><span class="p">:</span><span class="n">viewController</span><span class="p">.</span><span class="n">view</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>

</pre></table></code></div></div><p>我们对外提供了一个<code class="language-plaintext highlighter-rouge">wireToViewController:</code>方法用于外部需要创建转场使用.</p><p>前面的代码我们发现有一处</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">leftDragInteractiveTransition</span> <span class="nf">wireToViewController</span><span class="p">:</span><span class="n">awemeVC</span><span class="p">];</span>
<span class="p">[</span><span class="n">self</span> <span class="nf">presentViewController</span><span class="p">:</span><span class="n">awemeVC</span> <span class="nf">animated</span><span class="p">:</span><span class="nb">YES</span> <span class="n">completion</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
</pre></table></code></div></div><p>这里就是需要把我们要弹出的上下滑VC实例传进来,进来之后为VC的<code class="language-plaintext highlighter-rouge">self.view</code>加个<code class="language-plaintext highlighter-rouge">pan</code>手势,</p><p>复写方法中我们可以看到相关开始结束 完成过程的百分比相关方法复写</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="cp">#pragma mark -
#pragma mark - override methods 复写方法
</span><span class="k">-</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">completionSpeed</span><span class="p">{</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">percentComplete</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">updateInteractiveTransition</span><span class="p">:(</span><span class="n">CGFloat</span><span class="p">)</span><span class="nv">percentComplete</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"%.2f"</span><span class="p">,</span><span class="n">percentComplete</span><span class="p">);</span>
    
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">cancelInteractiveTransition</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"转场取消"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">finishInteractiveTransition</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"转场完成"</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>看是手势 出发前 先检查一下是否如下条件</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">UIView</span> <span class="o">*</span><span class="n">vcView</span> <span class="o">=</span> <span class="n">gestureRecognizer</span><span class="p">.</span><span class="n">view</span><span class="p">;</span>
<span class="n">CGPoint</span> <span class="n">translation</span> <span class="o">=</span> <span class="p">[</span><span class="n">gestureRecognizer</span> <span class="nf">translationInView</span><span class="p">:</span><span class="n">vcView</span><span class="p">.</span><span class="n">superview</span><span class="p">];</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="p">.</span><span class="n">isInteracting</span> <span class="o">&amp;&amp;</span>
   <span class="p">(</span><span class="n">translation</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
    <span class="n">translation</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
    <span class="n">translation</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">translation</span><span class="p">.</span><span class="n">y</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>拿出手势作用的视图,然后坐标转换,判断当前是否已经开始了动画,如果没开始 或者x坐标 &lt; y坐标是判断当前是否是超过边界范围等等异常case处理.</p><p>开始的时候需要注意下</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c1">//修复当从右侧向左滑动的时候的bug 避免开始的时候从又向左滑动 当未开始的时候</span>
<span class="n">CGPoint</span> <span class="n">vel</span> <span class="o">=</span> <span class="p">[</span><span class="n">gestureRecognizer</span> <span class="nf">velocityInView</span><span class="p">:</span><span class="n">gestureRecognizer</span><span class="p">.</span><span class="n">view</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="p">.</span><span class="n">isInteracting</span> <span class="o">&amp;&amp;</span> <span class="n">vel</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">self</span><span class="p">.</span><span class="n">isInteracting</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>然后 开始的时候加个蒙版做为view.mask 这样是为了解决tableView 超出contentSize的范围要隐藏</p><p>剩下的就是中间过程</p><p><strong>关键的核心代码</strong></p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">self</span> <span class="nf">updateInteractiveTransition</span><span class="p">:</span><span class="n">progress</span><span class="p">];</span>
</pre></table></code></div></div><blockquote><p>更新转场的进度 这是这个类的自带方法,调用就行了</p></blockquote><p>最后 手势结束</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="n">CGFloat</span> <span class="n">progress</span> <span class="o">=</span> <span class="n">translation</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="p">[</span><span class="n">UIScreen</span> <span class="nf">mainScreen</span><span class="p">].</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
<span class="n">progress</span> <span class="o">=</span> <span class="n">fminf</span><span class="p">(</span><span class="n">fmaxf</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">progress</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">){</span>
    <span class="p">[</span><span class="n">UIView</span> <span class="nf">animateWithDuration</span><span class="p">:</span><span class="n">progress</span>
                          <span class="nl">delay:</span><span class="mi">0</span>
                        <span class="nl">options:</span><span class="n">UIViewAnimationOptionCurveEaseOut</span>
                     <span class="nl">animations:</span><span class="o">^</span><span class="p">{</span>
                         <span class="n">CGFloat</span> <span class="n">w</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIScreen</span> <span class="nf">mainScreen</span><span class="p">].</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
                         <span class="n">CGFloat</span> <span class="n">h</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIScreen</span> <span class="nf">mainScreen</span><span class="p">].</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
                         <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">presentingVC</span><span class="p">.</span><span class="n">view</span> <span class="nf">setCenter</span><span class="p">:</span><span class="n">CGPointMake</span><span class="p">(</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">)];</span>
                         <span class="n">self</span><span class="p">.</span><span class="n">presentingVC</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">CGAffineTransformMakeScale</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">);</span>
                     <span class="p">}</span> <span class="nf">completion</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">BOOL</span> <span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
                         <span class="n">self</span><span class="p">.</span><span class="n">isInteracting</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
                         <span class="p">[</span><span class="n">self</span> <span class="nf">cancelInteractiveTransition</span><span class="p">];</span>
                     <span class="p">}];</span>
<span class="p">}</span><span class="k">else</span> <span class="p">{</span>
    <span class="n">_isInteracting</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">finishInteractiveTransition</span><span class="p">];</span>
    <span class="p">[</span><span class="n">_presentingVC</span> <span class="nf">dismissViewControllerAnimated</span><span class="p">:</span><span class="nb">YES</span> <span class="nf">completion</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span>
<span class="c1">//移除 遮罩</span>
<span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">transitionMaskLayer</span> <span class="nf">removeFromSuperlayer</span><span class="p">];</span>
<span class="n">self</span><span class="p">.</span><span class="n">transitionMaskLayer</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</pre></table></code></div></div><blockquote><p>这里设置0.2的容差 如果你觉得这个应该开放接口设置可自行封装.</p></blockquote><p>当用户取消的话记得调用<code class="language-plaintext highlighter-rouge">cancelInteractiveTransition</code>方法取消</p><p>完成的话调用<code class="language-plaintext highlighter-rouge">finishInteractiveTransition</code>完成转场</p><h1 id="总结">总结</h1><p>整个过程还是比较简单的 如果看过喵神的文章将会更加清晰的了解转场的三个过程 就是 弹出和消失动画 以及一个中间转场过程需要我们熟悉.</p><p>优化点: 在原开源工程中的demo转场右滑是有bug的,我做了一下如下判断</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">//修复当从右侧向左滑动的时候的bug 避免开始的时候从又向左滑动 当未开始的时候</span>
<span class="n">CGPoint</span> <span class="n">vel</span> <span class="o">=</span> <span class="p">[</span><span class="n">gestureRecognizer</span> <span class="nf">velocityInView</span><span class="p">:</span><span class="n">gestureRecognizer</span><span class="p">.</span><span class="n">view</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="p">.</span><span class="n">isInteracting</span> <span class="o">&amp;&amp;</span> <span class="n">vel</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">self</span><span class="p">.</span><span class="n">isInteracting</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">vel</code>这个变量 其实是判断当我们从右侧划入返回.修复了原来开源的一个bug</p><p>还有 原来开源中<code class="language-plaintext highlighter-rouge">tableView</code>的<code class="language-plaintext highlighter-rouge">contentSize</code>以外 区域露在外部,我用了一个mask的蒙版遮住了显示在外的区域.</p><p>唯一有些许遗憾的地方是抖音的左滑返回时候,有背景遮盖透明的渐变.这里由于时间关系和篇幅限制我没有花足够的时间调研.后续完善,写的不好请大家多多指教</p><p><a href="https://github.com/sunyazhou13/AwemeDemoTransition">最终得Demo在这里</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ios/'>iOS</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ios/" class="post-tag no-text-decoration" >iOS</a> <a href="/tags/%E5%8A%A8%E7%94%BB/" class="post-tag no-text-decoration" >动画</a> <a href="/tags/%E6%8A%96%E9%9F%B3%E5%8A%A8%E7%94%BB%E7%B3%BB%E5%88%97/" class="post-tag no-text-decoration" >抖音动画系列</a> <a href="/tags/objective-c/" class="post-tag no-text-decoration" >Objective-C</a> <a href="/tags/skills/" class="post-tag no-text-decoration" >skills</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 该博客文章由作者通过 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC BY 4.0</a> 进行授权。</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=iOS抖音的转场动画 - 迈腾大队长&url=https://www.sunyazhou.com/2018/12/AwemeTransition/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=iOS抖音的转场动画 - 迈腾大队长&u=https://www.sunyazhou.com/2018/12/AwemeTransition/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=iOS抖音的转场动画 - 迈腾大队长&url=https://www.sunyazhou.com/2018/12/AwemeTransition/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="http://service.weibo.com/share/share.php?title=iOS抖音的转场动画 - 迈腾大队长&url=https://www.sunyazhou.com/2018/12/AwemeTransition/" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>最近更新</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/2020/09/GCD/">阿里、字节：一套高效的iOS面试题之多线程</a><li><a href="/2024/01/arktsbasic/">ArkTS和ArkUI基础语法</a><li><a href="/2024/01/HarmonyPhoneSendFileTomacOS/">解决如何从鸿蒙手机传文件到macOS</a><li><a href="/2024/02/MotionShake/">运动传感器摇晃检测优化</a><li><a href="/2022/04/YZ3DMenu/">开源YZ3DMenu导航菜单</a></ul></div><div id="access-tags"> <span>热门标签</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/objective-c/">Objective C</a> <a class="post-tag" href="/tags/ios/">iOS</a> <a class="post-tag" href="/tags/macos/">macOS</a> <a class="post-tag" href="/tags/skills/">skills</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/swift/">Swift</a> <a class="post-tag" href="/tags/c++/">C++</a> <a class="post-tag" href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/">音视频</a> <a class="post-tag" href="/tags/avfoundation/">AVFoundation</a> <a class="post-tag" href="/tags/swiftui/">SwiftUI</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">文章目录</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>接下来阅读</h3><div class="card-deck mb-4"><div class="card"> <a href="/2018/11/AwemeTopBottomScrollDemo/"><div class="card-body"> <span class="timeago small" > 2018-11-06 <i class="unloaded">2018-11-06T17:55:09+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>iOS抖音的上下滑实现</h3><div class="text-muted small"><p> 前言 一直一来都在 研究抖音App做的短视频 上下滑动 的技术实现, 今天写了个demo,方便学习技术技巧和记录知识, 技术实现原理 UITableView 其实就是一个UITableView改变上下显示范围. talk is cheap show me the code 我说话不绕弯子,代码如下 实现起来非常简单 _tableView = [[UITableVie...</p></div></div></a></div><div class="card"> <a href="/2018/11/AwemeAlbumAnimation/"><div class="card-body"> <span class="timeago small" > 2018-11-08 <i class="unloaded">2018-11-08T11:52:06+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>iOS抖音右下角专辑动画</h3><div class="text-muted small"><p> 前言 前两天分享了 抖音 上下滑切换 ,今天给和大家分享的是抖音右小角底部的专辑动画 上图看下 再看下抖音的 具体实现思路 首先需要3涨素材 这个在demo中就可以找到哈 在文章底部demo中有 ContrainerView Background Layer Album (UIImageView) 我们首先写个 MusicAlbumView 继承自...</p></div></div></a></div><div class="card"> <a href="/2018/11/PlayLoadingAnimation/"><div class="card-body"> <span class="timeago small" > 2018-11-14 <i class="unloaded">2018-11-14T14:14:39+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>iOS视频加载动画</h3><div class="text-muted small"><p> 前言 这几天一直跟开源的抖音demo斗智斗勇,今天跟大家分享的是抖音中或者快手中加载视频的动画 上图看成品 实现原理 首先我创建一个视图 @interface ViewController () @property (nonatomic, strong) UIView *playLoadingView; @end @implementation ViewController...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/2018/12/DetectingPanGestureDirection/" class="btn btn-outline-primary"><p>探测UIPanGesture的滑动方向</p></a> <a href="/2018/12/FinalSummary/" class="btn btn-outline-primary"><p>2018年终总结</p></a></div><div class="utterances-container"> <script src="https://utteranc.es/client.js" repo="sunyazhou13/gitment-comments" issue-term="pathname" theme="photon-dark" crossorigin="anonymous" async> </script></div><script type="text/javascript"> $(function() { window.onmessage = evt => { if (evt.origin === 'https://utteranc.es') { toggle.updateCommentStyle(); window.onmessage = null; } } }); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/sunyazhou13">sunyazhou</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，否则本网站上的博客文章均由作者根据知识共享许可协议 - 署名标示 4.0（CC BY 4.0）进行授权许可。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本博客由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，使用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> 作为主题</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">热门标签</h4><a class="post-tag" href="/tags/objective-c/">Objective C</a> <a class="post-tag" href="/tags/ios/">iOS</a> <a class="post-tag" href="/tags/macos/">macOS</a> <a class="post-tag" href="/tags/skills/">skills</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/swift/">Swift</a> <a class="post-tag" href="/tags/c++/">C++</a> <a class="post-tag" href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/">音视频</a> <a class="post-tag" href="/tags/avfoundation/">AVFoundation</a> <a class="post-tag" href="/tags/swiftui/">SwiftUI</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.sunyazhou.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
