<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>Learning AV Foundation(五)播放视频 | 迈腾大队长</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="我是孙亚洲(@sunyazhou13),一名来自北国冰城的iOS开发者,走在成为圣贤的路上.">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Learning AV Foundation(五)播放视频 | 迈腾大队长">
    <meta name="twitter:description" content="我是孙亚洲(@sunyazhou13),一名来自北国冰城的iOS开发者,走在成为圣贤的路上.">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Learning AV Foundation(五)播放视频 | 迈腾大队长">
    <meta property="og:description" content="我是孙亚洲(@sunyazhou13),一名来自北国冰城的iOS开发者,走在成为圣贤的路上.">

    
    <meta name="author" content="sunyazhou">
    
    <link rel="stylesheet" href="/css/vno.css">
    <link rel="stylesheet" href="//apps.bdimg.com/libs/fontawesome/4.1.0/css/font-awesome.min.css">

    
    <link rel="icon" href="/images/favicon.ico">
    

    
    <link rel="apple-touch-icon" href="/images/logo.jpg">
    
    
    <meta name="generator" content="hexo"/>
    
    <link rel="alternate" type="application/rss+xml" title="迈腾大队长" href="/atom.xml">
    

    <link rel="canonical" href="https://www.sunyazhou.com/2018/03/04/20180304LearningAVFoundationPlayingVideo/"/>

    
    <link rel="author" href="https://plus.google.com/107423989995616646161"/>
    
    <!-- fancybox support -->
    
        <script src="/lib/jquery-3.3.1.min.js"></script>
        <link rel="stylesheet" href="/lib/fancybox/dist/jquery.fancybox.min.css">
        <script src="/lib/fancybox/dist/jquery.fancybox.min.js"></script>
        <script src="/js/wrapImage.js"></script>
    
</head>

<body class="home-template no-js">

    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>

    
<header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background.jpg)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/" title="前往 迈腾大队长 的主页"><img src="/images/logo2.jpg" width="80" alt="迈腾大队长 logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage for 迈腾大队长">迈腾大队长</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">不断学习, 与时俱进. - 始于2017</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">嗨,我是孙亚洲(@sunyazhou13),一名来自祖国北国冰城的iOS开发者.</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="访问博客" class="blog-button">文章</a></li>
            
              <li class="navigation__item"><a href="/archives">归档</a></li>
            
              <li class="navigation__item"><a href="/projects">作品</a></li>
            
              <li class="navigation__item"><a href="/aboutme">关于</a></li>
            
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  
  <li class="navigation__item">
    <a href="https://weibo.com/sunyazhou13" title="我的微博" target="_blank">
      <i class='social fa fa-weibo'></i>
      <span class="label">Weibo</span>
    </a>
  </li>


  <!-- Github -->
  
  <li class="navigation__item">
    <a href="https://github.com/sunyazhou13" title="查看我的GitHub主页" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>


<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  
  <li class="navigation__item">
    <a href="https://plus.google.com/107423989995616646161" title="Google+" target="_blank">
      <i class='social fa fa-google-plus-square'></i>
      <span class="label">Google+</span>
    </a>
  </li>


<!-- Facebook -->


<!-- Twitter -->

  <li class="navigation__item">
    <a href="https://twitter.com/sunyazhou" title="上Twitter找我" target="_blank">
      <i class='social fa fa-twitter'></i>
      <span class="label">Twitter</span>
    </a>
  </li>

<!-- instagram -->


  <li class="navigation__item">
    <a href="/atom.xml" title="RSS" target="_blank">
      <i class='social fa fa-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>


  <li class="navigation__item">
    <a href="mailto:sunyazhou13@163.com" title="邮件联系我" target="_blank">
      <i class='social fa fa-envelope'></i>
      <span class="label">Email</span>
    </a>
  </li>


  </ul>
</nav>

          </div>
        </div>

      </div>

    </div>

    <div class="panel-cover--overlay cover-red"></div>
  </div>
</header>


    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2018-03-04T08:56:06.000Z" class="post-list__meta--date date">2018-03-04</time>
 &#8226; <span class="post-meta__tags tags">分类&nbsp;
  <a class="tag-link" href="/tags/Learning-AV-Foundation/">Learning AV Foundation</a>, <a class="tag-link" href="/tags/iOS开发/">iOS开发</a>, <a class="tag-link" href="/tags/macOS开发/">macOS开发</a>

</span>
    </div>
    <h1 class="post-title">Learning AV Foundation(五)播放视频</h1>
  </header>

  <section class="post">
    <p><img src="https://gitee.com/sunyazhou/sunyazhou13.github.io-images/raw/master/20180304LearningAVFoundationPlayingVideo/5kAirplay.jpg"></p>
<h1 id="前言">前言</h1>
<p>很久没有写Learning AV Foundation相关的文章了,言归正传 本篇介绍一下简单的视频播放</p>
<p>了解视频播放之前我们来看戏<code>AVPlayer</code>需要的一些组件模型</p>
<figure>
<img src="https://gitee.com/sunyazhou/sunyazhou13.github.io-images/raw/master/20180304LearningAVFoundationPlayingVideo/AVPlayer.png" alt="AVPlayer组件模型"><figcaption>AVPlayer组件模型</figcaption>
</figure>
<h2 id="avplayer">AVPlayer</h2>
<p><code>AVPlayer</code>是一个用来播放基于基于时间的视听媒体的控制对象,支持播放:</p>
<ul>
<li>本地 媒体文件</li>
<li>异步下载 媒体文件</li>
<li>HTTP Live Streaming协议的流媒体 文件</li>
</ul>
<p><code>AVPlayer</code> 是个 逻辑层组件</p>
<p>(应用可以分为如下几层) &gt; UI层<br>
&gt; 业务逻辑层<br>
&gt; 持久层+网络层</p>
<p>如果播放<code>MP3</code>或<code>AAC</code>等音频文件, 是没有啥UI可视化的页面的。要是播放一个<code>QuickTime</code>的电影或一个<code>MPEG-4</code>视频, 就会搞得很不适应.<br>
如果要播放视频等功能设计到UI的话，可以使用<code>AVPlayerLayer</code>类。</p>
<blockquote>
<p>注意: <em><code>AVPlayer</code>只管理一个单独资源的播放, 如果播放多个可以使用<code>AVPlayer</code>的子类<code>AVQueuePlayer</code>, 用它来管理一个资源队列, 当需要在一个序列中播放多个条目或者 为音频、视频资源设置播放循环时刻使用这个类</em>.</p>
</blockquote>
<h2 id="avplayerlayer">AVPlayerLayer</h2>
<p><code>AVPlayerLayer</code>构建于 <code>Core Animation</code>之上, 是<code>AV Foundation</code>中能找到的位数不多的UI组件. <code>Core Animation</code> 是<code>Mac</code>和<code>iOS</code>平台上负责图形渲染与动画的基础框架,主要用于这些平台的美化和动画流畅度的提升. <code>Core Animation</code>本身具有基于时间的属性,并且由于它基于<code>OpenGL</code>,所以具有很好的性能.</p>
<p><code>AVPlayerLayer</code>扩展了<code>Core Animation</code> 的<code>CALayer</code>类, 并通过框架显示视频内容到屏幕上. 我们知道Layer是不响应事件的.</p>
<p>创建<code>AVPlayerLayer</code>需要实例化一个<code>AVPlayer</code>的对象，<code>AVPlayerLayer</code>有一个<code>videoGravity</code>属性可以设置三种类似填充模式的东西,用来拉扯和缩放的视频. 下面列举了16:9的视频置于4:3矩形范围来说明不同的<code>gravity</code>.</p>
<p>如下图:</p>
<p>__AVLayerVideoGravityResizeAspect__保持缩放比例 <img src="https://gitee.com/sunyazhou/sunyazhou13.github.io-images/raw/master/20180304LearningAVFoundationPlayingVideo/AVLayerVideoGravityResizeAspect.png"></p>
<p>__AVLayerVideoGravityResizeAspectFill__填充 <img src="https://gitee.com/sunyazhou/sunyazhou13.github.io-images/raw/master/20180304LearningAVFoundationPlayingVideo/AVLayerVideoGravityResizeAspectFill.png"></p>
<p>__AVLayerVideoGravityResize__拉伸</p>
<p><img src="https://gitee.com/sunyazhou/sunyazhou13.github.io-images/raw/master/20180304LearningAVFoundationPlayingVideo/AVLayerVideoGravityResize.png"></p>
<h2 id="avplayeritem">AVPlayerItem</h2>
<p>我们需要使用<code>AVPlayer</code>播放<code>AVAsset</code>,前面我知道<code>AVAsset</code>元数据里面有<code>创建时间</code>、<code>元数据</code>和<code>时长</code>等信息.但是并没有媒体中特定位置的方法.</p>
<p><strong>这是因为<code>AVAsset</code>模型只包含媒体资源的静态信息.这些不变的属性用来描述对象的静态信息.这就意味着仅使用<code>AVAsset</code>对象是不能实现播放功能的.如果播放我们需要使用<code>AVPlayerItem</code></strong></p>
<p><strong><code>AVPlayerItem</code>可以理解成是一个动态的<code>AVAsset</code>模型,</strong><br>
<code>AVPlayerItem</code>有<code>seekToTime:</code>方法和<code>presentationSize:</code>,<code>AVPlayerItem</code>由一个或多个媒体曲目组成.</p>
<p><code>AVPlayerItem</code>里面有`<code>AVPlayerItemTrack</code>轨道属性.</p>
<h2 id="播放示例">播放示例</h2>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">	<span class="keyword">self</span>.localURL = [[<span class="built_in">NSBundle</span> mainBundle] URLForResource:<span class="string">@"hubblecast"</span> withExtension:<span class="string">@"m4v"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AVAsset</span> *asset = [<span class="built_in">AVAsset</span> assetWithURL:<span class="keyword">self</span>.localURL];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">AVPlayerItem</span> *item = [<span class="built_in">AVPlayerItem</span> playerItemWithAsset:asset];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">AVPlayer</span> *player = [<span class="built_in">AVPlayer</span> playerWithPlayerItem:item];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">AVPlayerLayer</span> *layer = [<span class="built_in">AVPlayerLayer</span> playerLayerWithPlayer:player];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.view.layer addSublayer:layer];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个<code>AVPlayerItem</code>并没有任何代理告知我们是否已经开始播放,所以一般的搞法都是使用<code>KVO</code>去监听它的一个属性,<code>AVPlayerItemStatus</code></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, <span class="built_in">AVPlayerItemStatus</span>) &#123;</span><br><span class="line">	<span class="built_in">AVPlayerItemStatusUnknown</span>,</span><br><span class="line">	<span class="built_in">AVPlayerItemStatusReadyToPlay</span>,</span><br><span class="line">	<span class="built_in">AVPlayerItemStatusFailed</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>当它的<code>status</code>变成<code>AVPlayerItemStatusReadyToPlay</code>就说明已载入完成准备播放.</p>
<h2 id="cmtime">CMTime</h2>
<p>使用<code>CMTime</code>来处理各种音视频相关的时间操作,他是<code>CoreMedia</code>framework中的结构体.专门用于处理精确的时间,我们以前用的<code>NSTimeInterval</code>是存在计算不精确的问题(苹果官方说的).</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">CMTimeValue</span>	value;		<span class="comment">//分子</span></span><br><span class="line">	<span class="built_in">CMTimeScale</span>	timescale; <span class="comment">//分母</span></span><br><span class="line">	<span class="built_in">CMTimeFlags</span>	flags;		<span class="comment">//标记是否失效 eg. kCMTimeFlags_Valid, kCMTimeFlags_PositiveInfinity</span></span><br><span class="line">	<span class="built_in">CMTimeEpoch</span>	epoch;		</span><br><span class="line">&#125; <span class="built_in">CMTime</span>;</span><br></pre></td></tr></table></figure>
<p>这个结构体最关键的即使<code>value</code>(64位整形)和<code>timescale</code>(32位整形).</p>
<p>它表达时间的方式以分数表示比如:</p>
<p><code>0.5</code>秒</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CMTime</span> halfSecond = <span class="built_in">CMTimeMake</span>(<span class="number">1</span>, <span class="number">2</span>); <span class="comment">//0.5秒</span></span><br><span class="line"><span class="built_in">CMTime</span> fiveSecond = <span class="built_in">CMTimeMake</span>(<span class="number">5</span>, <span class="number">1</span>); <span class="comment">//5秒</span></span><br><span class="line"><span class="built_in">CMTime</span> oneSample = <span class="built_in">CMTimeMake</span>(<span class="number">1</span>, <span class="number">44100</span>); <span class="comment">//一个抽样的样本</span></span><br><span class="line"><span class="built_in">CMTime</span> zeroTime = kCMTimeZero;</span><br></pre></td></tr></table></figure>
<h2 id="创建自己的播放器">创建自己的播放器</h2>
<p>首先需要封装一个<code>player</code>,</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"TransportProtocol.h"</span></span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">AVPlayer</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PlayerView</span> : <span class="title">UIView</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="keyword">id</span> &lt;TransportProtocol&gt;  transport;</span><br><span class="line">- (<span class="keyword">id</span>)initWithPlayer:(<span class="built_in">AVPlayer</span> *)player;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>.m文件实现</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"PlayerView.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;AVFoundation/AVFoundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"THOverlayView.h"</span></span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PlayerView</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) THOverlayView *overlayView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">PlayerView</span></span></span><br><span class="line">+ (Class)layerClass&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">AVPlayerLayer</span> <span class="keyword">class</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)initWithPlayer:(<span class="built_in">AVPlayer</span> *)player&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> initWithFrame:<span class="built_in">CGRectZero</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.backgroundColor = [<span class="built_in">UIColor</span> blackColor];</span><br><span class="line">        <span class="keyword">self</span>.autoresizingMask = <span class="built_in">UIViewAutoresizingFlexibleWidth</span> | <span class="built_in">UIViewAutoresizingFlexibleHeight</span>;</span><br><span class="line">        [(<span class="built_in">AVPlayerLayer</span> *)[<span class="keyword">self</span> layer] setPlayer:player];</span><br><span class="line">        [[<span class="built_in">NSBundle</span> mainBundle] loadNibNamed:<span class="string">@"THOverlayView"</span> owner:<span class="keyword">self</span> options:<span class="literal">nil</span>];</span><br><span class="line">        [<span class="keyword">self</span> addSubview:<span class="keyword">self</span>.overlayView];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)layoutSubviews&#123;</span><br><span class="line">    [<span class="keyword">super</span> layoutSubviews];</span><br><span class="line">    <span class="keyword">self</span>.overlayView.frame = <span class="keyword">self</span>.bounds;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span> &lt;TransportProtocol&gt;)transport&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.overlayView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>transport 是播放器的视图点击视图代理等集成了 在一起</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">TransportDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line">- (<span class="keyword">void</span>)play;</span><br><span class="line">- (<span class="keyword">void</span>)pause;</span><br><span class="line">- (<span class="keyword">void</span>)stop;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)scrubbingDidStart;</span><br><span class="line">- (<span class="keyword">void</span>)scrubbedToTime:(<span class="built_in">NSTimeInterval</span>)time;</span><br><span class="line">- (<span class="keyword">void</span>)scrubbingDidEnd;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)jumpedToTime:(<span class="built_in">NSTimeInterval</span>)time;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@optional</span></span><br><span class="line">- (<span class="keyword">void</span>)subtitleSelected:(<span class="built_in">NSString</span> *)subtitle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">TransportProtocol</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">id</span> &lt;TransportDelegate&gt; delegate;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setTitle:(<span class="built_in">NSString</span> *)title;</span><br><span class="line">- (<span class="keyword">void</span>)setCurrentTime:(<span class="built_in">NSTimeInterval</span>)time duration:(<span class="built_in">NSTimeInterval</span>)duration;</span><br><span class="line">- (<span class="keyword">void</span>)setScrubbingTime:(<span class="built_in">NSTimeInterval</span>)time;</span><br><span class="line">- (<span class="keyword">void</span>)playbackComplete;</span><br><span class="line">- (<span class="keyword">void</span>)setSubtitles:(<span class="built_in">NSArray</span> *)subtitles;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>THOverlayView文件是顶层视图点击播放等等控件.</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PlayerController</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">UIView</span> *view;</span><br><span class="line">- (<span class="keyword">id</span>)initWithURL:(<span class="built_in">NSURL</span> *)assetURL;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>播放器的实现文件如下</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"PlayerController.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;AVFoundation/AVFoundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"TransportProtocol.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"PlayerView.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"AVAsset+Additions.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"UIAlertView+Additions.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"THThumbnail.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// AVPlayerItem's status property</span></span><br><span class="line"><span class="meta">#define STATUS_KEYPATH @<span class="meta-string">"status"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Refresh interval for timed observations of AVPlayer</span></span><br><span class="line"><span class="meta">#define REFRESH_INTERVAL 0.5f</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Define this constant for the key-value observation context.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">NSString</span> *PlayerItemStatusContext;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PlayerController</span> () &lt;<span class="title">TransportDelegate</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">AVAsset</span>               *asset;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">AVPlayerItem</span>          *playerItem;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">AVPlayer</span>              *player;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) PlayerView            *playerView;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">id</span> &lt;TransportProtocol&gt;  transport;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span>                    timeObserver;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span>                    itemEndObserver;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">float</span>                 lastPlaybackRate;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">AVAssetImageGenerator</span> *imageGenerator;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">PlayerController</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Setup</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)initWithURL:(<span class="built_in">NSURL</span> *)assetURL &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _asset = [<span class="built_in">AVAsset</span> assetWithURL:assetURL];                           <span class="comment">// 1</span></span><br><span class="line">        [<span class="keyword">self</span> prepareToPlay];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)prepareToPlay &#123;</span><br><span class="line">    <span class="built_in">NSArray</span> *keys = @[</span><br><span class="line">                      <span class="string">@"tracks"</span>,</span><br><span class="line">                      <span class="string">@"duration"</span>,</span><br><span class="line">                      <span class="string">@"commonMetadata"</span>,</span><br><span class="line">                      <span class="string">@"availableMediaCharacteristicsWithMediaSelectionOptions"</span></span><br><span class="line">                      ];</span><br><span class="line">    <span class="keyword">self</span>.playerItem = [<span class="built_in">AVPlayerItem</span> playerItemWithAsset:<span class="keyword">self</span>.asset          <span class="comment">// 2</span></span><br><span class="line">                           automaticallyLoadedAssetKeys:keys];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.playerItem addObserver:<span class="keyword">self</span>                                       <span class="comment">// 3</span></span><br><span class="line">                      forKeyPath:STATUS_KEYPATH</span><br><span class="line">                         options:<span class="number">0</span></span><br><span class="line">                         context:&amp;PlayerItemStatusContext];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.player = [<span class="built_in">AVPlayer</span> playerWithPlayerItem:<span class="keyword">self</span>.playerItem];          <span class="comment">// 4</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.playerView = [[PlayerView alloc] initWithPlayer:<span class="keyword">self</span>.player];    <span class="comment">// 5</span></span><br><span class="line">    <span class="keyword">self</span>.transport = <span class="keyword">self</span>.playerView.transport;</span><br><span class="line">    <span class="keyword">self</span>.transport.delegate = <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath</span><br><span class="line">                      ofObject:(<span class="keyword">id</span>)object</span><br><span class="line">                        change:(<span class="built_in">NSDictionary</span> *)change</span><br><span class="line">                       context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (context == &amp;PlayerItemStatusContext) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;                        <span class="comment">// 1</span></span><br><span class="line">            </span><br><span class="line">            [<span class="keyword">self</span>.playerItem removeObserver:<span class="keyword">self</span> forKeyPath:STATUS_KEYPATH];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>.playerItem.status == <span class="built_in">AVPlayerItemStatusReadyToPlay</span>) &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Set up time observers.                                   // 2</span></span><br><span class="line">                [<span class="keyword">self</span> addPlayerItemTimeObserver];</span><br><span class="line">                [<span class="keyword">self</span> addItemEndObserverForPlayerItem];</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">CMTime</span> duration = <span class="keyword">self</span>.playerItem.duration;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Synchronize the time display                             // 3</span></span><br><span class="line">                [<span class="keyword">self</span>.transport setCurrentTime:<span class="built_in">CMTimeGetSeconds</span>(kCMTimeZero)</span><br><span class="line">                                      duration:<span class="built_in">CMTimeGetSeconds</span>(duration)];</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Set the video title.</span></span><br><span class="line">                [<span class="keyword">self</span>.transport setTitle:<span class="keyword">self</span>.asset.title];                 <span class="comment">// 4</span></span><br><span class="line">                </span><br><span class="line">                [<span class="keyword">self</span>.player play];                                         <span class="comment">// 5</span></span><br><span class="line">                </span><br><span class="line">                [<span class="keyword">self</span> loadMediaOptions];</span><br><span class="line">                [<span class="keyword">self</span> generateThumbnails];</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                [<span class="built_in">UIAlertView</span> showAlertWithTitle:<span class="string">@"Error"</span></span><br><span class="line">                                        message:<span class="string">@"Failed to load video"</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)loadMediaOptions &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *mc = <span class="built_in">AVMediaCharacteristicLegible</span>;                            <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">AVMediaSelectionGroup</span> *group =</span><br><span class="line">    [<span class="keyword">self</span>.asset mediaSelectionGroupForMediaCharacteristic:mc];          <span class="comment">// 2</span></span><br><span class="line">    <span class="keyword">if</span> (group) &#123;</span><br><span class="line">        <span class="built_in">NSMutableArray</span> *subtitles = [<span class="built_in">NSMutableArray</span> array];                 <span class="comment">// 3</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">AVMediaSelectionOption</span> *option <span class="keyword">in</span> group.options) &#123;</span><br><span class="line">            [subtitles addObject:option.displayName];</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="keyword">self</span>.transport setSubtitles:subtitles];                            <span class="comment">// 4</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span>.transport setSubtitles:<span class="literal">nil</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)subtitleSelected:(<span class="built_in">NSString</span> *)subtitle &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *mc = <span class="built_in">AVMediaCharacteristicLegible</span>;</span><br><span class="line">    <span class="built_in">AVMediaSelectionGroup</span> *group =</span><br><span class="line">    [<span class="keyword">self</span>.asset mediaSelectionGroupForMediaCharacteristic:mc];          <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">BOOL</span> selected = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">AVMediaSelectionOption</span> *option <span class="keyword">in</span> group.options) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([option.displayName isEqualToString:subtitle]) &#123;</span><br><span class="line">            [<span class="keyword">self</span>.playerItem selectMediaOption:option                       <span class="comment">// 2</span></span><br><span class="line">                         inMediaSelectionGroup:group];</span><br><span class="line">            selected = <span class="literal">YES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!selected) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.playerItem selectMediaOption:<span class="literal">nil</span>                              <span class="comment">// 3</span></span><br><span class="line">                     inMediaSelectionGroup:group];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Time Observers</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addPlayerItemTimeObserver &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Create 0.5 second refresh interval - REFRESH_INTERVAL == 0.5</span></span><br><span class="line">    <span class="built_in">CMTime</span> interval =</span><br><span class="line">    <span class="built_in">CMTimeMakeWithSeconds</span>(REFRESH_INTERVAL, <span class="built_in">NSEC_PER_SEC</span>);              <span class="comment">// 1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Main dispatch queue</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_main_queue();                     <span class="comment">// 2</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Create callback block for time observer</span></span><br><span class="line">    __<span class="keyword">weak</span> PlayerController *weakSelf = <span class="keyword">self</span>;                             <span class="comment">// 3</span></span><br><span class="line">    <span class="keyword">void</span> (^callback)(<span class="built_in">CMTime</span> time) = ^(<span class="built_in">CMTime</span> time) &#123;</span><br><span class="line">        <span class="built_in">NSTimeInterval</span> currentTime = <span class="built_in">CMTimeGetSeconds</span>(time);</span><br><span class="line">        <span class="built_in">NSTimeInterval</span> duration = <span class="built_in">CMTimeGetSeconds</span>(weakSelf.playerItem.duration);</span><br><span class="line">        [weakSelf.transport setCurrentTime:currentTime duration:duration];  <span class="comment">// 4</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Add observer and store pointer for future use</span></span><br><span class="line">    <span class="keyword">self</span>.timeObserver =                                                     <span class="comment">// 5</span></span><br><span class="line">    [<span class="keyword">self</span>.player addPeriodicTimeObserverForInterval:interval</span><br><span class="line">                                              queue:queue</span><br><span class="line">                                         usingBlock:callback];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addItemEndObserverForPlayerItem &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> *name = <span class="built_in">AVPlayerItemDidPlayToEndTimeNotification</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSOperationQueue</span> *queue = [<span class="built_in">NSOperationQueue</span> mainQueue];</span><br><span class="line">    </span><br><span class="line">    __<span class="keyword">weak</span> PlayerController *weakSelf = <span class="keyword">self</span>;                             <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">void</span> (^callback)(<span class="built_in">NSNotification</span> *note) = ^(<span class="built_in">NSNotification</span> *notification) &#123;</span><br><span class="line">        [weakSelf.player seekToTime:kCMTimeZero                             <span class="comment">// 2</span></span><br><span class="line">                  completionHandler:^(<span class="built_in">BOOL</span> finished) &#123;</span><br><span class="line">                      [weakSelf.transport playbackComplete];                          <span class="comment">// 3</span></span><br><span class="line">                  &#125;];</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.itemEndObserver =                                                  <span class="comment">// 4</span></span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserverForName:name</span><br><span class="line">                                                      object:<span class="keyword">self</span>.playerItem</span><br><span class="line">                                                       queue:queue</span><br><span class="line">                                                  usingBlock:callback];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - THTransportDelegate Methods</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)play &#123;</span><br><span class="line">    [<span class="keyword">self</span>.player play];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)pause &#123;</span><br><span class="line">    <span class="keyword">self</span>.lastPlaybackRate = <span class="keyword">self</span>.player.rate;</span><br><span class="line">    [<span class="keyword">self</span>.player pause];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)stop &#123;</span><br><span class="line">    [<span class="keyword">self</span>.player setRate:<span class="number">0.0</span>f];</span><br><span class="line">    [<span class="keyword">self</span>.transport playbackComplete];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)jumpedToTime:(<span class="built_in">NSTimeInterval</span>)time &#123;</span><br><span class="line">    [<span class="keyword">self</span>.player seekToTime:<span class="built_in">CMTimeMakeWithSeconds</span>(time, <span class="built_in">NSEC_PER_SEC</span>)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)scrubbingDidStart &#123;                                                 <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">self</span>.lastPlaybackRate = <span class="keyword">self</span>.player.rate;</span><br><span class="line">    [<span class="keyword">self</span>.player pause];</span><br><span class="line">    [<span class="keyword">self</span>.player removeTimeObserver:<span class="keyword">self</span>.timeObserver];</span><br><span class="line">    <span class="keyword">self</span>.timeObserver = <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)scrubbedToTime:(<span class="built_in">NSTimeInterval</span>)time &#123;                               <span class="comment">// 2</span></span><br><span class="line">    [<span class="keyword">self</span>.playerItem cancelPendingSeeks];</span><br><span class="line">    [<span class="keyword">self</span>.player seekToTime:<span class="built_in">CMTimeMakeWithSeconds</span>(time, <span class="built_in">NSEC_PER_SEC</span>) toleranceBefore:kCMTimeZero toleranceAfter:kCMTimeZero];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)scrubbingDidEnd &#123;                                                   <span class="comment">// 3</span></span><br><span class="line">    [<span class="keyword">self</span> addPlayerItemTimeObserver];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.lastPlaybackRate &gt; <span class="number">0.0</span>f) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.player play];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Thumbnail Generation</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)generateThumbnails &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.imageGenerator =                                                   <span class="comment">// 1</span></span><br><span class="line">    [<span class="built_in">AVAssetImageGenerator</span> assetImageGeneratorWithAsset:<span class="keyword">self</span>.asset];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Generate the @2x equivalent</span></span><br><span class="line">    <span class="keyword">self</span>.imageGenerator.maximumSize = <span class="built_in">CGSizeMake</span>(<span class="number">200.0</span>f, <span class="number">0.0</span>f);             <span class="comment">// 2</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CMTime</span> duration = <span class="keyword">self</span>.asset.duration;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableArray</span> *times = [<span class="built_in">NSMutableArray</span> array];                         <span class="comment">// 3</span></span><br><span class="line">    <span class="built_in">CMTimeValue</span> increment = duration.value / <span class="number">20</span>;</span><br><span class="line">    <span class="built_in">CMTimeValue</span> currentValue = <span class="number">2.0</span> * duration.timescale;</span><br><span class="line">    <span class="keyword">while</span> (currentValue &lt;= duration.value) &#123;</span><br><span class="line">        <span class="built_in">CMTime</span> time = <span class="built_in">CMTimeMake</span>(currentValue, duration.timescale);</span><br><span class="line">        [times addObject:[<span class="built_in">NSValue</span> valueWithCMTime:time]];</span><br><span class="line">        currentValue += increment;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    __block <span class="built_in">NSUInteger</span> imageCount = times.count;                            <span class="comment">// 4</span></span><br><span class="line">    __block <span class="built_in">NSMutableArray</span> *images = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">AVAssetImageGeneratorCompletionHandler</span> handler;                         <span class="comment">// 5</span></span><br><span class="line">    </span><br><span class="line">    handler = ^(<span class="built_in">CMTime</span> requestedTime,</span><br><span class="line">                <span class="built_in">CGImageRef</span> imageRef,</span><br><span class="line">                <span class="built_in">CMTime</span> actualTime,</span><br><span class="line">                <span class="built_in">AVAssetImageGeneratorResult</span> result,</span><br><span class="line">                <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (result == <span class="built_in">AVAssetImageGeneratorSucceeded</span>) &#123;                     <span class="comment">// 6</span></span><br><span class="line">            <span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithCGImage:imageRef];</span><br><span class="line">            <span class="keyword">id</span> thumbnail =</span><br><span class="line">            [THThumbnail thumbnailWithImage:image time:actualTime];</span><br><span class="line">            [images addObject:thumbnail];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"Error: %@"</span>, [error localizedDescription]);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// If the decremented image count is at 0, we're all done.</span></span><br><span class="line">        <span class="keyword">if</span> (--imageCount == <span class="number">0</span>) &#123;                                            <span class="comment">// 7</span></span><br><span class="line">            <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                <span class="built_in">NSString</span> *name = THThumbnailsGeneratedNotification;</span><br><span class="line">                <span class="built_in">NSNotificationCenter</span> *nc = [<span class="built_in">NSNotificationCenter</span> defaultCenter];</span><br><span class="line">                [nc postNotificationName:name object:images];</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.imageGenerator generateCGImagesAsynchronouslyForTimes:times       <span class="comment">// 8</span></span><br><span class="line">                                              completionHandler:handler];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Housekeeping</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UIView</span> *)view &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.playerView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.itemEndObserver) &#123;                                             <span class="comment">// 5</span></span><br><span class="line">        <span class="built_in">NSNotificationCenter</span> *nc = [<span class="built_in">NSNotificationCenter</span> defaultCenter];</span><br><span class="line">        [nc removeObserver:<span class="keyword">self</span>.itemEndObserver</span><br><span class="line">                      name:<span class="built_in">AVPlayerItemDidPlayToEndTimeNotification</span></span><br><span class="line">                    object:<span class="keyword">self</span>.player.currentItem];</span><br><span class="line">        <span class="keyword">self</span>.itemEndObserver = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>这里说一下如何监听时间从而得知播放时间回调</p>
<h3 id="监听时间">监听时间</h3>
<p>当播放器播放的时候我们无法得知播放到播放器的哪个位置,为了解决这个问题<code>AVPlayerItem</code>添加了两个监听播放的方法以及具体的用法<code>API</code>.</p>
<h4 id="定期监听">定期监听</h4>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)addPeriodicTimeObserverForInterval:(<span class="built_in">CMTime</span>)interval</span><br><span class="line">                                   queue:(<span class="keyword">nullable</span> <span class="built_in">dispatch_queue_t</span>)queue</span><br><span class="line">                              usingBlock:(<span class="keyword">void</span> (^)(<span class="built_in">CMTime</span> time))block;</span><br></pre></td></tr></table></figure>
<p>这里主要是为了随着时间的变化移动播放器seek位置更新时间显示,通过<code>AVPlayer</code>的<code>addPeriodicTimeObserverForInterval:queue:usingBlock:</code> 来监听播放时间的变化</p>
<ul>
<li><code>interv</code><em>监听周期的间隔<code>CMTime</code></em></li>
<li><code>queue</code> <em>通知发送的顺序调度队列,一般我们都放在主线程回掉.(注意这里不能放在并行队列中)</em></li>
<li><code>block</code> <em>指定周期的时间回调.</em></li>
</ul>
<p>下面是示例代码</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)addPlayerItemTimeObserver &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Create 0.5 second refresh interval - REFRESH_INTERVAL == 0.5</span></span><br><span class="line">    <span class="built_in">CMTime</span> interval =</span><br><span class="line">    <span class="built_in">CMTimeMakeWithSeconds</span>(REFRESH_INTERVAL, <span class="built_in">NSEC_PER_SEC</span>);              <span class="comment">// 1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Main dispatch queue</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_main_queue();                     <span class="comment">// 2</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Create callback block for time observer</span></span><br><span class="line">    __<span class="keyword">weak</span> PlayerController *weakSelf = <span class="keyword">self</span>;                             <span class="comment">// 3</span></span><br><span class="line">    <span class="keyword">void</span> (^callback)(<span class="built_in">CMTime</span> time) = ^(<span class="built_in">CMTime</span> time) &#123;</span><br><span class="line">        <span class="built_in">NSTimeInterval</span> currentTime = <span class="built_in">CMTimeGetSeconds</span>(time);</span><br><span class="line">        <span class="built_in">NSTimeInterval</span> duration = <span class="built_in">CMTimeGetSeconds</span>(weakSelf.playerItem.duration);</span><br><span class="line">        [weakSelf.transport setCurrentTime:currentTime duration:duration];  <span class="comment">// 4</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Add observer and store pointer for future use</span></span><br><span class="line">    <span class="keyword">self</span>.timeObserver =                                                     <span class="comment">// 5</span></span><br><span class="line">    [<span class="keyword">self</span>.player addPeriodicTimeObserverForInterval:interval</span><br><span class="line">                                              queue:queue</span><br><span class="line">                                         usingBlock:callback];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="边界监听">边界监听</h4>
<p>什么叫边界监听呢?就是播放器播放到某个时间的触发的 时间位置.</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)addBoundaryTimeObserverForTimes:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSValue</span> *&gt; *)times</span><br><span class="line">                                queue:(<span class="keyword">nullable</span> <span class="built_in">dispatch_queue_t</span>)queue</span><br><span class="line">                           usingBlock:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))block;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>times</code> <em>CMTime值组成一个<code>NSArray</code>,这里面定义的一个时间点的数组.eg: 25% 50% 75%等时间点.</em></li>
<li><code>queue</code> <em>通知发送的顺序调度队列,一般我们都放在主线程回掉.(注意这里不能放在并行队列中)</em></li>
<li><code>block</code> <em>指定周期的时间回调.</em></li>
</ul>
<h3 id="显示字幕">显示字幕</h3>
<p><code>AVPlayerLayer</code>里有两个类来处理字幕</p>
<ul>
<li>AVMediaSelectionGroup</li>
<li>AVMediaSelectionOption</li>
</ul>
<p><code>AVMediaSelectionOption</code> 用于表示<code>AVAsset</code>备用媒体显示.在前几篇中我讲过一个媒体元数据中有<code>音频轨</code>、<code>视频轨</code>、<code>字幕轨</code>,<code>备用相机角度</code>等.</p>
<p>我们如果想找出字幕的话需要用到<code>AVAsset</code>的<code>availableMediaCharacteristicsWithMediaSelectionOptions</code>属性.</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span>&lt;<span class="built_in">AVMediaCharacteristic</span>&gt; *availableMediaCharacteristicsWithMediaSelectionOptions <span class="built_in">NS_AVAILABLE</span>(<span class="number">10</span>_8, <span class="number">5</span>_0);</span><br></pre></td></tr></table></figure>
<p>这个属性会返回一个数组的<code>字符串</code>,这些<code>字符串</code>用于表示保存在资源中可用选项的媒体特征,其实数组中包含的字符串的值为如下：</p>
<ul>
<li>AVMediaCharacteristicVisual 视频</li>
<li>AVMediaCharacteristicAudible 音频</li>
<li>AVMediaCharacteristicLegible 字幕或隐藏式字幕</li>
</ul>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">AVMediaSelectionGroup</span> *)mediaSelectionGroupForMediaCharacteristic:(<span class="built_in">AVMediaCharacteristic</span>)mediaCharacteristic <span class="built_in">NS_AVAILABLE</span>(<span class="number">10</span>_8, <span class="number">5</span>_0);</span><br></pre></td></tr></table></figure>
<p>请求可用媒体特性数据后,调用<code>AVAsset</code>的<code>mediaSelectionGroupForMediaCharacteristic:</code>方法.为其传递要检索的选项的特定媒体特征.这个方法返回一个<code>AVMediaSelectionGroup</code>,它作为一个或多个互斥的<code>AVMediaSelectionGroup</code>实例的容器.</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)loadMediaOptions &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *mc = <span class="built_in">AVMediaCharacteristicLegible</span>;                            <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">AVMediaSelectionGroup</span> *group =</span><br><span class="line">        [<span class="keyword">self</span>.asset mediaSelectionGroupForMediaCharacteristic:mc];          <span class="comment">// 2</span></span><br><span class="line">    <span class="keyword">if</span> (group) &#123;</span><br><span class="line">        <span class="built_in">NSMutableArray</span> *subtitles = [<span class="built_in">NSMutableArray</span> array];                 <span class="comment">// 3</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">AVMediaSelectionOption</span> *option <span class="keyword">in</span> group.options) &#123;</span><br><span class="line">            [subtitles addObject:option.displayName];</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="keyword">self</span>.transport setSubtitles:subtitles];                            <span class="comment">// 4</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span>.transport setSubtitles:<span class="literal">nil</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="airplay">AirPlay</h2>
<p>AirPlay相信大部分iOS开发者都耳熟能详,这个东西是用于无线方式将流媒体音频/视频内容在<code>Apple TV</code>上播放.或者将纯音频内容在多种第三方音频系统中播放(如汽车中内置的CarPlay).如果大家有<code>Apple TV</code>或其它音频系统中的一个,就会觉得这个功能实在太实用了.其实把这个功能整合到我们的APP中十分容易.</p>
<p><code>AVPlayer</code>有一个属性是<code>allowsExternalPlayback</code>,允许启用或者禁用<code>AirPlay</code>播放功能.该属性默认是<code>YES</code>,即在不做任何额外编码的情况下,播放器应用程序也会自动支持<code>AirPlay</code>功能.</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> allowsExternalPlayback <span class="built_in">NS_AVAILABLE</span>(<span class="number">10</span>_11, <span class="number">6</span>_0);</span><br></pre></td></tr></table></figure>
<p>不过从iOS11之后才有专门针对AirPlay的framework功能API,在以前我们使用<code>Media Player</code>中的<code>MPVolumeView</code>来实现.</p>
<p>示例代码:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MPVolumeView *volumeView = [[MPVolumeView alloc] init];</span><br><span class="line">   volumeView.showsVolumeSlider = NO;</span><br><span class="line">   [volumeView sizeToFit];</span><br><span class="line">   [transportView addSubview:volumeView];</span><br></pre></td></tr></table></figure>
<p>当AirPlay可用时,而且WIFI 网络启用时才会显示线路选择按钮.这两个条件只有一个不满足, MPVolumeView 就会自动隐藏按钮.</p>
<h2 id="总结">总结</h2>
<p>本章讲述了 如何使用AVPlayer以及AVPlayerItem 的一些属性 监听播放进度回调,取 字幕等等.</p>
<p><a href="https://github.com/sunyazhou13/Learning-AV-Foundation-Demos" target="_blank" rel="noopener">详细demo请参考</a></p>

  </section>

</article>


    <! -- 添加捐赠图标 -->
<div class ="post-donate">
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           ↑<br>
           欣赏此文？求鼓励，求支持！
        </span>
        <br>
    </div>  
    <div id="donate_guide" class="donate_bar center hidden" >
        <!-- 方式一： 
            ![](/img/Alipay.jpg)
            ![](/img/WeChatpay.jpg)
        -->
        <!-- 方式二；
            step1：在_config.yml中添加配置
                Alipay: /img/Alipay.jpg
                WeChatpay: /img/WeChatpay.jpg
            step2：此处两张图片的路径分别设置为如下
                <img src="undefined"
                <img src="undefined"
        -->
        <!-- 支付宝打赏图案 -->
        <img src="/images/Alipay.jpg" alt="支付宝打赏">
        <!-- 微信打赏图案 -->
        <img src="/images/WeChatpay.jpg" alt="微信打赏">
    </div>
    <script type="text/javascript">
        document.getElementById('btn_donate').onclick = function(){
            $('#donate_board').addClass('hidden');
            $('#donate_guide').removeClass('hidden');
        }
    </script>
</div>

<! -- 添加捐赠图标 -->



<section class="read-more">
     
        
            <div class="read-more-item">
                <span class="read-more-item-dim">最近的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2018/03/05/20180305ComputerGraphicsRenderingProcess/" title="计算机图形渲染的流程">计算机图形渲染的流程</a></h2>
                <p class="excerpt">
                
                
前言
今天在网上找到了一篇有价值的文章,来说明计算机中的图像渲染流程以及像素点计算和坐标点相关的知识.
计算机图形渲染的流程
计算机的绘图过程可以简单用流水线来说明，而产品(数据)就是经过流水线作业(渲染)到屏幕的图像。这条流水线可以简化为(本文的概念):绘图位置座标指定;着色指定;输出指定;下图
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2018-03-05T04:11:41.000Z" class="post-list__meta--date date">2018-03-05</time>
 &#8226; <span class="post-list__meta--tags tags">于&nbsp;
  <a class="tag-link" href="/tags/iOS开发/">iOS开发</a>, <a class="tag-link" href="/tags/macOS开发/">macOS开发</a>

</span><a class="btn-border-small" href="/2018/03/05/20180305ComputerGraphicsRenderingProcess/">继续阅读</a></div>

            </div>
        

        
            <div class="read-more-item">
                <span class="read-more-item-dim">更早的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2018/02/04/20180204WordEmbeding/" title="NLP分词WordEmbeding">NLP分词WordEmbeding</a></h2>
                <p class="excerpt">
                
                
前言
学习过程中记录一下python代码
#!/usr/bin/env python# coding:utf8import sysreload(sys)sys.setdefaultencoding(&#39;utf8&#39;)# 加载包from gensim.models import Word2Vecfrom
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2018-02-04T04:24:30.000Z" class="post-list__meta--date date">2018-02-04</time>
 &#8226; <span class="post-list__meta--tags tags">于&nbsp;
  <a class="tag-link" href="/tags/python开发/">python开发</a>

</span><a class="btn-border-small" href="/2018/02/04/20180204WordEmbeding/">继续阅读</a></div>

            </div>
        
   
</section>



  <div id="gitalk-container" style="padding: 0px 30px 0px 30px;"></div> 

  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script type="text/javascript">

  if(true){
    var gitalk = new Gitalk({
      clientID: '15c55ed469ea673ae332',
      clientSecret: '1801dbf9b1589c256260c85d779eb51d0cf40885',
      repo: 'gitment-comments',
      owner: 'sunyazhou13',
      admin: ['sunyazhou13'],
      id: 'Sun Mar 04 2018 16:56:06 GMT+0800',
      distractionFreeMode: 'true'
  })
  gitalk.render('gitalk-container') 
  }
  </script>




            <footer class="footer">
    <span class="footer__copyright">
        本站点采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>
    </span>
    <span class="footer__copyright">
        基于 <a href="http://hexo.io">Hexo</a> 搭建，感谢 <a href="https://pages.github.com/">GitHub Pages</a> 和 Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a> 提供免费的托管服务
    </span>
    <span class="footer__copyright">
        &copy; 2020 - 本站由 <a href="/">@sunyazhou13</a> 创建,
        使用<a href="https://github.com/lenbo-ma/hexo-theme-vno">hexo-theme-vno</a>主题,
        修改自<a href="https://github.com/onevcat/vno" target="_blank">喵神的vno</a>
    </span>
</footer>

        </div>
    </div>

    <script src="https://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="/js/main.js"></script>

     




    


    

<script type="text/javascript">

// var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
// document.write(unescape("%3Cspan id='cnzz_stat_icon_1274885345'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s13.cnzz.com/z_stat.php%3Fid%3D1274885345%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));

var cnzz_s_tag = document.createElement('script');
cnzz_s_tag.type = 'text/javascript';
cnzz_s_tag.async = true;
cnzz_s_tag.charset = "utf-8";
cnzz_s_tag.src = src="https://s13.cnzz.com/z_stat.php?id=1274885345&web_id=1274885345&async=1";
var root_s = document.getElementsByTagName('script')[0];
root_s.parentNode.insertBefore(cnzz_s_tag, root_s);

</script>


<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
