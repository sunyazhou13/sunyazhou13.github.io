<!DOCTYPE html><html lang="zh-Hans" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.5.1"><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="CocoaPods完全使用指南" /><meta name="author" content="孙亚洲" /><meta property="og:locale" content="zh_Hans" /><meta name="description" content="嗨,我是孙亚洲(@sunyazhou13),一名来自祖国北国冰城的iOS开发者." /><meta property="og:description" content="嗨,我是孙亚洲(@sunyazhou13),一名来自祖国北国冰城的iOS开发者." /><link rel="canonical" href="https://www.sunyazhou.com/2023/04/cocoapodsuserguide/" /><meta property="og:url" content="https://www.sunyazhou.com/2023/04/cocoapodsuserguide/" /><meta property="og:site_name" content="迈腾大队长" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-04-26T03:22:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="CocoaPods完全使用指南" /><meta name="twitter:site" content="@sunyazhou" /><meta name="twitter:creator" content="@孙亚洲" /><meta name="google-site-verification" content="Xo29j227HYVdC-vDA_-qJwvDP3PIo-lC78CFeBvhrDA" /> <script type="application/ld+json"> {"url":"https://www.sunyazhou.com/2023/04/cocoapodsuserguide/","@type":"BlogPosting","headline":"CocoaPods完全使用指南","dateModified":"2023-04-26T03:22:00+00:00","datePublished":"2023-04-26T03:22:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.sunyazhou.com/2023/04/cocoapodsuserguide/"},"author":{"@type":"Person","name":"孙亚洲"},"description":"嗨,我是孙亚洲(@sunyazhou13),一名来自祖国北国冰城的iOS开发者.","@context":"https://schema.org"}</script><title>CocoaPods完全使用指南 | 迈腾大队长</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/images/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">迈腾大队长</a></div><div class="site-subtitle font-italic">不斷學習,與時俱進.求真務實,實事求是.</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3"></i> <span>主页</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3"></i> <span>归档</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3"></i> <span>分类</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3"></i> <span>标签</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/projects/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-paint-brush ml-xl-3 mr-xl-3"></i> <span>作品</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3"></i> <span>关于</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } get isResolvedDarkMode() { if (this.isLightMode) { return false; } return this.isSysDarkPrefer; } updateCommentStyle() { var theme = "github-light"; if (this.isResolvedDarkMode) { theme = "photon-dark"; } let comment = document.querySelector("iframe.utterances-frame"); if (comment == null) { return; } comment.contentWindow.postMessage( { type: "set-theme", theme: theme }, "https://utteranc.es/" ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateCommentStyle(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/sunyazhou13" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/sunyazhou" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.weibo.com/sunyazhou13" aria-label="" target="_blank" rel="noopener"> <i class="fab fa-weibo"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sunyazhou','111.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 主页 </a> </span> <span>CocoaPods完全使用指南</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>CocoaPods完全使用指南</h1><div class="post-meta text-muted d-flex flex-column"><div> 　由 <span class="author"> 孙亚洲 </span> 发布于 <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Apr 26, 2023, 3:22 AM +0000" > 2023-04-26 <i class="unloaded">2023-04-26T03:22:00+00:00</i> </span></div><div> 最后更新: <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Tue, Apr 2, 2024, 7:42 PM +0800" > 04-02 <i class="unloaded">2024-04-02T11:42:11+00:00</i> </span></div></div><div class="post-content"><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20201010PodSpec/cocoapods.webp" alt="" /></p><h1 id="前言">前言</h1><p>本文具有强烈的个人感情色彩,如有观看不适,请尽快关闭. 本文仅作为个人学习记录使用,也欢迎在许可协议范围内转载或分享,请尊重版权并且保留原文链接,谢谢您的理解合作. 如果您觉得本站对您能有帮助,您可以使用RSS方式订阅本站,感谢支持!.</p><p>在我的技术认知里, Cocoapods已经成为每一位iOS开发者必备的技能之一,然后这么多年过去了,在我认为它已经过时了的时候居然还有人对这个东西玩的不透彻,今天我就把我这么多年使用的经验高阶部分全部都拿出来跟不熟悉这个工具的同行分享一下.</p><p>对于大多数软件开发团队来说，依赖管理工具必不可少，它能针对开源和私有依赖进行安装与管理，从而提升开发效率，降低维护成本。针对不同的语言与平台，其依赖管理工具也各有不同，例如<code class="language-plaintext highlighter-rouge">npm</code>管理<code class="language-plaintext highlighter-rouge">Javascript</code>、<code class="language-plaintext highlighter-rouge">Gradle </code>、<code class="language-plaintext highlighter-rouge">Maven</code> 管理<code class="language-plaintext highlighter-rouge">Jar</code> 包、<code class="language-plaintext highlighter-rouge">pip </code>管理 <code class="language-plaintext highlighter-rouge">Python </code>包，<code class="language-plaintext highlighter-rouge">Bundler</code>、<code class="language-plaintext highlighter-rouge">RubyGems</code>等等。本文聚焦于<code class="language-plaintext highlighter-rouge"> iOS </code>方面，对 <code class="language-plaintext highlighter-rouge">CocoaPods </code>的使用和部分原理进行阐述。</p><h2 id="简单易用的-cocoapods">简单易用的 CocoaPods</h2><p>对于 iOSer 来说，CocoaPods 并不陌生，几乎所有的 iOS 工程都会有它的身影。CocoaPods 采用 Ruby 构建，它是 Swift 和 Objective-C Cocoa 项目的依赖管理工具。在 MacOS 上，推荐使用默认的 Ruby 进行安装 (以下操作均在 CocoaPods 1.10.1、Ruby 2.7.2 进行)：</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">sudo</span> <span class="n">gem</span> <span class="n">install</span> <span class="n">cocoapods</span>
</pre></table></code></div></div><p>如果安装成功，便可以使用 pod 的相关命令了。针对一个简单的项目来说，只需三步便可引入其他的依赖：</p><ul><li>1.创建 Podfile 文件( CocoaPods 提供了 pod init 命令创建)<li>2.对 Podfile 文件进行编写，添加依赖的库，版本等信息。<li>3.在命令行执行 <code class="language-plaintext highlighter-rouge">pod install</code> 命令</ul><p>顺利的话，这时在项目目录下会出现以下文件：</p><ul><li>.xcworkspace：CocoaPods 将项目分为了主工程与依赖工程(Pods)。与 .xcodeproj 相比 .xcworkspace 对于管理多个项目的能力更强，你也可以将复杂的大型应用转换为以 .xcworkspace 构建的多个兄弟项目，从而更轻松的维护和共享功能。<li>Podfile.lock：记录并跟踪依赖库版本，将依赖库锁定于某个版本。<li>Pods 文件夹：存放依赖库代码。<li>Pods/Manifest.lock：每次 pod install 时创建的 <code class="language-plaintext highlighter-rouge">Podfile.lock</code>的副本，用于比较这两个文件。一般来说, Podfile.lock 会纳入版本控制管理，而 Pods 文件夹则不会纳入版本控制变更；这意味着 Podfile.lock 表示项目应该依赖的库版本信息，而 Manifest.lock 则代表本地 Pods 的依赖库版本信息。在 pod install 后会将脚本插入到 Build Phases，名为 <code class="language-plaintext highlighter-rouge">[CP] Check Pods Manifest.lock</code>，从而保证开发者在运行 app 之前能够更新 Pods，以确保代码是最新的。</ul><h2 id="pod-install-vs-pod-update">pod install vs. pod update</h2><ul><li><code class="language-plaintext highlighter-rouge">pod install</code>：在每一次编辑 Podfile 以添加、更新或删除 pod 时使用。它会下载并安装新的 Pod，并将其版本信息写入 Podfile.lock 中。<li><code class="language-plaintext highlighter-rouge">pod outdated</code>：列出所有比 Podfile.lock 中当前记录的版本 newer 版本的 pod。<li><code class="language-plaintext highlighter-rouge">pod update [PODNAME]</code>：CocoaPods 会查找 newer 版本的 PODNAME，同时将 pod 更新到可能的最新版本(须符合 Podfile 限制)。若没有 PODNAME，则会将每一个 pod 更新到可能的最新版本。</ul><p>一般来说，每次编辑 Podfile 时使用 <code class="language-plaintext highlighter-rouge">pod install</code>，仅在需要更新某个 pod 版本(所有版本)时才使用 pod update。同时，需提交 Podfile.lock 文件而不是 Pods 文件夹来达到同步所有 pod 版本的目的。</p><blockquote><p>newer 代表更加新的，若采用中文理解起来比较别扭。</p></blockquote><h2 id="podfile-语法规范">Podfile 语法规范</h2><p>Podfile 描述了一个或多个 Xcode 项目的 target 依赖关系，它是一种 DSL，了解它对我们使用好 CocoaPods 是一个必不可少的步骤。下面列出其相关的语法规范：</p><h4 id="root-options">Root Options</h4><p><code class="language-plaintext highlighter-rouge">install!</code>：指定 CocoaPods 安装 Podfile 时使用的安装方法和选项。如：</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">install</span><span class="o">!</span> <span class="s1">'cocoapods'</span>,
         :deterministic_uuids <span class="o">=&gt;</span> <span class="nb">false</span>,
         :integrate_targets <span class="o">=&gt;</span> <span class="nb">false</span>
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">:clean</code>：根据 podspec 和项目支持平台的指定，清理所有不被 pod 使用的文件，默认为 true。<li><code class="language-plaintext highlighter-rouge">:deduplicate_targets</code>：是否对 pod target 进行重复数据删除，默认为 true。<li><code class="language-plaintext highlighter-rouge">:deterministic_uuids</code>：创建 pod project 是否产生确定性 UUID，默认为 true。<li><code class="language-plaintext highlighter-rouge">:integrate_targets</code>：是否继承到用户项目中，为 false 会将 Pod 下载并安装到到 project_path/Pods 目录下，默认为 true。<li><code class="language-plaintext highlighter-rouge">:lock_pos_sources</code>：是否锁定 pod 的源文件，当 Xcode 尝试修改时会提示解锁文件，默认为 true。<li><code class="language-plaintext highlighter-rouge">:warn_for_multiple_pod_sources</code>：当多个 source 包含同名同版本 pod 时是否发出警告，默认为 true。<li><code class="language-plaintext highlighter-rouge">:warn_for_unused_master_specs_repo</code>：如果没有明确指出 master specs repo 的 git 是否发出警告，默认为 true。<li><code class="language-plaintext highlighter-rouge">:share_schemes_for_development_pods</code>：是否为开发中的 pod 分享 schemes，默认为 false。<li><code class="language-plaintext highlighter-rouge">:disable_input_output_paths</code>：是否禁用 CocoaPods 脚本阶段的输入输出路径（Copy Frameworks 和 Copy Resources），默认为 false。<li><code class="language-plaintext highlighter-rouge">:preserve_pod_file_structure</code>：是否保留所有 pod 的文件结构，默认为 false。<li><code class="language-plaintext highlighter-rouge">:generate_multiple_pod_projects</code>：是否为每一个 pod target 生成 一个 project，生成与 Pods/Pods 文件夹中，默认为 false。<li><code class="language-plaintext highlighter-rouge">:incremental_installation</code>：仅对自上次安装的 target 与其关联的 project 的变更部分进行重新生成，默认为 false。<li><code class="language-plaintext highlighter-rouge">:skip_pods_project_generation</code>：是否跳过生成 Pods.xcodeproj 并仅进行依赖项解析与下载，默认为 false。 <code class="language-plaintext highlighter-rouge">ensure_bundler!</code>：当 bundler 版本不匹配时发出警告。</ul><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">ensure_bundler!</span> <span class="s1">'~&gt; 2.0.0'</span>
</pre></table></code></div></div><h4 id="dependencies">Dependencies</h4><p><code class="language-plaintext highlighter-rouge">pod</code>：指定项目的依赖项</p><ul><li>依赖版本控制：<code class="language-plaintext highlighter-rouge">=</code>、<code class="language-plaintext highlighter-rouge">&gt;</code>、<code class="language-plaintext highlighter-rouge">&gt;=</code>、<code class="language-plaintext highlighter-rouge">&lt;</code>、<code class="language-plaintext highlighter-rouge">&lt;=</code> 为字面意思；<code class="language-plaintext highlighter-rouge">~&gt; 0.1.2</code> 表示 <code class="language-plaintext highlighter-rouge">0.1.2 &lt;= currVersion &lt; 0.2</code> 之间的符合要求的最新版本版本。<li>Build configurations：默认依赖安装在所有的构建配置中，但也可仅在指定构建配置中启用。<li>Modular Headers：用于将 pod 转换为 module 以支持模块，这时在 Swift 中可以不用借助 <code class="language-plaintext highlighter-rouge">bridging-header</code> 桥接就可以直接导入，简化了 Swift 引用 Objective-C 的方式；也可以采用 <code class="language-plaintext highlighter-rouge">use_modular_headers!</code> 进行全局的变更。<li>Source：指定具有依赖项的源，同时会忽略全局源。<li>Subspecs：默认会安装所有的 subspecs，但可制定安装某些 subspecs。<li>Test Specs：默认不会安装 test specs，但可选择性安装 test specs。<li>Local path：将开发的 pod 与其客户端一起使用，可采用 path。<li>指定某个特殊或者更为先进的 pod 版本</ul><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1"># 依赖版本控制</span>
<span class="n">pod</span> <span class="s1">'Objection'</span><span class="p">,</span> <span class="s1">'~&gt; 0.9'</span><span class="err"> </span>
<span class="c1"># Build configurations</span>
<span class="n">pod</span> <span class="s1">'PonyDebugger'</span><span class="p">,</span> <span class="ss">:configurations</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'Debug'</span><span class="p">,</span> <span class="s1">'Beta'</span><span class="p">]</span><span class="err"> </span>
<span class="c1"># Modular Headers</span>
<span class="n">pod</span> <span class="s1">'SSZipArchive'</span><span class="p">,</span> <span class="ss">:modular_headers</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="err"> </span>
<span class="c1"># Source</span>
<span class="n">pod</span> <span class="s1">'PonyDebugger'</span><span class="p">,</span> <span class="ss">:source</span> <span class="o">=&gt;</span> <span class="s1">'https://github.com/CocoaPods/Specs.git'</span>
<span class="c1"># Subspecs</span>
<span class="n">pod</span> <span class="s1">'QueryKit'</span><span class="p">,</span> <span class="ss">:subspecs</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'Attribute'</span><span class="p">,</span> <span class="s1">'QuerySet'</span><span class="p">]</span><span class="err"> </span>
<span class="c1"># Test Specs</span>
<span class="n">pod</span> <span class="s1">'AFNetworking'</span><span class="p">,</span> <span class="ss">:testspecs</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'UnitTests'</span><span class="p">,</span> <span class="s1">'SomeOtherTests'</span><span class="p">]</span>
<span class="c1"># Local path</span>
<span class="n">pod</span> <span class="s1">'AFNetworking'</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s1">'~/Documents/AFNetworking'</span>
<span class="c1"># 指定某个特殊或者更为先进的 Pod 版本</span>
<span class="n">pod</span> <span class="s1">'AFNetworking'</span><span class="p">,</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s1">'https://github.com/gowalla/AFNetworking.git'</span><span class="p">,</span> <span class="ss">:branch</span> <span class="o">=&gt;</span> <span class="s1">'dev'</span>
<span class="n">pod</span> <span class="s1">'AFNetworking'</span><span class="p">,</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s1">'https://github.com/gowalla/AFNetworking.git'</span><span class="p">,</span> <span class="ss">:tag</span> <span class="o">=&gt;</span> <span class="s1">'0.7.0'</span>
<span class="n">pod</span> <span class="s1">'AFNetworking'</span><span class="p">,</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s1">'https://github.com/gowalla/AFNetworking.git'</span><span class="p">,</span> <span class="ss">:commit</span> <span class="o">=&gt;</span> <span class="s1">'082f8319af'</span>
<span class="c1"># 指定某个 podspec</span>
<span class="n">pod</span> <span class="s1">'JSONKit'</span><span class="p">,</span> <span class="ss">:podspec</span> <span class="o">=&gt;</span> <span class="s1">'https://example.com/JSONKit.podspec'</span>

</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">inherit</code>：设置当前 target 的继承模式。</p><p><code class="language-plaintext highlighter-rouge">:complete</code> 继承父级 target 的所有行为，<code class="language-plaintext highlighter-rouge">:none</code> 不继承父级 target 的任何行为，<code class="language-plaintext highlighter-rouge">:search_paths</code> 仅继承父级的搜索路径。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">target</span> <span class="s1">'App'</span> <span class="k">do</span>
  <span class="n">target</span> <span class="s1">'AppTests'</span> <span class="k">do</span>
    <span class="n">inherit!</span> <span class="ss">:search_paths</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">target</code>：与 Xcode 中的 target 相对应，block 中是 target 的依赖项。</p><p>默认情况下，target 包含在父级 target 定义的依赖项，也即<code class="language-plaintext highlighter-rouge"> inherit! </code>为 <code class="language-plaintext highlighter-rouge">:complete</code>。关于 <code class="language-plaintext highlighter-rouge">:complete</code>和 <code class="language-plaintext highlighter-rouge">:search_paths</code>，<code class="language-plaintext highlighter-rouge">:complete</code> 会拷贝父级 target 的 pod 副本，而 <code class="language-plaintext highlighter-rouge">:search_paths</code> 则只进行 <code class="language-plaintext highlighter-rouge">FRAMEWORK_SEARCH_PATHS</code> 和 <code class="language-plaintext highlighter-rouge">HEADER_SEARCH_PATHS</code> 的相关拷贝，具体可通过比对 Pods/Target Support Files 的相关文件得以验证，一般在 <code class="language-plaintext highlighter-rouge">UnitTests</code> 中使用，以减少多余的 <code class="language-plaintext highlighter-rouge">install_framework</code> 过程。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="n">target</span> <span class="s1">'ShowsApp'</span> <span class="k">do</span>
<span class="err"> </span> <span class="n">pod</span> <span class="s1">'ShowsKit'</span>
<span class="err"> </span> <span class="c1"># 拥有 ShowsKit 和 ShowTVAuth 的拷贝</span>
<span class="err"> </span> <span class="n">target</span> <span class="s1">'ShowsTV'</span> <span class="k">do</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">pod</span> <span class="s1">'ShowTVAuth'</span>
<span class="err"> </span> <span class="k">end</span>
<span class="err"> </span> <span class="c1"># 拥有 Specta 和 Expecta 的拷贝</span>
<span class="err"> </span> <span class="c1"># 并且能够通过 ShowsApp 进行访问 ShowsKit, 相当于 ShowsApp 是 ShowsTests 的宿主APP</span>
<span class="err"> </span> <span class="n">target</span> <span class="s1">'ShowsTests'</span> <span class="k">do</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">inherit!</span> <span class="ss">:search_paths</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">pod</span> <span class="s1">'Specta'</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">pod</span> <span class="s1">'Expecta'</span>
<span class="err"> </span> <span class="k">end</span>
<span class="k">end</span>

</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">abstract_target</code>：定义 <code class="language-plaintext highlighter-rouge">abstract_target</code>，方便 target 进行依赖继承，在 CocoaPods 1.0 版本之前为 <code class="language-plaintext highlighter-rouge">link_with</code>。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">abstract_target</span> <span class="s1">'Networking'</span> <span class="k">do</span>
  <span class="n">pod</span> <span class="s1">'AlamoFire'</span>
  <span class="n">target</span> <span class="s1">'Networking App 1'</span>
  <span class="n">target</span> <span class="s1">'Networking App 2'</span>
<span class="k">end</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">abstract</code>：表示当前 target 是抽象的，不会链接到 Xcode 的 target 中。</p><p><code class="language-plaintext highlighter-rouge">script_phase</code>：添加脚本阶段</p><p>在执行完 <code class="language-plaintext highlighter-rouge">pod install</code> 之后 CocoaPods 会将脚本添加到对应的 <code class="language-plaintext highlighter-rouge">target build phases</code>。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">target</span> <span class="s1">'App'</span> <span class="k">do</span>
<span class="n">script_phase</span> <span class="p">{</span>
<span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'scriptName'</span> <span class="c1"># 脚本名称,</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="ss">:script</span> <span class="o">=&gt;</span> <span class="s1">'echo "nihao"'</span> <span class="c1"># 脚本内容,</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="ss">:execution_position</span> <span class="o">=&gt;</span> <span class="ss">:before_compile</span> <span class="o">/</span> <span class="ss">:after_compile</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="ss">:shell_path</span> <span class="o">=&gt;</span> <span class="s1">'/usr/bin/ruby'</span> <span class="c1"># 脚本路径</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="ss">:input_files</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'/input/filePath'</span><span class="p">],</span> <span class="c1"># 输入文件</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="ss">:output_files</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'/outpput/filePath'</span><span class="p">]</span> <span class="c1"># 输出文件</span>
<span class="p">}</span>
<span class="k">end</span>

</pre></table></code></div></div><h4 id="target-configuration">Target configuration</h4><p><code class="language-plaintext highlighter-rouge">platform</code>：指定其构建平台。</p><p>默认值为 iOS 4.3、OSX 10.6、tvOS 9.0 和 watchOS 2.0。CocoaPods 1.0 之前的版本为 xcodeproj</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">platform</span> <span class="ss">:ios</span><span class="p">,</span> <span class="s1">'4.0'</span>

</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">project</code>：指定包含 target 的 Xcode project。这一般在 workspace 存在多个 xcode project 中使用：</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c1"># 在 FastGPS Project 中可以找到一个名为 MyGPSApp 的 target</span>
<span class="n">target</span> <span class="s1">'MyGPSApp'</span> <span class="k">do</span>
  <span class="n">project</span> <span class="s1">'FastGPS'</span>
  <span class="o">...</span>
<span class="k">end</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">inhibit_all_warnings!</code>：禁止所有警告。如果针对单个 Pod，则可以采用：</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">pod</span> <span class="s1">'SSZipArchive'</span><span class="p">,</span> <span class="ss">:inhibit_warnings</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="n">pod</span> <span class="s1">'SSZipArchive'</span><span class="p">,</span> <span class="ss">:inhibit_warnings</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">user_modular_headers!</code>：将所有 Pod 模块化。如果针对单个 Pod，则可以采用：</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">pod</span> <span class="s1">'SSZipArchive'</span><span class="p">,</span> <span class="ss">:modular_headers</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="n">pod</span> <span class="s1">'SSZipArchive'</span><span class="p">,</span> <span class="ss">:modular_headers</span> <span class="o">=&gt;</span> <span class="kp">false</span>

</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">user_frameworks!</code>：采用 framework 而不是 .a 文件的静态库。 可以通过 <code class="language-plaintext highlighter-rouge">:linkage</code> 指定使用静态库还是动态库：</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">use_frameworks</span><span class="err">！</span><span class="ss">:linkage</span> <span class="o">=&gt;</span> <span class="ss">:dynamic</span> <span class="o">/</span> <span class="ss">:static</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">supports_swift_versions</code>：指定 target definition 支持的 swift 版本要求</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">supports_swift_versions</span> <span class="s1">'&gt;= 3.0'</span><span class="p">,</span> <span class="s1">'&lt; 4.0'</span>
</pre></table></code></div></div><h4 id="workspace">Workspace</h4><p><code class="language-plaintext highlighter-rouge">workspace</code>：指定包含所有项目的 Xcode workspace。</p><h4 id="sources">Sources</h4><p><code class="language-plaintext highlighter-rouge">sources</code>：Podfile 从指定的源列表中进行检索。sources 默认存储在 ~/.cocoapods/repos 中，是全局的而非按 target definition 存储。当有多个相同的 Pod 时，优先采用检索到的 Pod 的第一个源，因此当指定另一个来源时，则需显示指定 CocoaPods 的源。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">source</span> <span class="s1">'https://github.com/artsy/Specs.git'</span>
<span class="n">source</span> <span class="s1">'https://github.com/CocoaPods/Specs.git'</span>
</pre></table></code></div></div><h4 id="hooks">Hooks</h4><p><code class="language-plaintext highlighter-rouge">plugin</code>：指定在安装期间使用的插件。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">plugin</span> <span class="s1">'cocoapods-keys'</span><span class="p">,</span> <span class="ss">:keyring</span> <span class="o">=&gt;</span> <span class="s1">'Eidolon'</span>
<span class="n">plugin</span> <span class="s1">'slather'</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">pre_install</code>：在下载后和在安装 Pod 前进行更改。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">pre_install</span> <span class="k">do</span> <span class="o">|</span><span class="n">installer</span><span class="o">|</span>
  <span class="c1"># Do something fancy!</span>
<span class="k">end</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">pre_integrate</code>：在 project 写入磁盘前进行更改。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">pre_integrate</span> <span class="k">do</span> <span class="o">|</span><span class="n">installer</span><span class="o">|</span>
  <span class="c1"># perform some changes on dependencies</span>
<span class="k">end</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">post_install</code>：对生成 project 写入磁盘前进行最后的修改。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="n">post_install</span> <span class="k">do</span> <span class="o">|</span><span class="n">installer</span><span class="o">|</span>
    <span class="n">installer</span><span class="p">.</span><span class="nf">generated_projects</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">project</span><span class="o">|</span>
        <span class="n">project</span><span class="p">.</span><span class="nf">targets</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">target</span><span class="o">|</span>
            <span class="n">target</span><span class="p">.</span><span class="nf">build_configurations</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
                <span class="n">config</span><span class="p">.</span><span class="nf">build_settings</span><span class="p">[</span><span class="s1">'IPHONEOS_DEPLOYMENT_TARGET'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'11.0'</span>
            <span class="k">end</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>

</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">post_integrate</code>：在 project 写入磁盘后进行最后更改。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">post_integrate</span> <span class="k">do</span> <span class="o">|</span><span class="n">installer</span><span class="o">|</span>
  <span class="c1"># some change after project write to disk</span>
<span class="k">end</span>
</pre></table></code></div></div><h2 id="podspec-语法规范">podspec 语法规范</h2><p>podspec = pod Specification，意为 pod 规范，它是一个 Ruby 文件。包含了 Pod 的库版本详细信息，例如应从何处获取源、使用哪些文件、要应用构建设置等信息；也可以看作该文件是整个仓库的索引文件，了解它对我们知道 Pod 库是如何组织、运作的提供了很大帮助。podspec 的 DSL 提供了极大的灵活性，文件可通过 <code class="language-plaintext highlighter-rouge">pod spec create</code> 创建。</p><h4 id="root">Root</h4><div class="table-wrapper"><table><thead><tr><th style="text-align: left">名称<th style="text-align: center">用途<th style="text-align: left">必需<tbody><tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">name</code><td style="text-align: center">pod 名称<td style="text-align: left">required<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">version</code><td style="text-align: center">pod 版本，遵循语义化版本控制<td style="text-align: left">required<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">swift_version</code><td style="text-align: center">支持的 Swift 版本<td style="text-align: left"> <tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">cocoapods_version</code><td style="text-align: center">支持的 CocoaPods 版本<td style="text-align: left"> <tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">authors</code><td style="text-align: center">pod 维护者的姓名和电子邮件，用“, ”进行分割<td style="text-align: left">required<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">license</code><td style="text-align: center">pod 的许可证<td style="text-align: left">required<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">homepage</code><td style="text-align: center">pod 主页的 URL<td style="text-align: left">required<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">source</code><td style="text-align: center">源地址，即源文件的存放地址，支持多种形式源<td style="text-align: left">required<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">summary</code><td style="text-align: center">pod 的简短描述<td style="text-align: left">required<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">prepare_command</code><td style="text-align: center">下载 pod 后执行的 bash 脚本<td style="text-align: left"> <tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">static_framework</code><td style="text-align: center">是否采用静态 framework 分发<td style="text-align: left"> <tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">deprecated</code><td style="text-align: center">该库是否已被弃用<td style="text-align: left"> <tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">deprecated_in_favor_of</code><td style="text-align: center">该库名称已被弃用，取而代之<td style="text-align: left"> </table></div><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="no">Pod</span><span class="o">::</span><span class="no">Spec</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">name</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=</span> <span class="s1">'CustomPod'</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">version</span><span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=</span> <span class="s1">'0.1.0'</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">summary</span><span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=</span> <span class="s1">'A short description of CustomPod.'</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">swift_versions</span> <span class="err"> </span> <span class="o">=</span> <span class="p">[</span><span class="s1">'3.0'</span><span class="p">,</span> <span class="s1">'4.0'</span><span class="p">,</span> <span class="s1">'4.2'</span><span class="p">]</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">cocoapods_version</span><span class="err"> </span> <span class="o">=</span><span class="err"> </span> <span class="s1">'&gt;= 0.36'</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">author</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'nihao'</span> <span class="o">=&gt;</span> <span class="s1">'XXXX@qq.com'</span> <span class="p">}</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">license</span><span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">'MIT'</span><span class="p">,</span> <span class="ss">:file</span> <span class="o">=&gt;</span> <span class="s1">'LICENSE'</span> <span class="p">}</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">homepage</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=</span> <span class="s1">'https://github.com/XXX/CustomPod'</span>
<span class="c1"># Supported Key</span>
<span class="c1"># :git=&gt; :tag, :branch, :commit,:submodules</span>
<span class="c1"># :svn=&gt; :folder, :tag,:revision</span>
<span class="c1"># :hg=&gt;:revision</span>
<span class="c1"># :http=&gt; :flatten, :type, :sha256, :sha1,:headers</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">source</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s1">'https://github.com/XX/CustomPod.git'</span><span class="p">,</span> <span class="ss">:tag</span> <span class="o">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="nf">version</span><span class="p">.</span><span class="nf">to_s</span> <span class="p">}</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">prepare_command</span><span class="err"> </span> <span class="o">=</span><span class="err"> </span> <span class="s1">'ruby build_files.rb'</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">static_framework</span> <span class="o">=</span> <span class="kp">true</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">deprecated</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=</span> <span class="kp">true</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">deprecated_in_favor_of</span><span class="err"> </span> <span class="o">=</span><span class="err"> </span> <span class="s1">'NewMoreAwesomePod'</span>
<span class="k">end</span>

</pre></table></code></div></div><h4 id="platform">Platform</h4><p><code class="language-plaintext highlighter-rouge">platform</code>：pod 支持的平台，留空意味着 pod 支持所有平台。当支持多平台时应该用 <code class="language-plaintext highlighter-rouge">deployment_target</code> 代替。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">platform</span> <span class="o">=</span> <span class="ss">:osx</span><span class="p">,</span> <span class="s1">'10.8'</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">deployment_target</code>：允许指定支持此 pod 的多个平台，为每个平台指定不同的部署目标。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">ios</span><span class="p">.</span><span class="nf">deployment_target</span> <span class="o">=</span> <span class="s1">'6.0'</span>
<span class="n">spec</span><span class="p">.</span><span class="nf">osx</span><span class="p">.</span><span class="nf">deployment_target</span> <span class="o">=</span> <span class="s1">'10.8'</span>
</pre></table></code></div></div><h4 id="build-settings">Build settings</h4><p><code class="language-plaintext highlighter-rouge">dependency</code>：基于其他 pods 或子规范的依赖</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">dependency</span> <span class="s1">'AFNetworking'</span><span class="p">,</span> <span class="s1">'~&gt; 1.0'</span><span class="p">,</span> <span class="ss">:configurations</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'Debug'</span><span class="p">]</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">info_plist</code>：加入到生成的 Info.plist 的键值对，会对 CocoaPods 生成的默认值进行覆盖。仅对使用 framework 的框架有影响，对静态库无效。对于应用规范，这些值将合并到应用程序主机的 <code class="language-plaintext highlighter-rouge">Info.plist</code>；对于测试规范，这些值将合并到测试包的 Info.plist。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">info_plist</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'CFBundleIdentifier'</span> <span class="o">=&gt;</span> <span class="s1">'com.myorg.MyLib'</span><span class="p">,</span>
  <span class="s1">'MY_VAR'</span> <span class="o">=&gt;</span> <span class="s1">'SOME_VALUE'</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">requires_arc</code>：允许指定哪些 source_files 采用 ARC，不使用 ARC 的文件将具有 <code class="language-plaintext highlighter-rouge">-fno-objc-arc</code> 编译器标志</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">requires_arc</span> <span class="o">=</span> <span class="kp">false</span>
<span class="n">spec</span><span class="p">.</span><span class="nf">requires_arc</span> <span class="o">=</span> <span class="s1">'Classes/Arc'</span>
<span class="n">spec</span><span class="p">.</span><span class="nf">requires_arc</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Classes/*ARC.m'</span><span class="p">,</span> <span class="s1">'Classes/ARC.mm'</span><span class="p">]</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">frameworks</code>：使用者 target 需要链接的系统框架列表</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">ios</span><span class="p">.</span><span class="nf">framework</span> <span class="o">=</span> <span class="s1">'CFNetwork'</span>
<span class="n">spec</span><span class="p">.</span><span class="nf">frameworks</span> <span class="o">=</span> <span class="s1">'QuartzCore'</span><span class="p">,</span> <span class="s1">'CoreData'</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">weak_frameworks</code>：使用者 target 需要弱链接的框架列表</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">weak_framework</span> <span class="o">=</span> <span class="s1">'Twitter'</span>
<span class="n">spec</span><span class="p">.</span><span class="nf">weak_frameworks</span> <span class="o">=</span> <span class="s1">'Twitter'</span><span class="p">,</span> <span class="s1">'SafariServices'</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">libraries</code>：使用者 target 需要链接的系统库列表</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">ios</span><span class="p">.</span><span class="nf">library</span> <span class="o">=</span> <span class="s1">'xml2'</span>
<span class="n">spec</span><span class="p">.</span><span class="nf">libraries</span> <span class="o">=</span> <span class="s1">'xml2'</span><span class="p">,</span> <span class="s1">'z'</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">compiler_flags</code>：应传递给编译器的 flags</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">compiler_flags</span> <span class="o">=</span> <span class="s1">'-DOS_OBJECT_USE_OBJC=0'</span><span class="p">,</span> <span class="s1">'-Wno-format'</span>

</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">pod_target_xcconfig</code>：将指定 flag 添加到最终 pod 的 xcconfig 文件</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">pod_target_xcconfig</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'OTHER_LDFLAGS'</span> <span class="o">=&gt;</span> <span class="s1">'-lObjC'</span> <span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">user_target_xcconfig</code>：🙅 将指定 flag 添加到最终聚合的 target 的 xcconfig，不推荐使用此属性，因为会污染用户的构建设置，可能会导致冲突。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">user_target_xcconfig</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'MY_SUBSPEC'</span> <span class="o">=&gt;</span> <span class="s1">'YES'</span> <span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">prefix_header_contents</code>：🙅 在 Pod 中注入的预编译内容，不推荐使用此属性，因为其会污染用户或者其他库的预编译头。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">prefix_header_contents</span> <span class="o">=</span> <span class="s1">'#import &lt;UIKit/UIKit.h&gt;'</span><span class="p">,</span> <span class="s1">'#import &lt;Foundation/Foundation.h&gt;'</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">prefix_header_file</code>：预编译头文件，false 表示不生成默认的 CocoaPods 的与编译头文件。🙅 不推荐使用路径形式，因为其会污染用户或者其他库的预编译头。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">prefix_header_file</span> <span class="o">=</span> <span class="s1">'iphone/include/prefix.pch'</span>
<span class="n">spec</span><span class="p">.</span><span class="nf">prefix_header_file</span> <span class="o">=</span> <span class="kp">false</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">module_name</code>：生成的 framrwork / clang module 使用的名称，而非默认名称。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">module_name</span> <span class="o">=</span> <span class="s1">'Three20'</span>

</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">header_dir</code>：存储头文件的目录，这样它们就不会被破坏。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">header_dir</span> <span class="o">=</span> <span class="s1">'Three20Core'</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">header_mappings_dir</code>：用于保留头文件文件夹的目录。如未提供，头文件将被碾平。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">header_mappings_dir</span> <span class="o">=</span> <span class="s1">'src/include'</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">script_phases</code>：该属性允许定义脚本在 pod 编译时执行，其作为 <code class="language-plaintext highlighter-rouge">xcode build</code> 命令的一部分执行，还可以利用编译期间所设置的环境变量。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">script_phases</span> <span class="o">=</span> <span class="p">[</span>
<span class="err"> </span> <span class="err"> </span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Hello World'</span><span class="p">,</span> <span class="ss">:script</span> <span class="o">=&gt;</span> <span class="s1">'echo "Hello World"'</span> <span class="p">},</span>
<span class="err"> </span> <span class="err"> </span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Hello Ruby World'</span><span class="p">,</span> <span class="ss">:script</span> <span class="o">=&gt;</span> <span class="s1">'puts "Hello World"'</span><span class="p">,</span> <span class="ss">:shell_path</span> <span class="o">=&gt;</span> <span class="s1">'/usr/bin/ruby'</span> <span class="p">},</span>
<span class="err"> </span> <span class="p">]</span>
</pre></table></code></div></div><h4 id="file-patterns">File patterns</h4><p>文件模式指定了库的所有文件管理方式，如源代码、头文件、framework、libaries、以及各种资源。其文件模式通配符形式可参考<a href="https://guides.cocoapods.org/syntax/podspec.html#group_file_patterns">链接</a></p><p><code class="language-plaintext highlighter-rouge">source_files</code>：指定源文件</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">source_files</span> <span class="o">=</span> <span class="s1">'Classes/**/*.{h,m}'</span><span class="p">,</span> <span class="s1">'More_Classes/**/*.{h,m}'</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">public_header_files</code>：指定公共头文件，这些头文件与源文件匹配，并生成文档向用户提供。如果未指定，则将 source_files 中的所有头文件都包含生成。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">public_header_files</span> <span class="o">=</span> <span class="s1">'Headers/Public/*.h'</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">project_header_files</code>：指定项目头文件，与公共头文件相对应，以排除不应向用户项目公开且不应用于生成文档的标头，且不会出现在构建目录中。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">project_header_files</span> <span class="o">=</span> <span class="s1">'Headers/Project/*.h'</span>

</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">private_header_files</code>：私有头文件，与公共头文件对应，以排除不应向用户项目公开且不应用于生成文档的标头，这些头文件会出现在产物中的 PrivateHeader 文件夹中。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">private_header_files</span> <span class="o">=</span> <span class="s1">'Headers/Private/*.h'</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">vendered_frameworks</code>：pod 附加的 framework 路径</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">ios</span><span class="p">.</span><span class="nf">vendored_frameworks</span> <span class="o">=</span> <span class="s1">'Frameworks/MyFramework.framework'</span>
<span class="n">spec</span><span class="p">.</span><span class="nf">vendored_frameworks</span> <span class="o">=</span> <span class="s1">'MyFramework.framework'</span><span class="p">,</span> <span class="s1">'TheirFramework.xcframework'</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">vendered_libraries</code>：pod 附加的 libraries 路径</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">ios</span><span class="p">.</span><span class="nf">vendored_library</span> <span class="o">=</span> <span class="s1">'Libraries/libProj4.a'</span>
<span class="n">spec</span><span class="p">.</span><span class="nf">vendored_libraries</span> <span class="o">=</span> <span class="s1">'libProj4.a'</span><span class="p">,</span> <span class="s1">'libJavaScriptCore.a'</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">on_demand_resources</code>：根据 <a href="https://developer.apple.com/videos/play/wwdc2015/214/">Introducing On demand Resources</a>按需加载资源，不推荐与主工程共享标签，默认类别为 <code class="language-plaintext highlighter-rouge">category =&gt; :download_on_demand</code></p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">s</span><span class="p">.</span><span class="nf">on_demand_resources</span> <span class="o">=</span> <span class="p">{</span>
<span class="err"> </span> <span class="s1">'Tag1'</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:paths</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'file1.png'</span><span class="p">,</span> <span class="s1">'file2.png'</span><span class="p">],</span> <span class="ss">:category</span> <span class="o">=&gt;</span> <span class="ss">:download_on_demand</span> <span class="p">}</span>
<span class="p">}</span>
<span class="n">s</span><span class="p">.</span><span class="nf">on_demand_resources</span> <span class="o">=</span> <span class="p">{</span>
<span class="err"> </span> <span class="s1">'Tag1'</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:paths</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'file1.png'</span><span class="p">,</span> <span class="s1">'file2.png'</span><span class="p">],</span> <span class="ss">:category</span> <span class="o">=&gt;</span> <span class="ss">:initial_install</span> <span class="p">}</span>
<span class="p">}</span>

</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">resources</code>：为 pod 构建的 bundle 的名称和资源文件，其中 key 为 bundle 名称，值代表它们应用的文件模式。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">resource_bundles</span> <span class="o">=</span> <span class="p">{</span>
<span class="s1">'MapBox'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'MapView/Map/Resources/*.png'</span><span class="p">],</span>
<span class="err"> </span> <span class="err"> </span> <span class="s1">'MapBoxOtherResources'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'MapView/Map/OtherResources/*.png'</span><span class="p">]</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">exclude_files</code>：排除的文件模式列表</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">ios</span><span class="p">.</span><span class="nf">exclude_files</span> <span class="o">=</span> <span class="s1">'Classes/osx'</span>
<span class="n">spec</span><span class="p">.</span><span class="nf">exclude_files</span> <span class="o">=</span> <span class="s1">'Classes/**/unused.{h,m}'</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">preserve_paths</code>：下载后不应删除的文件。默认情况下，CocoaPods 会删除与其他文件模式不匹配的所有文件</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">preserve_path</span> <span class="o">=</span> <span class="s1">'IMPORTANT.txt'</span>
<span class="n">spec</span><span class="p">.</span><span class="nf">preserve_paths</span> <span class="o">=</span> <span class="s1">'Frameworks/*.framework'</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">module_map</code>：pod 继承为 framework 时使用的模块映射文件，默认为 true，CocoaPods 根据 公共头文件创建 module_map 文件。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">module_map</span> <span class="o">=</span> <span class="s1">'source/module.modulemap'</span>
<span class="n">spec</span><span class="p">.</span><span class="nf">module_map</span> <span class="o">=</span> <span class="kp">false</span>
</pre></table></code></div></div><h4 id="subspecs">Subspecs</h4><p><code class="language-plaintext highlighter-rouge">subspec</code>：子模块的规范；实行双重继承：specs 自动继承所有 subspec 作为依赖项(除非指定默认 spec)；subspec 继承了父级的属性；</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="c1"># 采用不同源文件的 Specs, CocoaPods 自动处理重复引用问题</span>
<span class="n">subspec</span> <span class="s1">'Twitter'</span> <span class="k">do</span> <span class="o">|</span><span class="n">sp</span><span class="o">|</span>
<span class="err"> </span> <span class="n">sp</span><span class="p">.</span><span class="nf">source_files</span> <span class="o">=</span> <span class="s1">'Classes/Twitter'</span>
<span class="k">end</span>

<span class="n">subspec</span> <span class="s1">'Pinboard'</span> <span class="k">do</span> <span class="o">|</span><span class="n">sp</span><span class="o">|</span>
<span class="err"> </span> <span class="n">sp</span><span class="p">.</span><span class="nf">source_files</span> <span class="o">=</span> <span class="s1">'Classes/Pinboard'</span>
<span class="k">end</span>

<span class="c1"># 引用其他子规范</span>
<span class="n">s</span><span class="p">.</span><span class="nf">subspec</span> <span class="s2">"Core"</span> <span class="k">do</span> <span class="o">|</span><span class="n">ss</span><span class="o">|</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">ss</span><span class="p">.</span><span class="nf">source_files</span><span class="err"> </span> <span class="o">=</span> <span class="s2">"Sources/Moya/"</span><span class="p">,</span> <span class="s2">"Sources/Moya/Plugins/"</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">ss</span><span class="p">.</span><span class="nf">dependency</span> <span class="s2">"Alamofire"</span><span class="p">,</span> <span class="s2">"~&gt; 5.0"</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">ss</span><span class="p">.</span><span class="nf">framework</span><span class="err"> </span> <span class="o">=</span> <span class="s2">"Foundation"</span>
<span class="err"> </span> <span class="k">end</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">subspec</span> <span class="s2">"ReactiveSwift"</span> <span class="k">do</span> <span class="o">|</span><span class="n">ss</span><span class="o">|</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">ss</span><span class="p">.</span><span class="nf">source_files</span> <span class="o">=</span> <span class="s2">"Sources/ReactiveMoya/"</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">ss</span><span class="p">.</span><span class="nf">dependency</span> <span class="s2">"Moya/Core"</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">ss</span><span class="p">.</span><span class="nf">dependency</span> <span class="s2">"ReactiveSwift"</span><span class="p">,</span> <span class="s2">"~&gt; 6.0"</span>
<span class="err"> </span> <span class="k">end</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">subspec</span> <span class="s2">"RxSwift"</span> <span class="k">do</span> <span class="o">|</span><span class="n">ss</span><span class="o">|</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">ss</span><span class="p">.</span><span class="nf">source_files</span> <span class="o">=</span> <span class="s2">"Sources/RxMoya/"</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">ss</span><span class="p">.</span><span class="nf">dependency</span> <span class="s2">"Moya/Core"</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">ss</span><span class="p">.</span><span class="nf">dependency</span> <span class="s2">"RxSwift"</span><span class="p">,</span> <span class="s2">"~&gt; 5.0"</span>
<span class="err"> </span> <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># 嵌套子规范</span>
<span class="no">Pod</span><span class="o">::</span><span class="no">Spec</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Root'</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">subspec</span> <span class="s1">'Level_1'</span> <span class="k">do</span> <span class="o">|</span><span class="n">sp</span><span class="o">|</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">sp</span><span class="p">.</span><span class="nf">subspec</span> <span class="s1">'Level_2'</span> <span class="k">do</span> <span class="o">|</span><span class="n">ssp</span><span class="o">|</span>
<span class="err"> </span> <span class="err"> </span> <span class="k">end</span>
<span class="err"> </span> <span class="k">end</span>
<span class="k">end</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">default_subspecs</code>：默认子规范数组名称，不指定将全部子规范作为默认子规范，<code class="language-plaintext highlighter-rouge">:none</code> 表示不需要任何子规范。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">default_subspec</span> <span class="o">=</span> <span class="s1">'Core'</span>
<span class="n">spec</span><span class="p">.</span><span class="nf">default_subspecs</span> <span class="o">=</span> <span class="s1">'Core'</span><span class="p">,</span> <span class="s1">'UI'</span>
<span class="n">spec</span><span class="p">.</span><span class="nf">default_subspecs</span> <span class="o">=</span> <span class="ss">:none</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">scheme</code>：用以给指定 scheme configuration 添加拓展</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">scheme</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:launch_arguments</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'Arg1'</span><span class="p">]</span> <span class="p">}</span>
<span class="n">spec</span><span class="p">.</span><span class="nf">scheme</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:launch_arguments</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'Arg1'</span><span class="p">,</span> <span class="s1">'Arg2'</span><span class="p">],</span> <span class="ss">:environment_variables</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">'Key1'</span> <span class="o">=&gt;</span> <span class="s1">'Val1'</span><span class="p">}</span> <span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">test_spec</code>：测试规范，在 1.8 版本支持。可参考：<a href="https://blog.cocoapods.org/CocoaPods-1.8.0-beta/">CocoaPods 1.8 Beta</a> <br /> <code class="language-plaintext highlighter-rouge">requires_app_host</code>：是否需要宿主 APP 运行测试，仅适用于测试规范。<br /> <code class="language-plaintext highlighter-rouge">app_host_name</code>：必要时作用于应用程序的应用程序规范名称<br /> <code class="language-plaintext highlighter-rouge">app_spec</code>：宿主 APP 规范</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="no">Pod</span><span class="o">::</span><span class="no">Spec</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">name</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=</span> <span class="s1">'CannonPodder'</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">version</span><span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="o">=</span> <span class="s1">'1.0.0'</span>
<span class="err"> </span> <span class="c1"># ...rest of attributes here</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">app_spec</span> <span class="s1">'DemoApp'</span> <span class="k">do</span> <span class="o">|</span><span class="n">app_spec</span><span class="o">|</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">app_spec</span><span class="p">.</span><span class="nf">source_files</span> <span class="o">=</span> <span class="s1">'DemoApp/**/*.swift'</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># Dependency used only by this app spec.</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">app_spec</span><span class="p">.</span><span class="nf">dependency</span> <span class="s1">'Alamofire'</span>
<span class="err"> </span> <span class="k">end</span>
<span class="err"> </span> <span class="n">s</span><span class="p">.</span><span class="nf">test_spec</span> <span class="s1">'Tests'</span> <span class="k">do</span> <span class="o">|</span><span class="n">test_spec</span><span class="o">|</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">test_spec</span><span class="p">.</span><span class="nf">requires_app_host</span> <span class="o">=</span> <span class="kp">true</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># Use 'DemoApp' as the app host.</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">test_spec</span><span class="p">.</span><span class="nf">app_host_name</span> <span class="o">=</span> <span class="s1">'CannonPodder/DemoApp'</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># ...rest of attributes here</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># This is required since 'DemoApp' is specified as the app host.</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">test_spec</span><span class="p">.</span><span class="nf">dependency</span> <span class="s1">'CannonPodder/DemoApp'</span>
<span class="err"> </span> <span class="k">end</span>
<span class="k">end</span>
</pre></table></code></div></div><h4 id="multi-platform-support">Multi-Platform support</h4><p>存储特定于某一个平台的值，分别为 ios、osx、macOS、tvos、watchos：</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">spec</span><span class="p">.</span><span class="nf">resources</span> <span class="o">=</span> <span class="s1">'Resources/**/*.png'</span>
<span class="n">spec</span><span class="p">.</span><span class="nf">ios</span><span class="p">.</span><span class="nf">resources</span> <span class="o">=</span> <span class="s1">'Resources_ios/**/*.png'</span>
</pre></table></code></div></div><h2 id="pod-的开发流程">Pod 的开发流程</h2><p>了解完 Podfile 和 podspec 的相关的规范之后，那么开发自己的 pod 应该是一件驾轻就熟的事。</p><h4 id="spec-repo">Spec Repo</h4><p>Spec Repo 是 podspec 的仓库，即是存储相关的 podspec 文件的地方。本地源存储于 ~/.cocoapods/repos中，它从 git 上拉取并完全保留目录结构。可以发现， Master Specs Repo 的现在目录结构有些特殊；以往版本的 Master Spec Repo 是完全在同一目录下的，但若大量文件在同一目录中会导致了 <a href="https://github.com/CocoaPods/CocoaPods/issues/4989#issuecomment-193772935">Github 下载慢</a> 的问题。为解决这个问题，采用散列表形式处理。具体方式为对名称进行 MD5 计算得到散列值，取前三位作为目录前缀，以对文件分散化。初次之外，CocoaPods 后续还采用 CDN 以及 trunk 进一步加快下载速度，有兴趣可以参考 <a href="http://chuquan.me/2022/01/07/source-analyze-principle/">CocoaPods Source 管理机制</a>。</p><p>如：<code class="language-plaintext highlighter-rouge">md5("CJFoundation") =&gt; 044d913fdd5a52b303222c357521f744</code>；<code class="language-plaintext highlighter-rouge">CJFoundation</code> 则在 /Specs/0/4/4 目录中</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20230426CocoaPodsUserGuide/1.webp" alt="" /></p><h4 id="create">Create</h4><p>只需利用  <code class="language-plaintext highlighter-rouge">pod lib create [PodName] </code> 命令便可以快速创建一个自己的 pod 。填写好使用平台、使用语言、是否包含 Demo、测试框架等信息，CocoaPods 会从默认的 Git 地址中拉取一份 pod 模版，同时也可以通过 <code class="language-plaintext highlighter-rouge">--template-url=URL</code> 指定模版地址。在执行完后，整个文件结构如下：</p><div class="language-swift highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="n">tree</span> <span class="kt">CustomPod</span> <span class="o">-</span><span class="kt">L</span> <span class="mi">2</span>
<span class="kt">CustomPod</span>
<span class="err">├──</span> <span class="kt">CustomPod</span>
<span class="err">│</span> <span class="err"> </span> <span class="err">├──</span> <span class="kt">Assets</span> <span class="c1">// 存放资源文件</span>
<span class="err">│</span> <span class="err"> </span> <span class="err">└──</span> <span class="kt">Classes</span>
<span class="err">│</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err">└──</span> <span class="kt">RemoveMe</span><span class="o">.</span><span class="p">[</span><span class="n">swift</span><span class="sr">/m] //</span> <span class="n">单一文件以确保最初编译工作</span>
<span class="err">├──</span> <span class="kt">CustomPod</span><span class="o">.</span><span class="n">podspec</span> <span class="c1">// Pod 的 spec 文件, 是一个 Pod 依赖的索引以及规范信息</span>
<span class="err">├──</span> <span class="kt">Example</span> <span class="c1">// 用作演示/测试的示例项目</span>
<span class="err">│</span> <span class="err"> </span> <span class="err">├──</span> <span class="kt">CustomPod</span>
<span class="err">│</span> <span class="err"> </span> <span class="err">├──</span> <span class="kt">CustomPod</span><span class="o">.</span><span class="n">xcodeproj</span>
<span class="err">│</span> <span class="err"> </span> <span class="err">├──</span> <span class="kt">CustomPod</span><span class="o">.</span><span class="n">xcworkspace</span>
<span class="err">│</span> <span class="err"> </span> <span class="err">├──</span> <span class="kt">Podfile</span>
<span class="err">│</span> <span class="err"> </span> <span class="err">├──</span> <span class="kt">Podfile</span><span class="o">.</span><span class="n">lock</span>
<span class="err">│</span> <span class="err"> </span> <span class="err">├──</span> <span class="kt">Pods</span>
<span class="err">│</span> <span class="err"> </span> <span class="err">└──</span> <span class="kt">Tests</span>
<span class="err">├──</span> <span class="n">_Pods</span><span class="o">.</span><span class="n">xcodeproj</span> <span class="o">-&gt;</span> <span class="kt">Example</span><span class="sr">/Pods/Pods.xcodeproj //</span> <span class="n">指向</span> <span class="kt">Pods</span> <span class="n">项目的以获得</span> <span class="kt">Carthage</span> <span class="n">支持</span>
<span class="err">├──</span> <span class="kt">LICENSE</span> <span class="c1">// 许可证</span>
<span class="err">└──</span> <span class="kt">README</span><span class="o">.</span><span class="n">md</span><span class="err"> </span> <span class="c1">// 自述文件</span>
</pre></table></code></div></div><h4 id="development">Development</h4><p>将源文件和资源分别放入 Classes / Assets 文件夹中，或者按你喜欢的方式组织文件，并在 podspec 文件中编辑相应项。如果你有任何想使用的配置项，可参考前面的podsepc 语法规范 。 一般来说，开发 Pod 一般都是作为本地 Pod 被其他 Project 所依赖进行开发，无论是使用 example 文件夹的 project 或者其他的 Project。</p><p><code class="language-plaintext highlighter-rouge">pod 'Name', :path =&gt; '~/CustomPod/'</code></p><h4 id="testing">Testing</h4><p>通过 <code class="language-plaintext highlighter-rouge">pod lib lint </code>以验证 Pod 仓库的使用是否正常。</p><h4 id="release">Release</h4><p>前面提到过 podspec 可以看作是整个仓库的索引文件，有了这个文件也就能组织起一个 Pod。因此官方的源以及私有源都只需要 podspec 即可，而其他文件则应推送到 podspec 中 source 中指定仓库，这个仓库应该是你自创建的。 在准备发布推送源代码时，需要更新版本号以及在 git 上打上 tag，这是为了进行版本号匹配，因为默认情况下的 podspec 文件中：</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">s</span><span class="p">.</span><span class="nf">source</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s1">'https://github.com/XXX/CustomPod.git'</span><span class="p">,</span> <span class="ss">:tag</span> <span class="o">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="nf">version</span><span class="p">.</span><span class="nf">to_s</span> <span class="p">}</span>
</pre></table></code></div></div><p>可能你的工作流操作如下：</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cd</span> ~/code/Pods/NAME
<span class="nv">$ </span>edit NAME.podspec
<span class="c"># set the new version to 0.0.1</span>
<span class="c"># set the new tag to 0.0.1</span>
<span class="nv">$ </span>pod lib lint
<span class="nv">$ </span>git add <span class="nt">-A</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Release 0.0.1."</span>
<span class="nv">$ </span>git tag <span class="s1">'0.0.1'</span>
<span class="nv">$ </span>git push <span class="nt">--tags</span>
</pre></table></code></div></div><p>存有几种方式推送 podspec 文件：</p><ul><li>1.推送到<a href="https://github.com/CocoaPods/Specs">公共仓库</a>，需要用到的 trunk 子命令，更多可以参考 <a href="https://guides.cocoapods.org/making/getting-setup-with-trunk">Getting setup with Trunk</a>：</ul><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c"># 通过电子邮箱进行注册</span>
pod trunk register orta@cocoapods.org <span class="s1">'Orta Therox'</span> <span class="nt">--description</span><span class="o">=</span><span class="s1">'macbook air'</span> 
<span class="c"># 将指定podspec文件推送到公共仓库中</span>
pod trunk push <span class="o">[</span>NAME.podspec] 
<span class="c"># 添加其他人作为协作者</span>
pod trunk add-owner ARAnalytics kyle@cocoapods.org 
</pre></table></code></div></div><ul><li>2.推送到私有源，例如 <a href="https://github.com/artsy/Specs">Artsy/Specs</a>，需要用到 repo 子命令，更多可以参考 <a href="https://guides.cocoapods.org/making/private-cocoapods">Private Pods</a>：</ul><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c"># 将私有源地址添加到本地</span>
pod repo add REPO_NAME SOURCE_URL 
<span class="c"># 检查私有源是否安装成功并准备就绪</span>
<span class="nb">cd</span> ~/.cocoapods/repos/REPO_NAME
pod repo lint <span class="nb">.</span>
<span class="c"># 将Pod的podspec添加到指定REPO_NAME中</span>
pod repo push REPO_NAME SPEC_NAME.podspec
</pre></table></code></div></div><ul><li>3.不推送到任何源中，若能存在以 URL 方式检索到 podspec文件，则可用该 URL，一般采用仓库地址，例如：</ul><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">pod</span> <span class="s1">'AFNetworking'</span><span class="p">,</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s1">'https://github.com/XXX/CustomPod.git'</span>
</pre></table></code></div></div><h4 id="semantic-versioning">Semantic Versioning</h4><p>语义化版本控制顾名思义是一种语义上的版本控制，它不要求强制遵循，只是希望开发者能够尽量遵守。如果库之间依赖关系过高，可能面临版本控制被锁死的风险（可能需要对每一个依赖库改版才能完成某次升级）；如果库之间依赖关系过于松散，又将无法避免版本的混乱（可能库兼容性不再能支持以往版本），语义化版本控制正是作为这个问题的解决方案之一。无论在 CocoaPods 中，还是 Swift Packager Manager 上，官方都希望库开发者的的版本号能遵循这一原则：</p><p>例如，给定版本号 <code class="language-plaintext highlighter-rouge">MAJOR.MINOR.PATCH</code>：</p><ul><li>1.<code class="language-plaintext highlighter-rouge">MAJOR</code>：进行不兼容的 API 更改时进行修改<li>2.<code class="language-plaintext highlighter-rouge">MINOR</code>：向后兼容的方式添加新功能时进行修改<li>3.<code class="language-plaintext highlighter-rouge">PATCH</code>：进行向后兼容的错误修复时进行修改</ul><p>先行版本号以及版本编译信息可以添加到 <code class="language-plaintext highlighter-rouge">MAJOR.MINOR.PATCH</code> 后面以作为延伸。</p><h2 id="cocoapods-原理浅析">CocoaPods 原理浅析</h2><h4 id="cococapods-核心组件">CococaPods 核心组件</h4><p>CocoaPods 被 Ruby 管理，其核心部分也被分为一个一个组件。下载源码，可以看到 Gemfile 文件如下，其依赖了若干个 <code class="language-plaintext highlighter-rouge">gem</code>，有意思的是 <code class="language-plaintext highlighter-rouge">cp_gem</code> 函数，通过 <code class="language-plaintext highlighter-rouge">SKIP_UNRELEASED_VERSIONS</code> 与 <code class="language-plaintext highlighter-rouge">path</code>来控制是否采用本地的 gem 路径，实现了 DEVELOPMENT 与 RELEASE 环境的切换。</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="no">SKIP_UNRELEASED_VERSIONS</span> <span class="o">=</span> <span class="kp">false</span>
<span class="c1"># Declares a dependency to the git repo of CocoaPods gem. This declaration is</span>
<span class="c1"># compatible with the local git repos feature of Bundler.</span>
<span class="k">def</span> <span class="nf">cp_gem</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">repo_name</span><span class="p">,</span> <span class="n">branch</span> <span class="o">=</span> <span class="s1">'master'</span><span class="p">,</span> <span class="ss">path: </span><span class="kp">false</span><span class="p">)</span>
<span class="err"> </span> <span class="k">return</span> <span class="n">gem</span> <span class="nb">name</span> <span class="k">if</span> <span class="no">SKIP_UNRELEASED_VERSIONS</span>
<span class="err"> </span> <span class="n">opts</span> <span class="o">=</span> <span class="k">if</span> <span class="n">path</span>
<span class="err">  </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="p">{</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">"../</span><span class="si">#{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
<span class="err">  </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">else</span>
<span class="err">  </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">url</span> <span class="o">=</span> <span class="s2">"https://github.com/CocoaPods/</span><span class="si">#{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">.git"</span>
<span class="err">  </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="p">{</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="n">url</span><span class="p">,</span> <span class="ss">:branch</span> <span class="o">=&gt;</span> <span class="n">branch</span> <span class="p">}</span>
<span class="err">  </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="k">end</span>
<span class="err"> </span> <span class="n">gem</span> <span class="nb">name</span><span class="p">,</span> <span class="n">opts</span>
<span class="k">end</span>

<span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

<span class="n">gemspec</span>

<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
<span class="err"> </span> <span class="n">cp_gem</span> <span class="s1">'claide'</span><span class="p">,</span><span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="s1">'CLAide'</span>
<span class="err"> </span> <span class="n">cp_gem</span> <span class="s1">'cocoapods-core'</span><span class="p">,</span><span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="s1">'Core'</span>
<span class="err"> </span> <span class="n">cp_gem</span> <span class="s1">'cocoapods-deintegrate'</span><span class="p">,</span> <span class="s1">'cocoapods-deintegrate'</span>
<span class="err"> </span> <span class="n">cp_gem</span> <span class="s1">'cocoapods-downloader'</span><span class="p">,</span><span class="err"> </span> <span class="s1">'cocoapods-downloader'</span>
<span class="err"> </span> <span class="n">cp_gem</span> <span class="s1">'cocoapods-plugins'</span><span class="p">,</span> <span class="err"> </span> <span class="err"> </span> <span class="s1">'cocoapods-plugins'</span>
<span class="err"> </span> <span class="n">cp_gem</span> <span class="s1">'cocoapods-search'</span><span class="p">,</span><span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="s1">'cocoapods-search'</span>
<span class="err"> </span> <span class="n">cp_gem</span> <span class="s1">'cocoapods-trunk'</span><span class="p">,</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="s1">'cocoapods-trunk'</span>
<span class="err"> </span> <span class="n">cp_gem</span> <span class="s1">'cocoapods-try'</span><span class="p">,</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="s1">'cocoapods-try'</span>
<span class="err"> </span> <span class="n">cp_gem</span> <span class="s1">'molinillo'</span><span class="p">,</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="s1">'Molinillo'</span>
<span class="err"> </span> <span class="n">cp_gem</span> <span class="s1">'nanaimo'</span><span class="p">,</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="s1">'Nanaimo'</span>
<span class="err"> </span> <span class="n">cp_gem</span> <span class="s1">'xcodeproj'</span><span class="p">,</span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="s1">'Xcodeproj'</span>
<span class="err"> </span> <span class="n">gem</span> <span class="s1">'cocoapods-dependencies'</span><span class="p">,</span> <span class="s1">'~&gt; 1.0.beta.1'</span>
<span class="err"> </span> <span class="o">...</span>
<span class="k">end</span>
</pre></table></code></div></div><p>这些组件相对独立，被分成一个一个 Gem 包，在 <a href="https://guides.cocoapods.org/contributing/components.html">Core Components</a> 中，可以找到对这些组件的简要描述。同时也可以到 CocoaPods 的 Github 中去看详细文档。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20230426CocoaPodsUserGuide/2.webp" alt="" /></p><ul><li><code class="language-plaintext highlighter-rouge">CocoaPods</code>：命令行支持与安装程序，也会处理 CocoaPods 的所有用户交互。<li><code class="language-plaintext highlighter-rouge">cocoapods-core</code>：对模版文件的解析，如 Podfile、.podspec 等文件。<li><code class="language-plaintext highlighter-rouge">CLAide</code>：一个简单的命令解析器，它提供了一个快速创建功能齐全的命令行界面的 API。<li><code class="language-plaintext highlighter-rouge">cocoapods-downloader</code>：用于下载源码，为各种类型的源代码控制器(HTTP/SVN/Git/Mercurial) 提供下载器。它提供 tags、commites、revisions、branches 以及 zips 文件的下载与解压缩操作。<li><code class="language-plaintext highlighter-rouge">Monlinillo</code>：CocoaPods：对于依赖仲裁算法的封装，它是一个具有前项检察的回溯算法。不仅在 pods 中，Bundler 和 RubyGems 也是使用这一套仲裁算法。<li><code class="language-plaintext highlighter-rouge">Xcodeproj</code>：通过 Ruby 来对 Xcode projects 进行创建于修改。如：脚本管理、libraries 构建、Xcode workspece 和配置文件的管理。<li><code class="language-plaintext highlighter-rouge">cocoapods-plugins</code>：插件管理，其中有 pod plugins 命令帮助你获取的可用插件列表以及开发一个新插件等功能，具体可用 pod plugins –help 了解。</ul><h4 id="pod-install-做了什么">pod install 做了什么</h4><p>执行 <code class="language-plaintext highlighter-rouge">pod install --verbose</code>，会显示 pod install 过程中的更多 debugging 信息。下文主要参考<a href="https://www.desgard.com/2020/08/17/cocoapods-story-2.html">整体把握 CocoaPods 核心组件 </a></p><p>经过消息转发与 CLAide 命令解析，最终调用了 CocoaPods/lib/cocoapods/installer.rb 的 install! 函数，主要流程图如下：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20230426CocoaPodsUserGuide/3.webp" alt="" /></p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">install!</span>
<span class="n">prepare</span>
<span class="n">resolve_dependencies</span>
<span class="n">download_dependencies</span>
<span class="n">validate_targets</span>
<span class="n">clean_sandbox</span>
<span class="k">if</span> <span class="n">installation_options</span><span class="p">.</span><span class="nf">skip_pods_project_generation?</span>
<span class="n">show_skip_pods_project_generation_message</span>
<span class="n">run_podfile_post_install_hooks</span>
<span class="k">else</span>
<span class="n">integrate</span>
<span class="k">end</span>
<span class="n">write_lockfiles</span>
<span class="n">perform_post_install_actions</span>
<span class="k">end</span>
</pre></table></code></div></div><h4 id="1-install-环境准备prepare">1. Install 环境准备（prepare）</h4><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">prepare</span>
<span class="err"> </span> <span class="c1"># 如果检测出当前目录是 Pods，直接 raise 终止</span>
<span class="err"> </span> <span class="k">if</span> <span class="no">Dir</span><span class="p">.</span><span class="nf">pwd</span><span class="p">.</span><span class="nf">start_with?</span><span class="p">(</span><span class="n">sandbox</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">to_path</span><span class="p">)</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">message</span> <span class="o">=</span> <span class="s1">'Command should be run from a directory outside Pods directory.'</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">message</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n\n\t</span><span class="s2">Current directory is </span><span class="si">#{</span><span class="no">UI</span><span class="p">.</span><span class="nf">path</span><span class="p">(</span><span class="no">Pathname</span><span class="p">.</span><span class="nf">pwd</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
<span class="err"> </span> <span class="err"> </span> <span class="k">raise</span> <span class="no">Informative</span><span class="p">,</span> <span class="n">message</span>
<span class="err"> </span> <span class="k">end</span>
<span class="err"> </span> <span class="no">UI</span><span class="p">.</span><span class="nf">message</span> <span class="s1">'Preparing'</span> <span class="k">do</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 如果 lock 文件的 CocoaPods 主版本和当前版本不同，将以新版本的配置对 xcodeproj 工程文件进行更新</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">deintegrate_if_different_major_version</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 对 sandbox(Pods) 目录建立子目录结构</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">sandbox</span><span class="p">.</span><span class="nf">prepare</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 检测 PluginManager 是否有 pre-install 的 plugin</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">ensure_plugins_are_installed!</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 执行插件中 pre-install 的所有 hooks 方法</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">run_plugins_pre_install_hooks</span>
<span class="err"> </span> <span class="k">end</span>
<span class="k">end</span>
</pre></table></code></div></div><p>在 prepare 阶段会完成 <code class="language-plaintext highlighter-rouge">pod install</code> 的环境准备，包括目录结构、版本一致性以及 <code class="language-plaintext highlighter-rouge">pre_install</code> 的 hook。</p><h4 id="2-解决依赖冲突resolve-dependencies">2. 解决依赖冲突（resolve dependencies）</h4><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">resolve_dependencies</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 获取 Sources</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">plugin_sources</span> <span class="o">=</span> <span class="n">run_source_provider_hooks</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 创建一个 Analyzer</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">analyzer</span> <span class="o">=</span> <span class="n">create_analyzer</span><span class="p">(</span><span class="n">plugin_sources</span><span class="p">)</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 如果带有 repo_update 标记</span>
<span class="err"> </span> <span class="err"> </span> <span class="no">UI</span><span class="p">.</span><span class="nf">section</span> <span class="s1">'Updating local specs repositories'</span> <span class="k">do</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1"># 执行 Analyzer 的更新 Repo 操作</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">analyzer</span><span class="p">.</span><span class="nf">update_repositories</span>
<span class="err"> </span> <span class="err"> </span> <span class="k">end</span> <span class="k">if</span> <span class="n">repo_update?</span>
<span class="err"> </span> <span class="err"> </span> <span class="no">UI</span><span class="p">.</span><span class="nf">section</span> <span class="s1">'Analyzing dependencies'</span> <span class="k">do</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1"># 从 analyzer 取出最新的分析结果，@analysis_result，@aggregate_targets，@pod_targets</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">analyze</span><span class="p">(</span><span class="n">analyzer</span><span class="p">)</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1"># 拼写错误降级识别，白名单过滤</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">validate_build_configurations</span>
<span class="err"> </span> <span class="err"> </span> <span class="k">end</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 如果 deployment? 为 true，会验证 podfile &amp; lockfile 是否需要更新</span>
<span class="err"> </span> <span class="err"> </span> <span class="no">UI</span><span class="p">.</span><span class="nf">section</span> <span class="s1">'Verifying no changes'</span> <span class="k">do</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">verify_no_podfile_changes!</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">verify_no_lockfile_changes!</span>
<span class="err"> </span> <span class="err"> </span> <span class="k">end</span> <span class="k">if</span> <span class="n">deployment?</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">analyzer</span>
<span class="k">end</span>
</pre></table></code></div></div><p>通过 Podfile、Podfile.lock 以及 manifest.lock 等生成 Analyzer 对象，其内部会使用个 Molinillo 算法解析得到一张依赖关系表，进行一系列的分析与依赖冲突解决。</p><h4 id="3-下载依赖文件download-dependencies">3. 下载依赖文件（download dependencies）</h4><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">download_dependencies</span>
<span class="err"> </span> <span class="no">UI</span><span class="p">.</span><span class="nf">section</span> <span class="s1">'Downloading dependencies'</span> <span class="k">do</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 构造 Pod Source Installer</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">install_pod_sources</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 执行 podfile 定义的 pre install 的 hooks</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">run_podfile_pre_install_hooks</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 根据配置清理 pod sources 信息，主要是清理无用 platform 相关内容</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">clean_pod_sources</span>
<span class="err"> </span> <span class="k">end</span>
<span class="k">end</span>
</pre></table></code></div></div><p>经过前面分析与解决依赖冲突后，这是会进行依赖下载。会根据依赖信息是否被新添加或者修改等信息进行下载，同时下载后也会在本地留有一份缓存，其目录在 ～/Library/Caches/CocoaPods 。</p><h4 id="4-验证-targetsvalidate-targets">4. 验证 targets（validate targets）</h4><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">validate_targets</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">validator</span> <span class="o">=</span> <span class="no">Xcode</span><span class="o">::</span><span class="no">TargetValidator</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">aggregate_targets</span><span class="p">,</span> <span class="n">pod_targets</span><span class="p">,</span> <span class="n">installation_options</span><span class="p">)</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">validator</span><span class="p">.</span><span class="nf">validate!</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">validate!</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">verify_no_duplicate_framework_and_library_names</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">verify_no_static_framework_transitive_dependencies</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">verify_swift_pods_swift_version</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">verify_swift_pods_have_module_dependencies</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">verify_no_multiple_project_names</span> <span class="k">if</span> <span class="n">installation_options</span><span class="p">.</span><span class="nf">generate_multiple_pod_projects?</span>
<span class="k">end</span>
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">verify_no_duplicate_framework_and_library_names</code>：验证是否有重名的 framework / library<li><code class="language-plaintext highlighter-rouge">verify_no_static_framework_transitive_dependencies</code>：验证动态库是否有静态链接库依赖。个人认为，这个验证是不必要的，起码不必要 error。<li><code class="language-plaintext highlighter-rouge">verify_swift_pods_swift_version</code>：验证 Swift pod 的 Swift 版本配置且相互兼容<li><code class="language-plaintext highlighter-rouge">verify_swift_pods_have_module_dependencies</code>：验证 Swift pod 是否支持 module<li><code class="language-plaintext highlighter-rouge">verify_no_multiple_project_names</code>：验证没有重名的 project 名称</ul><h4 id="5-生成工程integrate">5. 生成工程（Integrate）</h4><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">integrate</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">generate_pods_project</span>
<span class="err"> </span> <span class="err"> </span> <span class="k">if</span> <span class="n">installation_options</span><span class="p">.</span><span class="nf">integrate_targets?</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="c1"># 集成用户配置，读取依赖项，使用 xcconfig 来配置</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">integrate_user_project</span>
<span class="err"> </span> <span class="err"> </span> <span class="k">else</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="no">UI</span><span class="p">.</span><span class="nf">section</span> <span class="s1">'Skipping User Project Integration'</span>
<span class="err"> </span> <span class="err"> </span> <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">generate_pods_project</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 创建 stage sanbox 用于保存安装前的沙盒状态，以支持增量编译的对比</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">stage_sandbox</span><span class="p">(</span><span class="n">sandbox</span><span class="p">,</span> <span class="n">pod_targets</span><span class="p">)</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 检查是否支持增量编译，如果支持将返回 cache result</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">cache_analysis_result</span> <span class="o">=</span> <span class="n">analyze_project_cache</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 需要重新生成的 target</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">pod_targets_to_generate</span> <span class="o">=</span> <span class="n">cache_analysis_result</span><span class="p">.</span><span class="nf">pod_targets_to_generate</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 需要重新生成的 aggregate target</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">aggregate_targets_to_generate</span> <span class="o">=</span> <span class="n">cache_analysis_result</span><span class="p">.</span><span class="nf">aggregate_targets_to_generate</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 清理需要重新生成 target 的 header 和 pod folders</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">clean_sandbox</span><span class="p">(</span><span class="n">pod_targets_to_generate</span><span class="p">)</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 生成 Pod Project，组装 sandbox 中所有 Pod 的 path、build setting、源文件引用、静态库文件、资源文件等</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">create_and_save_projects</span><span class="p">(</span><span class="n">pod_targets_to_generate</span><span class="p">,</span> <span class="n">aggregate_targets_to_generate</span><span class="p">,</span>
<span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="err"> </span> <span class="n">cache_analysis_result</span><span class="p">.</span><span class="nf">build_configurations</span><span class="p">,</span> <span class="n">cache_analysis_result</span><span class="p">.</span><span class="nf">project_object_version</span><span class="p">)</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># SandboxDirCleaner 用于清理增量 pod 安装中的无用 headers、target support files 目录</span>
<span class="err"> </span> <span class="err"> </span> <span class="no">SandboxDirCleaner</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">sandbox</span><span class="p">,</span> <span class="n">pod_targets</span><span class="p">,</span> <span class="n">aggregate_targets</span><span class="p">).</span><span class="nf">clean!</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># 更新安装后的 cache 结果到目录 `Pods/.project_cache` 下</span>
<span class="err"> </span> <span class="err"> </span> <span class="n">update_project_cache</span><span class="p">(</span><span class="n">cache_analysis_result</span><span class="p">,</span> <span class="n">target_installation_results</span><span class="p">)</span>
<span class="k">end</span>
</pre></table></code></div></div><p>将之前版本仲裁的所有组件通过 project 文件的形式组织起来，并对 project 中做一些用户指定的配置。</p><h4 id="6-写入依赖write-lockfiles">6. 写入依赖（write lockfiles）</h4><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">write_lockfiles</span>
<span class="err"> </span> <span class="vi">@lockfile</span> <span class="o">=</span> <span class="n">generate_lockfile</span>
<span class="err"> </span> <span class="no">UI</span><span class="p">.</span><span class="nf">message</span> <span class="s2">"- Writing Lockfile in </span><span class="si">#{</span><span class="no">UI</span><span class="p">.</span><span class="nf">path</span> <span class="n">config</span><span class="p">.</span><span class="nf">lockfile_path</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># No need to invoke Sandbox#update_changed_file here since this logic already handles checking if the</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># contents of the file are the same.</span>
<span class="err"> </span> <span class="err"> </span> <span class="vi">@lockfile</span><span class="p">.</span><span class="nf">write_to_disk</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="nf">lockfile_path</span><span class="p">)</span>
<span class="err"> </span> <span class="k">end</span>
<span class="err"> </span> <span class="no">UI</span><span class="p">.</span><span class="nf">message</span> <span class="s2">"- Writing Manifest in </span><span class="si">#{</span><span class="no">UI</span><span class="p">.</span><span class="nf">path</span> <span class="n">sandbox</span><span class="p">.</span><span class="nf">manifest_path</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># No need to invoke Sandbox#update_changed_file here since this logic already handles checking if the</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1"># contents of the file are the same.</span>
<span class="err"> </span> <span class="err"> </span> <span class="vi">@lockfile</span><span class="p">.</span><span class="nf">write_to_disk</span><span class="p">(</span><span class="n">sandbox</span><span class="p">.</span><span class="nf">manifest_path</span><span class="p">)</span>
<span class="err"> </span> <span class="k">end</span>
<span class="k">end</span>
</pre></table></code></div></div><p>将依赖更新写入 Podfile.lock 与 Manifest.lock</p><h4 id="7-结束回调perform-post-install-action">7. 结束回调（perform post install action）</h4><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">perform_post_install_actions</span>
<span class="err"> </span> <span class="c1"># 调用 HooksManager 执行每个插件的 post_install 方法 </span>
<span class="err"> </span> <span class="n">run_plugins_post_install_hooks</span>
<span class="err"> </span> <span class="c1"># 打印过期 pod target 警告</span>
<span class="err"> </span> <span class="n">warn_for_deprecations</span>
<span class="err"> </span> <span class="c1"># 如果 pod 配置了 script phases 脚本，会主动输出一条提示消息</span>
<span class="err"> </span> <span class="n">warn_for_installed_script_phases</span>
<span class="err"> </span> <span class="c1"># 警告移除的 master specs repo 的 specs</span>
<span class="err"> </span> <span class="n">warn_for_removing_git_master_specs_repo</span>
<span class="err"> </span> <span class="c1"># 输出结束信息 `Pod installation complete!`</span>
<span class="err"> </span> <span class="n">print_post_install_message</span>
<span class="k">end</span>
</pre></table></code></div></div><p>最后的收尾工作，进行 post install action 的 hook 执行以及一些 warning 打印。</p><h2 id="cocoapods--plugins">CocoaPods + Plugins</h2><p>早在 2013 年，CocoaPods 就添加了对插件的支持，以添加不符合依赖管理和生态系统增长为主要目标的功能。CocoaPods Plugins 可以：在 install 前后添加 hook、添加新命令到 pod、以及利用 Ruby 动态性做任何事。下面介绍一下常见的插件：</p><ul><li><a href="https://github.com/leavez/cocoapods-binary">cocoapods-binary</a>：一个比较早期的二进制插件库，是诸多二进制方案的灵感来源<li><a href="https://github.com/wordpress-mobile/cocoapods-repo-update">cocoapods-repo-update</a>：自动化 pod repo update<li><a href="https://github.com/upgrad/cocoapods-integrate-flutter">cocoapods-integrate-flutter</a>：将 flutter 与现有 iOS 应用程序集成<li><a href="https://github.com/alibaba-archive/cocoapods-uploader">cocoapods-uploader</a>：上传文件/目录到远程仓库</ul><blockquote><p>许多插件可能许久未维护，读者使用需自行斟酌。</p></blockquote><h2 id="不太常见概念">不太常见概念</h2><p>CocoaPods 的配置内容几乎包含了 Xcode Build 的方方面面，因此存在许多不太常见的概念，在此做一个链接聚合以供参考。</p><ul><li><p>Clang Module / module_map / umbrella header：Clang Module 是 Clang 16.0.0 中引入的概念，用以解决 #include / #import 头文件引入导致的相关问题；module_map 是用以描述 clang module 与 header 的关系；umbrella header 则是 module_map 中的语法规范，表示指定目录中的头文件都应包含在模块中。</p><li><a href="https://clang.llvm.org/docs/Modules.html#introduction">Modules</a><li><a href="http://chuquan.me/2021/02/11/clang-module/">Clang Module</a><li><a href="https://www.stephenw.cc/2017/08/23/llvm-modules/">LLVM 中的 Module</a><li>Hmap / Xcode Header / CocoaPods Headers</ul><p>Header Map 是一组头文件信息映射表，用 .hmap 后缀表示，整体结构以 Key-Value 形式存储；Key为头文件名称、Value 为 头文件物理地址。</p><p>Xcode Phases - Header 在构建配置中分为 public、private 与 project ，用以与 target 关联；其中 public 、private 就复制到最终产物的 header 和 PrivateHeaders 中，而 project 头文件不对外使用，则不会放到最终产物。</p><ul><li><a href="https://tech.meituan.com/2021/02/25/cocoapods-hmap-prebuilt.html">一款可以让大型iOS工程编译速度提升50%的工具</a><li><a href="https://help.apple.com/xcode/mac/current/#/dev50bab713d">What are build phases?</a><li><a href="https://nshipster.com/xcconfig/">Xcconfig</a>: 一种配置文件，用以对构建设置进行声明与管理，比如区分不同的开发环境等。<li><a href="https://developer.apple.com/videos/play/wwdc2015/214/">On demand resource</a>：WWDC 2015 引入的概念，对资源文件的按需加载。</ul><h1 id="总结">总结</h1><p>Cocoapods发展这么多年却依然服役于现有的iOS工程,足以说明其包管理的重要性,有很多SDK厂商用它做SDK制品工程的管理,有很多业务团队用它做工程组件化编译,凡此种种都足以说明这个工具是一个iOS开发者必备的专业工具,有很多细节希望大家认真挖掘.</p><p>参考列表:</p><p><a href="https://cocoapods.org/">Cocoapods.org官方网站</a><br /> <a href="https://objccn.io/issue-6-4/">深入理解 CocoaPods</a><br /> <a href="http://chuquan.me/2021/02/14/understand-ios-library-and-framework/">系统理解 iOS 库与框架</a> <a href="https://swiftunwrap.com/article/cocoapods-script-phases/">Cocoapods script phases</a> <a href="http://chuquan.me/2021/12/24/podfile-analyze-principle/">CocoaPods Podfile 解析原理 </a> <br /> <a href="https://semver.org/">Semantic Versioning 2.0.0</a> <br /> <a href="https://tech.meituan.com/2021/02/25/cocoapods-hmap-prebuilt.html">一款可以让大型iOS工程编译速度提升50%的工具</a><br /> <a href="http://chuquan.me/2022/01/07/source-analyze-principle/#more">CocoaPods Source 管理机制</a><br /> <a href="https://www.desgard.com/2020/06/11/cocoapods-story-1.html#podfilelock">版本管理工具及 Ruby 工具链环境</a><br /> <a href="https://www.desgard.com/2020/08/17/cocoapods-story-2.html">整体把握 CocoaPods 核心组件 </a><br /> <a href="https://binlogo.github.io/post/gong-cheng-xiao-lu-you-hua-cocoapods-you-hua/">工程效率优化：CocoaPods优化</a><br /> <a href="https://www.sunyazhou.com/2023/04/podcommands/">pod仓库的常用命令</a><br /> <a href="https://www.sunyazhou.com/2023/03/podxcassets/">如何在pod中的podspec使用XCAssets </a><br /> <a href="https://www.sunyazhou.com/2020/10/PodSpec/">Pod spec集成第三framework和.a工作记录</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ios/'>iOS</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ios/" class="post-tag no-text-decoration" >iOS</a> <a href="/tags/macos/" class="post-tag no-text-decoration" >macOS</a> <a href="/tags/objective-c/" class="post-tag no-text-decoration" >Objective-C</a> <a href="/tags/cocoapods/" class="post-tag no-text-decoration" >Cocoapods</a> <a href="/tags/skills/" class="post-tag no-text-decoration" >skills</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 该博客文章由作者通过 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC BY 4.0</a> 进行授权。</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=CocoaPods完全使用指南 - 迈腾大队长&url=https://www.sunyazhou.com/2023/04/cocoapodsuserguide/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=CocoaPods完全使用指南 - 迈腾大队长&u=https://www.sunyazhou.com/2023/04/cocoapodsuserguide/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=CocoaPods完全使用指南 - 迈腾大队长&url=https://www.sunyazhou.com/2023/04/cocoapodsuserguide/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="http://service.weibo.com/share/share.php?title=CocoaPods完全使用指南 - 迈腾大队长&url=https://www.sunyazhou.com/2023/04/cocoapodsuserguide/" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>最近更新</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/2018/03/WhatIsThedSYM/">什么是符号表?</a><li><a href="/2024/03/masonryrelayoutviews/">使用Masonry高阶方法对子视图统一布局</a><li><a href="/2024/01/mpremotecommandlikecommand/">iOS控制中心收藏按钮likeCommand动画</a><li><a href="/2024/01/harmonyoslaunchpage/">鸿蒙启动页面开发</a><li><a href="/2024/01/arktsbasic/">ArkTS和ArkUI基础语法</a></ul></div><div id="access-tags"> <span>热门标签</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/objective-c/">Objective C</a> <a class="post-tag" href="/tags/ios/">iOS</a> <a class="post-tag" href="/tags/macos/">macOS</a> <a class="post-tag" href="/tags/skills/">skills</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/swift/">Swift</a> <a class="post-tag" href="/tags/c++/">C++</a> <a class="post-tag" href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/">音视频</a> <a class="post-tag" href="/tags/swiftui/">SwiftUI</a> <a class="post-tag" href="/tags/avfoundation/">AVFoundation</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">文章目录</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>接下来阅读</h3><div class="card-deck mb-4"><div class="card"> <a href="/2020/04/CocoapodsProblems/"><div class="card-body"> <span class="timeago small" > 2020-04-10 <i class="unloaded">2020-04-10T07:13:59+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Cocoapods清华镜像</h3><div class="text-muted small"><p> 前言 本文具有强烈的个人感情色彩,如有观看不适,请尽快关闭. 本文仅作为个人学习记录使用,也欢迎在许可协议范围内转载或分享,请尊重版权并且保留原文链接,谢谢您的理解合作. 如果您觉得本站对您能有帮助,您可以使用RSS方式订阅本站,感谢支持!. Cocoapod疑难杂症 这几天开发 总遇到疑难杂症 是因为我的cocoapods升级到了1.9.1,导致各种问题 然后还被和谐,无奈找到如下解...</p></div></div></a></div><div class="card"> <a href="/2023/03/podxcassets/"><div class="card-body"> <span class="timeago small" > 2023-03-22 <i class="unloaded">2023-03-22T02:08:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>如何在pod中的podspec使用XCAssets</h3><div class="text-muted small"><p> 前言 本文具有强烈的个人感情色彩,如有观看不适,请尽快关闭. 本文仅作为个人学习记录使用,也欢迎在许可协议范围内转载或分享,请尊重版权并且保留原文链接,谢谢您的理解合作. 如果您觉得本站对您能有帮助,您可以使用RSS方式订阅本站,感谢支持!. 背景 最近这几年,移动端工程的开发模式逐渐变成面向pod开发,就是工程大了以后每个模块和业务就变成了单独的pod. 在这种使用pod的背景下...</p></div></div></a></div><div class="card"> <a href="/2023/04/podcommands/"><div class="card-body"> <span class="timeago small" > 2023-04-03 <i class="unloaded">2023-04-03T09:10:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>pod仓库的常用命令</h3><div class="text-muted small"><p> 前言 本文具有强烈的个人感情色彩,如有观看不适,请尽快关闭. 本文仅作为个人学习记录使用,也欢迎在许可协议范围内转载或分享,请尊重版权并且保留原文链接,谢谢您的理解合作. 如果您觉得本站对您能有帮助,您可以使用RSS方式订阅本站,感谢支持!. 添加私有源站的仓库 pod repo add sunyazhou-specs https://www.sunyazhou.com/xxpro...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/2023/04/podcommands/" class="btn btn-outline-primary"><p>pod仓库的常用命令</p></a> <a href="/2023/06/learnswiftuichapter1/" class="btn btn-outline-primary"><p>SwiftUI第一章学习总结</p></a></div><div class="utterances-container"> <script src="https://utteranc.es/client.js" repo="sunyazhou13/gitment-comments" issue-term="pathname" theme="photon-dark" crossorigin="anonymous" async> </script></div><script type="text/javascript"> $(function() { window.onmessage = evt => { if (evt.origin === 'https://utteranc.es') { toggle.updateCommentStyle(); window.onmessage = null; } } }); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/sunyazhou13">sunyazhou</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，否则本网站上的博客文章均由作者根据知识共享许可协议 - 署名标示 4.0（CC BY 4.0）进行授权许可。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本博客由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，使用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> 作为主题</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">热门标签</h4><a class="post-tag" href="/tags/objective-c/">Objective C</a> <a class="post-tag" href="/tags/ios/">iOS</a> <a class="post-tag" href="/tags/macos/">macOS</a> <a class="post-tag" href="/tags/skills/">skills</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/swift/">Swift</a> <a class="post-tag" href="/tags/c++/">C++</a> <a class="post-tag" href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/">音视频</a> <a class="post-tag" href="/tags/swiftui/">SwiftUI</a> <a class="post-tag" href="/tags/avfoundation/">AVFoundation</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.sunyazhou.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
