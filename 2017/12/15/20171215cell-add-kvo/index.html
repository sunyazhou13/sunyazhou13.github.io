<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>UICollectionViewCell添加KVO | 東引甌越</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="我是孙亚洲(@sunyazhou13),一名来自北国冰城的iOS开发者,走在成为圣贤的路上.">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="UICollectionViewCell添加KVO | 東引甌越">
    <meta name="twitter:description" content="我是孙亚洲(@sunyazhou13),一名来自北国冰城的iOS开发者,走在成为圣贤的路上.">

    <meta property="og:type" content="article">
    <meta property="og:title" content="UICollectionViewCell添加KVO | 東引甌越">
    <meta property="og:description" content="我是孙亚洲(@sunyazhou13),一名来自北国冰城的iOS开发者,走在成为圣贤的路上.">

    
    <meta name="author" content="sunyazhou">
    
    <link rel="stylesheet" href="/css/vno.css">
    <link rel="stylesheet" href="//apps.bdimg.com/libs/fontawesome/4.1.0/css/font-awesome.min.css">

    
    <link rel="icon" href="/images/favicon.ico">
    

    <meta name="generator" content="hexo"/>
    
    <link rel="alternate" type="application/rss+xml" title="東引甌越" href="/atom.xml">
    

    <link rel="canonical" href="https://www.sunyazhou.com/2017/12/15/20171215cell-add-kvo/"/>

    
    <link rel="author" href="https://plus.google.com/107423989995616646161"/>
    
</head>

<body class="home-template no-js">

    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>

    
<header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/" title="前往 東引甌越 的主页"><img src="/images/logo2.jpg" width="80" alt="東引甌越 logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage for 東引甌越">東引甌越</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">不断学习, 与时俱进.</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">嗨,我是孙亚洲(@sunyazhou13),一名来自北国冰城的iOS开发者,也搞过一些mac.现居帝都北京.开发数年有余,没有为往圣续绝学深感惭愧,始于2016.望诸位同仁多多指教.</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="访问博客" class="blog-button">文章</a></li>
            
              <li class="navigation__item"><a href="/archives">归档</a></li>
            
              <li class="navigation__item"><a href="/projects">作品</a></li>
            
              <li class="navigation__item"><a href="/aboutme">关于</a></li>
            
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  
  <li class="navigation__item">
    <a href="https://weibo.com/sunyazhou13" title="我的微博" target="_blank">
      <i class='social fa fa-weibo'></i>
      <span class="label">Weibo</span>
    </a>
  </li>


  <!-- Github -->
  
  <li class="navigation__item">
    <a href="https://github.com/sunyazhou13" title="查看我的GitHub主页" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>


<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  
  <li class="navigation__item">
    <a href="https://plus.google.com/107423989995616646161" title="Google+" target="_blank">
      <i class='social fa fa-google-plus-square'></i>
      <span class="label">Google+</span>
    </a>
  </li>


<!-- Facebook -->


<!-- Twitter -->

  <li class="navigation__item">
    <a href="https://twitter.com/sunyazhou" title="上Twitter找我" target="_blank">
      <i class='social fa fa-twitter'></i>
      <span class="label">Twitter</span>
    </a>
  </li>

<!-- instagram -->


  <li class="navigation__item">
    <a href="/atom.xml" title="RSS" target="_blank">
      <i class='social fa fa-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>


  <li class="navigation__item">
    <a href="mailto:sunyazhou13@163.com" title="邮件联系我" target="_blank">
      <i class='social fa fa-envelope'></i>
      <span class="label">Email</span>
    </a>
  </li>


  </ul>
</nav>

          </div>
        </div>

      </div>

    </div>

    <div class="panel-cover--overlay cover-slate"></div>
  </div>
</header>


    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2017-12-15T09:05:10.000Z" class="post-list__meta--date date">2017-12-15</time>
 &#8226; <span class="post-meta__tags tags">分类&nbsp;
  <a class="tag-link" href="/tags/iOS开发/">iOS开发</a>, <a class="tag-link" href="/tags/macOS开发/">macOS开发</a>

</span>
    </div>
    <h1 class="post-title">UICollectionViewCell添加KVO</h1>
  </header>

  <section class="post">
    <p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/20171215cell-add-kvo/UICollectionViewCell.png" alt=""></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>都一个多月没更新博客了,这一段时间太忙了. 这篇带来的分享内容是<strong>如何正确的给一个<code>UICollectionViewCell</code>添加<code>KVO</code>监听</strong>.</p>
<h2 id="开篇"><a href="#开篇" class="headerlink" title="开篇"></a>开篇</h2><p>由于目前在开发<a href="https://github.com/ksvc/KSYMediaEditorKit_iOS" target="_blank" rel="external">短视频</a>相关的SDK,面向的多数都是小白开发者,为了能让小白以最低的成本看懂 SDK 的代码以及用法,这就要求我们以小白最容易理解的方式开发代码,比如最低级的<code>MVC</code>模式,最直白的<code>Objective-C</code>(老实说我都烦透了 OC 这种超级长看着都难受的编程语言,早想用 swift 来玩一把了),所以在开发的技术选型和代码编写过程中都是达到小白最低的理解能力的开发模式,但有时候不得不面对在<em>小白能理解</em>和<em>功能的高级实现</em>之间做妥协.最近开发遇到个问题,如下:</p>
<blockquote>
<p>PM 有个需求 要实现在一个屏幕内多个 cell 上随意切换 录制视图并且能随意点击取消,再加上录制完成的视频如果不在选中状态就显示封面,如果在选中状态就继续预览,如果没有录制完的视频并且不在预览的 CELL要显示添加功能.</p>
</blockquote>
<p>听完这个需求是不是都晕了,我们来看张我实现完成的图.</p>
<p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/20171215cell-add-kvo/record_demo.gif" alt=""></p>
<ol>
<li>录制完的视频取出封面</li>
<li>正在预览的随时准备录制</li>
<li>随意能切换 cell 不影响录制视图</li>
<li>未录制的并且没有已录制完视频文件的 cell 显示 添加按钮</li>
</ol>
<p>第一眼看着没啥技术含量都 UI 是吧</p>
<p>好我们来玩点有技术含量的</p>
<h4 id="问题1"><a href="#问题1" class="headerlink" title="问题1"></a>问题1</h4><p>如果使用传统MVC 模式的话<code>Cell</code>上边显示数据,那<code>model</code>里面是不是要放一个<code>record</code>的实例对象 告诉它 啥时候开始啥时候结束,当然你有更好的方式我就不说了我其实也知道.</p>
<h4 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h4><p>取出封面很简单让 cell里面存储一下录制完的 URL 就可以了,然后每次调用 UICollectonView 的 <code>reload:</code>方法</p>
<h4 id="问题3"><a href="#问题3" class="headerlink" title="问题3"></a>问题3</h4><p>我们实现录制视图的方式是放在 cell 的一个 subview 上, 正在录制的视图如果 reload 的话 应该会瞬间没了.就算吭哧吭哧实现完开始录制、暂停录制、恢复录制、结束录制… 这活我觉得问题和隐患应该非常多.别想了 不能这么玩</p>
<h4 id="问题4"><a href="#问题4" class="headerlink" title="问题4"></a>问题4</h4><p>cell的选中和非选中问题,你有没有发现 如果正在录制的 cell 上的 view 是选中的有个红色的框代表当前属于 焦点状态.<br>那录制完成呢.是不是需要重新 reload cell 告诉它当前谁 选中 谁取消,如果点击的是同一个 cell 还要取反操作.如果正在预览是不是再次选中说明要停止预览显示加号或者封面图,想着想着你发现这玩意是个状态机.必须要想好 model 构造,要让model 的参数足够多去控制当前 cell 的选中状态、非选中状态、预览状态、非预览状态、录制状态、非录制状态、录完状态、停止录制状态… 想着想着 太麻烦了 于是我整理出一个状态机的表格 如下:</p>
<table>
<thead>
<tr>
<th style="text-align:center">Cell Status</th>
<th style="text-align:center">当前cell显示内容</th>
<th style="text-align:center">其它 cell 显示内容</th>
<th style="text-align:center">点击当前</th>
<th style="text-align:center">点击其它选中</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">无预览状态</td>
<td style="text-align:center">显示加号/封面图</td>
<td style="text-align:center">显示加号/或者封面</td>
<td style="text-align:center">开始预览</td>
<td style="text-align:center">切换预览视图</td>
</tr>
<tr>
<td style="text-align:center">正在预览状态</td>
<td style="text-align:center">预览视频</td>
<td style="text-align:center">显示加号/或者封面</td>
<td style="text-align:center">显示加号/或者封面</td>
<td style="text-align:center">切换预览视图</td>
</tr>
<tr>
<td style="text-align:center">正在录制状态</td>
<td style="text-align:center">预览视频/播放视频</td>
<td style="text-align:center">(显示加号或播放视频)/(显示加号或预览视频)</td>
<td style="text-align:center">无操作(上锁)</td>
<td style="text-align:center">无操作(上锁)</td>
</tr>
</tbody>
</table>
<blockquote>
<p><em>这些不重要,有这个印象就行了不用仔细看</em></p>
</blockquote>
<p>并不是我把问题复杂化,是 PM 的需求太复杂.不得不完整列出所有状态,精简,再精简,让小白开发者也能看懂的 SDK 才是好 SDK.</p>
<p>其实 其它的问题还有好多 我就不列出来了,好 现在我们来依次解决问题</p>
<p><strong>其实,综合上述信息来看,归根结底的原因是,实现这个录制随意切换功能等等的交互并不适用于<code>MVC</code>这种传统的玩法.<br>更像是一个<code>MVVM</code>的搞法</strong>,于是我想到了 MVVM 里面的精髓所在.要用<strong>数据驱动视图</strong>.</p>
<p>上面的4个主要问题不就是因为 model 的状态修改了要通知 cell 变化嘛.那我们使用 model 的状态来控制</p>
<blockquote>
<p>注意:<em>如果使用 MVVM 的玩法就不要再去调用 collectionview 的 reload:方法了</em></p>
</blockquote>
<p>目前开发实现<code>MVVM</code>的方式主流两种</p>
<ul>
<li>RAC</li>
<li>KVO</li>
</ul>
<p>显然<code>RAC</code>太大并不适用于我们 demo,用 KVO 搞一把.(代码有删减)</p>
<h4 id="第一步定义-model"><a href="#第一步定义-model" class="headerlink" title="第一步定义 model"></a>第一步定义 model</h4><figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^CompletionHandler)(<span class="built_in">UIImage</span> * image); <span class="comment">//取出 Image 给 Cell 显示的回调</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSUInteger</span>,KSYMultiCanvasModelStatus)&#123;</div><div class="line">    KSYMultiCanvasModelStatusNOPreview = <span class="number">0</span>,<span class="comment">//无预览状态</span></div><div class="line">    KSYMultiCanvasModelStatusINPreview = <span class="number">1</span>,<span class="comment">//正在预览状态</span></div><div class="line">    KSYMultiCanvasModelStatusRecording = <span class="number">2</span> <span class="comment">//正在录制状态</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">KSYCanvasModel</span> : <span class="title">NSObject</span> </span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSURL</span>  *videoURL; <span class="comment">//存放录制完视频 URL</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span>   isSelected;<span class="comment">//是否是选中</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) KSYMultiCanvasModelStatus modelStatus; <span class="comment">//重要!!!:模型状态用它控制 cell 显示</span></div><div class="line">- (<span class="keyword">void</span>)gengrateImageBySize:(<span class="built_in">CGSize</span>)size</div><div class="line">          completionHandler:(CompletionHandler)handler;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">KSYCanvasModel</span> ()</span></div><div class="line"></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)<span class="built_in">AVAssetImageGenerator</span> *imageGenerator;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">KSYCanvasModel</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)gengrateImageBySize:(<span class="built_in">CGSize</span>)size</div><div class="line">          completionHandler:(CompletionHandler)handler&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.videoURL == <span class="literal">nil</span>) &#123; handler(<span class="literal">nil</span>); &#125;</div><div class="line">    </div><div class="line">    <span class="built_in">AVURLAsset</span> *asset = [<span class="built_in">AVURLAsset</span> assetWithURL:<span class="keyword">self</span>.videoURL];</div><div class="line">    <span class="keyword">self</span>.imageGenerator = <span class="literal">nil</span>;</div><div class="line">    <span class="keyword">self</span>.imageGenerator = [<span class="built_in">AVAssetImageGenerator</span> assetImageGeneratorWithAsset:asset];</div><div class="line">    <span class="keyword">self</span>.imageGenerator.maximumSize = size;</div><div class="line">    </div><div class="line">    <span class="built_in">NSError</span> *error=<span class="literal">nil</span>;</div><div class="line">    <span class="built_in">CMTime</span> time= kCMTimeZero;<span class="comment">//CMTime是表示电影时间信息的结构体，第一个参数表示是视频第几秒，第二个参数表示每秒帧数.(如果要活的某一秒的第几帧可以使用CMTimeMake方法)</span></div><div class="line">    <span class="built_in">CMTime</span> actualTime;</div><div class="line">    <span class="built_in">CGImageRef</span> cgImage= [<span class="keyword">self</span>.imageGenerator copyCGImageAtTime:time actualTime:&amp;actualTime error:&amp;error];</div><div class="line">    <span class="keyword">if</span>(error)&#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"截取视频缩略图时发生错误，错误信息：%@"</span>,error.localizedDescription);</div><div class="line">        handler(<span class="literal">nil</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">CMTimeShow</span>(actualTime);</div><div class="line">    <span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithCGImage:cgImage];<span class="comment">//转化为UIImage</span></div><div class="line">    <span class="built_in">CGImageRelease</span>(cgImage);</div><div class="line">    handler(image);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>ok model 大概是这样 .m 文件主要是从视频中取封面图</p>
<h4 id="第二步定义-cell"><a href="#第二步定义-cell" class="headerlink" title="第二步定义 cell"></a>第二步定义 cell</h4><figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">"KSYCanvasModel.h"</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">NSString</span> *KSYModelKVOStatusContext;</div><div class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *KSYKeyPathForModelStatus = <span class="string">@"modelStatus"</span>;</div><div class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *KSYKeyPathForIsSelected = <span class="string">@"isSelected"</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">KSYCanvasCell</span> : <span class="title">UICollectionViewCell</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UIView</span> *canvasImageView;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UIImageView</span> *addImageView;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UIImageView</span> *boundsView;</div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) KSYCanvasModel *model;</div><div class="line"></div><div class="line"><span class="comment">//注册和移除观察接口</span></div><div class="line">- (<span class="keyword">void</span>)addObserver:(<span class="built_in">NSObject</span> *)observer</div><div class="line">         forKeyPath:(<span class="built_in">NSString</span> *)keyPath</div><div class="line">            options:(<span class="built_in">NSKeyValueObservingOptions</span>)options</div><div class="line">            context:(<span class="keyword">void</span> *)context;</div><div class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer</div><div class="line">            forKeyPath:(<span class="built_in">NSString</span> *)keyPath </div><div class="line">               context:(<span class="keyword">void</span> *)context;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">KSYCanvasCell</span>()</span></div><div class="line"><span class="comment">// 使用 ObservableKeys 保存 keyPath 观察状态，避免重复注册和重复移除（重复移除会导致 crash）</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableSet</span> *observableKeySets;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">KSYCanvasCell</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)awakeFromNib &#123;</div><div class="line">    [<span class="keyword">super</span> awakeFromNib];</div><div class="line">    </div><div class="line">    <span class="comment">//千万别把 KOV 监听写在这里</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//.,,此处省略了不太相关的代码</span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)addObserver:(<span class="built_in">NSObject</span> *)observer</div><div class="line">         forKeyPath:(<span class="built_in">NSString</span> *)keyPath</div><div class="line">            options:(<span class="built_in">NSKeyValueObservingOptions</span>)options</div><div class="line">            context:(<span class="keyword">void</span> *)context&#123;</div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.observableKeySets containsObject:keyPath]) &#123; <span class="keyword">return</span>; &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.observableKeySets == <span class="literal">nil</span>) &#123;</div><div class="line">        <span class="keyword">self</span>.observableKeySets = [<span class="built_in">NSMutableSet</span> set];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.observableKeySets addObject:keyPath];</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.model addObserver:observer</div><div class="line">                 forKeyPath:keyPath</div><div class="line">                    options:options</div><div class="line">                    context:context];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer</div><div class="line">            forKeyPath:(<span class="built_in">NSString</span> *)keyPath</div><div class="line">               context:(<span class="keyword">void</span> *)context&#123;</div><div class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span>.observableKeySets containsObject:keyPath]) &#123; <span class="keyword">return</span>; &#125;</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.model removeObserver:observer</div><div class="line">                    forKeyPath:keyPath</div><div class="line">                       context:context];</div><div class="line">    [<span class="keyword">self</span>.observableKeySets removeObject:keyPath];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath</div><div class="line">                      ofObject:(<span class="keyword">id</span>)object</div><div class="line">                        change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; *)change</div><div class="line">                       context:(<span class="keyword">void</span> *)context&#123;</div><div class="line">    <span class="keyword">if</span> ([KSYKeyPathForModelStatus isEqualToString:keyPath]) &#123;</div><div class="line">        KSYMultiCanvasModelStatus modelStatus = [[change objectForKey:<span class="built_in">NSKeyValueChangeNewKey</span>] integerValue];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"当前状态:%zd"</span>,modelStatus);</div><div class="line">		 <span class="comment">//拿到模型状态然后做适当的处理</span></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>([KSYKeyPathForIsSelected isEqualToString:keyPath])&#123;</div><div class="line">        <span class="comment">//处理是否显示边框</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<blockquote>
<p>这里要在.h 里面复写 下面这俩个方法 因为要再 ViewController 里面拿到 cell 调用这个方法</p>
</blockquote>
<ul>
<li><code>addObserver:forKeyPath:options:context:</code> 这个方法是系统方法需要复写并对外暴露接口</li>
<li><code>removeObserver:forKeyPath:context:</code> 这个方法是系统方法需要复写并对外暴露接口</li>
</ul>
<p>这里定义了一个上下文对象用于找到识别这个在 cell的监听还有两个要监听的属性(KSYCanvasCell.h 顶部)</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">NSString</span> *KSYModelKVOStatusContext;</div><div class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *KSYKeyPathForModelStatus = <span class="string">@"modelStatus"</span>;</div><div class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *KSYKeyPathForIsSelected = <span class="string">@"isSelected"</span>;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意:<strong>为了防止 cell 重复注册导致复用的时候崩溃,这里用<code>NSMutableSet</code>让 model 的观察者只注册一次</strong></p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">KSYCanvasCell</span>()</span></div><div class="line"><span class="comment">// 使用 ObservableKeys 保存 keyPath 观察状态，避免重复注册和重复移除（重复移除会导致 crash）</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableSet</span> *observableKeySets;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>添加的时候做一次check</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)addObserver:(<span class="built_in">NSObject</span> *)observer</div><div class="line">         forKeyPath:(<span class="built_in">NSString</span> *)keyPath</div><div class="line">            options:(<span class="built_in">NSKeyValueObservingOptions</span>)options</div><div class="line">            context:(<span class="keyword">void</span> *)context&#123;</div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.observableKeySets containsObject:keyPath]) &#123; <span class="keyword">return</span>; &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.observableKeySets == <span class="literal">nil</span>) &#123;</div><div class="line">        <span class="keyword">self</span>.observableKeySets = [<span class="built_in">NSMutableSet</span> set];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.observableKeySets addObject:keyPath];</div><div class="line">    </div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>移除的时候要做一次 check</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer</div><div class="line">            forKeyPath:(<span class="built_in">NSString</span> *)keyPath</div><div class="line">               context:(<span class="keyword">void</span> *)context&#123;</div><div class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span>.observableKeySets containsObject:keyPath]) &#123; <span class="keyword">return</span>; &#125;</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.model removeObserver:observer</div><div class="line">                    forKeyPath:keyPath</div><div class="line">                       context:context];</div><div class="line">    [<span class="keyword">self</span>.observableKeySets removeObject:keyPath];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ok cell 大概是这个意思</p>
<h4 id="第三步在-ViewController里面-适当的位置-注册-移除监听-并在ViewController控制器的生命周期内也做好相关监听的移除和添加"><a href="#第三步在-ViewController里面-适当的位置-注册-移除监听-并在ViewController控制器的生命周期内也做好相关监听的移除和添加" class="headerlink" title="第三步在 ViewController里面 适当的位置 注册/移除监听 并在ViewController控制器的生命周期内也做好相关监听的移除和添加"></a>第三步在 ViewController里面 适当的位置 注册/移除监听 并在ViewController控制器的生命周期内也做好相关监听的移除和添加</h4><p>这里我们需要实现<code>UICollectionViewDelegate</code>的代理协议来调用 cell 的添加 cell 和移除 cell</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)collectionView:(<span class="built_in">UICollectionView</span> *)collectionView willDisplayCell:(<span class="built_in">UICollectionViewCell</span> *)cell forItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath&#123;</div><div class="line">    KSYCanvasCell *canvasCell = (KSYCanvasCell *)cell;</div><div class="line">    [canvasCell addObserver:canvasCell</div><div class="line">                 forKeyPath:KSYKeyPathForModelStatus</div><div class="line">                    options:<span class="built_in">NSKeyValueObservingOptionNew</span></div><div class="line">                    context:&amp;KSYModelKVOStatusContext];</div><div class="line">    [canvasCell addObserver:canvasCell</div><div class="line">                 forKeyPath:KSYKeyPathForIsSelected</div><div class="line">                    options:<span class="built_in">NSKeyValueObservingOptionNew</span></div><div class="line">                    context:&amp;KSYModelKVOStatusContext];</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)collectionView:(<span class="built_in">UICollectionView</span> *)collectionView didEndDisplayingCell:(<span class="built_in">UICollectionViewCell</span> *)cell forItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath&#123;</div><div class="line">    KSYCanvasCell *canvasCell = (KSYCanvasCell *)cell;</div><div class="line">    <span class="comment">//状态变化</span></div><div class="line">    [canvasCell removeObserver:canvasCell</div><div class="line">                    forKeyPath:KSYKeyPathForModelStatus</div><div class="line">                       context:&amp;KSYModelKVOStatusContext];</div><div class="line">    <span class="comment">//选中变化</span></div><div class="line">    [canvasCell removeObserver:canvasCell</div><div class="line">                    forKeyPath:KSYKeyPathForIsSelected</div><div class="line">                       context:&amp;KSYModelKVOStatusContext];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你是不是会问为啥写这 </p>
<p>我来告诉我我遇到的一个坑</p>
<p>如果你在 下面的方法里写注册 后果不堪设想,因为 cell 是复用的,每次复写 KVO 都是在创建新的对象</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">- (__kindof <span class="built_in">UICollectionViewCell</span> *)collectionView:(<span class="built_in">UICollectionView</span> *)collectionView cellForItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath&#123;</div><div class="line">    KSYCanvasCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:[KSYCanvasCell className] forIndexPath:indexPath];</div><div class="line">    cell.model = [<span class="keyword">self</span>.models objectAtIndex:indexPath.row];</div><div class="line">    <span class="comment">//如果写在这里</span></div><div class="line">    <span class="keyword">return</span> cell;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>KVO的实现原理很简单,就是把这个对象的监听属性在底层复写一下,监听两个值之间的变化.KVO 原理相关的就不多废话了,这都是家常便饭了</p>
<p>我一开始写在了 cell 的 awakeFromNib: 因为都是 cell 拖拽的控件,但是麻烦真是接踵而至,各种崩溃</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)awakeFromNib &#123;</div><div class="line">    [<span class="keyword">super</span> awakeFromNib];</div><div class="line">	 <span class="comment">//别写在这里    </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你不信邪可以试试.</p>
<p>最后我们在控制器的适当位置修改 model 的状态这样就做到了实时更新 cell</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"></div><div class="line">- (<span class="keyword">void</span>)collectionView:(<span class="built_in">UICollectionView</span> *)collectionView didSelectItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath&#123;</div><div class="line">    <span class="comment">//------------处理点击-----------</span></div><div class="line">    KSYCanvasModel *lastModel = [<span class="keyword">self</span>.models objectAtIndex:<span class="keyword">self</span>.lastSelectedIndexPath.row];</div><div class="line">    KSYCanvasModel *selectedModel = [<span class="keyword">self</span>.models objectAtIndex:indexPath.row];</div><div class="line">    <span class="built_in">BOOL</span> clickSameCell = (<span class="keyword">self</span>.lastSelectedIndexPath == indexPath);</div><div class="line">    <span class="keyword">if</span> (clickSameCell) &#123;</div><div class="line">        <span class="comment">//选择同一个cell</span></div><div class="line">        selectedModel.isSelected = !selectedModel.isSelected;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        lastModel.isSelected = <span class="literal">NO</span>;</div><div class="line">        selectedModel.isSelected = <span class="literal">YES</span>;   </div><div class="line">    &#125;</div><div class="line">    selectedModel.modelStatus = KSYMultiCanvasModelStatusRecording; <span class="comment">//这就会出发 cell的 KVO 了</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后别忘了在ViewController的生命周期添加和移出观察者</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewWillDisappear:(<span class="built_in">BOOL</span>)animated</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> viewWillDisappear:animated];</div><div class="line">    [<span class="keyword">self</span>.canvasCollectionView.visibleCells enumerateObjectsUsingBlock:^(KSYCanvasCell *cell, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</div><div class="line">        [cell removeObserver:cell</div><div class="line">                  forKeyPath:KSYKeyPathForModelStatus</div><div class="line">                     context:&amp;KSYModelKVOStatusContext];</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样的实现过程就 解决了 上边提到的 问题 1、2、3、4</p>
<p>这也是最精简的实现方式,以小白的开发视角 来看也需要熟悉一点 MVVM 了.这都是成了 iOS 最标配了.</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这种偏向MVVM模式开发的方式 我个人觉得还是不错的,虽然现在各种MVVM格式早已经烂大街了,但只要想起来,用起来,能用简单直白的方式解决问题,它就是好的开发设计模式.当然本章也主要讲了一些技巧而已,不足之处还请各位指正.</p>
<p>demo我就不写了 可以参考<a href="https://github.com/ksvc/KSYMediaEditorKit_iOS" target="_blank" rel="external">我们的短视频 demo</a> multicanvas target</p>
<p>全文完</p>

  </section>

</article>


    <! -- 添加捐赠图标 -->
<div class ="post-donate">
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           ↑<br>
           欣赏此文？求鼓励，求支持！
        </span>
        <br>
    </div>  
    <div id="donate_guide" class="donate_bar center hidden" >
        <!-- 方式一： 
            ![](/img/Alipay.jpg)
            ![](/img/WeChatpay.jpg)
        -->
        <!-- 方式二；
            step1：在_config.yml中添加配置
                Alipay: /img/Alipay.jpg
                WeChatpay: /img/WeChatpay.jpg
            step2：此处两张图片的路径分别设置为如下
                <img src="undefined"
                <img src="undefined"
        -->
        <!-- 支付宝打赏图案 -->
        <img src="/images/Alipay.jpg" alt="支付宝打赏">
        <!-- 微信打赏图案 -->
        <img src="/images/WeChatpay.jpg" alt="微信打赏">
    </div>
    <script type="text/javascript">
        document.getElementById('btn_donate').onclick = function(){
            $('#donate_board').addClass('hidden');
            $('#donate_guide').removeClass('hidden');
        }
    </script>
</div>

<! -- 添加捐赠图标 -->



<section class="read-more">
     
        
            <div class="read-more-item">
                <span class="read-more-item-dim">最近的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2017/12/19/20171219AudioPan/" title="音频声像Pan值电平左右声道平衡">音频声像Pan值电平左右声道平衡</a></h2>
                <p class="excerpt">
                
                
前言最近在开发多媒体音视频相关业务,期间遇到的问题这里全做记录下来,下面是同事提供的一个例子我整理出来,以备后续开发遇到此类问题有个备案.
开篇最近开发音频涉及到左右声道调节,基于左右声道的音量实现 声音环绕效果.下面是 UI 演示.

这里其实修改的类似 AVAudioPlayer里面的pan值
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2017-12-19T03:40:13.000Z" class="post-list__meta--date date">2017-12-19</time>
 &#8226; <span class="post-list__meta--tags tags">于&nbsp;
  <a class="tag-link" href="/tags/iOS开发/">iOS开发</a>, <a class="tag-link" href="/tags/macOS开发/">macOS开发</a>

</span><a class="btn-border-small" href="/2017/12/19/20171219AudioPan/">继续阅读</a></div>

            </div>
        

        
            <div class="read-more-item">
                <span class="read-more-item-dim">更早的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2017/11/03/20171103iPhone-X-Adaptor/" title="适配iPhone X">适配iPhone X</a></h2>
                <p class="excerpt">
                
                
前言最近苹果发布iPhone X,随后小伙伴的 X 都到货了,适配问题也接踵而至,相信拿到 iPhone X的感觉是下面这样的:

本篇主要内容分为:

iPhone X尺寸参数
UI适配
极端情况处理
实践案例
总结

1.iPhone X尺寸参数1.1 首先 来围观一下模拟器的 iPhone 
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2017-11-03T03:44:44.000Z" class="post-list__meta--date date">2017-11-03</time>
 &#8226; <span class="post-list__meta--tags tags">于&nbsp;
  <a class="tag-link" href="/tags/iOS开发/">iOS开发</a>

</span><a class="btn-border-small" href="/2017/11/03/20171103iPhone-X-Adaptor/">继续阅读</a></div>

            </div>
        
   
</section>



  <div id="gitalk-container" style="padding: 0px 30px 0px 30px;"></div> 

  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script type="text/javascript">

  if(true){
    var gitalk = new Gitalk({
      clientID: '15c55ed469ea673ae332',
      clientSecret: '1801dbf9b1589c256260c85d779eb51d0cf40885',
      repo: 'gitment-comments',
      owner: 'sunyazhou13',
      admin: ['sunyazhou13'],
      id: 'Fri Dec 15 2017 17:05:10 GMT+0800',
      distractionFreeMode: 'true'
  })
  gitalk.render('gitalk-container') 
  }
  </script>




            <footer class="footer">
    <span class="footer__copyright">
        本站点采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>
    </span>
    <span class="footer__copyright">
        基于 <a href="http://hexo.io">Hexo</a> 搭建，感谢 <a href="https://pages.github.com/">GitHub Pages</a> 和 Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a> 提供免费的托管服务
    </span>
    <span class="footer__copyright">
        &copy; 2019 - 本站由 <a href="/">@sunyazhou13</a> 创建,
        使用<a href="https://github.com/lenbo-ma/hexo-theme-vno">hexo-theme-vno</a>主题,
        修改自<a href="https://github.com/onevcat/vno" target="_blank">喵神的vno</a>
    </span>
</footer>

        </div>
    </div>

    <script src="https://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="/js/main.js"></script>

     




    


    

<script type="text/javascript">

// var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
// document.write(unescape("%3Cspan id='cnzz_stat_icon_1274885345'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s13.cnzz.com/z_stat.php%3Fid%3D1274885345%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));

var cnzz_s_tag = document.createElement('script');
cnzz_s_tag.type = 'text/javascript';
cnzz_s_tag.async = true;
cnzz_s_tag.charset = "utf-8";
cnzz_s_tag.src = src="https://s13.cnzz.com/z_stat.php?id=1274885345&web_id=1274885345&async=1";
var root_s = document.getElementsByTagName('script')[0];
root_s.parentNode.insertBefore(cnzz_s_tag, root_s);

</script>


</body>
</html>
