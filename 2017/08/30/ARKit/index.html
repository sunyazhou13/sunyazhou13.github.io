<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>ARKit技术初探 | 東引甌越</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="嗨，我是孙亚洲, 一个来自北国冰城的iOS&amp;macOS开发者,就职于百度,爱好书法。开发5年有余,没有为往圣续绝学深感惭愧，今2017年开始写博客, 望诸位同仁多多指教.">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="ARKit技术初探 | 東引甌越">
    <meta name="twitter:description" content="嗨，我是孙亚洲, 一个来自北国冰城的iOS&amp;macOS开发者,就职于百度,爱好书法。开发5年有余,没有为往圣续绝学深感惭愧，今2017年开始写博客, 望诸位同仁多多指教.">

    <meta property="og:type" content="article">
    <meta property="og:title" content="ARKit技术初探 | 東引甌越">
    <meta property="og:description" content="嗨，我是孙亚洲, 一个来自北国冰城的iOS&amp;macOS开发者,就职于百度,爱好书法。开发5年有余,没有为往圣续绝学深感惭愧，今2017年开始写博客, 望诸位同仁多多指教.">

    
    <meta name="author" content="sunyazhou">
    
    <link rel="stylesheet" href="/css/vno.css">
    <link rel="stylesheet" href="//apps.bdimg.com/libs/fontawesome/4.1.0/css/font-awesome.min.css">

    
    <link rel="icon" href="/images/favicon.ico">
    

    <meta name="generator" content="hexo"/>
    
    <link rel="alternate" type="application/rss+xml" title="東引甌越" href="/atom.xml">
    

    <link rel="canonical" href="https://www.sunyazhou.com/2017/08/30/ARKit/"/>

    
    <link rel="author" href="https://plus.google.com/107423989995616646161"/>
    

    
<script type="text/javascript">
	var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?36adfbed8b30cd669f1457e388071878";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();

</script>

</head>

<body class="home-template no-js">

    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>

    
<header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/" title="前往 東引甌越 的主页"><img src="/images/logo2.jpg" width="80" alt="東引甌越 logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage for 東引甌越">東引甌越</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">不断学习, 与时俱进.</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">嗨,我是孙亚洲(@sunyazhou13),一名来自北国冰城的iOS/macOS开发者.现居帝都北京.开发数年有余,没有为往圣续绝学深感惭愧,今2017年开始写博客.望诸位同仁多多指教.</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="访问博客" class="blog-button">文章</a></li>
            
              <li class="navigation__item"><a href="/archives">归档</a></li>
            
              <li class="navigation__item"><a href="/aboutme">关于</a></li>
            
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  
  <li class="navigation__item">
    <a href="https://weibo.com/sunyazhou13" title="我的微博" target="_blank">
      <i class='social fa fa-weibo'></i>
      <span class="label">Weibo</span>
    </a>
  </li>


  <!-- Github -->
  
  <li class="navigation__item">
    <a href="https://github.com/sunyazhou13" title="查看我的GitHub主页" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>


<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  
  <li class="navigation__item">
    <a href="https://plus.google.com/107423989995616646161" title="Google+" target="_blank">
      <i class='social fa fa-google-plus-square'></i>
      <span class="label">Google+</span>
    </a>
  </li>


<!-- Facebook -->


<!-- Twitter -->

  <li class="navigation__item">
    <a href="https://twitter.com/sunyazhou" title="上Twitter找我" target="_blank">
      <i class='social fa fa-twitter'></i>
      <span class="label">Twitter</span>
    </a>
  </li>

<!-- instagram -->


  <li class="navigation__item">
    <a href="/atom.xml" title="RSS" target="_blank">
      <i class='social fa fa-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>


  <li class="navigation__item">
    <a href="mailto:sunyazhou13@163.com" title="邮件联系我" target="_blank">
      <i class='social fa fa-envelope'></i>
      <span class="label">Email</span>
    </a>
  </li>


  </ul>
</nav>

          </div>
        </div>

      </div>

    </div>

    <div class="panel-cover--overlay cover-disabled"></div>
  </div>
</header>


    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2017-08-30T06:50:43.000Z" class="post-list__meta--date date">2017-08-30</time>
 &#8226; <span class="post-meta__tags tags">分类&nbsp;
  <a class="tag-link" href="/tags/iOS开发/">iOS开发</a>, <a class="tag-link" href="/tags/macOS开发/">macOS开发</a>

</span>
    </div>
    <h1 class="post-title">ARKit技术初探</h1>
  </header>

  <section class="post">
    <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/ARKit/ARKit_preview.png" alt=""></p>
<p>本篇会从广泛介绍到详细介绍,也就是从粗粒度向细粒度逐渐过度讲解.<br>期间有任何问题请大家集思广益,多多指教. </p>
<h1 id="主要内容"><a href="#主要内容" class="headerlink" title="主要内容"></a>主要内容</h1><ul>
<li><strong>AR技术介绍</strong> </li>
<li><strong>ARKit工作原理及流程介绍</strong> </li>
<li><strong>ARKit简单代码实现</strong> </li>
<li><strong>ARKit框架所有API介绍</strong> </li>
<li><strong>ARScnView介绍</strong> </li>
<li><strong>ARSession介绍</strong> </li>
<li><strong>ARCamera介绍</strong> </li>
<li><strong>ARKit捕捉平地</strong> </li>
<li><strong>AR代码demo实现</strong> </li>
</ul>
<h2 id="AR技术介绍"><a href="#AR技术介绍" class="headerlink" title="AR技术介绍"></a>AR技术介绍</h2><h4 id="AR技术简介"><a href="#AR技术简介" class="headerlink" title="AR技术简介"></a>AR技术简介</h4><ul>
<li>增强现实技术（Augmented Reality，简称 AR），是一种实时的计算摄影机影像的位置及角度并加上相应图像、视频、3D模型的技术，这种技术的目标是在屏幕上把虚拟世界套在现实世界并进行互动</li>
<li>AR场景实现技术要素<ol>
<li>多媒体捕捉现实图像：如摄像头</li>
<li>三维建模:3D立体模型</li>
<li>传感器追踪:主要追踪现实世界动态物体的六轴变化，这六轴分别是X、Y、Z轴位移及旋转。其中位移三轴决定物体的方位和大小，旋转三轴决定物体显示的区域</li>
<li>坐标识别及转换：3D模型显示在现实图像中不是单纯的frame坐标点，而是一个三维的矩阵坐标</li>
<li>AR还可以与虚拟物体进行一些交互(optional)<br><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/447c7f0d7eed6cd1e4971d0fa19bef8401686383/ARKit/AR_Direction.png" alt=""></li>
</ol>
</li>
</ul>
<h4 id="ARKit概述及特点"><a href="#ARKit概述及特点" class="headerlink" title="ARKit概述及特点"></a>ARKit概述及特点</h4><ul>
<li><p><code>ARKit</code> 框架(framework)提供 两种 AR 技术</p>
<ul>
<li><strong>基于3D 场景(<code>SceneKit</code>) 实现的增强现实</strong></li>
<li><p><strong>基于2D 场景(<code>SpriktKit</code>) 实现的增强现实</strong>  </p>
<blockquote>
<p> 一般主流都是基于3D 实现,<code>ARkit</code>兼容 <code>SceneKit</code>和 <code>SpriktKit</code> (苹果推出游戏引擎)framework </p>
</blockquote>
</li>
</ul>
</li>
<li><p>显示AR 效果为什么依赖 <strong>3D引擎<code>SceneKit</code>和 2D 引擎<code>SpriktKit</code> 苹果的游戏引擎框架? 原因是游戏引擎才可以加载物体模型。</strong></p>
<blockquote>
<p> 虽然<code>ARKit</code>中的视图<strong>(<code>ARSCNView</code>)继承自<code>SCNView</code>,<code>SCNView</code>继承自<code>UIView</code></strong>,<br>但是目前<code>ARKit</code>框架本身只包含相机追踪, 不能直接加载物体模型, 所以只能依赖游戏引擎加载 ARKit (我觉得苹果是在充分利用和整合现有资源并推广自己的 framework 一石二鸟) 因为就目前我没有看到 任何<code>ARKit</code>支持 <code>Unity3D</code>或者 <code>Cocoas2D</code></p>
</blockquote>
</li>
</ul>
<h4 id="iOS11-如何支持ARKit"><a href="#iOS11-如何支持ARKit" class="headerlink" title="iOS11 如何支持ARKit"></a>iOS11 如何支持<code>ARKit</code></h4><p>iOS11虽然推出了 <code>ARKit</code> 但不是所有 iOS11系统都支持  </p>
<ul>
<li>必须 CPU  A9以上(iPhone 6s 以上 还有 iPhone SE)</li>
</ul>
<p>开发环境</p>
<ul>
<li>Xcode版本:Xcode9及以上</li>
<li>系统: iOS11及以上</li>
<li>iOS设备：处理器A9及 以上（6S机型及以上)</li>
<li>macOS系统: 10.12.4及以上</li>
</ul>
<h4 id="Xcode-自带创建模板-多数都不用"><a href="#Xcode-自带创建模板-多数都不用" class="headerlink" title="Xcode 自带创建模板(多数都不用)"></a>Xcode 自带创建模板(多数都不用)</h4><p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/ARKit/ARKit-Model.png" alt=""></p>
<p>demo 演示</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> () &lt;<span class="title">ARSCNViewDelegate</span>&gt;</span></div><div class="line"><span class="comment">//AR视图：展示3D界面</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">IBOutlet</span> ARSCNView *sceneView;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line">    </div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line"></div><div class="line">    <span class="comment">//场景代理</span></div><div class="line">    <span class="keyword">self</span>.sceneView.delegate = <span class="keyword">self</span>;</div><div class="line">    </div><div class="line">    <span class="comment">// 显示帧率</span></div><div class="line">    <span class="keyword">self</span>.sceneView.showsStatistics = <span class="literal">YES</span>;</div><div class="line">    </div><div class="line">    <span class="comment">// 创建一个场景</span></div><div class="line">    <span class="built_in">SCNScene</span> *scene = [<span class="built_in">SCNScene</span> sceneNamed:<span class="string">@"art.scnassets/ship.scn"</span>];</div><div class="line">    </div><div class="line">    <span class="comment">// Set the scene to the view</span></div><div class="line">    <span class="keyword">self</span>.sceneView.scene = scene;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewWillAppear:(<span class="built_in">BOOL</span>)animated &#123;</div><div class="line">    [<span class="keyword">super</span> viewWillAppear:animated];</div><div class="line">    </div><div class="line">    <span class="comment">// 世界坐标系配置</span></div><div class="line">    ARWorldTrackingSessionConfiguration *configuration = [ARWorldTrackingSessionConfiguration new];</div><div class="line">    </div><div class="line">    <span class="comment">// 运行3D 场景的 会话</span></div><div class="line">    [<span class="keyword">self</span>.sceneView.session runWithConfiguration:configuration];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewWillDisappear:(<span class="built_in">BOOL</span>)animated &#123;</div><div class="line">    [<span class="keyword">super</span> viewWillDisappear:animated];</div><div class="line">    </div><div class="line">    <span class="comment">// 暂停</span></div><div class="line">    [<span class="keyword">self</span>.sceneView.session pause];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)didReceiveMemoryWarning &#123;</div><div class="line">    [<span class="keyword">super</span> didReceiveMemoryWarning];</div><div class="line">    <span class="comment">// Release any cached data, images, etc that aren't in use.</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#pragma mark - ARSCNViewDelegate</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//给当前锚点创建一个节点 (node 可以理解成 UIView)</span></div><div class="line"><span class="comment">/*</span></div><div class="line">// Override to create and configure nodes for anchors added to the view's session.</div><div class="line">- (SCNNode *)renderer:(id&lt;SCNSceneRenderer&gt;)renderer nodeForAnchor:(ARAnchor *)anchor &#123;</div><div class="line">    SCNNode *node = [SCNNode new];</div><div class="line"> </div><div class="line">    // Add geometry to the node...</div><div class="line"> </div><div class="line">    return node;</div><div class="line">&#125;</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="comment">//会话有错误</span></div><div class="line">- (<span class="keyword">void</span>)session:(ARSession *)session didFailWithError:(<span class="built_in">NSError</span> *)error &#123;</div><div class="line">    <span class="comment">// Present an error message to the user</span></div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//被打断  类似音频播放的时候被打断 eg:前后台切换 来电话  siri</span></div><div class="line">- (<span class="keyword">void</span>)sessionWasInterrupted:(ARSession *)session &#123;</div><div class="line">    <span class="comment">// Inform the user that the session has been interrupted, for example, by presenting an overlay</span></div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//会话结束</span></div><div class="line">- (<span class="keyword">void</span>)sessionInterruptionEnded:(ARSession *)session &#123;</div><div class="line">    <span class="comment">// Reset tracking and/or remove existing anchors if consistent tracking is required</span></div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ARKit工作原理及流程介绍"><a href="#ARKit工作原理及流程介绍" class="headerlink" title="ARKit工作原理及流程介绍"></a>ARKit工作原理及流程介绍</h2><h3 id="主要内容-1"><a href="#主要内容-1" class="headerlink" title="主要内容"></a>主要内容</h3><p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/ARKit/Rendering_ARKit.png" alt=""></p>
<p><code>ARKit</code> 并不是一个独立运行的框架 必须要配合<code>SceneKit</code>,没有<code>SceneKit</code> <code>ARKit</code>和普通相机没有任何区别</p>
<blockquote>
<p> <em>难点:3D坐标的矩阵转换</em>     (3D X/Y/Z, 4x4坐标) </p>
</blockquote>
<p>下面是一张图 ARKit 的所有.h 头文件 (没有列出派生的子类)</p>
<p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/ARKit/ARDefines%402x.png" alt=""></p>
<ul>
<li><p>ARKit框架中的核心类</p>
<ul>
<li><strong><code>ARScnView</code></strong></li>
<li><strong><code>ARSession</code></strong></li>
<li><strong><code>ARCamera</code></strong></li>
</ul>
</li>
<li><p><code>ARKit</code>demo 示例 实现</p>
<ul>
<li>捕捉平面 添加物体</li>
</ul>
</li>
<li><p>AR虚拟增强现实就是指在相机捕捉到的现实世界图像中显示一个虚拟的3D模型,这个过程可以分为两个步骤</p>
<ol>
<li>相机捕捉现实世界图像 (由ARKit 实现)  </li>
<li>在图像中现实虚拟3D 模型(由SceneKit 实现)</li>
</ol>
</li>
<li><p><code>ARKit</code>与<code>SceneKit</code>框架关系图</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/ARKit/ARKit_UML.png" alt=""></p>
<ol>
<li><code>ARSCNView</code> –&gt; <code>SCNView</code>(SceneKit.framework)–&gt;<code>UIView</code>(UIKit.framework)</li>
<li>ARSCNView视图容器,它管理一个 <code>ARSession</code></li>
<li>在一个完整的虚拟增强现实体验中,<code>ARKit</code>只负责把真实世界画面转变为一个3D 场景, 这个过程主要分为两个环节：<ul>
<li>ARCamera 负责捕捉摄像头画面</li>
<li>ARSession 负责搭建3D 场景</li>
</ul>
</li>
<li><p>在一个完整的虚拟增强现实体验中,将虚拟物体展现在3D场景中是由<code>SceneKit</code>框架来完成的 </p>
<blockquote>
<p> 每一个虚拟的物体都是一个节点SCNNode,每一个节点构成了一个场景SCNScene,无数个场景构成了3D世界</p>
<p>可以理解UIViewController 的[view addSubview:xxxView];</p>
</blockquote>
</li>
</ol>
<h3 id="ARKit工作原理"><a href="#ARKit工作原理" class="headerlink" title="ARKit工作原理"></a>ARKit工作原理</h3><h4 id="ARSCNView与-ARSession关系"><a href="#ARSCNView与-ARSession关系" class="headerlink" title="ARSCNView与 ARSession关系"></a>ARSCNView与 ARSession关系</h4><p>说之前先了解一下这个<code>Session</code> 和<code>Context</code>命名以及含义</p>
<p><code>Session</code> 直译: 会话<br><code>Context</code> 直译: 上下文</p>
<p><em>在iOS框架中，凡是带session或者context后缀的，这种类一般自己不干活，作用一般都是两个</em>:</p>
<ul>
<li><strong>管理其他类，帮助他们搭建沟通桥梁，好处就是解耦</strong> </li>
<li><strong>负责帮助我们管理复杂环境下的内存</strong></li>
</ul>
<p><em><code>Session</code> 和<code>Context</code>不同点</em></p>
<ul>
<li>session 有硬件参与的(一般与硬件打交道), eg: 摄像头捕捉 <code>ARSession</code>、音频 <code>AVAudioSession</code>, 网卡相关的<code>NSURLSession</code> …. 等等.</li>
<li>context 一般没有硬件参与的, eg: <code>CGGraphicContext</code>、<code>EAGLContext</code> 绘图上下文, 以及自定义转场里面的那个 Context 就不详细列举了.</li>
</ul>
<p>回到正题, 如上所说 我们要想实现一个</p>
<p><code>ARSCNView</code> 与<code>ARCamera</code> 之间相互协同配合<br>(<code>ARSCNView</code> 与<code>ARCamera</code> 两者之间没有直接关系)</p>
<ul>
<li><strong>ARSCNView —–&gt; ARCamera 或</strong>   </li>
<li><strong>ARSCNView &lt;—– ARCamera</strong></li>
</ul>
<blockquote>
<p><strong>ARSCNView里有个 ARFrame(属性 成员变量), ARFrame 里面包含 ARCamera(属性 成员变量)</strong></p>
</blockquote>
<p>就需要一个沟通的桥梁 进行调度配合协作完成 图像捕捉到视觉渲染的过程<strong>这个桥梁 就是 <code>ARSession</code></strong></p>
<p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/ARKit/ARKit_session.png" alt=""></p>
<p>如果想运行一个 <code>ARSession</code>会话,必须指定一个叫<code>会话追踪配置</code>的对象<code>ARConfiguration</code>,<code>ARConfiguration</code>主要目的负责追踪相机在3D 世界中的位置以及一些特征场景的捕捉,<strong>比如捕捉平面</strong>,这个类 作用很大</p>
<ul>
<li><code>ARConfiguration</code>是个父类,为了更好实现增强现实的效果,苹果建议我们使用派生自它的子类<code>ARWorldTrackingConfiguration</code>(这个类仅支持<code>A9</code>芯片之后的机型). </li>
</ul>
<p>注意: <em>原来是这个<code>ARWorldTrackingSessionConfiguration</code>现在被弃用了.</em></p>
<p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/ARKit/ARWorldTrackingConfiguration.png" alt=""></p>
<h4 id="ARFrame-与-ARWorldTrackingConfiguration"><a href="#ARFrame-与-ARWorldTrackingConfiguration" class="headerlink" title="ARFrame 与 ARWorldTrackingConfiguration"></a>ARFrame 与 ARWorldTrackingConfiguration</h4><p><code>ARSession</code> 搭建沟通的桥梁的参与者有两个</p>
<ol>
<li>ARFrame</li>
<li>ARWorldTrackingConfiguration</li>
</ol>
<p><code>ARWorldTrackingConfiguration</code> （3D世界追踪配置) 的作用是跟踪设备的<strong>方向、位置、检测摄像头捕捉到的内容</strong>.</p>
<p>它的内部实现了一系列庞大的算法和调用iPhone 上必要的传感器来检测手机的 <strong>移动、旋转、平移</strong>(六轴位置方向变化) </p>
<p>当<code>ARWorldTrackingConfiguration</code>计算出相机在3D 世界中的位置时,会把这个<strong>位置数据</strong> 交个<code>ARSession</code>去管理, 而相机的<strong>位置数据</strong>对应的类就是<code>ARFrame</code> </p>
<blockquote>
<p><code>ARSession</code>类一个属性叫<code>currentFrame</code> 就是 ARFrame 的实例变量</p>
</blockquote>
<p><code>ARCamera</code>只负责捕捉图像,不参与数据的处理. 它属于3D 场景中的一个环节,<br>每个3D Scene 都会有一个 Camera, 这个 Camera 决定了我们看到物体的视野.</p>
<p>这三者关系如下:</p>
<p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/ARKit/relationship_ARFrame.png" alt=""></p>
<blockquote>
<p><code>ARFrame</code>里面有我们需要的<code>CVPixelBufferRef</code>(capturedImage) 和 <code>ARCamera</code> 也就是我们需要的图像的原始数据</p>
</blockquote>
<p><strong>ARCamera在3D世界的位置</strong></p>
<p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/ARKit/coordinate.png" alt=""></p>
<h3 id="ARKit-工作流程"><a href="#ARKit-工作流程" class="headerlink" title="ARKit 工作流程"></a>ARKit 工作流程</h3><p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/ARKit/ar_workflow.png" alt=""> 图片来自:<a href="http://www.jianshu.com/p/0492c7122d2f" target="_blank" rel="external">坤小</a></p>
<ol>
<li><code>ARSCNView</code>加载场景<code>SCNScene</code></li>
<li><code>SCNScene</code> 启动相机<code>ARCamera</code>开始捕捉场景</li>
<li><code>ARCamera</code> 捕捉场景后 <code>ARSCNView</code>开始将场景数据给<code>ARSession</code></li>
<li><code>ARSession</code> 通过<code>ARConfiguration</code>(或者它的派生子类) 实现场景的追踪并返回一个<code>ARFrame</code>.</li>
<li>给<code>ARSCNView</code>的 scene 添加一个子节点(3D物体模型)</li>
</ol>
<blockquote>
<p><code>ARConfiguration</code> 捕捉相机的位置的目的是<strong>能够在添加的3D 物体模型的时候计算出3D 物体模型相对于相机的真实矩阵位置</strong></p>
</blockquote>
<p>注意:<strong>在3D坐标系统中</strong></p>
<ul>
<li>世界坐标系 相当于 UIView 的 <code>Frame</code></li>
<li>本地坐标系 相当于 UIView 的 <code>bounds</code></li>
</ul>
<blockquote>
<p>坐标系的转换在 ARKit 中是比较难部分 </p>
</blockquote>
<h2 id="ARKit简单代码实现"><a href="#ARKit简单代码实现" class="headerlink" title="ARKit简单代码实现"></a>ARKit简单代码实现</h2><p><a href="https://github.com/sunyazhou13/ARDemos/blob/master/ARDemo1.zip" target="_blank" rel="external">代码ARKitDemo1</a></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event&#123;</div><div class="line">    <span class="comment">//1. 使用场景加载 scn 文件</span></div><div class="line">    </div><div class="line">    <span class="built_in">SCNScene</span> *scene = [<span class="built_in">SCNScene</span> sceneNamed:<span class="string">@"Models.scnassets/vase/vase.scn"</span>];</div><div class="line">    <span class="built_in">SCNNode</span> *plantNode = scene.rootNode.childNodes[<span class="number">0</span>];</div><div class="line">    </div><div class="line">    <span class="comment">//2. 调整位置 将节点添加到当前屏幕中</span></div><div class="line">    plantNode.position = <span class="built_in">SCNVector3Make</span>(<span class="number">0</span>, <span class="number">-1</span>, <span class="number">-1</span>);</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">//3. 将飞机节点添加到当前屏幕</span></div><div class="line">    [<span class="keyword">self</span>.arSceneView.scene.rootNode addChildNode:plantNode];</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里需要补充一点 </p>
<blockquote>
<p>我们先抛开<code>ARSCNView</code>和 <code>UIViewController</code> 以及<code>UIView</code>的关系</p>
</blockquote>
<p><strong>我们只说一下<code>ARSCNView</code>,<code>scene</code>,<code>node</code>啥关系</strong></p>
<p><code>ARSCNView</code> 是个集成自 UIView 的视图</p>
<p><code>ARSCNView</code> 有个属性(成员变量)叫<code>scene</code> 这就相当于 VC</p>
<p><code>scene</code>有 <code>rootNode</code> 相当于 VC 有<code>self.view</code></p>
<p><strong>可以把<code>scene</code>理解为 VC</strong><br><strong>把<code>rootNode</code>理解为 <code>self.view</code></strong></p>
<p>我们知道 self.view 可以添加 子 view 通过 </p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">[<span class="keyword">self</span>.view addSubview:xxx];</div></pre></td></tr></table></figure>
<p> 那么 node 也就有了相应的方法</p>
 <figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">[scene.rootNode addChildNode:xxxNode];</div></pre></td></tr></table></figure>
<blockquote>
<p>注意:<em><strong>所有的场景有且只有一个根节点，其他所有节点都是根节点的子节点</strong></em></p>
</blockquote>
<h2 id="ARKit框架所有API介绍"><a href="#ARKit框架所有API介绍" class="headerlink" title="ARKit框架所有API介绍"></a>ARKit框架所有API介绍</h2><p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/ARKit/ARDefines%402x.png" alt=""></p>
<p>还是拿上边这张图说一下 这里我们诉求剖析所有 API 从而达到大家都了解 ARKit的内容</p>
<h4 id="ARAnchor"><a href="#ARAnchor" class="headerlink" title="ARAnchor"></a>ARAnchor</h4><p><code>ARAnchor</code>表示一个物体在3D 空间的位置和方向(ARAnchor 俗称 3D 锚点, 类似 UIKit 框架中 CALayer的 Anchor)</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ARAnchor</span> : <span class="title">NSObject</span> &lt;<span class="title">NSCopying</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">//锚点唯一标识</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSUUID</span> *identifier;</div><div class="line"></div><div class="line"><span class="comment">//锚点的旋转变换矩阵，定义了锚点的旋转、位置、缩放。是一个4x4的矩阵</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) matrix_float4x4 transform;</div><div class="line"></div><div class="line"><span class="comment">//构造方法,一般我们无需构造。因为添加一个3D物体时ARKit会有代理告知我们物体的锚点</span></div><div class="line">- (<span class="keyword">instancetype</span>)initWithTransform:(matrix_float4x4)transform;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>ARFrame</code>表示的也是物体的位置和方向,但是<code>ARFrame</code>通常标识的是 AR 相机的<strong>位置</strong>和<strong>方向</strong>以及追踪相机的时间戳,还有捕捉到相机的图片帧(CVPixelBufferRef)</p>
</blockquote>
<h4 id="ARError"><a href="#ARError" class="headerlink" title="ARError"></a>ARError</h4><p><code>ARError</code> 错误描述类, eg: 设备不支持, 常驻后台的会话中断…等</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">FOUNDATION_EXTERN <span class="built_in">NSString</span> *<span class="keyword">const</span> ARErrorDomain;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ERROR_ENUM</span>(ARErrorDomain, ARErrorCode) &#123;</div><div class="line">    <span class="comment">/** Unsupported session configuration. */</span></div><div class="line">    ARErrorCodeUnsupportedConfiguration   = <span class="number">100</span>,</div><div class="line">    </div><div class="line">    <span class="comment">/** A sensor required to run the session is not available. */</span></div><div class="line">    ARErrorCodeSensorUnavailable          = <span class="number">101</span>,</div><div class="line">    </div><div class="line">    <span class="comment">/** A sensor failed to provide the required input. */</span></div><div class="line">    ARErrorCodeSensorFailed               = <span class="number">102</span>,</div><div class="line">    </div><div class="line">    <span class="comment">/** App does not have permission to use the camera. The user may change this in settings. */</span></div><div class="line">    ARErrorCodeCameraUnauthorized         = <span class="number">103</span>,</div><div class="line">    </div><div class="line">    <span class="comment">/** World tracking has encountered a fatal error. */</span></div><div class="line">    ARErrorCodeWorldTrackingFailed        = <span class="number">200</span>,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="ARFrame"><a href="#ARFrame" class="headerlink" title="ARFrame"></a>ARFrame</h4><p><code>ARFrame</code> 主要是追踪当前的状态 eg: 图片帧, 时间戳,位置方向等参数.</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ARFrame</span> : <span class="title">NSObject</span> &lt;<span class="title">NSCopying</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">//时间戳</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSTimeInterval</span> timestamp;</div><div class="line"></div><div class="line"><span class="comment">//图片帧</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) CVPixelBufferRef capturedImage;</div><div class="line"></div><div class="line"><span class="comment">//相机（表示这个ARFrame是哪一个相机的，iPhone7plus有两个摄像机）</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">readonly</span>) ARCamera *camera;</div><div class="line"></div><div class="line"><span class="comment">//返回当前相机捕捉到的锚点数据（当一个3D虚拟模型加入到ARKit中时，锚点值得就是这个模型在AR中的位置）</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span>&lt;ARAnchor *&gt; *anchors;</div><div class="line"></div><div class="line"><span class="comment">//灯光 指的是灯光强度 一般是0-2000，系统默认1000</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>, <span class="keyword">readonly</span>) ARLightEstimate *lightEstimate;</div><div class="line"></div><div class="line"><span class="comment">//特征点（应该是捕捉平地或者人脸的，比较苹果有自带的人脸识别功能） 仅限 world 的追踪配置可用</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>, <span class="keyword">readonly</span>) ARPointCloud *rawFeaturePoints;</div><div class="line"></div><div class="line"><span class="comment">//根据2D坐标点搜索3D模型，这个方法通常用于，当我们在手机屏幕点击某一个点的时候，可以捕捉到这一个点所在的3D模型的位置，至于为什么是一个数组非常好理解。手机屏幕一个是长方形，这是一个二维空间。而相机捕捉到的是一个由这个二维空间射出去的长方体，我们点击屏幕一个点可以理解为在这个长方体的边缘射出一条线，这一条线上可能会有多个3D物体模型</span></div><div class="line">point：<span class="number">2</span>D坐标点（手机屏幕某一点）</div><div class="line">ARHitTestResultType：捕捉类型  点还是面</div><div class="line">(<span class="built_in">NSArray</span>&lt;ARHitTestResult *&gt; *)：追踪结果数组</div><div class="line"></div><div class="line">- (<span class="built_in">NSArray</span>&lt;ARHitTestResult *&gt; *)hitTest:(<span class="built_in">CGPoint</span>)point types:(ARHitTestResultType)types;</div><div class="line"></div><div class="line"><span class="comment">//相机窗口的的坐标变换（可用于相机横竖屏的旋转适配）</span></div><div class="line">-(<span class="built_in">CGAffineTransform</span>)displayTransformWithViewportSize:(<span class="built_in">CGSize</span>)viewportSize orientation:(<span class="built_in">UIInterfaceOrientation</span>)orientation;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>这里说一下一个技巧 如果在一个类里面我们不想提供<code>init:</code>方法的话 该如何写？</p>
<p>我们都知道<code>OC</code>里面所有的<code>class</code>都是继承 自<code>NSObject</code>,<code>NSObject</code>里面有<code>init:</code>、<code>dealloc:</code>等方法.</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ARAnchor</span> (<span class="title">Unavailable</span>)</span></div><div class="line"></div><div class="line">- (<span class="keyword">instancetype</span>)init <span class="built_in">NS_UNAVAILABLE</span>;</div><div class="line">+ (<span class="keyword">instancetype</span>)new <span class="built_in">NS_UNAVAILABLE</span>;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<blockquote>
<p>这里用到的技巧就是 写个 Category 并复写该方法后边标注为<code>NS_UNAVAILABLE</code></p>
</blockquote>
<h4 id="ARHitTestResult"><a href="#ARHitTestResult" class="headerlink" title="ARHitTestResult"></a>ARHitTestResult</h4><p><code>ARHitTestResult</code> 点击回调结果,这个类主要用于AR 技术中 <strong>现实世界与3D 场景中虚拟物体的交互.</strong> eg:在相机中移动、拖拽3D 虚拟物体,都可以通过这个类来获取 ARKit 所捕捉的结果.</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="built_in">NS_OPTIONS</span>(<span class="built_in">NSUInteger</span>, ARHitTestResultType) &#123;</div><div class="line">    <span class="comment">//点</span></div><div class="line">    ARHitTestResultTypeFeaturePoint              = (<span class="number">1</span> &lt;&lt; <span class="number">0</span>),</div><div class="line">	<span class="comment">//水平面 y为0.    </span></div><div class="line">    ARHitTestResultTypeEstimatedHorizontalPlane  = (<span class="number">1</span> &lt;&lt; <span class="number">1</span>),</div><div class="line">    </div><div class="line">    <span class="comment">//已结存在的平面</span></div><div class="line">    ARHitTestResultTypeExistingPlane             = (<span class="number">1</span> &lt;&lt; <span class="number">3</span>),</div><div class="line">    </div><div class="line">    <span class="comment">//已结存在的锚点和平面</span></div><div class="line">    ARHitTestResultTypeExistingPlaneUsingExtent  = (<span class="number">1</span> &lt;&lt; <span class="number">4</span>),</div><div class="line">&#125; <span class="built_in">NS_SWIFT_NAME</span>(ARHitTestResult.ResultType);</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ARHitTestResult</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="comment">//捕捉类型</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) ARHitTestResultType type;</div><div class="line"></div><div class="line"><span class="comment">//3D虚拟物体与相机的距离（单位：米）</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">CGFloat</span> distance;</div><div class="line"></div><div class="line"><span class="comment">//本地坐标矩阵（世界坐标指的是相机为场景原点的坐标，而每一个3D物体自身有一个场景，本地坐标就是相对于这个场景的坐标）类似于frame和bounds的区别</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) matrix_float4x4 localTransform;</div><div class="line"></div><div class="line"><span class="comment">//世界坐标矩阵</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) matrix_float4x4 worldTransform;</div><div class="line"></div><div class="line"><span class="comment">//锚点（3D虚拟物体，在虚拟世界有一个位置，这个位置参数是SceneKit中的SCNVector3：三维矢量），而锚点anchor是这个物体在AR现实场景中的位置，是一个4x4的矩阵</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>, <span class="keyword">readonly</span>) ARAnchor *anchor;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>这里需要了解一下:</p>
<ul>
<li><p><strong>matrix_float4x4</strong> <strong>worldTransform</strong>; 世界坐标系 <strong>以相机为场景的原点开始(0,0,0,0)</strong> 也就是以相机为圆心向外,参照这个原点 3D 物体的位置信息. 这就相当于2D 的 UIView 的 frame (绝对坐标)</p>
</li>
<li><p><strong>matrix_float4x4</strong>  <strong>localTransform</strong>; 本地坐标系 以一个 node 为父节点为参照,相当于距离这个父场景的坐标.</p>
</li>
<li><p><strong>matrix_float4x4</strong> <a href="http://www.opengl-tutorial.org/cn/beginners-tutorials/tutorial-3-matrices/" target="_blank" rel="external">4x4 矩阵请参考这里</a> </p>
</li>
</ul>
<h4 id="ARLightEstimate"><a href="#ARLightEstimate" class="headerlink" title="ARLightEstimate"></a>ARLightEstimate</h4><p><code>ARLightEstimate</code></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ARLightEstimate</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="comment">//环境灯光强度  范围0-2000 默认1000</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">CGFloat</span> ambientIntensity;</div><div class="line"></div><div class="line"><span class="comment">//环境光温度</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">CGFloat</span> ambientColorTemperature;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<h4 id="ARPlaneAnchor"><a href="#ARPlaneAnchor" class="headerlink" title="ARPlaneAnchor"></a>ARPlaneAnchor</h4><p><code>ARPlaneAnchor</code>派生自<code>ARAnchor</code>的子类, 平面锚点.<code>ARKit</code>能自动识别平地,并且添加一个锚点到场景中,当然要想看到真实世界中的平地效果需要我们自己使用 <code>SCNNode</code>渲染一个锚点.</p>
<blockquote>
<p>锚点只是一个位置</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ARPlaneAnchor</span> : <span class="title">ARAnchor</span></span></div><div class="line"></div><div class="line"><span class="comment">//平地类型，目前只有一个，就是水平面 </span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) ARPlaneAnchorAlignment alignment;</div><div class="line"></div><div class="line"><span class="comment">//3轴矢量结构体，表示平地的中心点  x/y/z</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) vector_float3 center;</div><div class="line"></div><div class="line"><span class="comment">//3轴矢量结构体，表示平地的大小（宽度和高度）  x/y/z</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) vector_float3 extent;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<h4 id="ARPointCloud"><a href="#ARPointCloud" class="headerlink" title="ARPointCloud"></a>ARPointCloud</h4><p><code>ARPointCloud</code> 点状渲染  </p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ARPointCloud</span> : <span class="title">NSObject</span> &lt;<span class="title">NSCopying</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">//点数</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> count;</div><div class="line"></div><div class="line"><span class="comment">//每一个点的位置的集合（结构体带*表示的是结构体数组）</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="keyword">const</span> vector_float3 *points;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<h4 id="ARConfiguration"><a href="#ARConfiguration" class="headerlink" title="ARConfiguration"></a>ARConfiguration</h4><p><code>ARConfiguration</code> 会话追踪配置</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="comment">//追踪对其方式</span></div><div class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, ARWorldAlignment) &#123;</div><div class="line">    <span class="comment">/* 相机位置 vector (0, -1, 0) /</span></div><div class="line">    ARWorldAlignmentGravity,</div><div class="line">    /* 相机位置及方向. vector (0, -1, 0)    heading ：(0, 0, -1) */</div><div class="line">    ARWorldAlignmentGravityAndHeading,</div><div class="line">    <span class="comment">/* 相机方向. */</span></div><div class="line">    ARWorldAlignmentCamera</div><div class="line">&#125; ;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="built_in">NS_OPTIONS</span>(<span class="built_in">NSUInteger</span>, ARPlaneDetection) &#123;</div><div class="line">    ARPlaneDetectionNone        = <span class="number">0</span>,</div><div class="line">    ARPlaneDetectionHorizontal  = (<span class="number">1</span> &lt;&lt; <span class="number">0</span>), <span class="comment">//探测平面是水平横向</span></div><div class="line">&#125; ;</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ARConfiguration</span> : <span class="title">NSObject</span> &lt;<span class="title">NSCopying</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">//当前设备是否支持，一般A9芯片以下设备不支持</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">class</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">BOOL</span> isSupported;</div><div class="line"></div><div class="line"><span class="comment">//世界坐标的对齐方式 </span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readwrite</span>) ARWorldAlignment worldAlignment;</div><div class="line"></div><div class="line"><span class="comment">//是否需要自适应灯光效果，默认是YES</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readwrite</span>, <span class="keyword">getter</span>=isLightEstimationEnabled) <span class="built_in">BOOL</span> lightEstimationEnabled;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">//世界会话追踪配置，苹果建议我们使用这个类，这个子类只有一个属性，也就是可以帮助我们追踪相机捕捉到的平地</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ARWorldTrackingSessionConfiguration</span> : <span class="title">ARConfiguration</span></span></div><div class="line"></div><div class="line"><span class="comment">//探测的类型</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readwrite</span>) ARPlaneDetection planeDetection;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<blockquote>
<p>会话配置的恩子类:ARWorldTrackingSessionConfiguration，它们在同一个API文件中</p>
</blockquote>
<h4 id="ARSKView"><a href="#ARSKView" class="headerlink" title="ARSKView"></a>ARSKView</h4><p><code>ARSKView</code>是2D 的 AR 视图 这个基本就不需要讲了 和 <code>ARSCNView</code>一样,就不重复介绍了</p>
<h4 id="ARScnView-重点介绍"><a href="#ARScnView-重点介绍" class="headerlink" title="ARScnView 重点介绍"></a>ARScnView 重点介绍</h4><figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ARSCNView</span> : <span class="title">SCNView</span></span></div><div class="line"></div><div class="line"><span class="comment">//代理</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">nullable</span>) <span class="keyword">id</span>&lt;ARSCNViewDelegate&gt; delegate;</div><div class="line"></div><div class="line"><span class="comment">//AR 会话</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) ARSession *session;</div><div class="line"></div><div class="line"><span class="comment">//场景</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">SCNScene</span> *scene;</div><div class="line"></div><div class="line"><span class="comment">//是否自动适应灯光</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> automaticallyUpdatesLighting;</div><div class="line"></div><div class="line"><span class="comment">//返回对应节点的锚点，节点是一个3D虚拟物体，它的坐标是虚拟场景中的坐标，而锚点ARAnchor是ARKit中现实世界的坐标</span></div><div class="line">- (<span class="keyword">nullable</span> ARAnchor *)anchorForNode:(<span class="built_in">SCNNode</span> *)node;</div><div class="line"></div><div class="line"><span class="comment">//返回对应锚点的物体</span></div><div class="line">- (<span class="keyword">nullable</span> <span class="built_in">SCNNode</span> *)nodeForAnchor:(ARAnchor *)anchor;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"></div><div class="line"></div><div class="line"> */</div><div class="line">- (<span class="built_in">NSArray</span>&lt;ARHitTestResult *&gt; *)hitTest:(<span class="built_in">CGPoint</span>)point types:(ARHitTestResultType)types;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<blockquote>
<p>根据2D坐标点搜索3D模型，这个方法通常用于，当我们在手机屏幕点击某一个点的时候，可以捕捉到这一个点所在的3D模型的位置，至于为什么是一个数组非常好理解。手机屏幕一个是长方形，这是一个二维空间。而相机捕捉到的是一个由这个二维空间射出去的长方体，我们点击屏幕一个点可以理解为在这个长方体的边缘射出一条线，这一条线上可能会有多个3D物体模型,point：2D坐标点（手机屏幕某一点）<br>ARHitTestResultType：捕捉类型  点还是面<br>(NSArray<arhittestresult *=""> *)：追踪结果数组  详情见本章节ARHitTestResult类介绍<br>数组的结果排序是由近到远</arhittestresult></p>
</blockquote>
<p>代理方法</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="comment">//代理的内部实现了SCNSceneRendererDelegate：scenekit代理 和ARSessionObserver：ARSession监听（KVO机制）</span></div><div class="line"><span class="meta">#pragma mark - ARSCNViewDelegate</span></div><div class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">ARSCNViewDelegate</span> &lt;<span class="title">SCNSceneRendererDelegate</span>, <span class="title">ARSessionObserver</span>&gt;</span></div><div class="line"><span class="keyword">@optional</span></div><div class="line"></div><div class="line"><span class="comment">//自定义节点的锚点</span></div><div class="line">- (<span class="keyword">nullable</span> <span class="built_in">SCNNode</span> *)renderer:(<span class="keyword">id</span> &lt;<span class="built_in">SCNSceneRenderer</span>&gt;)renderer nodeForAnchor:(ARAnchor *)anchor;</div><div class="line"></div><div class="line"><span class="comment">//当添加节点是会调用，我们可以通过这个代理方法得知我们添加一个虚拟物体到AR场景下的锚点（AR现实世界中的坐标）</span></div><div class="line">- (<span class="keyword">void</span>)renderer:(<span class="keyword">id</span> &lt;<span class="built_in">SCNSceneRenderer</span>&gt;)renderer didAddNode:(<span class="built_in">SCNNode</span> *)node forAnchor:(ARAnchor *)anchor;</div><div class="line"></div><div class="line"><span class="comment">//将要刷新节点</span></div><div class="line">- (<span class="keyword">void</span>)renderer:(<span class="keyword">id</span> &lt;<span class="built_in">SCNSceneRenderer</span>&gt;)renderer willUpdateNode:(<span class="built_in">SCNNode</span> *)node forAnchor:(ARAnchor *)anchor;</div><div class="line"></div><div class="line"><span class="comment">//已经刷新节点</span></div><div class="line">- (<span class="keyword">void</span>)renderer:(<span class="keyword">id</span> &lt;<span class="built_in">SCNSceneRenderer</span>&gt;)renderer didUpdateNode:(<span class="built_in">SCNNode</span> *)node forAnchor:(ARAnchor *)anchor;</div><div class="line"></div><div class="line"><span class="comment">//移除节点</span></div><div class="line">- (<span class="keyword">void</span>)renderer:(<span class="keyword">id</span> &lt;<span class="built_in">SCNSceneRenderer</span>&gt;)renderer didRemoveNode:(<span class="built_in">SCNNode</span> *)node forAnchor:(ARAnchor *)anchor;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<h4 id="ARSesson-重点介绍"><a href="#ARSesson-重点介绍" class="headerlink" title="ARSesson 重点介绍"></a>ARSesson 重点介绍</h4><p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/ARKit/session_brige002.png" alt=""></p>
<p><code>ARSesson</code> 是一个连接底层与 AR 视图之间的桥梁, <code>ARSCNView</code>里的所有方法都是又<code>ARSession</code>提供的</p>
<p><strong><code>ARSesson</code>获取相机位置数据主要由两种方式</strong></p>
<ul>
<li>push 通过实现 Session 的代理<code>session:didUpdateFrame:</code>告知用户</li>
<li>pull 用户想要可主动去取 <code>ARSession</code>的<code>currentFrame</code>属性</li>
</ul>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ARSession</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="comment">//代理</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">id</span> &lt;ARSessionDelegate&gt; delegate;</div><div class="line"></div><div class="line"><span class="comment">//指定代理执行的线程（主线程不会有延迟，子线程会有延迟），不指定的话默认主线程</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) <span class="built_in">dispatch_queue_t</span> delegateQueue;</div><div class="line"></div><div class="line"><span class="comment">//相机当前的位置（是由会话追踪配置计算出来的）</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>, <span class="keyword">readonly</span>) ARFrame *currentFrame;</div><div class="line"></div><div class="line"><span class="comment">//会话配置</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>, <span class="keyword">readonly</span>) ARConfiguration *configuration;</div><div class="line"></div><div class="line"><span class="comment">//运行会话（这行代码就是开启AR的关键所在）</span></div><div class="line">- (<span class="keyword">void</span>)runWithConfiguration:(ARConfiguration *)configuration <span class="built_in">NS_SWIFT_UNAVAILABLE</span>(<span class="string">"Use run(_:options:) instead"</span>);</div><div class="line"></div><div class="line"><span class="comment">//运行会话，只是多了一个参数ARSessionRunOptions：作用就是会话断开重连时的行为。</span></div><div class="line">- (<span class="keyword">void</span>)runWithConfiguration:(ARConfiguration *)configuration options:(ARSessionRunOptions)options <span class="built_in">NS_SWIFT_NAME</span>(run(_:options:));</div><div class="line"></div><div class="line"><span class="comment">//暂停会话</span></div><div class="line">- (<span class="keyword">void</span>)pause;</div><div class="line"></div><div class="line"><span class="comment">//添加锚点</span></div><div class="line">- (<span class="keyword">void</span>)addAnchor:(ARAnchor *)anchor <span class="built_in">NS_SWIFT_NAME</span>(add(anchor:));</div><div class="line"></div><div class="line"><span class="comment">//移除锚点</span></div><div class="line">- (<span class="keyword">void</span>)removeAnchor:(ARAnchor *)anchor <span class="built_in">NS_SWIFT_NAME</span>(remove(anchor:));</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<blockquote>
<p>运行会话<strong>runWithConfiguration:options:</strong> options 是个<code>ARSessionRunOptions</code>枚举<br>这个方法的作用就是会话断开重连时的行为</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="built_in">NS_OPTIONS</span>(<span class="built_in">NSUInteger</span>, ARSessionRunOptions) &#123;</div><div class="line">	 <span class="comment">//表示重置追踪</span></div><div class="line">    ARSessionRunOptionResetTracking           = (<span class="number">1</span> &lt;&lt; <span class="number">0</span>),</div><div class="line">    </div><div class="line">    <span class="comment">//移除现有锚点</span></div><div class="line">    ARSessionRunOptionRemoveExistingAnchors   = (<span class="number">1</span> &lt;&lt; <span class="number">1</span>)</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>下面来看下<code>ARSession</code>的代理</p>
<p><code>ARSession</code> 分 两种</p>
<ul>
<li>KVO 观察者 ARSessionObserver</li>
<li>delegate 委托代理 ARSessionDelegate</li>
</ul>
<blockquote>
<p>看到这我也很奇怪这个玩法 </p>
</blockquote>
<p>ARSessionObserver如下</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">ARSessionObserver</span> &lt;<span class="title">NSObject</span>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">@optional</span></div><div class="line"></div><div class="line"><span class="comment">//session 失败</span></div><div class="line">- (<span class="keyword">void</span>)session:(ARSession *)session didFailWithError:(<span class="built_in">NSError</span> *)error;</div><div class="line"></div><div class="line"><span class="comment">//相机追踪状态发生改变</span></div><div class="line">- (<span class="keyword">void</span>)session:(ARSession *)session cameraDidChangeTrackingState:(ARCamera *)camera;</div><div class="line"></div><div class="line"><span class="comment">//session 意外断开（如果开启ARSession之后，APP退到后台就有可能导致会话断开）</span></div><div class="line">- (<span class="keyword">void</span>)sessionWasInterrupted:(ARSession *)session;</div><div class="line"></div><div class="line"><span class="comment">//session 会话断开后 恢复(短时间退到后台再进入APP会自动恢复）</span></div><div class="line">- (<span class="keyword">void</span>)sessionInterruptionEnded:(ARSession *)session;</div><div class="line"></div><div class="line"><span class="comment">//session 已经输出了一个 音频数据 `CMSampleBufferRef` </span></div><div class="line">- (<span class="keyword">void</span>)session:(ARSession *)session didOutputAudioSampleBuffer:(<span class="built_in">CMSampleBufferRef</span>)audioSampleBuffer;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>ARSessionDelegate 如下</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">相机位置发生改变 就是相机的位置有变动</div><div class="line">- (<span class="keyword">void</span>)session:(ARSession *)session didUpdateFrame:(ARFrame *)frame;</div><div class="line"></div><div class="line"><span class="comment">// 已添加锚点</span></div><div class="line">- (<span class="keyword">void</span>)session:(ARSession *)session didAddAnchors:(<span class="built_in">NSArray</span>&lt;ARAnchor*&gt;*)anchors;</div><div class="line"></div><div class="line"><span class="comment">//刷新锚点</span></div><div class="line">- (<span class="keyword">void</span>)session:(ARSession *)session didUpdateAnchors:(<span class="built_in">NSArray</span>&lt;ARAnchor*&gt;*)anchors;</div><div class="line"></div><div class="line"><span class="comment">//移除锚点</span></div><div class="line">- (<span class="keyword">void</span>)session:(ARSession *)session didRemoveAnchors:(<span class="built_in">NSArray</span>&lt;ARAnchor*&gt;*)anchors;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>以上是 <code>ARSession</code></p>
<h4 id="ARCamera-重点介绍"><a href="#ARCamera-重点介绍" class="headerlink" title="ARCamera 重点介绍"></a>ARCamera 重点介绍</h4><p><code>ARCamera</code>是个相机, 它是链接虚拟场景和现实场景的之间的枢纽. </p>
<p>在<code>ARKit</code>中,它是捕捉现实图像的相机,在 SceneKit 中它是3D 虚拟世界中的相机</p>
<blockquote>
<p>游戏里一般第一人称3D 游戏, 英雄就是一个3D 相机, 我们电脑屏幕看到的画面就是这个相机捕捉到的画面</p>
</blockquote>
<p>一般情况下我们不需要自己去创建一个<code>ARCamera</code>实例, 因为每次初始化一个 <code>ARSCNView</code>的时候,它会默认为我们创建一个<code>ARCamera</code>实例,而且这个相机就是摄像头的位置,同时也是3D 世界中的原点所在 <strong>(0,0,0)</strong> </p>
<p>至于<code>ARCamera</code> 的 api 一般我们也不用 care,<code>ARKit</code>默认会配置好.</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ARCamera</span> : <span class="title">NSObject</span> &lt;<span class="title">NSCopying</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">//4x4矩阵表示相机位置 跟锚点类似</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) matrix_float4x4 transform;</div><div class="line"></div><div class="line"><span class="comment">//相机方向（旋转）的矢量欧拉角 分别是x/y/z</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) vector_float3 eulerAngles;</div><div class="line"></div><div class="line"><span class="comment">//相机追踪状态（在下方会有枚举值介绍）</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) ARTrackingState trackingState <span class="built_in">NS_REFINED_FOR_SWIFT</span>;</div><div class="line"></div><div class="line"><span class="comment">//追踪运动类型</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) ARTrackingStateReason trackingStateReason <span class="built_in">NS_REFINED_FOR_SWIFT</span>;</div><div class="line"></div><div class="line"><span class="comment">//相机曲率 3x3矩阵  </span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) matrix_float3x3 intrinsics;</div><div class="line"></div><div class="line"><span class="comment">//摄像头分辨率</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">CGSize</span> imageResolution;</div><div class="line"></div><div class="line"><span class="comment">//投影矩阵</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) matrix_float4x4 projectionMatrix;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//创建相机 使用x,y,z 位置 </span></div><div class="line">- (<span class="built_in">CGPoint</span>)projectPoint:(vector_float3)point orientation:(<span class="built_in">UIInterfaceOrientation</span>)orientation viewportSize:(<span class="built_in">CGSize</span>)viewportSize;</div><div class="line"> </div><div class="line"><span class="comment">//创建相机投影矩阵 近面距离  远面距离</span></div><div class="line">- (matrix_float4x4)projectionMatrixForOrientation:(<span class="built_in">UIInterfaceOrientation</span>)orientation viewportSize:(<span class="built_in">CGSize</span>)viewportSize zNear:(<span class="built_in">CGFloat</span>)zNear zFar:(<span class="built_in">CGFloat</span>)zFar;</div><div class="line"></div><div class="line"><span class="comment">//创建相机投影矩阵</span></div><div class="line">- (matrix_float4x4)viewMatrixForOrientation:(<span class="built_in">UIInterfaceOrientation</span>)orientation;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<blockquote>
<p>上边提到的远面和近面距离 <img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/ARKit/distance.png" alt="">  可以参考这张图 摘自<a href="http://www.jianshu.com/p/bc151ff65cef" target="_blank" rel="external">投影变换</a><br><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/ARKit/distance2.png" alt=""><br> 这属于 OpenGL的学习范畴.有兴趣可以学习一下</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="comment">//相机追踪状态枚举</span></div><div class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, ARTrackingState) &#123;</div><div class="line">	 <span class="comment">/* 不被允许 */</span></div><div class="line">    ARTrackingStateNotAvailable,</div><div class="line">    </div><div class="line">    <span class="comment">/* 最小 */</span></div><div class="line">    ARTrackingStateLimited,</div><div class="line">    </div><div class="line">    <span class="comment">/* 正常. */</span></div><div class="line">    ARTrackingStateNormal,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//追踪运动类型</span></div><div class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, ARTrackingStateReason) &#123;</div><div class="line">    <span class="comment">/* 无. */</span></div><div class="line">    ARTrackingStateReasonNone,</div><div class="line">    </div><div class="line">    <span class="comment">//初始化</span></div><div class="line">    ARTrackingStateReasonInitializing,</div><div class="line">    </div><div class="line">    <span class="comment">/* 运动. */</span></div><div class="line">    ARTrackingStateReasonExcessiveMotion,</div><div class="line">    </div><div class="line">    <span class="comment">/** 脸部捕捉. */</span></div><div class="line">    ARTrackingStateReasonInsufficientFeatures,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>这里面涉及到的 一个叫做<code>eulerAngles</code><a href="https://zh.wikipedia.org/wiki/%E6%AC%A7%E6%8B%89%E8%A7%92" target="_blank" rel="external">欧拉角</a><br><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/ARKit/eulerAngles.png" alt=""><br>这个欧拉角是解决3D物体的 旋转矩阵 等取向问题, 就有有一个平面 是静止不动的 一个平面是动的 根据圆心距离两个平面相交的 角度或者 sin cos 来解决一些夹角标记、旋转矩阵等问题 具体可以参考维基百科的解释 (我研究了一阵 还是云里雾里 见笑见笑) </p>
</blockquote>
<h4 id="ARKit捕捉平地"><a href="#ARKit捕捉平地" class="headerlink" title="ARKit捕捉平地"></a>ARKit捕捉平地</h4><p><img src="https://raw.githubusercontent.com/sunyazhou13/sunyazhou13.github.io-images/master/ARKit/plane_detective.gif" alt=""></p>
<p><a href="https://github.com/sunyazhou13/ARDemos/blob/master/ARDemoPlaneDetective.zip" target="_blank" rel="external">探测平地demo</a></p>
<p>贴一下核心代码</p>
<p>添加节点时候调用（当开启平地捕捉模式之后，如果捕捉到平地，ARKit会自动添加一个平地节点）</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="meta">#pragma mark -</span></div><div class="line"><span class="meta">#pragma mark - ARSCNViewDelegate 代理</span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)renderer:(<span class="keyword">id</span> &lt;<span class="built_in">SCNSceneRenderer</span>&gt;)renderer didAddNode:(<span class="built_in">SCNNode</span> *)node forAnchor:(ARAnchor *)anchor&#123;</div><div class="line">    <span class="keyword">if</span> ([anchor isMemberOfClass:[ARPlaneAnchor <span class="keyword">class</span>]]) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"捕捉到平地"</span>);</div><div class="line">        <span class="comment">//添加一个3D 平面模型,ARKit 只有捕捉能力,锚点是一个空间位置,要想更加清楚的看到这个空间,我们需要给空间添加一个平地的3D模型来渲染他</span></div><div class="line">        <span class="comment">//1. 获取扑捉到的平地锚点</span></div><div class="line">        ARPlaneAnchor *planeAnchor = (ARPlaneAnchor *)anchor;</div><div class="line">        <span class="comment">//2. 创建一个3D物体模型 (系统捕捉到的平地是一个不规则大小的长方形，这里我们将其变成一个长方形，并且对平地做一次缩放）</span></div><div class="line">        <span class="comment">//创建长方形  参数:长,宽,高,圆角</span></div><div class="line">        <span class="built_in">SCNBox</span> *plane = [<span class="built_in">SCNBox</span> boxWithWidth:planeAnchor.extent.x * <span class="number">0.3</span> height:<span class="number">0</span> length:planeAnchor.extent.x * <span class="number">0.3</span> chamferRadius:<span class="number">0</span>];</div><div class="line">        <span class="comment">//3. 使用Material渲染3D模型 默认模型是白色的</span></div><div class="line">        plane.firstMaterial.diffuse.contents = [<span class="built_in">UIColor</span> cyanColor];</div><div class="line">        </div><div class="line">        <span class="comment">//4. 创建一个基于3D 物体模型的节点</span></div><div class="line">        <span class="built_in">SCNNode</span> *planeNode = [<span class="built_in">SCNNode</span> nodeWithGeometry:plane];</div><div class="line">        <span class="comment">//5. 设置节点的位置为捕捉到的平地的锚点和中心位置 SceneKit框架中节点的位置position是一个基于3D坐标系的矢量坐标SCNVector3Make</span></div><div class="line">        planeNode.position = <span class="built_in">SCNVector3Make</span>(planeAnchor.center.x, <span class="number">0</span>, planeAnchor.center.z);</div><div class="line">        </div><div class="line">        [node addChildNode:planeNode];</div><div class="line">        </div><div class="line">        <span class="comment">//6. 当捕捉到平地时，2s之后开始在平地上添加一个3D模型</span></div><div class="line">        </div><div class="line">        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">2</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</div><div class="line">            <span class="comment">//1.创建一个花瓶场景</span></div><div class="line">            <span class="built_in">SCNScene</span> *scene = [<span class="built_in">SCNScene</span> sceneNamed:<span class="string">@"Models.scnassets/vase/vase.scn"</span>];</div><div class="line">            <span class="comment">//2.获取花瓶节点（一个场景会有多个节点，此处我们只写，花瓶节点则默认是场景子节点的第一个）</span></div><div class="line">            <span class="comment">//所有的场景有且只有一个根节点，其他所有节点都是根节点的子节点</span></div><div class="line">            <span class="built_in">SCNNode</span> *vaseNode = scene.rootNode.childNodes[<span class="number">0</span>];</div><div class="line">            </div><div class="line">            <span class="comment">//4.设置花瓶节点的位置为捕捉到的平地的位置，如果不设置，则默认为原点位置，也就是相机位置</span></div><div class="line">            vaseNode.position = <span class="built_in">SCNVector3Make</span>(planeAnchor.center.x, <span class="number">0</span>, planeAnchor.center.z);</div><div class="line">            </div><div class="line">            <span class="comment">//5.将花瓶节点添加到当前屏幕中</span></div><div class="line">            <span class="comment">//!!!此处一定要注意：花瓶节点是添加到代理捕捉到的节点中，而不是AR试图的根节点。因为捕捉到的平地锚点是一个本地坐标系，而不是世界坐标系</span></div><div class="line">            [node addChildNode:vaseNode];</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="AR代码demo实现"><a href="#AR代码demo实现" class="headerlink" title="AR代码demo实现"></a>AR代码demo实现</h4><p><a href="https://github.com/sunyazhou13/ARDemos" target="_blank" rel="external">所有相关的 demos 仓库</a></p>
<p>参考文献 </p>
<p><a href="http://metalkit.org/2017/07/29/using-arkit-with-metal.html" target="_blank" rel="external">Using ARKit with Metal</a>  </p>
<p><a href="http://www.jianshu.com/p/c97b230fa391" target="_blank" rel="external">坤小1~10篇</a></p>

  </section>

</article>


    <! -- 添加捐赠图标 -->
<div class ="post-donate">
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           ↑<br>
           欣赏此文？求鼓励，求支持！
        </span>
        <br>
    </div>  
    <div id="donate_guide" class="donate_bar center hidden" >
        <!-- 方式一： 
            ![](/img/Alipay.jpg)
            ![](/img/WeChatpay.jpg)
        -->
        <!-- 方式二；
            step1：在_config.yml中添加配置
                Alipay: /img/Alipay.jpg
                WeChatpay: /img/WeChatpay.jpg
            step2：此处两张图片的路径分别设置为如下
                <img src="undefined"
                <img src="undefined"
        -->
        <!-- 支付宝打赏图案 -->
        <img src="/images/Alipay.jpg" alt="支付宝打赏">
        <!-- 微信打赏图案 -->
        <img src="/images/WeChatpay.jpg" alt="微信打赏">
    </div>
    <script type="text/javascript">
        document.getElementById('btn_donate').onclick = function(){
            $('#donate_board').addClass('hidden');
            $('#donate_guide').removeClass('hidden');
        }
    </script>
</div>

<! -- 添加捐赠图标 -->



<section class="read-more">
     
        
            <div class="read-more-item">
                <span class="read-more-item-dim">最近的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2017/09/01/2017-09-01-Charles-capture-https/" title="如何使用Charles截获https请求">如何使用Charles截获https请求</a></h2>
                <p class="excerpt">
                
                前言
如何使用charles在iOS设备上截获https的请求 
1.安装Charles官网下载就行了 至于破解之类的 自行google吧  我这里使用的是Charles 4.1.3版本 目前应该是最新的 
2.HTTP抓包配置(1) 查看电脑IP
(2) 设置手机HTTP代理手机连上电脑，点击“设
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2017-09-01T15:17:09.000Z" class="post-list__meta--date date">2017-09-01</time>
 &#8226; <span class="post-list__meta--tags tags">于&nbsp;
  <a class="tag-link" href="/tags/iOS开发/">iOS开发</a>, <a class="tag-link" href="/tags/macOS开发/">macOS开发</a>, <a class="tag-link" href="/tags/技巧/">技巧</a>

</span><a class="btn-border-small" href="/2017/09/01/2017-09-01-Charles-capture-https/">继续阅读</a></div>

            </div>
        

        
            <div class="read-more-item">
                <span class="read-more-item-dim">更早的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2017/08/07/Learning-AV-Foundation-AVAsset-Senior/" title="Learning AV Foundation(四)AVAsset元数据(高级篇)">Learning AV Foundation(四)AVAsset元数据(高级篇)</a></h2>
                <p class="excerpt">
                
                
前言先上图 

这一篇 我们将学习解决如何一套代码解析大部分 多媒体格式的文件然后形成通用的 model - 元数据键值空间标准化
内容介绍结构图

class 代码 

MediaItem (一个直接对外的接口)
MetaData (元数据model)
Genre (风格)
AVMetadata
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2017-08-07T12:36:46.000Z" class="post-list__meta--date date">2017-08-07</time>
 &#8226; <span class="post-list__meta--tags tags">于&nbsp;
  <a class="tag-link" href="/tags/Learning-AV-Foundation/">Learning AV Foundation</a>, <a class="tag-link" href="/tags/iOS开发/">iOS开发</a>, <a class="tag-link" href="/tags/macOS开发/">macOS开发</a>

</span><a class="btn-border-small" href="/2017/08/07/Learning-AV-Foundation-AVAsset-Senior/">继续阅读</a></div>

            </div>
        
   
</section>



<section class="post-comments">
       <!-- 来必力City版安装代码 -->
    <div id="lv-container" data-id="city" data-uid="MTAyMC8yOTU0NS82MTEz">
      <script type="text/javascript">
       (function(d, s) {
           var j, e = d.getElementsByTagName(s)[0];

           if (typeof LivereTower === 'function') { return; }

           j = d.createElement(s);
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;

           e.parentNode.insertBefore(j, e);
       })(document, 'script');
      </script>
    <noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
    </div>
    <!-- City版安装代码已完成 -->
</section>




            <footer class="footer">
    <span class="footer__copyright">
        本站点采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>
    </span>
    <span class="footer__copyright">
        基于 <a href="http://hexo.io">Hexo</a> 搭建，感谢 <a href="https://pages.github.com/">GitHub Pages</a> 和 Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a> 提供免费的托管服务
    </span>
    <span class="footer__copyright">
        &copy; 2017 - 本站由 <a href="/">@sunyazhou13</a> 创建,
        使用<a href="https://github.com/lenbo-ma/hexo-theme-vno">hexo-theme-vno</a>主题,
        修改自<a href="https://github.com/onevcat/vno" target="_blank">喵神的vno</a>
    </span>
</footer>

        </div>
    </div>

    <script src="https://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="/js/main.js"></script>

     



    
</body>
</html>
