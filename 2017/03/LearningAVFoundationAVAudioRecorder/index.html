<!DOCTYPE html><html lang="zh-Hans" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.5.1"><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Learning AV Foundation(三)AVAudioRecorder" /><meta name="author" content="孙亚洲" /><meta property="og:locale" content="zh_Hans" /><meta name="description" content="嗨,我是孙亚洲(@sunyazhou13),一名来自祖国北国冰城的iOS开发者." /><meta property="og:description" content="嗨,我是孙亚洲(@sunyazhou13),一名来自祖国北国冰城的iOS开发者." /><link rel="canonical" href="https://www.sunyazhou.com/2017/03/LearningAVFoundationAVAudioRecorder/" /><meta property="og:url" content="https://www.sunyazhou.com/2017/03/LearningAVFoundationAVAudioRecorder/" /><meta property="og:site_name" content="迈腾大队长" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2017-03-28T09:40:18+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Learning AV Foundation(三)AVAudioRecorder" /><meta name="twitter:site" content="@sunyazhou" /><meta name="twitter:creator" content="@孙亚洲" /><meta name="google-site-verification" content="Xo29j227HYVdC-vDA_-qJwvDP3PIo-lC78CFeBvhrDA" /> <script type="application/ld+json"> {"datePublished":"2017-03-28T09:40:18+00:00","@type":"BlogPosting","dateModified":"2017-03-28T09:40:18+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.sunyazhou.com/2017/03/LearningAVFoundationAVAudioRecorder/"},"author":{"@type":"Person","name":"孙亚洲"},"url":"https://www.sunyazhou.com/2017/03/LearningAVFoundationAVAudioRecorder/","description":"嗨,我是孙亚洲(@sunyazhou13),一名来自祖国北国冰城的iOS开发者.","headline":"Learning AV Foundation(三)AVAudioRecorder","@context":"https://schema.org"}</script><title>Learning AV Foundation(三)AVAudioRecorder | 迈腾大队长</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/images/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">迈腾大队长</a></div><div class="site-subtitle font-italic">不斷學習,與時俱進.求真務實,實事求是.</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3"></i> <span>主页</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3"></i> <span>归档</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3"></i> <span>分类</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3"></i> <span>标签</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/projects/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-paint-brush ml-xl-3 mr-xl-3"></i> <span>作品</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3"></i> <span>关于</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } get isResolvedDarkMode() { if (this.isLightMode) { return false; } return this.isSysDarkPrefer; } updateCommentStyle() { var theme = "github-light"; if (this.isResolvedDarkMode) { theme = "photon-dark"; } let comment = document.querySelector("iframe.utterances-frame"); if (comment == null) { return; } comment.contentWindow.postMessage( { type: "set-theme", theme: theme }, "https://utteranc.es/" ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateCommentStyle(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/sunyazhou13" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/sunyazhou" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.weibo.com/sunyazhou13" aria-label="" target="_blank" rel="noopener"> <i class="fab fa-weibo"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sunyazhou','111.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 主页 </a> </span> <span>Learning AV Foundation(三)AVAudioRecorder</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Learning AV Foundation(三)AVAudioRecorder</h1><div class="post-meta text-muted d-flex flex-column"><div> 　由 <span class="author"> 孙亚洲 </span> 发布于 <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Mar 28, 2017, 9:40 AM +0000" > 2017-03-28 <i class="unloaded">2017-03-28T09:40:18+00:00</i> </span></div><div> 最后更新: <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Apr 2, 2023, 4:42 PM +0800" > 2023-04-02 <i class="unloaded">2023-04-02T08:42:51+00:00</i> </span></div></div><div class="post-content"><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20170328LearningAVFoundationAVAudioRecorder/cover.webp" alt="" /></p><h2 id="前言">前言</h2><p>在<code class="language-plaintext highlighter-rouge">AV Foundation</code>中使用<code class="language-plaintext highlighter-rouge">AVAudioRecorder</code>类添加音频录制功能和使用<code class="language-plaintext highlighter-rouge">AVAudioPlayer</code>一样简单, 都是在<code class="language-plaintext highlighter-rouge">Audio Queue Server</code>上层构建的.同时支持<code class="language-plaintext highlighter-rouge">macOS</code>和<code class="language-plaintext highlighter-rouge">iOS</code>平台.可以从内置麦克风录制音频,也可以支持数字音频接口或USB外接麦克风录制.</p><h2 id="主要内容如下">主要内容如下:</h2><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>如何创建AVAudioRecorder  
    1. 音频格式
    2. 采样率
    3. 通道数
创建Demo
    1. 配置音频会话
    2. 实现录音功能
    3. 使用Audio Metering实现声波视觉显示
</pre></table></code></div></div><p>创建<code class="language-plaintext highlighter-rouge">AVAudioRecorder</code>之前先了解一下它的方法和成员变量</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">@property</span> <span class="p">(</span><span class="n">readonly</span><span class="p">,</span> <span class="n">getter</span><span class="o">=</span><span class="n">isRecording</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">recording</span><span class="p">;</span><span class="c1">//是否正在录音</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">readonly</span><span class="p">)</span> <span class="n">NSDictionary</span><span class="o">&lt;</span><span class="n">NSString</span> <span class="o">*</span><span class="p">,</span> <span class="n">id</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">settings</span><span class="p">;</span><span class="c1">//录音配置：采样率、音频格式、通道数...</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">readonly</span><span class="p">)</span> <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span><span class="p">;</span><span class="c1">//录音文件存放URL</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">readonly</span><span class="p">)</span> <span class="n">NSTimeInterval</span> <span class="n">currentTime</span><span class="p">;</span><span class="c1">//录音时长</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">getter</span><span class="o">=</span><span class="n">isMeteringEnabled</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">meteringEnabled</span><span class="p">;</span><span class="c1">//是否监控声波</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">AVAudioRecorder</code>的实例方法:</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">prepareToRecord</span><span class="p">;</span><span class="c1">//为录音准备缓冲区</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">record</span><span class="p">;</span><span class="c1">//录音开始，暂停后调用会恢复录音</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="nf">recordAtTime</span><span class="p">:(</span><span class="n">NSTimeInterval</span><span class="p">)</span><span class="nv">time</span><span class="p">;</span><span class="c1">//在指定时间后开始录音</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="nf">recordForDuration</span><span class="p">:(</span><span class="n">NSTimeInterval</span><span class="p">)</span> <span class="n">duration</span><span class="p">;</span><span class="c1">//按指定时长录音</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="nf">recordAtTime</span><span class="p">:(</span><span class="n">NSTimeInterval</span><span class="p">)</span><span class="nv">time</span> 
         <span class="nf">forDuration</span><span class="p">:(</span><span class="n">NSTimeInterval</span><span class="p">)</span><span class="nv">duration</span><span class="p">;</span><span class="c1">//上面2个的合体</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">pause</span><span class="p">;</span> <span class="c1">//暂停录音</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">stop</span><span class="p">;</span> <span class="c1">//停止录音</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">deleteRecording</span><span class="p">;</span><span class="c1">//删除录音，必须先停止录音再删除</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">AVAudioRecorder</code>的代理方法:</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c1">//录音完成后调用</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">audioRecorderDidFinishRecording</span><span class="p">:(</span><span class="n">AVAudioRecorder</span> <span class="o">*</span><span class="p">)</span><span class="nv">recorder</span> 
                           <span class="nf">successfully</span><span class="p">:(</span><span class="n">BOOL</span><span class="p">)</span><span class="nv">flag</span><span class="p">;</span>
<span class="c1">//录音编码发生错误时调用</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">audioRecorderEncodeErrorDidOccur</span><span class="p">:(</span><span class="n">AVAudioRecorder</span> <span class="o">*</span><span class="p">)</span><span class="nv">recorder</span> 
                                   <span class="nf">error</span><span class="p">:(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span><span class="p">;</span>
</pre></table></code></div></div><h2 id="如何创建avaudiorecorder">如何创建<code class="language-plaintext highlighter-rouge">AVAudioRecorder</code></h2><p>创建<code class="language-plaintext highlighter-rouge">AVAudioRecorder</code>对象所需要的参数如下:</p><ul><li>音频流录制时写入到本地的路径URL<li><code class="language-plaintext highlighter-rouge">settings</code>录音配置：采样率、音频格式、通道数…等键值参数字典<li>发生错误的<code class="language-plaintext highlighter-rouge">NSError</code>指针</ul><p>如下代码:</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="cm">/**
 创建录音器
 */</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">createRecorder</span> <span class="p">{</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">directory</span> <span class="o">=</span> <span class="n">NSTemporaryDirectory</span><span class="p">();</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">filePath</span> <span class="o">=</span> <span class="p">[</span><span class="n">directory</span> <span class="nf">stringByAppendingPathComponent</span><span class="p">:</span><span class="s">@"voice1.m4a"</span><span class="p">];</span>
    <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nf">fileURLWithPath</span><span class="p">:</span><span class="n">filePath</span><span class="p">];</span>
    
    <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">setting</span> <span class="o">=</span> <span class="p">@{</span><span class="n">AVFormatIDKey</span> <span class="o">:</span> <span class="err">@</span><span class="p">(</span><span class="n">kAudioFormatMPEG4AAC</span><span class="p">),</span>
                              <span class="nl">AVSampleRateKey:</span> <span class="mf">@22050.0f</span><span class="p">,</span>
                              <span class="nl">AVNumberOfChannelsKey:</span> <span class="mi">@1</span><span class="p">};</span>
    <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="o">=</span> <span class="p">[[</span><span class="n">AVAudioRecorder</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithURL</span><span class="p">:</span><span class="n">url</span>
                                                <span class="nl">settings:</span><span class="n">setting</span>
                                                   <span class="nl">error:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">prepareToRecord</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Recorder Create Error: %@"</span><span class="p">,</span> <span class="p">[</span><span class="n">error</span> <span class="nf">localizedDescription</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>这里的建议调用<code class="language-plaintext highlighter-rouge">[self.recorder prepareToRecord]</code>方法对录音实例进行预设就像<a href="http://sunyazhou.com/2017/03/17/Learning-AV-Foundation-AVAudioPlayer/">上一章</a>创建<code class="language-plaintext highlighter-rouge">AVAudioPlayer</code>类似.都是为了执行底层<code class="language-plaintext highlighter-rouge">Audio Queue</code>初始化的必要过程.这个<code class="language-plaintext highlighter-rouge">prepareToRecord</code>方法还在给定的URL参数指定的位置创建一个文件，这样就减少了录制启动时的延时</p><h2 id="音频格式">音频格式</h2><p><code class="language-plaintext highlighter-rouge">AVFormatIDKey</code>key指定录制格式,这里的除了<code class="language-plaintext highlighter-rouge">kAudioFormatMPEG4AAC</code>格式还有下面这些:</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="n">CF_ENUM</span><span class="p">(</span><span class="n">AudioFormatID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">kAudioFormatLinearPCM</span>               <span class="o">=</span> <span class="err">'</span><span class="n">lpcm</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatAC3</span>                     <span class="o">=</span> <span class="err">'</span><span class="n">ac</span><span class="o">-</span><span class="mi">3</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormat60958AC3</span>                <span class="o">=</span> <span class="err">'</span><span class="n">cac3</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatAppleIMA4</span>               <span class="o">=</span> <span class="err">'</span><span class="n">ima4</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatMPEG4AAC</span>                <span class="o">=</span> <span class="err">'</span><span class="n">aac</span> <span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatMPEG4CELP</span>               <span class="o">=</span> <span class="err">'</span><span class="n">celp</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatMPEG4HVXC</span>               <span class="o">=</span> <span class="err">'</span><span class="n">hvxc</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatMPEG4TwinVQ</span>             <span class="o">=</span> <span class="err">'</span><span class="n">twvq</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatMACE3</span>                   <span class="o">=</span> <span class="err">'</span><span class="n">MAC3</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatMACE6</span>                   <span class="o">=</span> <span class="err">'</span><span class="n">MAC6</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatULaw</span>                    <span class="o">=</span> <span class="err">'</span><span class="n">ulaw</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatALaw</span>                    <span class="o">=</span> <span class="err">'</span><span class="n">alaw</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatQDesign</span>                 <span class="o">=</span> <span class="err">'</span><span class="n">QDMC</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatQDesign2</span>                <span class="o">=</span> <span class="err">'</span><span class="n">QDM2</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatQUALCOMM</span>                <span class="o">=</span> <span class="err">'</span><span class="n">Qclp</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatMPEGLayer1</span>              <span class="o">=</span> <span class="err">'</span><span class="p">.</span><span class="n">mp1</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatMPEGLayer2</span>              <span class="o">=</span> <span class="err">'</span><span class="p">.</span><span class="n">mp2</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatMPEGLayer3</span>              <span class="o">=</span> <span class="err">'</span><span class="p">.</span><span class="n">mp3</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatTimeCode</span>                <span class="o">=</span> <span class="err">'</span><span class="n">time</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatMIDIStream</span>              <span class="o">=</span> <span class="err">'</span><span class="n">midi</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatParameterValueStream</span>    <span class="o">=</span> <span class="err">'</span><span class="n">apvs</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatAppleLossless</span>           <span class="o">=</span> <span class="err">'</span><span class="n">alac</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatMPEG4AAC_HE</span>             <span class="o">=</span> <span class="err">'</span><span class="n">aach</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatMPEG4AAC_LD</span>             <span class="o">=</span> <span class="err">'</span><span class="n">aacl</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatMPEG4AAC_ELD</span>            <span class="o">=</span> <span class="err">'</span><span class="n">aace</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatMPEG4AAC_ELD_SBR</span>        <span class="o">=</span> <span class="err">'</span><span class="n">aacf</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatMPEG4AAC_ELD_V2</span>         <span class="o">=</span> <span class="err">'</span><span class="n">aacg</span><span class="err">'</span><span class="p">,</span>    
    <span class="n">kAudioFormatMPEG4AAC_HE_V2</span>          <span class="o">=</span> <span class="err">'</span><span class="n">aacp</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatMPEG4AAC_Spatial</span>        <span class="o">=</span> <span class="err">'</span><span class="n">aacs</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatAMR</span>                     <span class="o">=</span> <span class="err">'</span><span class="n">samr</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatAMR_WB</span>                  <span class="o">=</span> <span class="err">'</span><span class="n">sawb</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatAudible</span>                 <span class="o">=</span> <span class="err">'</span><span class="n">AUDB</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatiLBC</span>                    <span class="o">=</span> <span class="err">'</span><span class="n">ilbc</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatDVIIntelIMA</span>             <span class="o">=</span> <span class="mh">0x6D730011</span><span class="p">,</span>
    <span class="n">kAudioFormatMicrosoftGSM</span>            <span class="o">=</span> <span class="mh">0x6D730031</span><span class="p">,</span>
    <span class="n">kAudioFormatAES3</span>                    <span class="o">=</span> <span class="err">'</span><span class="n">aes3</span><span class="err">'</span><span class="p">,</span>
    <span class="n">kAudioFormatEnhancedAC3</span>             <span class="o">=</span> <span class="err">'</span><span class="n">ec</span><span class="o">-</span><span class="mi">3</span><span class="err">'</span>
<span class="p">};</span>

</pre></table></code></div></div><p>这里的<code class="language-plaintext highlighter-rouge">kAudioFormatLinearPCM</code>会将为压缩的音频流写入到文件中,这就是原始数据,保真度最高,当然文件也最大, 选择ACC<code class="language-plaintext highlighter-rouge">kAudioFormatMPEG4AAC</code>或者AppleIMA4<code class="language-plaintext highlighter-rouge">kAudioFormatAppleLossless</code>等格式会显著缩小文件，还能保证音频质量.</p><blockquote><p><em>注意:</em> <em>指定的音频格式一定要和文件写入的URL文件类型保持一致。如果录制xxx.wav文件格式 是 Waveform Audio File Format(WAVE)的格式要求,即 低字节序、 LinePCM。 如果<code class="language-plaintext highlighter-rouge">AVFormatIDKey</code>指定的值不是<code class="language-plaintext highlighter-rouge">kAudioFormatLinearPCM</code>则会发生错误。NSError 会返回如下错误</em> <em>The operation couldn’t be completed. (OSState error 1718449215.)</em></p></blockquote><h2 id="采样率">采样率</h2><p>上边的代码里<code class="language-plaintext highlighter-rouge">AVSampleRateKey</code>用于定义录音器的采样率. <strong>采样率定义了对输入的模拟音频信号每一秒内的采样数</strong>. 如果使用<strong>低采样率</strong> 比如8kHz,会导致粗粒度、AM广播类型的录制效果, 不过文件会比较小; 使用<strong>44.1kHz的采样率(CD质量的采样率)</strong>会得到非常高质量的内容, 不过文件比较大. 至于使用什么样的采样率没有明确的定义. 不过开发者应该尽量使用<strong>标准的采样率，比如: 8000Hz、16 000Hz(16kHz)、22050Hz(22.05kHz)或 44100Hz(44.1kHz)、当然还有48000Hz和96000Hz</strong> ,(kHz代表千赫),超过48000或96000的采样对人耳已经没有意义.最终是我们的耳朵在进行判断.（<a href="http://sunyazhou.com/2017/03/17/Learning-AV-Foundation-AVAudioPlayer/">上一章</a>说了 <strong>人耳所能听到的声音，最低的频率是从20Hz起一直到最高频率20kHz</strong>,录音最好采用 x 2 倍的频率）</p><h2 id="通道数">通道数</h2><p><code class="language-plaintext highlighter-rouge">AVNumberOfChannelsKey</code>用于定义记录音频内容的通道数。<strong>指定默认值1 意味着使用单声道录制</strong>、<strong>设置2意味着使用立体声录制</strong>。除非使用外部硬件进行录制，否则同窗应该创建单声道录音。 这里的通道数是指 录制设备的输入数量 可以理解为 麦克风 内置 或者外接麦克风录制比如 插入Apple耳机 里面的麦克风。</p><blockquote><p>以上是全面<code class="language-plaintext highlighter-rouge">AVAudioRecorder</code>的部分概念,<code class="language-plaintext highlighter-rouge">AVAudioRecorder</code>支持<strong>无限时长录制</strong>,还可以设置从<strong>未来某一时间点开始录制</strong>或<strong>指定时长录制</strong></p></blockquote><h2 id="网络流媒体处理">网络流媒体处理</h2><p><code class="language-plaintext highlighter-rouge">AVAudioPlayer</code>音频播放器只能播放本地文件，并且是一次性加载所有的音频数据，但我们有时候需要边下载边听怎么办？ <code class="language-plaintext highlighter-rouge">AVAudioPlayer</code>是不支持这种网络流媒体形式的音频播放，要播放这种网络流媒体，我们需要使用<code class="language-plaintext highlighter-rouge">AudioToolbox</code>框架的音频队列服务<code class="language-plaintext highlighter-rouge">Audio Queue Services</code>。</p><p><strong>音频队列服务分为3个部分:</strong></p><blockquote><ul><li>3个缓冲器<li>1个缓冲队列<li>1个回调</ul></blockquote><p><strong>1. 下面是录音的音频队列服务的工作原理:</strong></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20170328LearningAVFoundationAVAudioRecorder/QueueServiceRecord.webp" alt="" /></p><p><strong>2. 下面是播放音频的音频队列服务的工作原理;</strong></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20170328LearningAVFoundationAVAudioRecorder/QueueServicePlay.webp" alt="" /></p><p>当然处理这些不需要我们自己去写C语言函数实现 有个开源库<a href="https://github.com/sunyazhou13/FreeStreamer">FreeStreamer</a></p><p>FreeStreamer使用</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="cp">#import &lt;FreeStreamer/FreeStreamer.h&gt;
</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">viewDidLoad</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">viewDidLoad</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">initAudioStream</span><span class="p">];</span>
    <span class="c1">//播放网络流媒体音频</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">audioStream</span> <span class="nf">play</span><span class="p">];</span>
<span class="p">}</span>
<span class="cm">/* 初始化网络流媒体对象 */</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">initAudioStream</span><span class="p">{</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">urlStr</span> <span class="o">=</span> <span class="s">@"http://sc1.111ttt.com/2016/1/02/24/195242042236.mp3"</span><span class="p">;</span>
    <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nf">URLWithString</span><span class="p">:</span><span class="n">urlStr</span><span class="p">];</span>
    <span class="c1">//创建FSAudioStream对象</span>
    <span class="n">self</span><span class="p">.</span><span class="n">audioStream</span> <span class="o">=</span> <span class="p">[[</span><span class="n">FSAudioStream</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithUrl</span><span class="p">:</span><span class="n">url</span><span class="p">];</span>
    <span class="c1">//设置播放错误回调Block</span>
    <span class="n">self</span><span class="p">.</span><span class="n">audioStream</span><span class="p">.</span><span class="n">onFailure</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="n">FSAudioStreamError</span> <span class="n">error</span><span class="p">,</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">description</span><span class="p">){</span>
          <span class="n">NSLog</span><span class="p">(</span><span class="s">@"播放过程中发生错误，错误信息：%@"</span><span class="p">,</span><span class="n">description</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="c1">//设置播放完成回调Block</span>
    <span class="n">self</span><span class="p">.</span><span class="n">audioStream</span><span class="p">.</span><span class="n">onCompletion</span> <span class="o">=</span> <span class="o">^</span><span class="p">(){</span>
          <span class="n">NSLog</span><span class="p">(</span><span class="s">@"播放完成!"</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">audioStream</span> <span class="nf">setVolume</span><span class="p">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">];</span><span class="c1">//设置声音大小</span>
<span class="p">}</span>
</pre></table></code></div></div><p>有点跑远了 回到正题 本章将不会把这个写到demo中 请谅解</p><h1 id="下面我们来写个avaudiorecorder的demo-完成上述功能">下面我们来写个<code class="language-plaintext highlighter-rouge">AVAudioRecorder</code>的Demo 完成上述功能</h1><h2 id="配置会话">配置会话</h2><p>首先创建以一个AVAudioRecorderDemo工程iOS平台这些相信大家非常熟练了.</p><p>在<code class="language-plaintext highlighter-rouge">AppDelegate</code>里面导入<code class="language-plaintext highlighter-rouge">#import &lt;AVFoundation/AVFoundation.h&gt;</code> 写上设置如下代码</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="nf">application</span><span class="p">:(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didFinishLaunchingWithOptions</span><span class="p">:(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">launchOptions</span> <span class="p">{</span>
    
    <span class="n">AVAudioSession</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="p">[</span><span class="n">AVAudioSession</span> <span class="nf">sharedInstance</span><span class="p">];</span>
    <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">session</span> <span class="nf">setCategory</span><span class="p">:</span><span class="n">AVAudioSessionCategoryPlayAndRecord</span> <span class="nf">error</span><span class="p">:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Category Error: %@"</span><span class="p">,[</span><span class="n">error</span> <span class="nf">localizedDescription</span><span class="p">]);</span>
    <span class="p">}</span>
    
    <span class="c1">//激活会话</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">session</span> <span class="nf">setActive</span><span class="p">:</span><span class="nb">YES</span> <span class="nf">error</span><span class="p">:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Activation Error: %@"</span><span class="p">,[</span><span class="n">error</span> <span class="nf">localizedDescription</span><span class="p">]);</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>这<code class="language-plaintext highlighter-rouge">AVAudioSessionCategoryPlayAndRecord</code>是<a href="http://sunyazhou.com/2017/03/17/Learning-AV-Foundation-AVAudioPlayer/">上一章</a>说的那几种Category,我们需要__录音+播放__功能</p><p>下一步 配置 plist文件访问权限信息 可以参考<a href="http://localhost:4000/2017/03/20/Access-privacy-sensitive-data-private-access-permission/">Access privacy-sensitive data</a>这篇文章把访问权限需要的 信息填充上.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20170328LearningAVFoundationAVAudioRecorder/FillInfo.webp" alt="plist1" /></p><p>然后选择SourceCode <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20170328LearningAVFoundationAVAudioRecorder/SourceCode.webp" alt="plist2" /></p><p>填写上</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c">&lt;!-- 🎤 Microphone --&gt;</span>
<span class="nt">&lt;key&gt;</span>NSMicrophoneUsageDescription<span class="nt">&lt;/key&gt;</span>
<span class="nt">&lt;string&gt;</span>$(PRODUCT_NAME) microphone use<span class="nt">&lt;/string&gt;</span>
</pre></table></code></div></div><p>上边这些是为了访问本地授权, 记得授权如果第一次被拒就必须让用户手动 到通用-设置里面去配置否则将永远不好使哈。如果不写这种本地授权 程序应该会 crash</p><h2 id="录音代码实现">录音代码实现</h2><p>首先我们来封装一个类起名叫<code class="language-plaintext highlighter-rouge">BDRecoder</code>吧. 这里类我们让它负责所有 音频录制、暂停录制、保存录制文件等功能 并有回调函数等block. <code class="language-plaintext highlighter-rouge">BDRecoder.h</code>看起来像下面这样, 这里后续完善的话可以加个代理 表示录制过程中意外中断或者线路切换等逻辑.</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="c1">//</span>
<span class="c1">//  BDRecorder.h</span>
<span class="c1">//  AVAudioRecorderDemo</span>
<span class="c1">//</span>
<span class="c1">//  Created by sunyazhou on 2017/3/29.</span>
<span class="c1">//  Copyright © 2017年 Baidu, Inc. All rights reserved.</span>
<span class="c1">//</span>

<span class="cp">#import &lt;Foundation/Foundation.h&gt;
#import &lt;AVFoundation/AVFoundation.h&gt;
</span>
<span class="k">@class</span> <span class="nc">MemoModel</span><span class="p">;</span>
<span class="c1">//录音停止的回调</span>
<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">^</span><span class="n">BDRecordingStopCompletionHanlder</span><span class="p">)(</span><span class="n">BOOL</span><span class="p">);</span>
<span class="c1">//保存录音文件完成的回调</span>
<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">^</span><span class="n">BDRecordingSaveCompletionHanlder</span><span class="p">)(</span><span class="n">BOOL</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

<span class="k">@interface</span> <span class="nc">BDRecorder</span> <span class="p">:</span> <span class="nc">NSObject</span>

<span class="cm">/**
 * 外部获取当前录制的时间
 * 小时:分钟:秒  当然后续可以加微秒和毫秒哈就是格式字符串 00:03:02 这样
 */</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">formattedCurrentTime</span><span class="p">;</span>

<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">record</span><span class="p">;</span> <span class="c1">//开始录音</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">pause</span><span class="p">;</span>  <span class="c1">//暂停录音</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">stopWithCompletionHandler</span><span class="p">:(</span><span class="n">BDRecordingStopCompletionHanlder</span><span class="p">)</span><span class="nv">handler</span><span class="p">;</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">saveRecordingWithName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">name</span>
            <span class="nf">completionHandler</span><span class="p">:(</span><span class="n">BDRecordingSaveCompletionHanlder</span><span class="p">)</span><span class="nv">handler</span><span class="p">;</span>

<span class="cm">/**
 回放录制的文件

 @param memo 备忘录文件model 放着当前播放的model
 @return 是否播放成功
 */</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="nf">playbackURL</span><span class="p">:(</span><span class="n">MemoModel</span> <span class="o">*</span><span class="p">)</span><span class="nv">memo</span><span class="p">;</span>
<span class="k">@end</span>

</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">BDRecoder.m</code></p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
</pre><td class="rouge-code"><pre><span class="c1">//</span>
<span class="c1">//  BDRecorder.m</span>
<span class="c1">//  AVAudioRecorderDemo</span>
<span class="c1">//</span>
<span class="c1">//  Created by sunyazhou on 2017/3/29.</span>
<span class="c1">//  Copyright © 2017年 Baidu, Inc. All rights reserved.</span>
<span class="c1">//</span>

<span class="cp">#import "BDRecorder.h"
</span>
<span class="cp">#import "MemoModel.h"
</span>
<span class="k">@interface</span> <span class="nc">BDRecorder</span> <span class="p">()</span> <span class="o">&lt;</span><span class="n">AVAudioRecorderDelegate</span><span class="o">&gt;</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">AVAudioPlayer</span> <span class="o">*</span><span class="n">player</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">AVAudioRecorder</span> <span class="o">*</span><span class="n">recorder</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">BDRecordingStopCompletionHanlder</span> <span class="n">completionHandler</span><span class="p">;</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">BDRecorder</span>

<span class="k">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="n">init</span> <span class="p">{</span>
    <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nf">init</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSString</span> <span class="o">*</span><span class="n">temDir</span> <span class="o">=</span> <span class="n">NSTemporaryDirectory</span><span class="p">();</span>
        <span class="n">NSString</span> <span class="o">*</span><span class="n">filePath</span> <span class="o">=</span> <span class="p">[</span><span class="n">temDir</span> <span class="nf">stringByAppendingPathComponent</span><span class="p">:</span><span class="s">@"test1.caf"</span><span class="p">];</span>
        <span class="n">NSURL</span> <span class="o">*</span><span class="n">fileURL</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nf">fileURLWithPath</span><span class="p">:</span><span class="n">filePath</span><span class="p">];</span>
        
        <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">setting</span> <span class="o">=</span> <span class="p">@{</span><span class="n">AVFormatIDKey</span><span class="o">:</span> <span class="err">@</span><span class="p">(</span><span class="n">kAudioFormatAppleIMA4</span><span class="p">),</span>
                                  <span class="nl">AVSampleRateKey:</span> <span class="mf">@44100.0f</span><span class="p">,</span>
                                  <span class="nl">AVNumberOfChannelsKey:</span> <span class="mi">@1</span><span class="p">,</span>
                                  <span class="nl">AVEncoderBitDepthHintKey:</span> <span class="mi">@16</span><span class="p">,</span>
                                  <span class="nl">AVEncoderAudioQualityKey:</span> <span class="err">@</span><span class="p">(</span><span class="n">AVAudioQualityMedium</span><span class="p">)</span>
                                  <span class="p">};</span>
        <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
        <span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="o">=</span> <span class="p">[[</span><span class="n">AVAudioRecorder</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithURL</span><span class="p">:</span><span class="n">fileURL</span> <span class="nf">settings</span><span class="p">:</span><span class="n">setting</span> <span class="n">error</span><span class="o">:&amp;</span><span class="n">error</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">self</span><span class="p">.</span><span class="n">recorder</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
            <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">prepareToRecord</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Create Recorder Error: %@"</span><span class="p">,[</span><span class="n">error</span> <span class="nf">localizedDescription</span><span class="p">]);</span>
        <span class="p">}</span> 
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">record</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">record</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">pause</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">pause</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">stopWithCompletionHandler</span><span class="p">:(</span><span class="n">BDRecordingStopCompletionHanlder</span><span class="p">)</span><span class="nv">handler</span> <span class="p">{</span>
    <span class="n">self</span><span class="p">.</span><span class="n">completionHandler</span> <span class="o">=</span> <span class="n">handler</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">stop</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">saveRecordingWithName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">name</span>
            <span class="nf">completionHandler</span><span class="p">:(</span><span class="n">BDRecordingSaveCompletionHanlder</span><span class="p">)</span><span class="nv">handler</span> <span class="p">{</span>
    <span class="n">NSTimeInterval</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDate</span> <span class="nf">timeIntervalSinceReferenceDate</span><span class="p">];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">filename</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"%@-%f.caf"</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">docDir</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">documentsDirectory</span><span class="p">];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">destPath</span> <span class="o">=</span> <span class="p">[</span><span class="n">docDir</span> <span class="nf">stringByAppendingPathComponent</span><span class="p">:</span><span class="n">filename</span><span class="p">];</span>
    <span class="n">NSURL</span> <span class="o">*</span><span class="n">srcURL</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">recorder</span><span class="p">.</span><span class="n">url</span><span class="p">;</span>
    <span class="n">NSURL</span> <span class="o">*</span><span class="n">destURL</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nf">fileURLWithPath</span><span class="p">:</span><span class="n">destPath</span><span class="p">];</span>
    <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">success</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSFileManager</span> <span class="nf">defaultManager</span><span class="p">]</span> <span class="nf">copyItemAtURL</span><span class="p">:</span><span class="n">srcURL</span> <span class="nf">toURL</span><span class="p">:</span><span class="n">destURL</span> <span class="n">error</span><span class="o">:&amp;</span><span class="n">error</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MemoModel</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="p">[</span><span class="n">MemoModel</span> <span class="nf">memoWithTitle</span><span class="p">:</span><span class="n">name</span> <span class="nf">url</span><span class="p">:</span><span class="n">destURL</span><span class="p">];</span>
        <span class="n">handler</span><span class="p">(</span><span class="nb">YES</span><span class="p">,</span> <span class="n">model</span><span class="p">);</span>
    <span class="p">}</span>
    
    
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">documentsDirectory</span> <span class="p">{</span>
    <span class="n">NSArray</span> <span class="o">*</span><span class="n">paths</span> <span class="o">=</span> <span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">NSDocumentDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="nb">YES</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">paths</span> <span class="nf">objectAtIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">audioRecorderDidFinishRecording</span><span class="p">:(</span><span class="n">AVAudioRecorder</span> <span class="o">*</span><span class="p">)</span><span class="nv">recorder</span>
                           <span class="nf">successfully</span><span class="p">:(</span><span class="n">BOOL</span><span class="p">)</span><span class="nv">flag</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">completionHandler</span><span class="p">)</span> <span class="p">{</span> <span class="n">self</span><span class="p">.</span><span class="n">completionHandler</span><span class="p">(</span><span class="n">flag</span><span class="p">);</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">@end</span>

</pre></table></code></div></div><p>这里的<code class="language-plaintext highlighter-rouge">self.completionHandler</code>当外部调用<code class="language-plaintext highlighter-rouge">stopWithCompletionHandler</code>的时候暂存一下block是为了录音完成时告诉外部通知一下以便于可以弹出一个UIAlertView去显示保存等操作</p><p>当停止录音, 进入语音备忘阶段命名阶段时 让外部调用<code class="language-plaintext highlighter-rouge">saveRecordingWithName:completionHandler </code>传入文件的命名,然后我们通过<code class="language-plaintext highlighter-rouge">self.recorder.url</code>获取到URL并且copy到tmp里面是目录并命名</p><p>下一步要实现<code class="language-plaintext highlighter-rouge">playbackURL:</code> 这里面有个<code class="language-plaintext highlighter-rouge">MemoModel</code>参数的对象, 这个<code class="language-plaintext highlighter-rouge">MemoModel</code>是一个对象model放着 文件name、url…</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="cp">#import &lt;Foundation/Foundation.h&gt;
</span>
<span class="k">@interface</span> <span class="nc">MemoModel</span> <span class="p">:</span> <span class="nc">NSObject</span> <span class="o">&lt;</span><span class="n">NSCopying</span><span class="o">&gt;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">copy</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">title</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">copy</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">dateString</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">copy</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">timeString</span><span class="p">;</span>

<span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="nf">memoWithTitle</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">title</span> <span class="nf">url</span><span class="p">:(</span><span class="n">NSURL</span> <span class="o">*</span><span class="p">)</span><span class="nv">url</span><span class="p">;</span>

<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">deleteMemo</span><span class="p">;</span>
<span class="k">@end</span>
<span class="c1">//具体实现请参考我的最终demo</span>
</pre></table></code></div></div><p>实现播放部分需要创建播放器 这里就简单创建一下<code class="language-plaintext highlighter-rouge">AVAudioPlayer</code></p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="cm">/**
 回放录制的文件
 
 @param memo 备忘录文件model 放着当前播放的model
 @return 是否播放成功
 */</span>
<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="nf">playbackURL</span><span class="p">:(</span><span class="n">MemoModel</span> <span class="o">*</span><span class="p">)</span><span class="nv">memo</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">player</span> <span class="nf">stop</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">player</span> <span class="o">=</span> <span class="p">[[</span><span class="n">AVAudioPlayer</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithContentsOfURL</span><span class="p">:</span><span class="n">memo</span><span class="p">.</span><span class="n">url</span> <span class="nf">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">player</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">player</span> <span class="nf">prepareToPlay</span><span class="p">];</span>
        <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>这里通过memo.url 给当前播放器播放, 这里就简单实现一下 如果需要复杂实现可以参考我上一章讲解的<code class="language-plaintext highlighter-rouge">AVAudioPlayer</code></p><p>最后把显示事件部分的代码加上</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="cm">/**
 * 外部获取当前录制的时间
 * 小时:分钟:秒  当然后续可以加微秒和毫秒哈就是格式字符串 00:03:02 这样
 */</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">formattedCurrentTime</span><span class="p">;</span>

</pre></table></code></div></div><p>这里我们需要复写<code class="language-plaintext highlighter-rouge">formattedCurrentTime</code>get方法获取时间格式例如: 00:00:00</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="cm">/**
 返回当前录制的时间格式 HH:mm:ss

 @return 返回组装好的字符串
 */</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">formattedCurrentTime</span> <span class="p">{</span>
    <span class="n">NSUInteger</span> <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span><span class="p">.</span><span class="n">currentTime</span><span class="p">;</span>
    <span class="n">NSInteger</span> <span class="n">hours</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">);</span>
    <span class="n">NSInteger</span> <span class="n">minutes</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">%</span> <span class="mi">60</span><span class="p">;</span>
    <span class="n">NSInteger</span> <span class="n">seconds</span> <span class="o">=</span> <span class="n">time</span> <span class="o">%</span> <span class="mi">60</span><span class="p">;</span>
    
    <span class="n">NSString</span> <span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="s">@"%02i:%02i:%02i"</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="n">format</span><span class="p">,</span> <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span><span class="p">];</span>
<span class="p">}</span>
</pre></table></code></div></div><p>上边大致是封装<code class="language-plaintext highlighter-rouge">BDRecorder</code>的过程</p><p>下面是对<code class="language-plaintext highlighter-rouge">ViewController</code>UI的设置, 设置好时间格式 我们需要在<code class="language-plaintext highlighter-rouge">ViewController</code>里 自己搞个定时器去更新录制的时间在UI上的显示, 因为<code class="language-plaintext highlighter-rouge">self.recorder.currentTime</code>是只读熟悉 没提供set方法 所以我们也无法用KVO监听recorder的属性变化.</p><p>代码如下:</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
</pre><td class="rouge-code"><pre><span class="c1">//</span>
<span class="c1">//  ViewController.m</span>
<span class="c1">//  AVAudioRecorderDemo</span>
<span class="c1">//</span>
<span class="c1">//  Created by sunyazhou on 2017/3/28.</span>
<span class="c1">//  Copyright © 2017年 Baidu, Inc. All rights reserved.</span>
<span class="c1">//</span>

<span class="cp">#import "ViewController.h"
</span>
<span class="cp">#import &lt;Masonry/Masonry.h&gt;
#import &lt;AVFoundation/AVFoundation.h&gt;
</span>
<span class="cp">#import "BDRecorder.h"
#import "LevelMeterView.h"
#import "MemoModel.h"
#import "MemoCell.h"
#import "LevelPair.h"
</span>
<span class="cp">#define MEMOS_ARCHIVE    @"memos.archive"
</span>
<span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span> <span class="o">&lt;</span><span class="n">UITableViewDelegate</span><span class="p">,</span> <span class="n">UITableViewDataSource</span><span class="o">&gt;</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSMutableArray</span> <span class="o">&lt;</span><span class="n">MemoModel</span> <span class="o">*&gt;*</span><span class="n">memos</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">BDRecorder</span> <span class="o">*</span><span class="n">recorder</span><span class="p">;</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSTimer</span> <span class="o">*</span><span class="n">timer</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">CADisplayLink</span> <span class="o">*</span><span class="n">levelTimer</span><span class="p">;</span>


<span class="k">@property</span> <span class="p">(</span><span class="n">weak</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">IBOutlet</span> <span class="n">UIView</span> <span class="o">*</span><span class="n">containerView</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">weak</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">IBOutlet</span> <span class="n">UIButton</span> <span class="o">*</span><span class="n">recordButton</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">weak</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">IBOutlet</span> <span class="n">UIButton</span> <span class="o">*</span><span class="n">stopButton</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">weak</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">IBOutlet</span> <span class="n">UILabel</span> <span class="o">*</span><span class="n">timeLabel</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">weak</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">IBOutlet</span> <span class="n">LevelMeterView</span> <span class="o">*</span><span class="n">levelMeterView</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">weak</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">IBOutlet</span> <span class="n">UITableView</span> <span class="o">*</span><span class="n">tableview</span><span class="p">;</span>



<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">ViewController</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">viewDidLoad</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">viewDidLoad</span><span class="p">];</span>
    
    <span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="o">=</span> <span class="p">[[</span><span class="n">BDRecorder</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">memos</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="nf">array</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">stopButton</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    
    <span class="n">UIImage</span> <span class="o">*</span><span class="n">recordImage</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIImage</span> <span class="nf">imageNamed</span><span class="p">:</span><span class="s">@"record"</span><span class="p">]</span> <span class="nf">imageWithRenderingMode</span><span class="p">:</span><span class="n">UIImageRenderingModeAlwaysOriginal</span><span class="p">];</span>
    <span class="n">UIImage</span> <span class="o">*</span><span class="n">pauseImage</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIImage</span> <span class="nf">imageNamed</span><span class="p">:</span><span class="s">@"pause"</span><span class="p">]</span> <span class="nf">imageWithRenderingMode</span><span class="p">:</span><span class="n">UIImageRenderingModeAlwaysOriginal</span><span class="p">];</span>
    <span class="n">UIImage</span> <span class="o">*</span><span class="n">stopImage</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIImage</span> <span class="nf">imageNamed</span><span class="p">:</span><span class="s">@"stop"</span><span class="p">]</span> <span class="nf">imageWithRenderingMode</span><span class="p">:</span><span class="n">UIImageRenderingModeAlwaysOriginal</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recordButton</span> <span class="nf">setImage</span><span class="p">:</span><span class="n">recordImage</span> <span class="nf">forState</span><span class="p">:</span><span class="n">UIControlStateNormal</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recordButton</span> <span class="nf">setImage</span><span class="p">:</span><span class="n">pauseImage</span> <span class="nf">forState</span><span class="p">:</span><span class="n">UIControlStateSelected</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">stopButton</span> <span class="nf">setImage</span><span class="p">:</span><span class="n">stopImage</span> <span class="nf">forState</span><span class="p">:</span><span class="n">UIControlStateNormal</span><span class="p">];</span>
    
    <span class="n">NSData</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSData</span> <span class="nf">dataWithContentsOfURL</span><span class="p">:[</span><span class="n">self</span> <span class="nf">archiveURL</span><span class="p">]];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_memos</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="nf">array</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">_memos</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSKeyedUnarchiver</span> <span class="nf">unarchiveObjectWithData</span><span class="p">:</span><span class="n">data</span><span class="p">];</span>
    <span class="p">}</span>
    
    
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">tableview</span> <span class="nf">registerNib</span><span class="p">:[</span><span class="n">UINib</span> <span class="nf">nibWithNibName</span><span class="p">:</span><span class="s">@"MemoCell"</span> <span class="nf">bundle</span><span class="p">:[</span><span class="n">NSBundle</span> <span class="nf">mainBundle</span><span class="p">]]</span> <span class="n">forCellReuseIdentifier</span><span class="o">:</span><span class="s">@"MemoCell"</span><span class="p">];</span>
    
    
    <span class="p">[</span><span class="n">self</span> <span class="nf">layoutSubveiws</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">layoutSubveiws</span><span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">containerView</span> <span class="nf">mas_makeConstraints</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">MASConstraintMaker</span> <span class="o">*</span><span class="n">make</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">make</span><span class="p">.</span><span class="n">top</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">mas_top</span><span class="p">).</span><span class="n">offset</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
        <span class="n">make</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">mas_left</span><span class="p">).</span><span class="n">offset</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
        <span class="n">make</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">mas_right</span><span class="p">).</span><span class="n">offset</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">);</span>
        <span class="n">make</span><span class="p">.</span><span class="n">centerX</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">mas_centerX</span><span class="p">);</span>
        <span class="n">make</span><span class="p">.</span><span class="n">bottom</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tableview</span><span class="p">.</span><span class="n">mas_top</span><span class="p">).</span><span class="n">offset</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">);</span>
    <span class="p">}];</span>
    
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">tableview</span> <span class="nf">mas_makeConstraints</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">MASConstraintMaker</span> <span class="o">*</span><span class="n">make</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">make</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">bottom</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">);</span>
        <span class="n">make</span><span class="p">.</span><span class="n">top</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">mas_top</span><span class="p">).</span><span class="n">offset</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
    <span class="p">}];</span>
    
    
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">timeLabel</span> <span class="nf">mas_makeConstraints</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">MASConstraintMaker</span> <span class="o">*</span><span class="n">make</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">make</span><span class="p">.</span><span class="n">top</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">containerView</span><span class="p">);</span>
        <span class="n">make</span><span class="p">.</span><span class="n">centerX</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">containerView</span><span class="p">.</span><span class="n">mas_centerX</span><span class="p">);</span>
        <span class="n">make</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="mi">@25</span><span class="p">);</span>
    <span class="p">}];</span>
    
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recordButton</span> <span class="nf">mas_makeConstraints</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">MASConstraintMaker</span> <span class="o">*</span><span class="n">make</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">make</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">containerView</span><span class="p">.</span><span class="n">mas_left</span><span class="p">);</span>
        <span class="n">make</span><span class="p">.</span><span class="n">bottom</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">containerView</span><span class="p">.</span><span class="n">mas_bottom</span><span class="p">);</span>
        <span class="n">make</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="mi">@71</span><span class="p">);</span>
    <span class="p">}];</span>
    
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">stopButton</span> <span class="nf">mas_makeConstraints</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">MASConstraintMaker</span> <span class="o">*</span><span class="n">make</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">make</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">containerView</span><span class="p">.</span><span class="n">mas_right</span><span class="p">);</span>
        <span class="n">make</span><span class="p">.</span><span class="n">bottom</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">containerView</span><span class="p">.</span><span class="n">mas_bottom</span><span class="p">);</span>
        <span class="n">make</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="mi">@71</span><span class="p">);</span>
    <span class="p">}];</span>
    
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">levelMeterView</span> <span class="nf">mas_makeConstraints</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">MASConstraintMaker</span> <span class="o">*</span><span class="n">make</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">make</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">);</span>
        <span class="n">make</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="mi">@30</span><span class="p">);</span>
        <span class="n">make</span><span class="p">.</span><span class="n">bottom</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tableview</span><span class="p">.</span><span class="n">mas_top</span><span class="p">);</span>
    <span class="p">}];</span>
<span class="p">}</span>


<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">startTimer</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">timer</span> <span class="nf">invalidate</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">timer</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSTimer</span> <span class="nf">timerWithTimeInterval</span><span class="p">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span>
                                         <span class="nl">target:</span><span class="n">self</span>
                                       <span class="nl">selector:</span><span class="k">@selector</span><span class="p">(</span><span class="n">updateTimeDisplay</span><span class="p">)</span>
                                       <span class="nl">userInfo:</span><span class="nb">nil</span>
                                        <span class="nl">repeats:</span><span class="nb">YES</span><span class="p">];</span>
    <span class="p">[[</span><span class="n">NSRunLoop</span> <span class="nf">mainRunLoop</span><span class="p">]</span> <span class="nf">addTimer</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">timer</span> <span class="nf">forMode</span><span class="p">:</span><span class="n">NSRunLoopCommonModes</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">stopTimer</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">timer</span> <span class="nf">invalidate</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">timer</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">updateTimeDisplay</span> <span class="p">{</span>
    <span class="n">self</span><span class="p">.</span><span class="n">timeLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">recorder</span><span class="p">.</span><span class="n">formattedCurrentTime</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">startMeterTimer</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">levelTimer</span> <span class="nf">invalidate</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">levelTimer</span> <span class="o">=</span> <span class="p">[</span><span class="n">CADisplayLink</span> <span class="nf">displayLinkWithTarget</span><span class="p">:</span><span class="n">self</span> <span class="nf">selector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">updateMeter</span><span class="p">)];</span>
<span class="c1">//    if ([self.levelTimer respondsToSelector:@selector(setPreferredFramesPerSecond:)]) {</span>
<span class="c1">//        self.levelTimer.preferredFramesPerSecond = 5;</span>
<span class="c1">//    } else {</span>
    <span class="n">self</span><span class="p">.</span><span class="n">levelTimer</span><span class="p">.</span><span class="n">frameInterval</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="c1">//    }</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">levelTimer</span> <span class="nf">addToRunLoop</span><span class="p">:[</span><span class="n">NSRunLoop</span> <span class="nf">currentRunLoop</span><span class="p">]</span>
                          <span class="nl">forMode:</span><span class="n">NSRunLoopCommonModes</span><span class="p">];</span>
    
<span class="p">}</span>


<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">stopMeterTimer</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">levelTimer</span> <span class="nf">invalidate</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">levelTimer</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">levelMeterView</span> <span class="nf">resetLevelMeter</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">updateMeter</span> <span class="p">{</span>
    <span class="n">LevelPair</span> <span class="o">*</span><span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">levels</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">levelMeterView</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">levels</span><span class="p">.</span><span class="n">level</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">levelMeterView</span><span class="p">.</span><span class="n">peakLevel</span> <span class="o">=</span> <span class="n">levels</span><span class="p">.</span><span class="n">peakLevel</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">levelMeterView</span> <span class="nf">setNeedsDisplay</span><span class="p">];</span>
    
<span class="p">}</span>

<span class="cp">#pragma mark -
#pragma mark - UITableViewDelegate
</span><span class="k">-</span> <span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nf">tableView</span><span class="p">:(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableView</span> <span class="nf">numberOfRowsInSection</span><span class="p">:(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nv">section</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">memos</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">-</span> <span class="p">(</span><span class="n">UITableViewCell</span> <span class="o">*</span><span class="p">)</span><span class="nf">tableView</span><span class="p">:(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableView</span> <span class="nf">cellForRowAtIndexPath</span><span class="p">:(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span> <span class="p">{</span>
    <span class="n">MemoCell</span> <span class="o">*</span><span class="n">cell</span> <span class="o">=</span> <span class="p">[</span><span class="n">tableView</span> <span class="nf">dequeueReusableCellWithIdentifier</span><span class="p">:</span><span class="s">@"MemoCell"</span><span class="p">];</span>
    <span class="n">cell</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">memos</span><span class="p">[</span><span class="n">indexPath</span><span class="p">.</span><span class="nf">row</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">cell</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">tableView</span><span class="p">:(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableView</span> <span class="nf">didSelectRowAtIndexPath</span><span class="p">:(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span><span class="p">{</span>
    <span class="n">MemoModel</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">memos</span><span class="p">[</span><span class="n">indexPath</span><span class="p">.</span><span class="nf">row</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">playbackURL</span><span class="p">:</span><span class="n">model</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="nf">tableView</span><span class="p">:(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableView</span> <span class="nf">canEditRowAtIndexPath</span><span class="p">:(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">tableView</span><span class="p">:(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableView</span> <span class="nf">commitEditingStyle</span><span class="p">:(</span><span class="n">UITableViewCellEditingStyle</span><span class="p">)</span><span class="nv">editingStyle</span> <span class="nf">forRowAtIndexPath</span><span class="p">:(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">editingStyle</span> <span class="o">==</span> <span class="n">UITableViewCellEditingStyleDelete</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MemoModel</span> <span class="o">*</span><span class="n">memo</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">memos</span><span class="p">[</span><span class="n">indexPath</span><span class="p">.</span><span class="nf">row</span><span class="p">];</span>
        <span class="p">[</span><span class="n">memo</span> <span class="nf">deleteMemo</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">memos</span> <span class="nf">removeObjectAtIndex</span><span class="p">:</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span> <span class="nf">saveMemos</span><span class="p">];</span>
        <span class="p">[</span><span class="n">tableView</span> <span class="nf">deleteRowsAtIndexPaths</span><span class="p">:@[</span><span class="n">indexPath</span><span class="p">]</span> <span class="nf">withRowAnimation</span><span class="p">:</span><span class="n">UITableViewRowAnimationAutomatic</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="nf">tableView</span><span class="p">:(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableView</span> <span class="nf">heightForRowAtIndexPath</span><span class="p">:(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">80</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#pragma mark - event response 所有触发的事件响应 按钮、通知、分段控件等
</span><span class="k">-</span> <span class="p">(</span><span class="n">IBAction</span><span class="p">)</span><span class="nf">record</span><span class="p">:(</span><span class="n">UIButton</span> <span class="o">*</span><span class="p">)</span><span class="nv">sender</span> <span class="p">{</span>
    <span class="n">self</span><span class="p">.</span><span class="n">stopButton</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">sender</span> <span class="nf">isSelected</span><span class="p">])</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">self</span> <span class="nf">stopMeterTimer</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span> <span class="nf">stopTimer</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">pause</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">self</span> <span class="nf">startMeterTimer</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span> <span class="nf">startTimer</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">record</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="n">sender</span> <span class="nf">setSelected</span><span class="p">:</span><span class="o">!</span><span class="p">[</span><span class="n">sender</span> <span class="nf">isSelected</span><span class="p">]];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">IBAction</span><span class="p">)</span><span class="nf">stopRecording</span><span class="p">:(</span><span class="n">UIButton</span> <span class="o">*</span><span class="p">)</span><span class="nv">sender</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">stopMeterTimer</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">recordButton</span><span class="p">.</span><span class="n">selected</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">stopButton</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">stopWithCompletionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">BOOL</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">double</span> <span class="n">delayInSeconds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mo">01</span><span class="p">;</span>
        <span class="n">dispatch_time_t</span> <span class="n">popTime</span> <span class="o">=</span> <span class="n">dispatch_time</span><span class="p">(</span><span class="n">DISPATCH_TIME_NOW</span><span class="p">,</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">delayInSeconds</span> <span class="o">*</span> <span class="n">NSEC_PER_SEC</span><span class="p">));</span>
        <span class="n">dispatch_after</span><span class="p">(</span><span class="n">popTime</span><span class="p">,</span> <span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
            <span class="p">[</span><span class="n">self</span> <span class="nf">showSaveDialog</span><span class="p">];</span>
        <span class="p">});</span>
    <span class="p">}];</span>
<span class="p">}</span>


<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">showSaveDialog</span> <span class="p">{</span>
    <span class="n">UIAlertController</span> <span class="o">*</span><span class="n">alertController</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIAlertController</span> <span class="nf">alertControllerWithTitle</span><span class="p">:</span><span class="s">@"保存录音"</span> <span class="nf">message</span><span class="p">:</span><span class="s">@"输入名称"</span> <span class="n">preferredStyle</span><span class="o">:</span><span class="n">UIAlertControllerStyleAlert</span><span class="p">];</span>
    <span class="p">[</span><span class="n">alertController</span> <span class="nf">addTextFieldWithConfigurationHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">UITextField</span> <span class="o">*</span> <span class="n">_Nonnull</span> <span class="n">textField</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">textField</span><span class="p">.</span><span class="n">placeholder</span> <span class="o">=</span> <span class="s">@"我的录音"</span><span class="p">;</span>
    <span class="p">}];</span>
    <span class="n">UIAlertAction</span> <span class="o">*</span><span class="n">cancelAction</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIAlertAction</span> <span class="nf">actionWithTitle</span><span class="p">:</span><span class="s">@"Cancel"</span> <span class="nf">style</span><span class="p">:</span><span class="n">UIAlertActionStyleCancel</span> <span class="n">handler</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="n">UIAlertAction</span> <span class="o">*</span><span class="n">okAction</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIAlertAction</span> <span class="nf">actionWithTitle</span><span class="p">:</span><span class="s">@"OK"</span> <span class="nf">style</span><span class="p">:</span><span class="n">UIAlertActionStyleDefault</span> <span class="n">handler</span><span class="o">:^</span><span class="p">(</span><span class="n">UIAlertAction</span> <span class="o">*</span> <span class="n">_Nonnull</span> <span class="n">action</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSString</span> <span class="o">*</span><span class="n">filename</span> <span class="o">=</span> <span class="p">[</span><span class="n">alertController</span><span class="p">.</span><span class="n">textFields</span><span class="p">.</span><span class="n">firstObject</span> <span class="nf">text</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">saveRecordingWithName</span><span class="p">:</span><span class="n">filename</span> <span class="nf">completionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">BOOL</span> <span class="n">success</span><span class="p">,</span> <span class="n">id</span> <span class="n">object</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">memos</span> <span class="nf">insertObject</span><span class="p">:</span><span class="n">object</span> <span class="nf">atIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">];</span>
                <span class="p">[</span><span class="n">self</span> <span class="nf">saveMemos</span><span class="p">];</span>
                <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">tableview</span> <span class="nf">reloadData</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Error saving file: %@"</span><span class="p">,</span> <span class="p">[</span><span class="n">object</span> <span class="nf">localizedDescription</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}];</span>
    <span class="p">}];</span>
    <span class="p">[</span><span class="n">alertController</span> <span class="nf">addAction</span><span class="p">:</span><span class="n">cancelAction</span><span class="p">];</span>
    <span class="p">[</span><span class="n">alertController</span> <span class="nf">addAction</span><span class="p">:</span><span class="n">okAction</span><span class="p">];</span>
    
    <span class="p">[</span><span class="n">self</span> <span class="nf">presentViewController</span><span class="p">:</span><span class="n">alertController</span> <span class="nf">animated</span><span class="p">:</span><span class="nb">YES</span> <span class="n">completion</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span>

<span class="cp">#pragma mark - Memo Archiving
</span><span class="c1">//保存备忘录model  这里简单用归档的方式存储一下</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">saveMemos</span> <span class="p">{</span>
    <span class="n">NSData</span> <span class="o">*</span><span class="n">fileData</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSKeyedArchiver</span> <span class="nf">archivedDataWithRootObject</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">memos</span><span class="p">];</span>
    <span class="p">[</span><span class="n">fileData</span> <span class="nf">writeToURL</span><span class="p">:[</span><span class="n">self</span> <span class="nf">archiveURL</span><span class="p">]</span> <span class="nf">atomically</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">//存储归档的路径</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSURL</span> <span class="o">*</span><span class="p">)</span><span class="n">archiveURL</span> <span class="p">{</span>
    <span class="n">NSArray</span> <span class="o">*</span><span class="n">paths</span> <span class="o">=</span> <span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">NSDocumentDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="nb">YES</span><span class="p">);</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">docsDir</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span> <span class="nf">objectAtIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">archivePath</span> <span class="o">=</span> <span class="p">[</span><span class="n">docsDir</span> <span class="nf">stringByAppendingPathComponent</span><span class="p">:</span><span class="n">MEMOS_ARCHIVE</span><span class="p">];</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nf">fileURLWithPath</span><span class="p">:</span><span class="n">archivePath</span><span class="p">];</span>
<span class="p">}</span>



<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">didReceiveMemoryWarning</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">didReceiveMemoryWarning</span><span class="p">];</span>
    <span class="c1">// Dispose of any resources that can be recreated.</span>
<span class="p">}</span>


<span class="k">@end</span>

</pre></table></code></div></div><p>代码稍稍有点长 我简单说一下 大家可以参照最终的demo</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSMutableArray</span> <span class="o">&lt;</span><span class="n">MemoModel</span> <span class="o">*&gt;*</span><span class="n">memos</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">BDRecorder</span> <span class="o">*</span><span class="n">recorder</span><span class="p">;</span>

</pre></table></code></div></div><p>声明一个数组 存放需要播放的model对象信息 名称 文件url、日期等</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSTimer</span> <span class="o">*</span><span class="n">timer</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">CADisplayLink</span> <span class="o">*</span><span class="n">levelTimer</span><span class="p">;</span>
</pre></table></code></div></div><p>一个timer用于 刷新录制时间 <code class="language-plaintext highlighter-rouge">levelTimer</code>用于刷新录制的视波图也叫<code class="language-plaintext highlighter-rouge">Audio Metering</code>对音频进行计量</p><p>在<code class="language-plaintext highlighter-rouge">BDRecorder</code>中增加了</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">-</span> <span class="p">(</span><span class="n">LevelPair</span> <span class="o">*</span><span class="p">)</span><span class="n">levels</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">updateMeters</span><span class="p">];</span>
    <span class="kt">float</span> <span class="n">avgPower</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">averagePowerForChannel</span><span class="p">:</span><span class="mi">0</span><span class="p">];</span>
    <span class="kt">float</span> <span class="n">peakPower</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">peakPowerForChannel</span><span class="p">:</span><span class="mi">0</span><span class="p">];</span>
    <span class="kt">float</span> <span class="n">linearLevel</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">meterTable</span> <span class="nf">valueForPower</span><span class="p">:</span><span class="n">avgPower</span><span class="p">];</span>
    <span class="kt">float</span> <span class="n">linearPeak</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">meterTable</span> <span class="nf">valueForPower</span><span class="p">:</span><span class="n">peakPower</span><span class="p">];</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">LevelPair</span> <span class="nf">levelsWithLevel</span><span class="p">:</span><span class="n">linearLevel</span> <span class="nf">peakLevel</span><span class="p">:</span><span class="n">linearPeak</span><span class="p">];</span>
<span class="p">}</span>
</pre></table></code></div></div><p>这两个方法 1. averagePowerForChannel取出波谷平均值 2. peakPowerForChannel取出波峰 两个方法都会返回一个用于表示声音分贝(dB)等级的浮点值. 这个值的表示范围<code class="language-plaintext highlighter-rouge">0dB(fullscale) ~ -160dB</code> 0dB最大 -160dB最小</p><p><strong>开启音频计量 (需要在<code class="language-plaintext highlighter-rouge">BDRecorder</code>中开启, 如下代码) 会带来很多额外的开销，但我觉得还是很划算的 毕竟要显示视觉效果才是王道. 如果<code class="language-plaintext highlighter-rouge">meteringEnabled</code>开启则音频录音器就会对捕捉到的音频样本进行分贝计算。</strong></p><p><strong>开启音频计量(Audio Metering)方法:</strong></p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">self</span><span class="p">.</span><span class="n">recorder</span><span class="p">.</span><span class="n">meteringEnabled</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
</pre></table></code></div></div><p>更新前调用了如下代码</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">-</span> <span class="p">(</span><span class="n">LevelPair</span> <span class="o">*</span><span class="p">)</span><span class="n">levels</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">updateMeters</span><span class="p">];</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>每当读取值之前需要调用<code class="language-plaintext highlighter-rouge">[self.recorder updateMeters]</code>方法才能获取到最新值，否则可能获取的不够精确</p><p>然后 使用<code class="language-plaintext highlighter-rouge">MeterTable</code>类 声明的函数<code class="language-plaintext highlighter-rouge">valueForPower:</code> 把上边两个阀值 转成线性运算</p><p><strong>就是分贝值从对数形式的<code class="language-plaintext highlighter-rouge">-160 ~ 0</code>范围转换为线性0到1的形式.</strong></p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre><td class="rouge-code"><pre><span class="c1">//</span>
<span class="c1">//  MeterTable.m</span>
<span class="c1">//  AVAudioRecorderDemo</span>
<span class="c1">//</span>
<span class="c1">//  Created by sunyazhou on 2017/4/5.</span>
<span class="c1">//  Copyright © 2017年 Baidu, Inc. All rights reserved.</span>
<span class="c1">//</span>

<span class="cp">#import "MeterTable.h"
</span>

<span class="cp">#define MIN_DB -60.0f
#define TABLE_SIZE 300
</span>
<span class="k">@implementation</span> <span class="nc">MeterTable</span> <span class="p">{</span>
    <span class="kt">float</span> <span class="n">_scaleFactor</span><span class="p">;</span>
    <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">_meterTable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">init</span> <span class="p">{</span>
    <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nf">init</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">float</span> <span class="n">dbResolution</span> <span class="o">=</span> <span class="n">MIN_DB</span> <span class="o">/</span> <span class="p">(</span><span class="n">TABLE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        
        <span class="n">_meterTable</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="nf">arrayWithCapacity</span><span class="p">:</span><span class="n">TABLE_SIZE</span><span class="p">];</span>
        <span class="n">_scaleFactor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">/</span> <span class="n">dbResolution</span><span class="p">;</span>
        
        <span class="kt">float</span> <span class="n">minAmp</span> <span class="o">=</span> <span class="n">dbToAmp</span><span class="p">(</span><span class="n">MIN_DB</span><span class="p">);</span>
        <span class="kt">float</span> <span class="n">ampRange</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">-</span> <span class="n">minAmp</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">invAmpRange</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">/</span> <span class="n">ampRange</span><span class="p">;</span>
        
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TABLE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">float</span> <span class="n">decibels</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dbResolution</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">amp</span> <span class="o">=</span> <span class="n">dbToAmp</span><span class="p">(</span><span class="n">decibels</span><span class="p">);</span>
            <span class="kt">float</span> <span class="n">adjAmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">amp</span> <span class="o">-</span> <span class="n">minAmp</span><span class="p">)</span> <span class="o">*</span> <span class="n">invAmpRange</span><span class="p">;</span>
            <span class="n">_meterTable</span><span class="p">[</span><span class="nf">i</span><span class="p">]</span> <span class="o">=</span> <span class="err">@</span><span class="p">(</span><span class="n">adjAmp</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">float</span> <span class="nf">dbToAmp</span><span class="p">(</span><span class="kt">float</span> <span class="n">dB</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">powf</span><span class="p">(</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mo">05</span><span class="n">f</span> <span class="o">*</span> <span class="n">dB</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="nf">valueForPower</span><span class="p">:(</span><span class="kt">float</span><span class="p">)</span><span class="nv">power</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">power</span> <span class="o">&lt;</span> <span class="n">MIN_DB</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">power</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">power</span> <span class="o">*</span> <span class="n">_scaleFactor</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">_meterTable</span><span class="p">[</span><span class="nf">index</span><span class="p">]</span> <span class="nf">floatValue</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">@end</span>

</pre></table></code></div></div><blockquote><p><strong>这个类创建了一个数组<code class="language-plaintext highlighter-rouge">_meterTable</code>保存从计算前的分贝数到使用一定级别分贝解析之后的转换结果, 这里使用的解析率<code class="language-plaintext highlighter-rouge">-0.2dB</code>, 解析等级可以通过<code class="language-plaintext highlighter-rouge">MIN_DB</code> <code class="language-plaintext highlighter-rouge">TABLE_SIZE</code>这两个宏的值来修改,每个分贝值都调用<code class="language-plaintext highlighter-rouge">dbToAmp:</code>函数转换为线性范围内的值,使其处于<code class="language-plaintext highlighter-rouge">0(-60dB) ~ 1()</code>范围内, 之后由这些范围内的值构成平行曲线,开平方计算并保存到内部查找表格中. 然后如果外部需要可以调用<code class="language-plaintext highlighter-rouge">valueForPower:</code>来获取.</strong></p></blockquote><p>然后保存到<code class="language-plaintext highlighter-rouge">LevelPair</code>的实例对象返回 这个实例很简单存放两个值一个<code class="language-plaintext highlighter-rouge">level</code>一个<code class="language-plaintext highlighter-rouge">peakLevel</code></p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">@interface</span> <span class="nc">LevelPair</span> <span class="p">:</span> <span class="nc">NSObject</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="kt">float</span> <span class="n">level</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="kt">float</span> <span class="n">peakLevel</span><span class="p">;</span>

<span class="k">+</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="nf">levelsWithLevel</span><span class="p">:(</span><span class="kt">float</span><span class="p">)</span><span class="nv">level</span> <span class="nf">peakLevel</span><span class="p">:(</span><span class="kt">float</span><span class="p">)</span><span class="nv">peakLevel</span><span class="p">;</span>

<span class="k">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="nf">initWithLevel</span><span class="p">:(</span><span class="kt">float</span><span class="p">)</span><span class="nv">level</span> <span class="nf">peakLevel</span><span class="p">:(</span><span class="kt">float</span><span class="p">)</span><span class="nv">peakLevel</span><span class="p">;</span>

<span class="k">@end</span>
</pre></table></code></div></div><p>在<code class="language-plaintext highlighter-rouge">ViewController</code>中显示相关的UI</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">startTimer</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">timer</span> <span class="nf">invalidate</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">timer</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSTimer</span> <span class="nf">timerWithTimeInterval</span><span class="p">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span>
                                         <span class="nl">target:</span><span class="n">self</span>
                                       <span class="nl">selector:</span><span class="k">@selector</span><span class="p">(</span><span class="n">updateTimeDisplay</span><span class="p">)</span>
                                       <span class="nl">userInfo:</span><span class="nb">nil</span>
                                        <span class="nl">repeats:</span><span class="nb">YES</span><span class="p">];</span>
    <span class="p">[[</span><span class="n">NSRunLoop</span> <span class="nf">mainRunLoop</span><span class="p">]</span> <span class="nf">addTimer</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">timer</span> <span class="nf">forMode</span><span class="p">:</span><span class="n">NSRunLoopCommonModes</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">stopTimer</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">timer</span> <span class="nf">invalidate</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">timer</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">updateTimeDisplay</span> <span class="p">{</span>
    <span class="n">self</span><span class="p">.</span><span class="n">timeLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">recorder</span><span class="p">.</span><span class="n">formattedCurrentTime</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">startMeterTimer</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">levelTimer</span> <span class="nf">invalidate</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">levelTimer</span> <span class="o">=</span> <span class="p">[</span><span class="n">CADisplayLink</span> <span class="nf">displayLinkWithTarget</span><span class="p">:</span><span class="n">self</span> <span class="nf">selector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">updateMeter</span><span class="p">)];</span>
<span class="c1">//    if ([self.levelTimer respondsToSelector:@selector(setPreferredFramesPerSecond:)]) {</span>
<span class="c1">//        self.levelTimer.preferredFramesPerSecond = 5;</span>
<span class="c1">//    } else {</span>
    <span class="n">self</span><span class="p">.</span><span class="n">levelTimer</span><span class="p">.</span><span class="n">frameInterval</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="c1">//    }</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">levelTimer</span> <span class="nf">addToRunLoop</span><span class="p">:[</span><span class="n">NSRunLoop</span> <span class="nf">currentRunLoop</span><span class="p">]</span>
                          <span class="nl">forMode:</span><span class="n">NSRunLoopCommonModes</span><span class="p">];</span>
    
<span class="p">}</span>


<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">stopMeterTimer</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">levelTimer</span> <span class="nf">invalidate</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">levelTimer</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">levelMeterView</span> <span class="nf">resetLevelMeter</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">updateMeter</span> <span class="p">{</span>
    <span class="n">LevelPair</span> <span class="o">*</span><span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">levels</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">levelMeterView</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">levels</span><span class="p">.</span><span class="n">level</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">levelMeterView</span><span class="p">.</span><span class="n">peakLevel</span> <span class="o">=</span> <span class="n">levels</span><span class="p">.</span><span class="n">peakLevel</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">levelMeterView</span> <span class="nf">setNeedsDisplay</span><span class="p">];</span>
    
<span class="p">}</span>

</pre></table></code></div></div><p>用于定时器的处理</p><p>事件的相关响应</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="cp">#pragma mark - event response 所有触发的事件响应 按钮、通知、分段控件等
</span><span class="k">-</span> <span class="p">(</span><span class="n">IBAction</span><span class="p">)</span><span class="nf">record</span><span class="p">:(</span><span class="n">UIButton</span> <span class="o">*</span><span class="p">)</span><span class="nv">sender</span> <span class="p">{</span>
    <span class="n">self</span><span class="p">.</span><span class="n">stopButton</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">sender</span> <span class="nf">isSelected</span><span class="p">])</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">self</span> <span class="nf">stopMeterTimer</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span> <span class="nf">stopTimer</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">pause</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">self</span> <span class="nf">startMeterTimer</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span> <span class="nf">startTimer</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">record</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="n">sender</span> <span class="nf">setSelected</span><span class="p">:</span><span class="o">!</span><span class="p">[</span><span class="n">sender</span> <span class="nf">isSelected</span><span class="p">]];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">IBAction</span><span class="p">)</span><span class="nf">stopRecording</span><span class="p">:(</span><span class="n">UIButton</span> <span class="o">*</span><span class="p">)</span><span class="nv">sender</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">stopMeterTimer</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">recordButton</span><span class="p">.</span><span class="n">selected</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">stopButton</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">recorder</span> <span class="nf">stopWithCompletionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">BOOL</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">double</span> <span class="n">delayInSeconds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mo">01</span><span class="p">;</span>
        <span class="n">dispatch_time_t</span> <span class="n">popTime</span> <span class="o">=</span> <span class="n">dispatch_time</span><span class="p">(</span><span class="n">DISPATCH_TIME_NOW</span><span class="p">,</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">delayInSeconds</span> <span class="o">*</span> <span class="n">NSEC_PER_SEC</span><span class="p">));</span>
        <span class="n">dispatch_after</span><span class="p">(</span><span class="n">popTime</span><span class="p">,</span> <span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
            <span class="p">[</span><span class="n">self</span> <span class="nf">showSaveDialog</span><span class="p">];</span>
        <span class="p">});</span>
    <span class="p">}];</span>
<span class="p">}</span>

</pre></table></code></div></div><p>这里保存数据使用的是归档方式</p><p><code class="language-plaintext highlighter-rouge">BDRecorder</code>没有 处理意外中断等情况 比如外接麦克风 和音频意外来电等，如果需要处理 就可以在<code class="language-plaintext highlighter-rouge">BDRecorder</code>中声明几个代理监听音频回话的那几个通知就可以了 这里出于学习为目的就简单写到这里吧，如果大家需求强烈我可以回头补上并开源。</p><p>很多人纠结如何根据波形绘制更好的图 我这里是借助本书作者的demo完成相关波形处理的视图。</p><div class="language-objc highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
</pre><td class="rouge-code"><pre><span class="cp">#import "LevelMeterView.h"
</span>
<span class="cp">#import "LevelMeterColorThreshold.h"
</span>
<span class="k">@interface</span> <span class="nc">LevelMeterView</span> <span class="p">()</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">)</span> <span class="n">NSUInteger</span> <span class="n">ledCount</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">UIColor</span> <span class="o">*</span><span class="n">ledBackgroundColor</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">UIColor</span> <span class="o">*</span><span class="n">ledBorderColor</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">colorThresholds</span><span class="p">;</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">LevelMeterView</span>

<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="nf">initWithFrame</span><span class="p">:(</span><span class="n">CGRect</span><span class="p">)</span><span class="nv">frame</span> <span class="p">{</span>
    <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nf">initWithFrame</span><span class="p">:</span><span class="n">frame</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">self</span> <span class="nf">setupView</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="nf">initWithCoder</span><span class="p">:(</span><span class="n">NSCoder</span> <span class="o">*</span><span class="p">)</span><span class="nv">coder</span> <span class="p">{</span>
    <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nf">initWithCoder</span><span class="p">:</span><span class="n">coder</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">self</span> <span class="nf">setupView</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">setupView</span> <span class="p">{</span>
    
    <span class="n">self</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">clearColor</span><span class="p">];</span>
    
    <span class="n">_ledCount</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
    
    <span class="n">_ledBackgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">colorWithWhite</span><span class="p">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="nf">alpha</span><span class="p">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">35</span><span class="n">f</span><span class="p">];</span>
    <span class="n">_ledBorderColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">blackColor</span><span class="p">];</span>
    
    <span class="n">UIColor</span> <span class="o">*</span><span class="n">greenColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">colorWithRed</span><span class="p">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">458</span> <span class="nf">green</span><span class="p">:</span><span class="mi">1</span><span class="p">.</span><span class="mo">000</span> <span class="n">blue</span><span class="o">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">396</span> <span class="n">alpha</span><span class="o">:</span><span class="mi">1</span><span class="p">.</span><span class="mo">000</span><span class="p">];</span>
    <span class="n">UIColor</span> <span class="o">*</span><span class="n">yellowColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">colorWithRed</span><span class="p">:</span><span class="mi">1</span><span class="p">.</span><span class="mo">000</span> <span class="nf">green</span><span class="p">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">930</span> <span class="n">blue</span><span class="o">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">315</span> <span class="n">alpha</span><span class="o">:</span><span class="mi">1</span><span class="p">.</span><span class="mo">000</span><span class="p">];</span>
    <span class="n">UIColor</span> <span class="o">*</span><span class="n">redColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">colorWithRed</span><span class="p">:</span><span class="mi">1</span><span class="p">.</span><span class="mo">000</span> <span class="nf">green</span><span class="p">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">325</span> <span class="n">blue</span><span class="o">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">329</span> <span class="n">alpha</span><span class="o">:</span><span class="mi">1</span><span class="p">.</span><span class="mo">000</span><span class="p">];</span>
    
    <span class="n">_colorThresholds</span> <span class="o">=</span> <span class="p">@[[</span><span class="n">LevelMeterColorThreshold</span> <span class="nf">colorThresholdWithMaxValue</span><span class="p">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="nf">color</span><span class="p">:</span><span class="n">greenColor</span> <span class="n">name</span><span class="o">:</span><span class="s">@"green"</span><span class="p">],</span>
                         <span class="p">[</span><span class="n">LevelMeterColorThreshold</span> <span class="nf">colorThresholdWithMaxValue</span><span class="p">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span> <span class="nf">color</span><span class="p">:</span><span class="n">yellowColor</span> <span class="n">name</span><span class="o">:</span><span class="s">@"yellow"</span><span class="p">],</span>
                         <span class="p">[</span><span class="n">LevelMeterColorThreshold</span> <span class="nf">colorThresholdWithMaxValue</span><span class="p">:</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="nf">color</span><span class="p">:</span><span class="n">redColor</span> <span class="n">name</span><span class="o">:</span><span class="s">@"red"</span><span class="p">]];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">drawRect</span><span class="p">:(</span><span class="n">CGRect</span><span class="p">)</span><span class="nv">rect</span> <span class="p">{</span>
    
    <span class="n">CGContextRef</span> <span class="n">context</span> <span class="o">=</span> <span class="n">UIGraphicsGetCurrentContext</span><span class="p">();</span>
    
    <span class="n">CGContextTranslateCTM</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CGRectGetHeight</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">bounds</span><span class="p">));</span>
    <span class="n">CGContextRotateCTM</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span> <span class="o">-</span><span class="n">M_PI_2</span><span class="p">);</span>
    <span class="n">CGRect</span> <span class="n">bounds</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">.,</span> <span class="mi">0</span><span class="p">.,</span> <span class="p">[</span><span class="n">self</span> <span class="nf">bounds</span><span class="p">].</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="p">[</span><span class="n">self</span> <span class="nf">bounds</span><span class="p">].</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
    
    
    <span class="n">CGFloat</span> <span class="n">lightMinValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">;</span>
    
    <span class="n">NSInteger</span> <span class="n">peakLED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">peakLevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">peakLED</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">peakLevel</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">ledCount</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">peakLED</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">ledCount</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">peakLED</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">ledCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">ledIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ledIndex</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">ledCount</span><span class="p">;</span> <span class="n">ledIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="n">UIColor</span> <span class="o">*</span><span class="n">ledColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">colorThresholds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nf">color</span><span class="p">];</span>
        
        <span class="n">CGFloat</span> <span class="n">ledMaxValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span> <span class="p">(</span><span class="n">ledIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">ledCount</span><span class="p">;</span>
        
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">colorIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">colorIndex</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">colorThresholds</span><span class="p">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">colorIndex</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">LevelMeterColorThreshold</span> <span class="o">*</span><span class="n">currThreshold</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">colorThresholds</span><span class="p">[</span><span class="nf">colorIndex</span><span class="p">];</span>
            <span class="n">LevelMeterColorThreshold</span> <span class="o">*</span><span class="n">nextThreshold</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">colorThresholds</span><span class="p">[</span><span class="n">colorIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">currThreshold</span><span class="p">.</span><span class="n">maxValue</span> <span class="o">&lt;=</span> <span class="n">ledMaxValue</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ledColor</span> <span class="o">=</span> <span class="n">nextThreshold</span><span class="p">.</span><span class="n">color</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="n">CGFloat</span> <span class="n">height</span> <span class="o">=</span> <span class="n">CGRectGetHeight</span><span class="p">(</span><span class="n">bounds</span><span class="p">);</span>
        <span class="n">CGFloat</span> <span class="n">width</span> <span class="o">=</span> <span class="n">CGRectGetWidth</span><span class="p">(</span><span class="n">bounds</span><span class="p">);</span>
        
        <span class="n">CGRect</span> <span class="n">ledRect</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="n">height</span> <span class="o">*</span> <span class="p">((</span><span class="n">CGFloat</span><span class="p">)</span> <span class="n">ledIndex</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">ledCount</span><span class="p">),</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">ledCount</span><span class="p">));</span>
        
        <span class="c1">// Fill background color</span>
        <span class="n">CGContextSetFillColorWithColor</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">ledBackgroundColor</span><span class="p">.</span><span class="n">CGColor</span><span class="p">);</span>
        <span class="n">CGContextFillRect</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ledRect</span><span class="p">);</span>
        
        <span class="c1">// Draw Light</span>
        <span class="n">CGFloat</span> <span class="n">lightIntensity</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ledIndex</span> <span class="o">==</span> <span class="n">peakLED</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">lightIntensity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">lightIntensity</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">level</span> <span class="o">-</span> <span class="n">lightMinValue</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ledMaxValue</span> <span class="o">-</span> <span class="n">lightMinValue</span><span class="p">));</span>
        <span class="p">}</span>
        
        <span class="n">UIColor</span> <span class="o">*</span><span class="n">fillColor</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lightIntensity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fillColor</span> <span class="o">=</span> <span class="n">ledColor</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lightIntensity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">CGColorRef</span> <span class="n">color</span> <span class="o">=</span> <span class="n">CGColorCreateCopyWithAlpha</span><span class="p">([</span><span class="n">ledColor</span> <span class="nf">CGColor</span><span class="p">],</span> <span class="n">lightIntensity</span><span class="p">);</span>
            <span class="n">fillColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">colorWithCGColor</span><span class="p">:</span><span class="n">color</span><span class="p">];</span>
            <span class="n">CGColorRelease</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="n">CGContextSetFillColorWithColor</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">fillColor</span><span class="p">.</span><span class="n">CGColor</span><span class="p">);</span>
        <span class="n">UIBezierPath</span> <span class="o">*</span><span class="n">fillPath</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIBezierPath</span> <span class="nf">bezierPathWithRoundedRect</span><span class="p">:</span><span class="n">ledRect</span> <span class="nf">cornerRadius</span><span class="p">:</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">];</span>
        <span class="n">CGContextAddPath</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">fillPath</span><span class="p">.</span><span class="n">CGPath</span><span class="p">);</span>
        
        <span class="c1">// Stroke border</span>
        <span class="n">CGContextSetStrokeColorWithColor</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">ledBorderColor</span><span class="p">.</span><span class="n">CGColor</span><span class="p">);</span>
        <span class="n">UIBezierPath</span> <span class="o">*</span><span class="n">strokePath</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIBezierPath</span> <span class="nf">bezierPathWithRoundedRect</span><span class="p">:</span><span class="n">CGRectInset</span><span class="p">(</span><span class="n">ledRect</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="nf">cornerRadius</span><span class="p">:</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">];</span>
        <span class="n">CGContextAddPath</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">strokePath</span><span class="p">.</span><span class="n">CGPath</span><span class="p">);</span>
        
        <span class="n">CGContextDrawPath</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">kCGPathFillStroke</span><span class="p">);</span>
        
        <span class="n">lightMinValue</span> <span class="o">=</span> <span class="n">ledMaxValue</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">CGFloat</span> <span class="nf">clamp</span><span class="p">(</span><span class="n">CGFloat</span> <span class="n">intensity</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">intensity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intensity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">intensity</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">resetLevelMeter</span> <span class="p">{</span>
    <span class="n">self</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">peakLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">setNeedsDisplay</span><span class="p">];</span>
<span class="p">}</span>


<span class="k">@end</span>
</pre></table></code></div></div><p>这里给出了level和peak的阀值 有很多第三方开源的view大家可以自行研究一下 很简单 就是把相关阀值量化的过程。</p><h2 id="总结">总结</h2><p><code class="language-plaintext highlighter-rouge">AVAudioRecorder</code> 的学习还算完整的搞完了,随时记录一下学习内容和技术知识。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/images/20170328LearningAVFoundationAVAudioRecorder/FinalDemo.webp" alt="" /></p><p><strong>最终<a href="https://github.com/sunyazhou13/AVAudioRecorderDemo">Demo</a></strong></p><p>欢迎大家指正错误 全文完</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ios/'>iOS</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ios/" class="post-tag no-text-decoration" >iOS</a> <a href="/tags/macos/" class="post-tag no-text-decoration" >macOS</a> <a href="/tags/objective-c/" class="post-tag no-text-decoration" >Objective-C</a> <a href="/tags/avfoundation/" class="post-tag no-text-decoration" >AVFoundation</a> <a href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/" class="post-tag no-text-decoration" >音视频</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 该博客文章由作者通过 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC BY 4.0</a> 进行授权。</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Learning AV Foundation(三)AVAudioRecorder - 迈腾大队长&url=https://www.sunyazhou.com/2017/03/LearningAVFoundationAVAudioRecorder/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Learning AV Foundation(三)AVAudioRecorder - 迈腾大队长&u=https://www.sunyazhou.com/2017/03/LearningAVFoundationAVAudioRecorder/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Learning AV Foundation(三)AVAudioRecorder - 迈腾大队长&url=https://www.sunyazhou.com/2017/03/LearningAVFoundationAVAudioRecorder/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="http://service.weibo.com/share/share.php?title=Learning AV Foundation(三)AVAudioRecorder - 迈腾大队长&url=https://www.sunyazhou.com/2017/03/LearningAVFoundationAVAudioRecorder/" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>最近更新</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/2025/05/MemoryAlignmentAlgorithm/">GPU内存对齐算法</a><li><a href="/2017/02/HowToUseGitManageCode/">如何使用git管理代码</a><li><a href="/2025/02/the-basics-on-the-memory-layout-of-swift-struct-instances/">Swift结构体实例内存布局的基础知识</a><li><a href="/2025/02/unsafe-swift-using-pointers-and-interacting-with-c/">如何使用unsafe Swift指针类型直接访问内存并与C交互</a><li><a href="/2017/01/UIViewControllerCodeStandard/">UIViewController代码规范</a></ul></div><div id="access-tags"> <span>热门标签</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/objective-c/">Objective C</a> <a class="post-tag" href="/tags/ios/">iOS</a> <a class="post-tag" href="/tags/macos/">macOS</a> <a class="post-tag" href="/tags/skills/">skills</a> <a class="post-tag" href="/tags/swift/">Swift</a> <a class="post-tag" href="/tags/swiftui/">SwiftUI</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/c++/">C++</a> <a class="post-tag" href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/">音视频</a> <a class="post-tag" href="/tags/avfoundation/">AVFoundation</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">文章目录</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>接下来阅读</h3><div class="card-deck mb-4"><div class="card"> <a href="/2022/04/CVPixelBufferRef/"><div class="card-body"> <span class="timeago small" > 2022-04-06 <i class="unloaded">2022-04-06T01:50:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>深入理解CVPixelBufferRef</h3><div class="text-muted small"><p> 在iOS里，我们经常能看到CVPixelBufferRef这个类型，在Camera采集返回的数据里得到一个CMSampleBufferRef,而每个CMSampleBufferRef里则包含一个CVPixelBufferRef,在视频硬解码的返回数据里也是一个CVPixelBufferRef。 顾名思义,CVPixelBufferRef是一种像素图片类型，由于CV开头，所以它是属于Co...</p></div></div></a></div><div class="card"> <a href="/2017/03/LearningAVFoundationAVSpeechSynthesizer/"><div class="card-body"> <span class="timeago small" > 2017-03-11 <i class="unloaded">2017-03-11T12:38:53+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Learning AV Foundation(一)汉字语音朗读</h3><div class="text-muted small"><p> 前言 最近在研究AV Foundation 框架 发现有一本书叫做 AV Foundation开发秘籍：实践掌握iOS &amp; OS X 应用的视听处理技术 然后google查了一下英文版叫 Learning AV Foundation: A Hands-on Guide to Mastering the AV Foundation Framework 看着国人的翻译不仅慨叹...</p></div></div></a></div><div class="card"> <a href="/2017/03/LearningAVFoundationAVAudioPlayer/"><div class="card-body"> <span class="timeago small" > 2017-03-17 <i class="unloaded">2017-03-17T10:26:06+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Learning AV Foundation(二)AVAudioPlayer</h3><div class="text-muted small"><p> 开篇 最近在学习AV Foundation 试图把学习内容记录下来 并参考一些博客文章 本期的内容是AVAudioPlayer 音频知识基础 音频文件的生成过程是将声音信息__采样__、量化__和__编码__产生的数字信号的过程，__人耳所能听到的声音，最低的频率是从20Hz起一直到最高频率20KHZ，因此音频文件格式的最大带宽是20KHZ。根据奈奎斯特的理论，只有采样频率高于...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/2017/03/CheckNSWindowisFullScreen/" class="btn btn-outline-primary"><p>判断NSWindow是否全屏</p></a> <a href="/2017/03/AccessPrivacySensitive/" class="btn btn-outline-primary"><p>隐私及敏感数据访问权限(Access privacy-sensitive data)</p></a></div><div class="utterances-container"> <script src="https://utteranc.es/client.js" repo="sunyazhou13/gitment-comments" issue-term="pathname" theme="photon-dark" crossorigin="anonymous" async> </script></div><script type="text/javascript"> $(function() { window.onmessage = evt => { if (evt.origin === 'https://utteranc.es') { toggle.updateCommentStyle(); window.onmessage = null; } } }); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/sunyazhou13">sunyazhou</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，否则本网站上的博客文章均由作者根据知识共享许可协议 - 署名标示 4.0（CC BY 4.0）进行授权许可。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本博客由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，使用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> 作为主题</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">热门标签</h4><a class="post-tag" href="/tags/objective-c/">Objective C</a> <a class="post-tag" href="/tags/ios/">iOS</a> <a class="post-tag" href="/tags/macos/">macOS</a> <a class="post-tag" href="/tags/skills/">skills</a> <a class="post-tag" href="/tags/swift/">Swift</a> <a class="post-tag" href="/tags/swiftui/">SwiftUI</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/c++/">C++</a> <a class="post-tag" href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91/">音视频</a> <a class="post-tag" href="/tags/avfoundation/">AVFoundation</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.sunyazhou.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
